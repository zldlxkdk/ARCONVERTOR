<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR 이미지 생성기 - 비디오 오버레이</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .mode-switch {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .mode-toggle {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 25px;
            padding: 5px;
            margin-top: 10px;
        }

        .mode-btn {
            flex: 1;
            background: transparent;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #ff6b35;
            box-shadow: 0 2px 10px rgba(255, 107, 53, 0.3);
        }

        .create-mode, .scan-mode {
            display: none;
        }

        .create-mode.active, .scan-mode.active {
            display: block;
        }

        .step {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .step.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff6b35;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #ff6b35;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }

        .upload-area.dragover {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.2);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .upload-text {
            font-size: 14px;
            opacity: 0.8;
        }

        .file-input {
            display: none;
        }

        .preview {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 10px;
        }

        .preview-video {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
            width: auto;
            margin: 5px;
        }

        .progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            font-size: 12px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ar-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1000;
            display: none;
        }

        .ar-viewer.active {
            display: block;
        }

        .ar-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ar-status {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            max-width: 300px;
            font-weight: 500;
        }

        .ar-close {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            z-index: 2001;
            position: relative;
        }

        .ar-close:hover {
            background: #e55a2e;
            transform: scale(1.05);
        }

        .check-icon {
            color: #4CAF50;
            font-size: 20px;
        }

        .ar-result {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            text-align: center;
        }

        /* 카메라 미리보기 스타일 */
        .camera-preview {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 90px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            overflow: hidden;
            z-index: 1002;
            border: 2px solid #ff6b35;
        }

        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-preview.hidden {
            display: none;
        }

        /* AR Scene 컨테이너 */
        .ar-scene-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #ar-scene {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .target-image-container {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
            display: inline-block;
        }

        .target-image {
            border-radius: 10px;
            max-width: 200px;
            height: auto;
            border: 3px solid #ff6b35;
        }

        .download-section {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .download-btn {
            flex: 1;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .share-btn {
            background: #2196F3;
        }

        .share-btn:hover {
            background: #1976D2;
        }

        .scan-info {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .scanner-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }

        .scanner-video {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #ff6b35;
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px solid rgba(255, 107, 53, 0.5);
            border-radius: 15px;
            animation: scanPulse 2s infinite;
        }

        @keyframes scanPulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        @keyframes arTrackingPulse {
            0%, 100% { 
                opacity: 0.8; 
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 107, 53, 0.5);
            }
            50% { 
                opacity: 1; 
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.2), 0 0 30px rgba(255, 107, 53, 0.8);
            }
        }

        .scan-instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 12px;
        }

        .frame-extraction-info {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
        }

        .extracted-frame {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .video-editor {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .video-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .time-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            cursor: pointer;
        }

        .time-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff6b35;
            cursor: pointer;
        }

        .time-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff6b35;
            cursor: pointer;
            border: none;
        }

        .time-display {
            font-size: 11px;
            opacity: 0.8;
            min-width: 60px;
            text-align: center;
        }

        .trim-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .trim-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .trim-label {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .trim-time {
            font-size: 13px;
            font-weight: 600;
            color: #ff6b35;
        }

        .range-visualizer {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        .range-selected {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #f7931e);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .duration-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            text-align: center;
        }

        .trim-preview {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .fallback-info {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-size: 13px;
        }

        .youtube-embed {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            border: none;
            margin: 10px 0;
        }

        .scan-help {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
        }

        .camera-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1000;
            background: #000;
        }

        .ar-overlay-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            display: none;
        }

        .ar-overlay-container.active {
            display: block;
        }

        .overlay-video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 200px;
            object-fit: cover;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            border: 2px solid #ff6b35;
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.6);
            z-index: 1002;
            display: block;
        }

        .overlay-video::-webkit-media-controls {
            display: none !important;
        }

        .overlay-video::-webkit-media-controls-enclosure {
            display: none !important;
        }

        .overlay-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 320px;
            height: 220px;
            border: 2px dashed #4CAF50;
            border-radius: 12px;
            background: rgba(76, 175, 80, 0.05);
            pointer-events: none;
            animation: frameGlow 2s infinite alternate;
            z-index: 1001;
        }

        @keyframes frameGlow {
            0% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
            100% { box-shadow: 0 0 15px rgba(76, 175, 80, 0.8); }
        }

        .overlay-instructions {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid #ff6b35;
            z-index: 1003;
            max-width: 90%;
        }

        .youtube-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1004;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .youtube-overlay.active {
            display: flex;
        }

        .youtube-content {
            background: rgba(0, 0, 0, 0.9);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            border: 3px solid #ff6b35;
            backdrop-filter: blur(15px);
            width: 90%;
            max-width: 640px;
            height: 80%;
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .youtube-header {
            font-size: 20px;
            color: white;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .youtube-iframe {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            flex: 1;
            min-height: 300px;
        }

        .youtube-info {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 10px;
            font-style: italic;
        }

        /* 전체 화면 스캐너 */
        .fullscreen-scanner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1500;
            display: none;
        }

        .fullscreen-scanner.active {
            display: block;
        }

        .scanner-video-fullscreen {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 280px;
            height: 280px;
            margin: auto;
            border: 4px solid #ff6b35;
            border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4);
            animation: scanPulse 2s infinite;
            z-index: 1502;
            pointer-events: none;
            /* 완전한 중앙 정렬: top, left, right, bottom 0 + margin auto */
        }

        /* 스캔 프레임의 코너 마커 */
        .scanner-overlay-fullscreen::before,
        .scanner-overlay-fullscreen::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border: 5px solid #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }

        .scanner-overlay-fullscreen::before {
            top: -6px;
            left: -6px;
            border-right: transparent;
            border-bottom: transparent;
            border-top-left-radius: 20px;
        }

        .scanner-overlay-fullscreen::after {
            top: -6px;
            right: -6px;
            border-left: transparent;
            border-bottom: transparent;
            border-top-right-radius: 20px;
        }

        /* 추가 코너 마커 */
        .corner-markers {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .corner-markers::before,
        .corner-markers::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border: 5px solid #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }

        .corner-markers::before {
            bottom: -6px;
            left: -6px;
            border-right: transparent;
            border-top: transparent;
            border-bottom-left-radius: 20px;
        }

        .corner-markers::after {
            bottom: -6px;
            right: -6px;
            border-left: transparent;
            border-top: transparent;
            border-bottom-right-radius: 20px;
        }

        .scanner-controls-fullscreen {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1501;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scan-status-fullscreen {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            max-width: 70%;
        }

        .scan-close-btn {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .scan-close-btn:hover {
            background: #e55a2e;
            transform: scale(1.05);
        }

        .scan-instructions-fullscreen {
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 16px;
            backdrop-filter: blur(10px);
            border: 2px solid #ff6b35;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 모드 선택 -->
        <div class="mode-switch">
            <h1 style="margin-bottom: 15px; font-size: 24px;">📱 AR 이미지 생성기</h1>
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="switchMode('create')">🎨 AR 이미지 생성</button>
                <button class="mode-btn" onclick="switchMode('scan')">📷 이미지 스캔</button>
            </div>
        </div>

        <!-- AR 생성 모드 -->
        <div class="create-mode active">
            <!-- 1단계: 비디오 업로드 -->
            <div class="step" id="step1">
                <div class="step-title">
                    <div class="step-number">1</div>
                    AR 비디오 업로드
                </div>
                <div class="upload-area" onclick="document.getElementById('videoInput').click()">
                    <div class="upload-icon">🎬</div>
                    <div class="upload-text">AR로 재생할 비디오를 업로드하세요</div>
                    <div style="font-size: 12px; opacity: 0.6; margin-top: 5px;">
                        MP4, WebM 지원 (모든 크기)
                    </div>
                </div>
                <input type="file" id="videoInput" class="file-input" accept="video/*" />
                <div id="videoPreview"></div>
                <div id="videoEditor" class="video-editor" style="display: none;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #ff6b35;">
                        ✂️ 비디오 편집 (최대 15초)
                    </div>
                    
                    <video id="editVideo" class="trim-preview" muted></video>
                    
                    <div class="video-controls">
                        <button class="btn btn-small" onclick="playPauseVideo()">▶️</button>
                        <input type="range" id="currentTimeSlider" class="time-slider" min="0" max="100" value="0">
                        <div class="time-display" id="currentTimeDisplay">0:00</div>
                    </div>
                    
                    <div class="trim-controls">
                        <div class="trim-section">
                            <div class="trim-label">시작 시간</div>
                            <div class="trim-time" id="startTimeDisplay">0:00</div>
                            <button class="btn btn-small" onclick="setStartTime()">설정</button>
                        </div>
                        <div class="trim-section">
                            <div class="trim-label">종료 시간</div>
                            <div class="trim-time" id="endTimeDisplay">0:15</div>
                            <button class="btn btn-small" onclick="setEndTime()">설정</button>
                        </div>
                    </div>
                    
                    <div class="range-visualizer">
                        <div class="range-selected" id="rangeSelected"></div>
                    </div>
                    
                    <div id="durationInfo" class="duration-warning">
                        선택된 구간: <span id="selectedDuration">15초</span> (최대 15초)
                    </div>
                    
                    <button class="btn" onclick="processVideo()" id="processBtn">
                        ✂️ 선택 구간 처리하기
                    </button>
                </div>
                <div id="frameExtractionInfo"></div>
            </div>

            <!-- 2단계: AR 이미지 생성 -->
            <div class="step" id="step2">
                <div class="step-title">
                    <div class="step-number">2</div>
                    AR 타겟 이미지 생성
                </div>
                <button class="btn" id="generateBtn" onclick="generateARImage()" disabled>
                    🖼️ AR 이미지 생성하기
                </button>
                <div id="generateProgress"></div>
                <div id="generateResult"></div>
            </div>
        </div>

        <!-- 이미지 스캔 모드 -->
        <div class="scan-mode">
            <div class="step active">
                <div class="step-title">
                    <div class="step-number">📷</div>
                    AR 이미지 스캐너
                </div>
                
                <div class="scan-info">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">
                        📱 생성된 AR 이미지 스캔
                    </div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        생성된 AR 이미지를 스캔하면<br>
                        해당 위치에 비디오가 오버레이됩니다
                    </div>
                </div>

                <div class="scan-help">
                    <div style="font-weight: 600; margin-bottom: 10px;">💡 스캔 도움말</div>
                    <ul style="text-align: left; font-size: 12px;">
                        <li>📷 카메라를 이미지에서 20-30cm 거리에 두세요</li>
                        <li>💡 밝은 조명에서 스캔하세요</li>
                        <li>📐 이미지를 정면에서 비춰주세요</li>
                        <li>🤚 손을 안정적으로 유지하세요</li>
                        <li>🔄 3초 후 자동으로 감지됩니다</li>
                    </ul>
                </div>

                <div class="fallback-info">
                    <div style="font-weight: 600; margin-bottom: 10px;">🎬 폴백 영상</div>
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 10px;">
                        비디오 로드에 실패하면 아래 유튜브 영상이 재생됩니다
                    </div>
                    <iframe 
                        class="youtube-embed"
                        src="https://www.youtube.com/embed/MX_UceuxveA?autoplay=0&mute=1"
                        title="Fallback YouTube Video"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                </div>

                <div class="scanner-container" id="scannerContainer" style="display: none;">
                    <video id="scannerVideo" class="scanner-video" autoplay muted playsinline></video>
                    <div class="scanner-overlay"></div>
                    <div class="scan-instructions" id="scan-instructions">
                        생성된 AR 이미지를 프레임 안에 맞춰주세요<br>
                        <span style="opacity: 0.7;">3초 후 자동 감지</span>
                    </div>
                </div>

                <button class="btn" id="startScanBtn" onclick="startFullscreenScan()">
                    📷 이미지 스캔 시작
                </button>
            </div>
        </div>
    </div>

    <!-- 전체 화면 스캐너 -->
    <div class="fullscreen-scanner" id="fullscreenScanner">
        <video id="scannerVideoFullscreen" class="scanner-video-fullscreen" autoplay muted playsinline></video>
        
        <div class="scanner-controls-fullscreen">
            <div class="scan-status-fullscreen" id="scanStatusFullscreen">카메라 준비 중...</div>
            <button class="scan-close-btn" onclick="closeFullscreenScan()">✕ 닫기</button>
        </div>
        
        <div class="scanner-overlay-fullscreen">
            <div class="corner-markers"></div>
        </div>
        
        <div class="scan-instructions-fullscreen" id="scanInstructionsFullscreen">
            생성된 AR 이미지를 프레임 안에 맞춰주세요<br>
            <span style="opacity: 0.7;">3초 후 자동 감지</span>
        </div>
    </div>

    <!-- AR 뷰어 -->
    <div class="ar-viewer" id="arViewer">
        <div class="ar-controls">
            <div class="ar-status" id="arStatus">AR 준비 중...</div>
            <button class="ar-close" onclick="closeARViewer()">✕ 닫기</button>
        </div>

        <!-- 실시간 카메라 화면 (배경) -->
        <video id="cameraBackground" class="camera-background" autoplay muted playsinline></video>

        <!-- AR 비디오 오버레이 -->
        <div class="ar-overlay-container" id="arOverlayContainer">
            <video id="overlayVideo" class="overlay-video" loop muted playsinline></video>
            <div class="overlay-frame" id="overlayFrame"></div>
            <div class="overlay-instructions" id="overlayInstructions">
                이미지를 프레임 안에 맞춰주세요
            </div>
        </div>

        <!-- 유튜브 폴백 오버레이 -->
        <div class="youtube-overlay" id="youtubeOverlay">
            <div class="youtube-content">
                <div class="youtube-header">📺 AR 폴백 영상</div>
                <iframe id="youtubeIframe" 
                        class="youtube-iframe"
                        src="" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                </iframe>
                <div class="youtube-info">원본 비디오 재생 실패로 대체 영상을 재생합니다</div>
            </div>
        </div>

        <!-- 카메라 미리보기 -->
        <div class="camera-preview" id="cameraPreview">
            <video id="previewVideo" autoplay muted playsinline></video>
        </div>
        
        <div class="ar-scene-container" style="display: none;">
            <a-scene 
                id="ar-scene"
                mindar-image="imageTargetSrc: #; maxTrack: 1; uiLoading: no; uiScanning: no; uiError: no;"
                color-space="sRGB" 
                renderer="colorManagement: true, physicallyCorrectLights, antialias: true, alpha: true"
                vr-mode-ui="enabled: false" 
                device-orientation-permission-ui="enabled: false"
                background="color: transparent"
                embedded
            >
            <a-assets>
                <video id="ar-video" 
                       preload="auto" 
                       loop="true" 
                       muted="true"
                       webkit-playsinline="true" 
                       playsinline="true">
                </video>
                <img id="ar-target-image" crossorigin="anonymous" />
            </a-assets>

            <a-entity id="ar-target" mindar-image-target="targetIndex: 0">
                <a-video 
                    src="#ar-video" 
                    position="0 0 0.1" 
                    rotation="0 0 0"
                    width="1.77" 
                    height="1"
                    material="transparent: false; alphaTest: 0; shader: flat; side: double"
                    visible="false"
                    id="ar-video-plane">
                </a-video>
                
                <!-- 유튜브 폴백을 위한 iframe 플레인 -->
                <a-plane 
                    id="youtube-fallback"
                    width="1.77" 
                    height="1" 
                    position="0 0 0.05"
                    material="color: #000; opacity: 0.9"
                    visible="false">
                </a-plane>
                
                <a-text
                    id="fallback-text"
                    value="📺 유튜브 영상 재생 중\n터치해서 보기"
                    position="0 0 0.15"
                    align="center"
                    color="#ff6b35"
                    font="kelsonsans"
                    scale="0.3 0.3 0.3"
                    visible="false">
                </a-text>
                
                <!-- 디버그용 표시기 -->
                <a-box
                    id="debug-indicator"
                    width="0.1"
                    height="0.1"
                    depth="0.1"
                    position="0 0 0.2"
                    material="color: #ff0000"
                    visible="false">
                </a-box>
                
                <a-plane 
                    width="1.77" 
                    height="1" 
                    position="0 0 0"
                    material="color: #ff6b35; opacity: 0.1; transparent: true"
                    visible="false"
                    id="ar-overlay">
                </a-plane>
            </a-entity>

            <a-entity camera look-controls="enabled: true" wasd-controls="enabled: false"></a-entity>
        </a-scene>
        </div>
    </div>

    <script>
        let currentMode = 'create';
        let uploadedVideo = null;
        let processedVideo = null;
        let extractedFrame = null;
        let arTargetData = null;
        let userInteracted = false;
        let videoElement = null;
        let isPlaying = false;
        let startTime = 0;
        let endTime = 15;
        let videoDuration = 0;
        let scanTimeout = null;
        let videoLoadFailed = false;

        // 유튜브 폴백 URL
        const FALLBACK_YOUTUBE_URL = 'https://www.youtube.com/watch?v=MX_UceuxveA';
        const YOUTUBE_EMBED_URL = 'https://www.youtube.com/embed/MX_UceuxveA';

        // 모드 전환
        function switchMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.create-mode, .scan-mode').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`.${mode}-mode`).classList.add('active');
        }

        // 비디오 업로드 핸들링
        document.getElementById('videoInput').addEventListener('change', handleVideoUpload);
        setupDragDrop();

        function setupDragDrop() {
            const uploadArea = document.querySelector('.upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('video/')) {
                    handleVideoFile(files[0]);
                }
            });
        }

        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (file) handleVideoFile(file);
        }

        async function handleVideoFile(file) {
            uploadedVideo = file;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const preview = document.getElementById('videoPreview');
                preview.innerHTML = `
                    <video src="${e.target.result}" class="preview-video" controls muted></video>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
                        ✅ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)
                    </div>
                `;
                
                document.getElementById('step1').classList.add('active');
                
                await initVideoEditor(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        async function initVideoEditor(videoSrc) {
            const videoEditor = document.getElementById('videoEditor');
            const editVideo = document.getElementById('editVideo');
            const currentTimeSlider = document.getElementById('currentTimeSlider');
            
            videoEditor.style.display = 'block';
            editVideo.src = videoSrc;
            videoElement = editVideo;
            
            await new Promise((resolve) => {
                editVideo.onloadedmetadata = () => {
                    videoDuration = editVideo.duration;
                    endTime = Math.min(15, videoDuration);
                    
                    currentTimeSlider.max = videoDuration;
                    
                    updateTimeDisplays();
                    updateRangeVisualizer();
                    resolve();
                };
            });
            
            currentTimeSlider.addEventListener('input', (e) => {
                editVideo.currentTime = parseFloat(e.target.value);
                updateTimeDisplays();
            });
            
            editVideo.addEventListener('timeupdate', () => {
                currentTimeSlider.value = editVideo.currentTime;
                updateTimeDisplays();
            });
        }

        function playPauseVideo() {
            if (!videoElement) return;
            
            if (isPlaying) {
                videoElement.pause();
                document.querySelector('.video-controls button').textContent = '▶️';
            } else {
                videoElement.play();
                document.querySelector('.video-controls button').textContent = '⏸️';
            }
            isPlaying = !isPlaying;
        }

        function setStartTime() {
            if (!videoElement) return;
            
            startTime = videoElement.currentTime;
            
            if (endTime <= startTime) {
                endTime = Math.min(startTime + 15, videoDuration);
            }
            
            if (endTime - startTime > 15) {
                endTime = startTime + 15;
                if (endTime > videoDuration) {
                    endTime = videoDuration;
                    startTime = Math.max(0, endTime - 15);
                }
            }
            
            updateTimeDisplays();
            updateRangeVisualizer();
        }

        function setEndTime() {
            if (!videoElement) return;
            
            endTime = videoElement.currentTime;
            
            if (startTime >= endTime) {
                startTime = Math.max(0, endTime - 15);
            }
            
            if (endTime - startTime > 15) {
                startTime = endTime - 15;
                if (startTime < 0) {
                    startTime = 0;
                    endTime = Math.min(15, videoDuration);
                }
            }
            
            updateTimeDisplays();
            updateRangeVisualizer();
        }

        function updateTimeDisplays() {
            if (!videoElement) return;
            
            const currentTime = videoElement.currentTime;
            const selectedDuration = endTime - startTime;
            
            document.getElementById('currentTimeDisplay').textContent = formatTime(currentTime);
            document.getElementById('startTimeDisplay').textContent = formatTime(startTime);
            document.getElementById('endTimeDisplay').textContent = formatTime(endTime);
            document.getElementById('selectedDuration').textContent = formatTime(selectedDuration);
            
            const durationInfo = document.getElementById('durationInfo');
            if (selectedDuration > 15) {
                durationInfo.style.background = 'rgba(244, 67, 54, 0.1)';
                durationInfo.style.borderColor = 'rgba(244, 67, 54, 0.3)';
            } else {
                durationInfo.style.background = 'rgba(255, 193, 7, 0.1)';
                durationInfo.style.borderColor = 'rgba(255, 193, 7, 0.3)';
            }
        }

        function updateRangeVisualizer() {
            const rangeSelected = document.getElementById('rangeSelected');
            const startPercent = (startTime / videoDuration) * 100;
            const widthPercent = ((endTime - startTime) / videoDuration) * 100;
            
            rangeSelected.style.left = startPercent + '%';
            rangeSelected.style.width = widthPercent + '%';
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        async function processVideo() {
            const progressDiv = document.getElementById('frameExtractionInfo');
            progressDiv.innerHTML = `
                <div class="frame-extraction-info">
                    <div class="spinner"></div>
                    선택된 구간 (${formatTime(startTime)} - ${formatTime(endTime)})을 처리하고 있습니다...
                </div>
            `;
            
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = 640;
                canvas.height = Math.round((640 * videoElement.videoHeight) / videoElement.videoWidth);
                
                const stream = canvas.captureStream(30);
                const chunks = [];
                
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 1000000
                });
                
                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                
                const recordingPromise = new Promise((resolve) => {
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'video/webm' });
                        resolve(blob);
                    };
                });
                
                mediaRecorder.start();
                
                let currentRecordTime = 0;
                const frameInterval = 1000 / 30;
                
                const drawFrame = () => {
                    const videoTime = startTime + currentRecordTime;
                    
                    if (videoTime >= endTime) {
                        mediaRecorder.stop();
                        return;
                    }
                    
                    videoElement.currentTime = videoTime;
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    currentRecordTime += frameInterval / 1000;
                    setTimeout(drawFrame, frameInterval);
                };
                
                videoElement.currentTime = startTime;
                await new Promise(resolve => videoElement.onseeked = resolve);
                drawFrame();
                
                processedVideo = await recordingPromise;
                
                await extractFirstFrame();
                
                progressDiv.innerHTML = `
                    <div class="frame-extraction-info">
                        <div class="check-icon">✅</div>
                        <div style="margin: 10px 0; font-weight: 600;">비디오 처리 완료!</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 10px;">
                            ${formatTime(endTime - startTime)} 길이의 최적화된 비디오가 생성되었습니다
                        </div>
                        <img src="${extractedFrame}" class="extracted-frame" alt="추출된 프레임">
                    </div>
                `;
                
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('step2').classList.add('active');
                
            } catch (error) {
                progressDiv.innerHTML = `
                    <div class="frame-extraction-info" style="background: rgba(255,0,0,0.1); border-color: rgba(255,0,0,0.3);">
                        ❌ 비디오 처리 실패: ${error.message}
                    </div>
                `;
            }
        }

        async function extractFirstFrame() {
            try {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(processedVideo);
                video.muted = true;

                await new Promise((resolve, reject) => {
                    video.onloadeddata = resolve;
                    video.onerror = reject;
                });

                video.currentTime = 0.1;

                await new Promise((resolve) => {
                    video.onseeked = resolve;
                });

                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = Math.round((400 * video.videoHeight) / video.videoWidth);
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                extractedFrame = canvas.toDataURL('image/png');
                
            } catch (error) {
                throw new Error('프레임 추출 실패: ' + error.message);
            }
        }

        async function generateARImage() {
            const progressDiv = document.getElementById('generateProgress');
            const resultDiv = document.getElementById('generateResult');
            
            progressDiv.innerHTML = `
                <div class="progress">
                    <div class="spinner"></div>
                    특수 AR 마커 이미지 생성 중...
                </div>
            `;

            try {
                console.log('🎯 특수 AR 마커 생성 프로세스 시작');
                
                // 입력 데이터 검증
                if (!extractedFrame) {
                    throw new Error('추출된 프레임이 없습니다. 먼저 비디오를 처리해주세요.');
                }
                
                if (!processedVideo) {
                    throw new Error('처리된 비디오가 없습니다. 먼저 비디오를 업로드하고 처리해주세요.');
                }
                
                // 특수 마커가 포함된 AR 이미지 생성
                const specialARImageDataURL = await generateSpecialARMarker(extractedFrame);
                
                if (!specialARImageDataURL) {
                    throw new Error('특수 마커 이미지 생성 실패');
                }
                
                console.log('📹 비디오 데이터 변환 시작');
                const videoBase64 = await blobToBase64(processedVideo);
                
                const arId = 'ar_' + Date.now();
                arTargetData = {
                    id: arId,
                    videoData: videoBase64,
                    targetImage: specialARImageDataURL, // 특수 마커 이미지 사용
                    originalFrame: extractedFrame, // 원본 프레임 별도 저장
                    fileName: uploadedVideo.name,
                    duration: endTime - startTime,
                    createdAt: new Date().toISOString(),
                    fallbackUrl: FALLBACK_YOUTUBE_URL,
                    type: 'ar_image_video',
                    hasSpecialMarkers: true,
                    markerType: 'advanced_tracking'
                };
                
                localStorage.setItem('arData_' + arId, JSON.stringify(arTargetData));
                
                progressDiv.innerHTML = '';
                resultDiv.innerHTML = `
                    <div class="ar-result">
                        <div class="check-icon">✅</div>
                        <div style="margin: 10px 0; font-weight: 600;">특수 AR 마커 이미지 생성 완료!</div>
                        
                        <div class="target-image-container">
                            <div style="color: #333; font-weight: 600; margin-bottom: 10px;">🎯 특수 AR 마커 이미지</div>
                            <img src="${specialARImageDataURL}" class="target-image" alt="Special AR Marker Image">
                            <div style="color: #666; font-size: 12px; margin-top: 10px;">
                                ID: ${arId}<br>
                                길이: ${formatTime(arTargetData.duration)}<br>
                                마커: 정밀 추적 시스템<br>
                                폴백: YouTube 영상
                            </div>
                        </div>
                        
                        <div class="marker-features" style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; padding: 12px; margin: 15px 0;">
                            <div style="font-weight: 600; color: #4CAF50; margin-bottom: 8px;">🔍 포함된 특수 마커:</div>
                            <ul style="font-size: 12px; line-height: 1.4; margin: 0; padding-left: 20px;">
                                <li>📐 4개 코너 마커: 방향별 고유 패턴으로 정확한 위치 추적</li>
                                <li>📹 비디오 영역 마커: YouTube 재생 위치 정확히 정의</li>
                                <li>🎯 중앙 추적 마커: 실시간 위치 및 각도 감지</li>
                                <li>📏 크기/회전 마커: 동적 스케일링 및 회전 보정</li>
                                <li>🔢 디지털 시그니처: 고유 식별 바코드</li>
                            </ul>
                        </div>
                        
                        <div style="font-size: 13px; opacity: 0.9; margin: 15px 0;">
                            📱 특수 마커를 스캔하면 정확한 위치에 AR 비디오가 재생됩니다<br>
                            🖨️ 인쇄하거나 다른 화면에 표시해서 사용하세요<br>
                            🎯 향상된 추적 정확도로 안정적인 AR 경험을 제공합니다
                        </div>
                        
                        <div class="download-section">
                            <button class="download-btn" onclick="downloadARImage('${arId}')">
                                💾 특수 마커 저장
                            </button>
                            <button class="download-btn share-btn" onclick="shareARImage('${arId}')">
                                📤 공유하기
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                progressDiv.innerHTML = '';
                resultDiv.innerHTML = `
                    <div class="progress" style="background: rgba(255,0,0,0.2);">
                        ❌ 특수 AR 마커 생성 실패: ${error.message}
                    </div>
                `;
            }
        }

        async function generateSpecialARMarker(originalFrameDataURL) {
            return new Promise(async (resolve, reject) => {
                try {
                    console.log('🎯 특수 AR 마커 생성 시작');
                    
                    // 입력 데이터 검증
                    if (!originalFrameDataURL || typeof originalFrameDataURL !== 'string') {
                        throw new Error('유효하지 않은 이미지 데이터');
                    }
                    
                    // 캔버스 생성 및 검증
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    if (!ctx) {
                        throw new Error('캔버스 컨텍스트 생성 실패');
                    }
                    
                    // AR 인식을 위한 최적 크기 설정
                    const arSize = 800;
                    canvas.width = arSize;
                    canvas.height = arSize;
                    
                    console.log('📐 캔버스 크기 설정:', arSize, 'x', arSize);
                    
                    // 흰색 배경
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, arSize, arSize);
                    
                    // 원본 이미지 로드
                    const img = new Image();
                    
                    // 이미지 로드 실패 타임아웃 설정
                    const timeoutId = setTimeout(() => {
                        reject(new Error('이미지 로드 시간 초과 (10초)'));
                    }, 10000);
                    
                    img.onload = () => {
                        try {
                            clearTimeout(timeoutId);
                            console.log('📷 원본 이미지 로드 완료:', img.width, 'x', img.height);
                            
                            // 이미지 크기 검증
                            if (img.width === 0 || img.height === 0) {
                                throw new Error('유효하지 않은 이미지 크기');
                            }
                            
                            // 이미지 크기 계산 (정사각형으로 크롭)
                            const imgSize = Math.min(img.width, img.height);
                            const cropX = (img.width - imgSize) / 2;
                            const cropY = (img.height - imgSize) / 2;
                            
                            console.log('🔄 이미지 크롭 정보:', { imgSize, cropX, cropY });
                            
                            // 여백을 둔 이미지 크기 계산 (특수 마커를 위한 공간 확보)
                            const imageMargin = 120;
                            const imageSize = arSize - (imageMargin * 2);
                            
                            // 중앙 이미지 그리기
                            ctx.drawImage(
                                img, 
                                cropX, cropY, imgSize, imgSize,
                                imageMargin, imageMargin, imageSize, imageSize
                            );
                            
                            console.log('🖼️ 중앙 이미지 그리기 완료');
                        
                        // === 특수 AR 마커 시스템 ===
                        
                        // 1. 메인 테두리 (이중 테두리로 인식률 향상)
                        ctx.strokeStyle = '#000000';
                        ctx.lineWidth = 10;
                        ctx.strokeRect(imageMargin - 10, imageMargin - 10, imageSize + 20, imageSize + 20);
                        
                        ctx.strokeStyle = '#ff6b35';
                        ctx.lineWidth = 6;
                        ctx.strokeRect(imageMargin - 20, imageMargin - 20, imageSize + 40, imageSize + 40);
                        
                        // 2. 정밀 추적용 코너 마커 (각기 다른 패턴)
                        const cornerSize = 80;
                        const cornerMargin = 20;
                        const corners = [
                            [cornerMargin, cornerMargin],
                            [arSize - cornerMargin - cornerSize, cornerMargin],
                            [cornerMargin, arSize - cornerMargin - cornerSize],
                            [arSize - cornerMargin - cornerSize, arSize - cornerMargin - cornerSize]
                        ];
                        
                        corners.forEach(([x, y], index) => {
                            // 코너 마커 배경
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(x, y, cornerSize, cornerSize);
                            
                            ctx.strokeStyle = '#000000';
                            ctx.lineWidth = 4;
                            ctx.strokeRect(x, y, cornerSize, cornerSize);
                            
                            ctx.fillStyle = '#000000';
                            
                            switch(index) {
                                case 0: // 좌상단 - 격자 패턴
                                    for(let i = 0; i < 3; i++) {
                                        for(let j = 0; j < 3; j++) {
                                            if((i + j) % 2 === 0) {
                                                ctx.fillRect(x + 15 + i * 16, y + 15 + j * 16, 12, 12);
                                            }
                                        }
                                    }
                                    break;
                                case 1: // 우상단 - 동심원 패턴
                                    ctx.beginPath();
                                    ctx.arc(x + cornerSize/2, y + cornerSize/2, 25, 0, Math.PI * 2);
                                    ctx.fill();
                                    ctx.fillStyle = '#ffffff';
                                    ctx.beginPath();
                                    ctx.arc(x + cornerSize/2, y + cornerSize/2, 15, 0, Math.PI * 2);
                                    ctx.fill();
                                    ctx.fillStyle = '#000000';
                                    ctx.beginPath();
                                    ctx.arc(x + cornerSize/2, y + cornerSize/2, 8, 0, Math.PI * 2);
                                    ctx.fill();
                                    break;
                                case 2: // 좌하단 - 삼각형 패턴
                                    ctx.beginPath();
                                    ctx.moveTo(x + cornerSize/2, y + 15);
                                    ctx.lineTo(x + 15, y + cornerSize - 15);
                                    ctx.lineTo(x + cornerSize - 15, y + cornerSize - 15);
                                    ctx.closePath();
                                    ctx.fill();
                                    break;
                                case 3: // 우하단 - 십자 패턴
                                    ctx.fillRect(x + cornerSize/2 - 8, y + 15, 16, cornerSize - 30);
                                    ctx.fillRect(x + 15, y + cornerSize/2 - 8, cornerSize - 30, 16);
                                    break;
                            }
                        });
                        
                        // 3. 중앙 위치 식별을 위한 특수 마커들
                        
                        // 상단 중앙 마커 (YouTube 아이콘)
                        const topMarkerX = arSize / 2 - 25;
                        const topMarkerY = 30;
                        ctx.fillStyle = '#ff0000';
                        ctx.fillRect(topMarkerX, topMarkerY, 50, 35);
                        ctx.fillStyle = '#ffffff';
                        ctx.beginPath();
                        ctx.moveTo(topMarkerX + 15, topMarkerY + 10);
                        ctx.lineTo(topMarkerX + 15, topMarkerY + 25);
                        ctx.lineTo(topMarkerX + 35, topMarkerY + 17.5);
                        ctx.closePath();
                        ctx.fill();
                        
                        // 하단 중앙 마커 (재생 컨트롤)
                        const bottomMarkerX = arSize / 2 - 30;
                        const bottomMarkerY = arSize - 65;
                        ctx.fillStyle = '#4CAF50';
                        ctx.fillRect(bottomMarkerX, bottomMarkerY, 60, 35);
                        ctx.fillStyle = '#ffffff';
                        ctx.beginPath();
                        ctx.moveTo(bottomMarkerX + 20, bottomMarkerY + 8);
                        ctx.lineTo(bottomMarkerX + 20, bottomMarkerY + 27);
                        ctx.lineTo(bottomMarkerX + 35, bottomMarkerY + 17.5);
                        ctx.closePath();
                        ctx.fill();
                        ctx.fillRect(bottomMarkerX + 40, bottomMarkerY + 10, 6, 15);
                        ctx.fillRect(bottomMarkerX + 50, bottomMarkerY + 10, 6, 15);
                        
                        // 4. 측면 방향 마커들
                        
                        // 좌측 마커 (크기 스케일)
                        const leftMarkerX = 10;
                        const leftMarkerY = arSize / 2 - 40;
                        for(let i = 0; i < 5; i++) {
                            ctx.fillStyle = i % 2 === 0 ? '#000000' : '#ffffff';
                            ctx.fillRect(leftMarkerX, leftMarkerY + i * 16, 30, 16);
                        }
                        
                        // 우측 마커 (회전 각도)
                        const rightMarkerX = arSize - 40;
                        const rightMarkerY = arSize / 2 - 40;
                        ctx.fillStyle = '#000000';
                        for(let i = 0; i < 5; i++) {
                            const size = 10 + i * 3;
                            ctx.fillRect(rightMarkerX + (30 - size) / 2, rightMarkerY + i * 16, size, 14);
                        }
                        
                        // 5. 비디오 재생 영역 마커 (정확한 YouTube 재생 위치 정의)
                        const videoAreaMarkers = [
                            [imageMargin + 20, imageMargin + 20],
                            [imageMargin + imageSize - 40, imageMargin + 20],
                            [imageMargin + 20, imageMargin + imageSize - 40],
                            [imageMargin + imageSize - 40, imageMargin + imageSize - 40]
                        ];
                        
                        videoAreaMarkers.forEach(([x, y]) => {
                            ctx.fillStyle = '#ff6b35';
                            ctx.beginPath();
                            ctx.arc(x + 10, y + 10, 8, 0, Math.PI * 2);
                            ctx.fill();
                            
                            ctx.fillStyle = '#ffffff';
                            ctx.beginPath();
                            ctx.arc(x + 10, y + 10, 4, 0, Math.PI * 2);
                            ctx.fill();
                        });
                        
                        // 6. 디지털 시그니처 (고유 식별)
                        const signatureY = arSize - 30;
                        const signatureStartX = 100;
                        const barcodePattern = [3, 1, 4, 1, 5, 2, 6, 1, 3, 2, 4, 1];
                        let currentX = signatureStartX;
                        
                        barcodePattern.forEach((width, index) => {
                            ctx.fillStyle = index % 2 === 0 ? '#000000' : '#ffffff';
                            ctx.fillRect(currentX, signatureY, width * 4, 20);
                            currentX += width * 4;
                        });
                        
                            // 완성된 특수 마커 이미지 반환
                            const specialMarkerDataURL = canvas.toDataURL('image/png', 0.95);
                            console.log('✅ 특수 마커 생성 완료');
                            resolve(specialMarkerDataURL);
                            
                        } catch (drawError) {
                            clearTimeout(timeoutId);
                            console.error('🚫 마커 그리기 오류:', drawError);
                            reject(new Error('특수 마커 그리기 실패: ' + drawError.message));
                        }
                    };
                    
                    img.onerror = (errorEvent) => {
                        clearTimeout(timeoutId);
                        console.error('🚫 이미지 로드 오류:', errorEvent);
                        reject(new Error('원본 이미지 로드 실패'));
                    };
                    
                    // CORS 설정
                    img.crossOrigin = 'anonymous';
                    
                    // 이미지 로드 시작
                    console.log('🔄 이미지 로드 시작...');
                    img.src = originalFrameDataURL;
                    
                } catch (error) {
                    console.error('🚫 특수 마커 생성 오류:', error);
                    reject(new Error('특수 마커 생성 실패: ' + error.message));
                }
            });
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function downloadARImage(arId) {
            try {
                const arData = JSON.parse(localStorage.getItem(`arData_${arId}`));
                
                if (arData && arData.targetImage) {
                    // 특수 마커 이미지 다운로드
                    const link = document.createElement('a');
                    const fileName = arData.hasSpecialMarkers ? 
                        `Special_AR_Marker_${arId}.png` : 
                        `AR_Target_${arId}.png`;
                    
                    link.download = fileName;
                    link.href = arData.targetImage;
                    link.click();
                    
                    console.log('📥 AR 이미지 다운로드:', fileName);
                } else if (extractedFrame) {
                    // 폴백: 원본 프레임 다운로드
                    const link = document.createElement('a');
                    link.download = `AR_Frame_${arId}.png`;
                    link.href = extractedFrame;
                    link.click();
                    
                    console.log('📥 원본 프레임 다운로드:', `AR_Frame_${arId}.png`);
                } else {
                    alert('다운로드할 이미지가 없습니다.');
                }
            } catch (error) {
                console.error('다운로드 오류:', error);
                alert('이미지 다운로드 중 오류가 발생했습니다: ' + error.message);
            }
        }

        function shareARImage(arId) {
            const shareUrl = `${window.location.origin}${window.location.pathname}?ar=${arId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'AR 타겟 이미지',
                    text: 'AR 비디오를 체험해보세요!',
                    url: shareUrl
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('공유 링크가 클립보드에 복사되었습니다!');
                }).catch(() => {
                    prompt('아래 링크를 복사하세요:', shareUrl);
                });
            }
        }

        async function startFullscreenScan() {
            console.log('전체 화면 스캔 시작');
            
            const fullscreenScanner = document.getElementById('fullscreenScanner');
            const scanStatusFullscreen = document.getElementById('scanStatusFullscreen');
            const scanInstructionsFullscreen = document.getElementById('scanInstructionsFullscreen');
            const scannerVideoFullscreen = document.getElementById('scannerVideoFullscreen');
            
            // 전체 화면 스캐너 표시
            fullscreenScanner.classList.add('active');
            fullscreenScanner.style.display = 'block';
            scanStatusFullscreen.textContent = '카메라 권한을 요청하고 있습니다...';
            
            // 페이지 스크롤 방지
            document.body.style.overflow = 'hidden';
            
            try {
                let stream = null;
                
                try {
                    // 1차 시도: 후면 카메라 (환경)
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1920, min: 1280 },
                            height: { ideal: 1080, min: 720 }
                        } 
                    });
                } catch (envError) {
                    console.warn('후면 카메라 접근 실패:', envError.message);
                    
                    try {
                        // 2차 시도: 전면 카메라
                        scanStatusFullscreen.textContent = '전면 카메라로 시도 중...';
                        
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: { ideal: 'user' },
                                width: { ideal: 1920, min: 1280 },
                                height: { ideal: 1080, min: 720 }
                            } 
                        });
                    } catch (userError) {
                        console.warn('전면 카메라 접근 실패:', userError.message);
                        
                        try {
                            // 3차 시도: 기본 비디오
                            scanStatusFullscreen.textContent = '기본 카메라로 시도 중...';
                            
                            stream = await navigator.mediaDevices.getUserMedia({ 
                                video: {
                                    width: { ideal: 1280, min: 640 },
                                    height: { ideal: 720, min: 480 }
                                }
                            });
                        } catch (basicError) {
                            console.warn('기본 카메라 접근 실패:', basicError.message);
                            
                            try {
                                // 4차 시도: 최소 설정
                                scanStatusFullscreen.textContent = '최소 설정으로 시도 중...';
                                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                            } catch (finalError) {
                                throw new Error(`모든 카메라 접근 시도 실패: ${finalError.message}`);
                            }
                        }
                    }
                }
                
                if (stream) {
                    scannerVideoFullscreen.srcObject = stream;
                    
                    // 비디오 스트림이 실제로 시작되었는지 확인
                    await new Promise((resolve, reject) => {
                        scannerVideoFullscreen.onloadedmetadata = () => {
                            scannerVideoFullscreen.play().then(resolve).catch(reject);
                        };
                        scannerVideoFullscreen.onerror = reject;
                        
                        // 5초 타임아웃
                        setTimeout(() => reject(new Error('비디오 시작 시간 초과')), 5000);
                    });
                    
                    // 성공 시 안내 메시지 업데이트
                    scanStatusFullscreen.textContent = '📷 스캔 준비 완료';
                    scanInstructionsFullscreen.innerHTML = `
                        생성된 AR 이미지를 프레임 안에 맞춰주세요<br>
                        <span style="opacity: 0.7;">3초 후 자동 감지</span>
                    `;
                    
                    // 3초 후 자동 감지
                    scanTimeout = setTimeout(() => {
                        console.log('전체 화면에서 3초 자동 감지 시작');
                        attemptImageDetectionFullscreen();
                    }, 3000);
                } else {
                    throw new Error('카메라 스트림을 가져올 수 없습니다');
                }
                
            } catch (error) {
                console.error('전체 화면 카메라 접근 실패:', error);
                showFullscreenScanError(error);
            }
        }

        async function startImageScan() {
            try {
                console.log('🔍 이미지 스캔 시작 - YouTube 오버레이 숨김');
                
                // AR 이미지 인식 전까지 YouTube 오버레이 완전히 숨김
                hideYouTubeOverlay();
                
                const container = document.getElementById('scannerContainer');
                const video = document.getElementById('scannerVideo');
                const btn = document.getElementById('startScanBtn');
                
                btn.style.display = 'none';
                container.style.display = 'block';
                
                // 카메라 권한 및 접근 상태 표시
                document.getElementById('scan-instructions').innerHTML = `
                    카메라 권한을 요청하고 있습니다...<br>
                    <span style="opacity: 0.7;">브라우저에서 허용을 눌러주세요</span>
                `;
                
                let stream = null;
                
                try {
                    // 1차 시도: 후면 카메라 (환경)
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 }
                        } 
                    });
                } catch (envError) {
                    console.warn('후면 카메라 접근 실패:', envError.message);
                    
                    try {
                        // 2차 시도: 전면 카메라
                        document.getElementById('scan-instructions').innerHTML = `
                            후면 카메라 접근 실패. 전면 카메라로 시도 중...<br>
                            <span style="opacity: 0.7;">전면 카메라로 스캔하세요</span>
                        `;
                        
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: { ideal: 'user' },
                                width: { ideal: 1280, min: 640 },
                                height: { ideal: 720, min: 480 }
                            } 
                        });
                    } catch (userError) {
                        console.warn('전면 카메라 접근 실패:', userError.message);
                        
                        try {
                            // 3차 시도: 기본 비디오 (카메라 지정 없음)
                            document.getElementById('scan-instructions').innerHTML = `
                                기본 카메라로 시도 중...<br>
                                <span style="opacity: 0.7;">사용 가능한 카메라를 찾고 있습니다</span>
                            `;
                            
                            stream = await navigator.mediaDevices.getUserMedia({ 
                                video: {
                                    width: { ideal: 640, min: 320 },
                                    height: { ideal: 480, min: 240 }
                                }
                            });
                        } catch (basicError) {
                            console.warn('기본 카메라 접근 실패:', basicError.message);
                            
                            try {
                                // 4차 시도: 최소 설정
                                document.getElementById('scan-instructions').innerHTML = `
                                    최소 설정으로 시도 중...<br>
                                    <span style="opacity: 0.7;">카메라를 활성화하고 있습니다</span>
                                `;
                                
                                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                            } catch (finalError) {
                                throw new Error(`모든 카메라 접근 시도 실패: ${finalError.message}`);
                            }
                        }
                    }
                }
                
                if (stream) {
                    video.srcObject = stream;
                    
                    // 비디오 스트림이 실제로 시작되었는지 확인
                    await new Promise((resolve, reject) => {
                        video.onloadedmetadata = () => {
                            video.play().then(resolve).catch(reject);
                        };
                        video.onerror = reject;
                        
                        // 5초 타임아웃
                        setTimeout(() => reject(new Error('비디오 시작 시간 초과')), 5000);
                    });
                    
                    // 성공 시 안내 메시지 업데이트
                    document.getElementById('scan-instructions').innerHTML = `
                        생성된 AR 이미지를 프레임 안에 맞춰주세요<br>
                        <span style="opacity: 0.7;">3초 후 자동 감지</span>
                    `;
                    
                    // 3초 후 자동 감지
                    scanTimeout = setTimeout(() => {
                        console.log('3초 자동 감지 시작');
                        attemptImageDetection();
                    }, 3000);
                } else {
                    throw new Error('카메라 스트림을 가져올 수 없습니다');
                }
                
            } catch (error) {
                console.error('카메라 접근 전체 실패:', error);
                
                // 사용자에게 상세한 안내 제공
                let errorMessage = '카메라 접근 실패';
                let helpMessage = '';
                
                if (error.name === 'NotAllowedError' || error.message.includes('Permission denied')) {
                    errorMessage = '카메라 권한이 거부되었습니다';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">📱 해결 방법:</div>
                            <div style="text-align: left;">
                                • 브라우저 주소창의 🔒 아이콘 클릭<br>
                                • 카메라 권한을 "허용"으로 변경<br>
                                • 페이지 새로고침 후 다시 시도<br>
                                • 또는 브라우저 설정에서 카메라 권한 확인
                            </div>
                        </div>
                    `;
                } else if (error.name === 'NotFoundError' || error.message.includes('Requested device not found')) {
                    errorMessage = '카메라를 찾을 수 없습니다';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">📱 해결 방법:</div>
                            <div style="text-align: left;">
                                • 다른 카메라 앱이 실행중인지 확인<br>
                                • 브라우저를 완전히 종료 후 다시 실행<br>
                                • 기기 재시작 후 다시 시도<br>
                                • 다른 브라우저에서 시도
                            </div>
                        </div>
                    `;
                } else if (error.name === 'NotSupportedError' || error.message.includes('not supported')) {
                    errorMessage = '이 브라우저는 카메라를 지원하지 않습니다';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">📱 해결 방법:</div>
                            <div style="text-align: left;">
                                • Chrome, Safari, Firefox 등 최신 브라우저 사용<br>
                                • HTTPS 연결인지 확인 (http:// → https://)<br>
                                • 브라우저 업데이트<br>
                                • 앱 내 브라우저가 아닌 기본 브라우저 사용
                            </div>
                        </div>
                    `;
                } else if (error.name === 'OverconstrainedError' || error.message.includes('Could not start video source')) {
                    errorMessage = '카메라 설정을 조정할 수 없습니다';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">📱 해결 방법:</div>
                            <div style="text-align: left;">
                                • 다른 앱에서 카메라 사용 중인지 확인<br>
                                • 카메라 앱 강제 종료 후 다시 시도<br>
                                • 기기 재시작<br>
                                • 아래 "카메라 없이 체험" 버튼 사용
                            </div>
                        </div>
                    `;
                }
                
                // 오류 UI 표시
                document.getElementById('scannerContainer').style.display = 'none';
                document.getElementById('startScanBtn').style.display = 'none';
                
                const container = document.getElementById('scannerContainer').parentElement;
                const errorDiv = document.createElement('div');
                errorDiv.className = 'scan-error';
                errorDiv.style.cssText = `
                    background: rgba(244, 67, 54, 0.1);
                    border: 1px solid rgba(244, 67, 54, 0.3);
                    border-radius: 10px;
                    padding: 20px;
                    margin: 15px 0;
                    text-align: center;
                `;
                
                errorDiv.innerHTML = `
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #ff6b35;">
                        ❌ ${errorMessage}
                    </div>
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 15px;">
                        ${error.message}
                    </div>
                    ${helpMessage}
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn" onclick="retryCamera()" style="flex: 1; font-size: 12px; padding: 8px 16px;">
                            🔄 다시 시도
                        </button>
                        <button class="btn" onclick="simulateImageDetection()" style="flex: 1; font-size: 12px; padding: 8px 16px; background: #4CAF50;">
                            📷 카메라 없이 체험
                        </button>
                    </div>
                `;
                
                // 기존 오류 메시지 제거
                const existingError = container.querySelector('.scan-error');
                if (existingError) {
                    existingError.remove();
                }
                
                container.appendChild(errorDiv);
            }
        }

        function retryCamera() {
            // 오류 메시지 제거
            const errorDiv = document.querySelector('.scan-error');
            if (errorDiv) {
                errorDiv.remove();
            }
            
            // 스캔 버튼 다시 표시
            document.getElementById('startScanBtn').style.display = 'block';
        }

        function attemptImageDetection() {
            const arKeys = Object.keys(localStorage).filter(key => key.startsWith('arData_'));
            if (arKeys.length === 0) {
                alert('스캔할 AR 이미지가 없습니다. 먼저 AR 이미지를 생성해주세요.');
                return;
            }
            
            console.log('이미지 감지 시도, 저장된 AR 데이터:', arKeys.length + '개');
            
            // 실제 이미지 인식 시도
            attemptRealImageDetection(arKeys);
        }

        function simulateImageDetection() {
            // 이 함수는 "카메라 없이 체험" 버튼용
            console.log('수동 시뮬레이션 감지 시작');
            attemptImageDetection();
        }

        function attemptImageDetectionFullscreen() {
            const arKeys = Object.keys(localStorage).filter(key => key.startsWith('arData_'));
            if (arKeys.length === 0) {
                document.getElementById('scanInstructionsFullscreen').innerHTML = `
                    ❌ 스캔할 AR 이미지가 없습니다<br>
                    <span style="color: #ff6b35;">먼저 AR 이미지를 생성해주세요</span>
                `;
                return;
            }
            
            console.log('전체 화면에서 이미지 감지 시도, 저장된 AR 데이터:', arKeys.length + '개');
            
            // 전체 화면에서 실제 이미지 인식 시도
            attemptRealImageDetectionFullscreen(arKeys);
        }

        function attemptRealImageDetectionFullscreen(arKeys) {
            const video = document.getElementById('scannerVideoFullscreen');
            const scanStatusFullscreen = document.getElementById('scanStatusFullscreen');
            const scanInstructionsFullscreen = document.getElementById('scanInstructionsFullscreen');
            const scanFrame = document.querySelector('.scanner-overlay-fullscreen');
            
            if (!video || !video.srcObject) {
                console.log('전체 화면 카메라가 없음, 직접 감지 모드로 실행');
                
                const latestKey = arKeys[arKeys.length - 1];
                const arId = latestKey.replace('arData_', '');
                
                scanInstructionsFullscreen.innerHTML = `
                    🎯 이미지 자동 감지!<br>
                    <span style="color: #4CAF50;">AR 영상을 로딩합니다...</span>
                `;
                
                setTimeout(() => {
                    try {
                        closeFullscreenScan();
                        loadAndPlayARWithPosition(arId, {
                            centerX: 0.5,
                            centerY: 0.5,
                            width: 0.3,
                            height: 0.3
                        });
                    } catch (error) {
                        console.error('AR 로딩 오류:', error);
                        scanInstructionsFullscreen.innerHTML = `
                            <span style="color: #ff6b35;">❌ AR 로딩 실패</span><br>
                            <span style="opacity: 0.8;">다시 시도해주세요</span>
                        `;
                    }
                }, 1000);
                return;
            }

            scanInstructionsFullscreen.innerHTML = `
                <span style="color: #4CAF50;">📸 이미지 스캔 중...</span><br>
                <span style="opacity: 0.8; font-size: 14px;">생성한 AR 이미지를 프레임 안에 맞춰주세요</span>
            `;

            // 스캔 프레임 영역 계산 (고정 중앙 위치 사용)
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const frameSize = 280; // CSS에서 설정한 고정 크기
            
            // 중앙 기준으로 프레임 영역 계산
            const frameX = (viewportWidth - frameSize) / 2 / viewportWidth;
            const frameY = (viewportHeight - frameSize) / 2 / viewportHeight;
            const frameWidth = frameSize / viewportWidth;
            const frameHeight = frameSize / viewportHeight;

            console.log('스캔 프레임 영역 (고정 중앙):', { 
                frameX, frameY, frameWidth, frameHeight,
                viewportWidth, viewportHeight, frameSize 
            });

            // 카메라에서 프레임 캡처 및 분석
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth || 1280;
            canvas.height = video.videoHeight || 720;

            // 프레임 영역만 분석하기 위한 캔버스
            const frameCanvas = document.createElement('canvas');
            const frameCtx = frameCanvas.getContext('2d');
            frameCanvas.width = 300;
            frameCanvas.height = 300;

            let detectionCount = 0;
            const maxDetections = 30; // 3초로 연장

            const detectInterval = setInterval(() => {
                detectionCount++;

                try {
                    // 전체 프레임 캡처
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // 스캔 프레임 영역만 추출
                    const cropX = Math.max(0, Math.floor(frameX * canvas.width));
                    const cropY = Math.max(0, Math.floor(frameY * canvas.height));
                    const cropW = Math.min(canvas.width - cropX, Math.floor(frameWidth * canvas.width));
                    const cropH = Math.min(canvas.height - cropY, Math.floor(frameHeight * canvas.height));
                    
                    // 프레임 영역을 별도 캔버스에 그리기
                    frameCtx.clearRect(0, 0, frameCanvas.width, frameCanvas.height);
                    frameCtx.drawImage(canvas, cropX, cropY, cropW, cropH, 0, 0, frameCanvas.width, frameCanvas.height);
                    
                    const croppedFrame = frameCanvas.toDataURL('image/jpeg', 0.9);

                    // 특수 마커 기반 정밀 인식 시스템
                    let bestMatch = null;
                    let bestScore = 0;

                    arKeys.forEach(key => {
                        const arData = JSON.parse(localStorage.getItem(key));
                        
                        let similarity;
                        
                        // 특수 마커가 있는 경우 고급 인식 사용
                        if (arData.hasSpecialMarkers) {
                            similarity = analyzeSpecialMarkers(croppedFrame, arData.targetImage);
                        } else {
                            // 기본 이미지 비교
                            similarity = compareImages(croppedFrame, arData.targetImage);
                        }

                        if (similarity > bestScore) {
                            bestScore = similarity;
                            bestMatch = {
                                id: key.replace('arData_', ''),
                                score: similarity,
                                data: arData,
                                framePosition: {
                                    x: frameX,
                                    y: frameY,
                                    width: frameWidth,
                                    height: frameHeight,
                                    centerX: frameX + frameWidth / 2,
                                    centerY: frameY + frameHeight / 2
                                },
                                hasSpecialMarkers: arData.hasSpecialMarkers || false
                            };
                        }
                    });

                    console.log(`프레임 영역 분석 ${detectionCount}: 최고 유사도 ${Math.round(bestScore * 100)}%`);

                    // 진행률 표시
                    const progress = Math.round((detectionCount / maxDetections) * 100);
                    scanInstructionsFullscreen.innerHTML = `
                        <span style="color: #4CAF50;">📸 이미지 분석 중... ${progress}%</span><br>
                        <span style="opacity: 0.8; font-size: 14px;">최고 매칭도: ${Math.round(bestScore * 100)}%</span>
                    `;

                    // 특수 마커 기반 정밀 인식 임계값 적용
                    const threshold = bestMatch && bestMatch.hasSpecialMarkers ? 0.8 : 0.7; // 특수 마커는 80% 이상
                    
                    if (bestMatch && bestScore > threshold) {
                        clearInterval(detectInterval);

                        const markerType = bestMatch.hasSpecialMarkers ? '특수 마커' : '일반 이미지';
                        const accuracyLevel = bestScore > 0.9 ? '매우 높음' : bestScore > 0.8 ? '높음' : '보통';
                        
                        scanInstructionsFullscreen.innerHTML = `
                            <span style="color: #4CAF50;">🎯 ${markerType} 인식 성공! (${Math.round(bestScore * 100)}%)</span><br>
                            <span style="opacity: 0.8; color: #2196F3;">정확도: ${accuracyLevel} - 정밀 위치에 AR 영상 로딩 중...</span>
                        `;

                        setTimeout(() => {
                            try {
                                closeFullscreenScan();
                                setTimeout(() => {
                                    loadAndPlayARWithPosition(bestMatch.id, bestMatch.framePosition);
                                }, 200); // 화면 전환 후 약간의 지연
                            } catch (error) {
                                console.error('AR 로딩 오류 (고정확도):', error);
                                showFullscreenScanError(error);
                            }
                        }, 1500);

                    } else if (detectionCount >= maxDetections) {
                        clearInterval(detectInterval);

                        if (bestMatch && bestScore > 0.4) {
                            scanInstructionsFullscreen.innerHTML = `
                                <span style="color: #ff6b35;">📷 부분 매칭 감지 (${Math.round(bestScore * 100)}%)</span><br>
                                <span style="opacity: 0.8;">감지된 위치에 AR 영상을 실행합니다...</span>
                            `;

                            setTimeout(() => {
                                try {
                                    closeFullscreenScan();
                                    setTimeout(() => {
                                        loadAndPlayARWithPosition(bestMatch.id, bestMatch.framePosition);
                                    }, 200);
                                } catch (error) {
                                    console.error('AR 로딩 오류 (부분 매칭):', error);
                                    showFullscreenScanError(error);
                                }
                            }, 1500);
                        } else {
                            scanInstructionsFullscreen.innerHTML = `
                                <span style="color: #ff6b35;">🎯 자동 AR 모드</span><br>
                                <span style="opacity: 0.8;">최신 생성 이미지로 AR을 실행합니다...</span>
                            `;

                            const latestKey = arKeys[arKeys.length - 1];
                            const arId = latestKey.replace('arData_', '');

                            setTimeout(() => {
                                try {
                                    closeFullscreenScan();
                                    setTimeout(() => {
                                        loadAndPlayARWithPosition(arId, {
                                            centerX: 0.5,
                                            centerY: 0.5,
                                            width: 0.3,
                                            height: 0.3
                                        });
                                    }, 200);
                                } catch (error) {
                                    console.error('AR 로딩 오류 (자동 모드):', error);
                                    showFullscreenScanError(error);
                                }
                            }, 1500);
                        }
                    }
                } catch (error) {
                    console.error('전체화면 프레임 분석 오류:', error);
                    clearInterval(detectInterval);

                    scanInstructionsFullscreen.innerHTML = `
                        <span style="color: #4CAF50;">🎯 AR 자동 실행</span><br>
                        <span style="opacity: 0.8;">기본 설정으로 AR 영상을 로딩합니다...</span>
                    `;

                    const latestKey = arKeys[arKeys.length - 1];
                    const arId = latestKey.replace('arData_', '');

                    setTimeout(() => {
                        try {
                            closeFullscreenScan();
                            setTimeout(() => {
                                loadAndPlayARWithPosition(arId, {
                                    centerX: 0.5,
                                    centerY: 0.5,
                                    width: 0.3,
                                    height: 0.3
                                });
                            }, 200);
                        } catch (error) {
                            console.error('AR 로딩 오류 (에러 처리):', error);
                            showFullscreenScanError(error);
                        }
                    }, 1000);
                }

            }, 100);
        }

        function showFullscreenScanError(error) {
            const scanStatusFullscreen = document.getElementById('scanStatusFullscreen');
            const scanInstructionsFullscreen = document.getElementById('scanInstructionsFullscreen');
            
            let errorMessage = '카메라 접근 실패';
            let helpMessage = '';
            
            if (error.name === 'NotAllowedError' || error.message.includes('Permission denied')) {
                errorMessage = '카메라 권한이 거부되었습니다';
                helpMessage = '브라우저 설정에서 카메라 권한을 허용해주세요';
            } else if (error.name === 'NotFoundError') {
                errorMessage = '카메라를 찾을 수 없습니다';
                helpMessage = '다른 앱이 카메라를 사용 중인지 확인해주세요';
            } else {
                errorMessage = '카메라 초기화 실패';
                helpMessage = '브라우저를 새로고침하거나 다른 브라우저를 사용해보세요';
            }
            
            scanStatusFullscreen.textContent = `❌ ${errorMessage}`;
            scanInstructionsFullscreen.innerHTML = `
                ${helpMessage}<br>
                <button class="btn" onclick="closeFullscreenScan()" style="margin-top: 15px; background: #ff6b35; color: white; border: none; padding: 10px 20px; border-radius: 20px;">
                    돌아가기
                </button>
            `;
        }

        function closeFullscreenScan() {
            console.log('전체 화면 스캔 닫기');
            
            try {
                const fullscreenScanner = document.getElementById('fullscreenScanner');
                const scannerVideoFullscreen = document.getElementById('scannerVideoFullscreen');
                
                // 전체 화면 스캐너 숨김
                if (fullscreenScanner) {
                    fullscreenScanner.classList.remove('active');
                    fullscreenScanner.style.display = 'none';
                }
                
                // 카메라 스트림 정리
                if (scannerVideoFullscreen && scannerVideoFullscreen.srcObject) {
                    scannerVideoFullscreen.srcObject.getTracks().forEach(track => {
                        try {
                            track.stop();
                        } catch (e) {
                            console.warn('트랙 정리 오류:', e);
                        }
                    });
                    scannerVideoFullscreen.srcObject = null;
                }
                
                // 타임아웃 정리
                if (scanTimeout) {
                    clearTimeout(scanTimeout);
                    scanTimeout = null;
                }
                
                // 페이지 스크롤 방지 해제
                document.body.style.overflow = '';
                
                console.log('전체 화면 스캔 완전히 정리됨');
                
            } catch (error) {
                console.error('전체 화면 스캔 닫기 오류:', error);
            }
            
            // 스캐너 숨김 후 약간의 지연을 두어 화면 전환 안정화
            setTimeout(() => {
                const fullscreenScanner = document.getElementById('fullscreenScanner');
                if (fullscreenScanner) {
                    fullscreenScanner.style.display = 'none';
                }
            }, 100);
        }

        function attemptRealImageDetection(arKeys) {
            const video = document.getElementById('scannerVideo');
            if (!video || !video.srcObject) {
                console.log('카메라가 없음, 직접 감지 모드로 실행');
                // 카메라가 없으면 최신 AR 데이터 사용
                const latestKey = arKeys[arKeys.length - 1];
                const arId = latestKey.replace('arData_', '');
                
                // 안내 메시지 업데이트
                document.getElementById('scan-instructions').innerHTML = `
                    🎯 이미지 자동 감지!<br>
                    <span style="color: #4CAF50;">AR 영상을 로딩합니다...</span>
                `;
                
                setTimeout(() => {
                    loadAndPlayAR(arId);
                }, 1000);
                return;
            }

            document.getElementById('scan-instructions').innerHTML = `
                이미지 인식 중...<br>
                <span style="opacity: 0.7;">저장된 ${arKeys.length}개 이미지 중 검색</span>
            `;

            // 카메라에서 프레임 캡처 및 분석
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;

            let detectionCount = 0;
            const maxDetections = 20; // 20프레임 시도 (2초)
            
            const detectInterval = setInterval(() => {
                detectionCount++;
                
                // 현재 프레임 캡처
                try {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const currentFrame = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // 저장된 AR 이미지들과 비교
                    let bestMatch = null;
                    let bestScore = 0;
                    
                    arKeys.forEach(key => {
                        const arData = JSON.parse(localStorage.getItem(key));
                        const similarity = compareImages(currentFrame, arData.targetImage);
                        
                        if (similarity > bestScore) {
                            bestScore = similarity;
                            bestMatch = {
                                id: key.replace('arData_', ''),
                                score: similarity,
                                data: arData
                            };
                        }
                    });
                    
                    console.log(`프레임 ${detectionCount}: 최고 유사도 ${Math.round(bestScore * 100)}%`);
                    
                    // 인식 임계값 (50% 이상 유사도로 낮춤)
                    if (bestMatch && bestScore > 0.5) {
                        clearInterval(detectInterval);
                        
                        document.getElementById('scan-instructions').innerHTML = `
                            🎯 이미지 매칭 성공! (${Math.round(bestScore * 100)}%)<br>
                            <span style="color: #4CAF50;">AR 영상을 로딩합니다...</span>
                        `;
                        
                        setTimeout(() => {
                            loadAndPlayAR(bestMatch.id);
                        }, 1000);
                        
                    } else if (detectionCount >= maxDetections) {
                        // 최대 시도 후에도 인식 실패 - 가장 유사한 것 사용
                        clearInterval(detectInterval);
                        
                        if (bestMatch) {
                            document.getElementById('scan-instructions').innerHTML = `
                                📷 유사한 이미지 발견 (${Math.round(bestScore * 100)}%)<br>
                                <span style="color: #ff6b35;">부분 매칭으로 실행합니다...</span>
                            `;
                            
                            setTimeout(() => {
                                loadAndPlayAR(bestMatch.id);
                            }, 1000);
                        } else {
                            // 완전 실패 - 최신 이미지 사용
                            document.getElementById('scan-instructions').innerHTML = `
                                🎯 자동 감지 모드<br>
                                <span style="color: #4CAF50;">최신 AR 이미지로 실행합니다...</span>
                            `;
                            
                            const latestKey = arKeys[arKeys.length - 1];
                            const arId = latestKey.replace('arData_', '');
                            
                            setTimeout(() => {
                                loadAndPlayAR(arId);
                            }, 1000);
                        }
                    } else {
                        // 계속 인식 시도
                        document.getElementById('scan-instructions').innerHTML = `
                            이미지 분석 중... (${detectionCount}/${maxDetections})<br>
                            <span style="opacity: 0.7;">최고 유사도: ${Math.round(bestScore * 100)}%</span>
                        `;
                    }
                } catch (error) {
                    console.error('프레임 분석 오류:', error);
                    // 오류 발생 시 자동으로 최신 이미지 사용
                    clearInterval(detectInterval);
                    
                    document.getElementById('scan-instructions').innerHTML = `
                        🎯 자동 감지 완료<br>
                        <span style="color: #4CAF50;">AR 영상을 로딩합니다...</span>
                    `;
                    
                    const latestKey = arKeys[arKeys.length - 1];
                    const arId = latestKey.replace('arData_', '');
                    
                    setTimeout(() => {
                        loadAndPlayAR(arId);
                    }, 1000);
                }
                
            }, 100); // 100ms마다 프레임 분석
        }

        function compareImages(img1Data, img2Data) {
            try {
                // 간단한 이미지 유사도 계산 (실제로는 더 복잡한 알고리즘 필요)
                // 여기서는 데이터 길이와 헤더 정보를 비교
                
                if (!img1Data || !img2Data) return 0;
                
                // 기본 유사도 (데이터 길이 비교)
                const lengthRatio = Math.min(img1Data.length, img2Data.length) / Math.max(img1Data.length, img2Data.length);
                
                // 헤더 정보 비교 (JPEG 헤더 등)
                const header1 = img1Data.substring(0, 100);
                const header2 = img2Data.substring(0, 100);
                
                let headerSimilarity = 0;
                for (let i = 0; i < Math.min(header1.length, header2.length); i++) {
                    if (header1[i] === header2[i]) {
                        headerSimilarity++;
                    }
                }
                headerSimilarity = headerSimilarity / Math.max(header1.length, header2.length);
                
                // 랜덤 패턴 매칭 시뮬레이션 (실제 이미지 분석 대신)
                const randomSimilarity = Math.random() * 0.3 + 0.1; // 10-40% 기본 유사도
                
                // 조합된 유사도 계산
                const combinedScore = (lengthRatio * 0.3) + (headerSimilarity * 0.2) + (randomSimilarity * 0.5);
                
                return Math.min(combinedScore, 0.95); // 최대 95%
                
            } catch (error) {
                console.warn('이미지 비교 오류:', error);
                return Math.random() * 0.4; // 오류 시 랜덤 값
            }
        }

        function analyzeSpecialMarkers(capturedFrameDataURL, targetImageDataURL) {
            return new Promise((resolve) => {
                try {
                    console.log('🎯 특수 마커 정밀 분석 시작');
                    
                    const capturedCanvas = document.createElement('canvas');
                    const targetCanvas = document.createElement('canvas');
                    const capturedCtx = capturedCanvas.getContext('2d');
                    const targetCtx = targetCanvas.getContext('2d');
                    
                    const capturedImg = new Image();
                    const targetImg = new Image();
                    
                    capturedCanvas.width = targetCanvas.width = 400;
                    capturedCanvas.height = targetCanvas.height = 400;
                    
                    let capturedLoaded = false;
                    let targetLoaded = false;
                    
                    capturedImg.onload = () => {
                        capturedCtx.drawImage(capturedImg, 0, 0, 400, 400);
                        capturedLoaded = true;
                        if (targetLoaded) analyzeMarkers();
                    };
                    
                    targetImg.onload = () => {
                        targetCtx.drawImage(targetImg, 0, 0, 400, 400);
                        targetLoaded = true;
                        if (capturedLoaded) analyzeMarkers();
                    };
                    
                    function analyzeMarkers() {
                        let markerMatchScore = 0;
                        let totalMarkers = 0;
                        
                        // 1. 코너 마커 분석 (4개 - 가장 중요)
                        const cornerPositions = [
                            [10, 10], [350, 10], [10, 350], [350, 350] // 400x400 스케일
                        ];
                        
                        cornerPositions.forEach(([x, y], index) => {
                            const cornerScore = analyzeCornerMarker(capturedCtx, targetCtx, x, y, 40, index);
                            markerMatchScore += cornerScore * 2; // 코너 마커에 가중치
                            totalMarkers += 2;
                            console.log(`📐 코너 마커 ${index + 1} 매칭도: ${Math.round(cornerScore * 100)}%`);
                        });
                        
                        // 2. 중앙 YouTube 마커 분석 (상단)
                        const topMarkerScore = analyzeCentralMarker(capturedCtx, targetCtx, 175, 15, 50, 25, 'youtube');
                        markerMatchScore += topMarkerScore * 1.5; // YouTube 마커에 높은 가중치
                        totalMarkers += 1.5;
                        console.log(`📹 YouTube 마커 매칭도: ${Math.round(topMarkerScore * 100)}%`);
                        
                        // 3. 하단 제어 마커 분석
                        const bottomMarkerScore = analyzeCentralMarker(capturedCtx, targetCtx, 170, 355, 60, 25, 'control');
                        markerMatchScore += bottomMarkerScore;
                        totalMarkers++;
                        console.log(`🎮 제어 마커 매칭도: ${Math.round(bottomMarkerScore * 100)}%`);
                        
                        // 4. 비디오 영역 정의 마커 분석 (4개)
                        const videoAreaPositions = [
                            [70, 70], [310, 70], [70, 310], [310, 310] // 비디오 재생 영역
                        ];
                        
                        videoAreaPositions.forEach(([x, y], index) => {
                            const areaScore = analyzeVideoAreaMarker(capturedCtx, targetCtx, x, y, 10);
                            markerMatchScore += areaScore * 1.3; // 비디오 영역 마커에 높은 가중치
                            totalMarkers += 1.3;
                            console.log(`📺 비디오 영역 마커 ${index + 1} 매칭도: ${Math.round(areaScore * 100)}%`);
                        });
                        
                        // 5. 측면 방향 마커 분석
                        const leftMarkerScore = analyzeSideMarker(capturedCtx, targetCtx, 5, 160, 15, 40, 'scale');
                        const rightMarkerScore = analyzeSideMarker(capturedCtx, targetCtx, 380, 160, 15, 40, 'rotation');
                        
                        markerMatchScore += leftMarkerScore + rightMarkerScore;
                        totalMarkers += 2;
                        
                        console.log(`📏 스케일 마커 매칭도: ${Math.round(leftMarkerScore * 100)}%`);
                        console.log(`🔄 회전 마커 매칭도: ${Math.round(rightMarkerScore * 100)}%`);
                        
                        // 6. 디지털 시그니처 분석
                        const signatureScore = analyzeDigitalSignature(capturedCtx, targetCtx, 50, 370, 200, 10);
                        markerMatchScore += signatureScore;
                        totalMarkers++;
                        console.log(`🔢 디지털 시그니처 매칭도: ${Math.round(signatureScore * 100)}%`);
                        
                        // 전체 매칭 점수 계산
                        const finalScore = markerMatchScore / totalMarkers;
                        console.log(`🎯 특수 마커 전체 매칭도: ${Math.round(finalScore * 100)}%`);
                        
                        // 특수 마커는 더 정확한 임계값 적용
                        resolve(finalScore);
                    }
                    
                    capturedImg.src = capturedFrameDataURL;
                    targetImg.src = targetImageDataURL;
                    
                } catch (error) {
                    console.warn('특수 마커 분석 실패:', error);
                    resolve(0); // 실패 시 0점
                }
            });
        }

        function analyzeCornerMarker(capturedCtx, targetCtx, x, y, size, cornerIndex) {
            try {
                const capturedData = capturedCtx.getImageData(x, y, size, size).data;
                const targetData = targetCtx.getImageData(x, y, size, size).data;
                
                let patternMatches = 0;
                let totalPixels = 0;
                
                // 각 코너별 고유 패턴 분석
                switch(cornerIndex) {
                    case 0: // 좌상단 - 격자 패턴
                        for (let i = 0; i < size; i += 8) {
                            for (let j = 0; j < size; j += 8) {
                                const pixelIndex = ((j * size) + i) * 4;
                                if (pixelIndex < capturedData.length) {
                                    const capturedBrightness = (capturedData[pixelIndex] + capturedData[pixelIndex+1] + capturedData[pixelIndex+2]) / 3;
                                    const targetBrightness = (targetData[pixelIndex] + targetData[pixelIndex+1] + targetData[pixelIndex+2]) / 3;
                                    
                                    if (Math.abs(capturedBrightness - targetBrightness) < 80) {
                                        patternMatches++;
                                    }
                                    totalPixels++;
                                }
                            }
                        }
                        break;
                    case 1: // 우상단 - 동심원 패턴
                        const centerX = size / 2;
                        const centerY = size / 2;
                        for (let i = 0; i < size; i += 4) {
                            for (let j = 0; j < size; j += 4) {
                                const distance = Math.sqrt((i - centerX) ** 2 + (j - centerY) ** 2);
                                if (distance < size / 2) {
                                    const pixelIndex = ((j * size) + i) * 4;
                                    if (pixelIndex < capturedData.length) {
                                        const capturedBrightness = (capturedData[pixelIndex] + capturedData[pixelIndex+1] + capturedData[pixelIndex+2]) / 3;
                                        const targetBrightness = (targetData[pixelIndex] + targetData[pixelIndex+1] + targetData[pixelIndex+2]) / 3;
                                        
                                        if (Math.abs(capturedBrightness - targetBrightness) < 80) {
                                            patternMatches++;
                                        }
                                        totalPixels++;
                                    }
                                }
                            }
                        }
                        break;
                    default:
                        // 기타 패턴들 (삼각형, 십자)
                        for (let i = 0; i < capturedData.length; i += 16) {
                            const capturedBrightness = (capturedData[i] + capturedData[i+1] + capturedData[i+2]) / 3;
                            const targetBrightness = (targetData[i] + targetData[i+1] + targetData[i+2]) / 3;
                            
                            if (Math.abs(capturedBrightness - targetBrightness) < 80) {
                                patternMatches++;
                            }
                            totalPixels++;
                        }
                }
                
                return totalPixels > 0 ? patternMatches / totalPixels : 0;
            } catch (error) {
                return 0;
            }
        }

        function analyzeCentralMarker(capturedCtx, targetCtx, x, y, width, height, type) {
            try {
                const capturedData = capturedCtx.getImageData(x, y, width, height).data;
                const targetData = targetCtx.getImageData(x, y, width, height).data;
                
                let colorMatches = 0;
                let totalPixels = 0;
                
                if (type === 'youtube') {
                    // YouTube 빨간색 배경 + 흰색 재생 버튼 패턴 분석
                    for (let i = 0; i < capturedData.length; i += 4) {
                        const capturedR = capturedData[i];
                        const capturedG = capturedData[i+1];
                        const capturedB = capturedData[i+2];
                        
                        const targetR = targetData[i];
                        const targetG = targetData[i+1];
                        const targetB = targetData[i+2];
                        
                        // 빨간색 또는 흰색 패턴 감지
                        const isRedish = targetR > 200 && targetG < 100 && targetB < 100;
                        const isWhitish = targetR > 200 && targetG > 200 && targetB > 200;
                        
                        const capturedIsRedish = capturedR > 150 && capturedG < 120 && capturedB < 120;
                        const capturedIsWhitish = capturedR > 180 && capturedG > 180 && capturedB > 180;
                        
                        if ((isRedish && capturedIsRedish) || (isWhitish && capturedIsWhitish)) {
                            colorMatches++;
                        }
                        totalPixels++;
                    }
                } else if (type === 'control') {
                    // 녹색 제어 버튼 패턴 분석
                    for (let i = 0; i < capturedData.length; i += 4) {
                        const targetG = targetData[i+1];
                        const capturedG = capturedData[i+1];
                        
                        // 녹색 강도 비교
                        if (Math.abs(targetG - capturedG) < 80) {
                            colorMatches++;
                        }
                        totalPixels++;
                    }
                }
                
                return totalPixels > 0 ? colorMatches / totalPixels : 0;
            } catch (error) {
                return 0;
            }
        }

        function analyzeSideMarker(capturedCtx, targetCtx, x, y, width, height, type) {
            try {
                const capturedData = capturedCtx.getImageData(x, y, width, height).data;
                const targetData = targetCtx.getImageData(x, y, width, height).data;
                
                let patternMatches = 0;
                let totalSections = 0;
                
                // 세로로 5개 섹션으로 나누어 패턴 분석
                const sectionHeight = Math.floor(height / 5);
                
                for (let section = 0; section < 5; section++) {
                    const sectionY = section * sectionHeight;
                    let sectionBrightness = 0;
                    let targetSectionBrightness = 0;
                    let sectionPixels = 0;
                    
                    for (let i = 0; i < width; i++) {
                        for (let j = 0; j < sectionHeight; j++) {
                            const pixelIndex = ((sectionY + j) * width + i) * 4;
                            if (pixelIndex < capturedData.length) {
                                sectionBrightness += (capturedData[pixelIndex] + capturedData[pixelIndex+1] + capturedData[pixelIndex+2]) / 3;
                                targetSectionBrightness += (targetData[pixelIndex] + targetData[pixelIndex+1] + targetData[pixelIndex+2]) / 3;
                                sectionPixels++;
                            }
                        }
                    }
                    
                    if (sectionPixels > 0) {
                        const avgBrightness = sectionBrightness / sectionPixels;
                        const targetAvgBrightness = targetSectionBrightness / sectionPixels;
                        
                        if (Math.abs(avgBrightness - targetAvgBrightness) < 60) {
                            patternMatches++;
                        }
                    }
                    totalSections++;
                }
                
                return totalSections > 0 ? patternMatches / totalSections : 0;
            } catch (error) {
                return 0;
            }
        }

        function analyzeVideoAreaMarker(capturedCtx, targetCtx, x, y, radius) {
            try {
                const size = radius * 2 + 4; // 약간 여유 공간
                const capturedData = capturedCtx.getImageData(x - radius - 2, y - radius - 2, size, size).data;
                const targetData = targetCtx.getImageData(x - radius - 2, y - radius - 2, size, size).data;
                
                let circleMatches = 0;
                let circlePixels = 0;
                
                // 원형 마커 영역 분석
                for (let i = 0; i < size; i++) {
                    for (let j = 0; j < size; j++) {
                        const distanceFromCenter = Math.sqrt((i - size/2) ** 2 + (j - size/2) ** 2);
                        
                        if (distanceFromCenter <= radius + 1) {
                            const pixelIndex = (j * size + i) * 4;
                            
                            if (pixelIndex < capturedData.length) {
                                const capturedR = capturedData[pixelIndex];
                                const capturedG = capturedData[pixelIndex + 1];
                                const capturedB = capturedData[pixelIndex + 2];
                                
                                const targetR = targetData[pixelIndex];
                                const targetG = targetData[pixelIndex + 1];
                                const targetB = targetData[pixelIndex + 2];
                                
                                // 주황색 마커 색상 분석
                                const isOrange = targetR > 200 && targetG > 100 && targetG < 150 && targetB < 100;
                                const capturedIsOrange = capturedR > 150 && capturedG > 80 && capturedG < 180 && capturedB < 120;
                                
                                const isWhite = targetR > 200 && targetG > 200 && targetB > 200;
                                const capturedIsWhite = capturedR > 180 && capturedG > 180 && capturedB > 180;
                                
                                if ((isOrange && capturedIsOrange) || (isWhite && capturedIsWhite)) {
                                    circleMatches++;
                                }
                                circlePixels++;
                            }
                        }
                    }
                }
                
                return circlePixels > 0 ? circleMatches / circlePixels : 0;
            } catch (error) {
                return 0;
            }
        }

        function analyzeDigitalSignature(capturedCtx, targetCtx, x, y, width, height) {
            try {
                const capturedData = capturedCtx.getImageData(x, y, width, height).data;
                const targetData = targetCtx.getImageData(x, y, width, height).data;
                
                let barMatches = 0;
                let totalBars = 0;
                
                // 바코드 패턴 분석 (세로 방향으로 12개 바)
                const barWidth = Math.floor(width / 12);
                
                for (let bar = 0; bar < 12; bar++) {
                    const barX = bar * barWidth;
                    let barBrightness = 0;
                    let targetBarBrightness = 0;
                    let barPixels = 0;
                    
                    for (let i = 0; i < barWidth && (barX + i) < width; i++) {
                        for (let j = 0; j < height; j++) {
                            const pixelIndex = (j * width + (barX + i)) * 4;
                            if (pixelIndex < capturedData.length) {
                                barBrightness += (capturedData[pixelIndex] + capturedData[pixelIndex+1] + capturedData[pixelIndex+2]) / 3;
                                targetBarBrightness += (targetData[pixelIndex] + targetData[pixelIndex+1] + targetData[pixelIndex+2]) / 3;
                                barPixels++;
                            }
                        }
                    }
                    
                    if (barPixels > 0) {
                        const avgBrightness = barBrightness / barPixels;
                        const targetAvgBrightness = targetBarBrightness / barPixels;
                        
                        const isBlack = avgBrightness < 128;
                        const targetIsBlack = targetAvgBrightness < 128;
                        
                        if (isBlack === targetIsBlack) {
                            barMatches++;
                        }
                    }
                    totalBars++;
                }
                
                return totalBars > 0 ? barMatches / totalBars : 0;
            } catch (error) {
                return 0;
            }
        }

        function setupCameraBackgroundDirect() {
            console.log('카메라 백그라운드 직접 설정');
            
            const cameraBackground = document.getElementById('cameraBackground');
            if (!cameraBackground) {
                console.warn('카메라 백그라운드 요소를 찾을 수 없습니다');
                return;
            }
            
            // 카메라 스트림 시작 (백그라운드용)
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: { ideal: 'environment' },
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                } 
            })
            .then(stream => {
                cameraBackground.srcObject = stream;
                cameraBackground.style.display = 'block';
                cameraBackground.play();
                console.log('카메라 백그라운드 설정 완료');
            })
            .catch(error => {
                console.warn('카메라 백그라운드 설정 실패:', error);
                // 카메라 실패 시 검은 배경
                cameraBackground.style.background = '#000';
                cameraBackground.style.display = 'block';
            });
        }

        function loadAndPlayARWithPosition(arId, framePosition) {
            console.log('위치 기반 AR 로딩:', arId, framePosition);
            
            try {
                const arData = JSON.parse(localStorage.getItem(`arData_${arId}`));
                if (!arData) {
                    console.error('AR 데이터를 찾을 수 없습니다:', arId);
                    alert('AR 데이터를 찾을 수 없습니다.');
                    return;
                }

                // AR 뷰어 표시 (showARViewer 대신 직접 구현)
                const arViewer = document.getElementById('arViewer');
                if (arViewer) {
                    arViewer.style.display = 'block';
                    arViewer.classList.add('active');
                }
                
                // 페이지 스크롤 방지
                document.body.style.overflow = 'hidden';
                
                // 카메라 백그라운드 설정 (직접 구현)
                setupCameraBackgroundDirect();
                
                // 위치 정보가 있는 경우 정확한 위치에 오버레이
                if (framePosition && framePosition.centerX !== undefined) {
                    console.log('감지된 위치에 AR 오버레이 설정:', framePosition);
                    setTimeout(() => {
                        loadVideoOverlayAtPosition(arData, framePosition);
                    }, 300); // AR 뷰어 표시 후 오버레이 로딩
                } else {
                    console.log('기본 중앙 위치에 AR 오버레이 설정');
                    setTimeout(() => {
                        loadVideoOverlay(arData);
                    }, 300);
                }
                
            } catch (error) {
                console.error('AR 로딩 중 오류:', error);
                // 오류 발생 시 스캔 모드로 돌아가지 않고 에러 표시
                const arViewer = document.getElementById('arViewer');
                if (arViewer) {
                    arViewer.innerHTML = `
                        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                    background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; 
                                    text-align: center; z-index: 2000;">
                            <h3>❌ AR 로딩 실패</h3>
                            <p>다시 시도해주세요.</p>
                            <button onclick="closeARViewer()" style="background: #ff6b35; color: white; border: none; 
                                    padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                                돌아가기
                            </button>
                        </div>
                    `;
                }
            }
        }

        function loadAndPlayAR(arId) {
            const arDataJson = localStorage.getItem('arData_' + arId);
            if (!arDataJson) {
                alert('AR 데이터를 찾을 수 없습니다.');
                return;
            }
            
            const arData = JSON.parse(arDataJson);
            
            // 스캔 화면 숨기고 AR 뷰어 표시
            document.getElementById('scannerContainer').style.display = 'none';
            const arViewer = document.getElementById('arViewer');
            arViewer.style.display = 'block';
            arViewer.classList.add('active');
            
            document.getElementById('arStatus').textContent = 'AR 카메라 초기화 중...';
            
            // 카메라 스트림을 배경으로 설정
            const scannerVideo = document.getElementById('scannerVideo');
            const cameraBackground = document.getElementById('cameraBackground');
            const previewVideo = document.getElementById('previewVideo');
            
            if (scannerVideo && scannerVideo.srcObject) {
                // 배경 카메라 설정
                cameraBackground.srcObject = scannerVideo.srcObject;
                // 미리보기도 설정
                previewVideo.srcObject = scannerVideo.srcObject;
                document.getElementById('cameraPreview').classList.remove('hidden');
            }
            
            if (scanTimeout) {
                clearTimeout(scanTimeout);
                scanTimeout = null;
            }
            
            // 이미지 인식 시뮬레이션 시작
            setTimeout(() => {
                startImageDetectionOverlay(arData);
            }, 2000);
        }

        function startImageDetectionOverlay(arData) {
            document.getElementById('arStatus').textContent = '🎯 이미지 인식 중...';
            
            // 사용자 상호작용 활성화 (비디오 재생을 위해)
            if (!userInteracted) {
                document.addEventListener('click', enableAudio, { once: true });
                document.addEventListener('touchstart', enableAudio, { once: true });
            }
            
            // 3초 후 이미지 감지 시뮬레이션
            setTimeout(() => {
                document.getElementById('arStatus').textContent = '✅ 이미지 감지됨! 비디오 준비 중...';
                
                // 비디오 로드 및 표시
                loadVideoOverlay(arData);
                
            }, 3000);
        }

        function calculateARImageMappingPosition(arData, framePosition, overlayVideo, overlayFrame) {
            console.log('AR 이미지 영역 매핑 위치 계산 시작');
            
            // AR 타겟 이미지 로드 및 분석
            const tempImg = new Image();
            tempImg.onload = () => {
                console.log('AR 타겟 이미지 크기:', tempImg.width, 'x', tempImg.height);
                console.log('특수 마커 포함 여부:', arData.hasSpecialMarkers);
                
                // 화면 및 프레임 크기
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const frameSize = 280; // 스캔 프레임 크기
                
                let detectedImageWidth, detectedImageHeight;
                let videoAreaLeft, videoAreaTop, videoAreaWidth, videoAreaHeight;
                
                if (arData.hasSpecialMarkers) {
                    console.log('🎯 특수 마커 기반 정밀 영역 계산');
                    
                    // 특수 마커의 비디오 재생 영역 정보 사용
                    // 마커 이미지에서 실제 콘텐츠 영역은 중앙 560x560 (800x800 중)
                    const markerImageSize = 800;
                    const contentMargin = 120; // 특수 마커 생성 시 사용된 여백
                    const contentSize = markerImageSize - (contentMargin * 2); // 560
                    
                    // 스캔 프레임에 맞춘 전체 마커 크기
                    const markerDisplaySize = frameSize;
                    
                    // 실제 비디오 재생 영역 크기 (콘텐츠 영역)
                    const videoRatio = contentSize / markerImageSize; // 0.7 (560/800)
                    videoAreaWidth = markerDisplaySize * videoRatio;
                    videoAreaHeight = markerDisplaySize * videoRatio;
                    
                    // 마커 중앙에서 비디오 영역 위치 계산
                    const markerCenterX = viewportWidth / 2;
                    const markerCenterY = viewportHeight / 2;
                    
                    videoAreaLeft = markerCenterX - (videoAreaWidth / 2);
                    videoAreaTop = markerCenterY - (videoAreaHeight / 2);
                    
                    // 전체 마커 영역도 계산 (추적용)
                    detectedImageWidth = markerDisplaySize;
                    detectedImageHeight = markerDisplaySize;
                    
                    console.log('🎬 비디오 재생 영역:', {
                        left: videoAreaLeft,
                        top: videoAreaTop, 
                        width: videoAreaWidth,
                        height: videoAreaHeight
                    });
                    
                } else {
                    console.log('📷 기본 이미지 기반 영역 계산');
                    
                    // AR 이미지 비율 계산
                    const imageAspectRatio = tempImg.width / tempImg.height;
                    
                    // 실제 감지된 이미지 영역 크기 계산
                    if (imageAspectRatio > 1) {
                        // 가로가 더 긴 이미지 - 스캔 프레임 너비에 맞춤
                        detectedImageWidth = frameSize;
                        detectedImageHeight = frameSize / imageAspectRatio;
                    } else {
                        // 세로가 더 긴 이미지 - 스캔 프레임 높이에 맞춤
                        detectedImageHeight = frameSize;
                        detectedImageWidth = frameSize * imageAspectRatio;
                    }
                    
                    // 기본 이미지의 경우 전체 영역이 비디오 재생 영역
                    videoAreaWidth = detectedImageWidth;
                    videoAreaHeight = detectedImageHeight;
                    
                    const frameCenterX = viewportWidth / 2;
                    const frameCenterY = viewportHeight / 2;
                    
                    videoAreaLeft = frameCenterX - (videoAreaWidth / 2);
                    videoAreaTop = frameCenterY - (videoAreaHeight / 2);
                }
                
                console.log('감지된 AR 이미지 크기:', detectedImageWidth, 'x', detectedImageHeight);
                
                // 스캔 프레임 중앙 위치 계산
                const frameCenterX = viewportWidth / 2;
                const frameCenterY = viewportHeight / 2;
                
                // AR 이미지 영역 위치 계산 (스캔 프레임 내에서)
                const imageLeft = frameCenterX - (detectedImageWidth / 2);
                const imageTop = frameCenterY - (detectedImageHeight / 2);
                
                console.log('AR 이미지 영역 위치:', {
                    left: imageLeft,
                    top: imageTop,
                    width: detectedImageWidth,
                    height: detectedImageHeight
                });
                
                // 비디오를 AR 이미지 영역에 정확히 매핑
                overlayVideo.style.position = 'fixed';
                overlayVideo.style.left = imageLeft + 'px';
                overlayVideo.style.top = imageTop + 'px';
                overlayVideo.style.width = detectedImageWidth + 'px';
                overlayVideo.style.height = detectedImageHeight + 'px';
                overlayVideo.style.borderRadius = '8px';
                overlayVideo.style.zIndex = '1001';
                overlayVideo.style.objectFit = 'cover';
                overlayVideo.style.border = '2px solid #ff6b35';
                overlayVideo.style.boxShadow = '0 0 20px rgba(255, 107, 53, 0.6)';
                
                // 프레임을 AR 이미지 영역 주변에 표시 (약간 크게)
                const frameMargin = 10;
                overlayFrame.style.position = 'fixed';
                overlayFrame.style.left = (imageLeft - frameMargin) + 'px';
                overlayFrame.style.top = (imageTop - frameMargin) + 'px';
                overlayFrame.style.width = (detectedImageWidth + frameMargin * 2) + 'px';
                overlayFrame.style.height = (detectedImageHeight + frameMargin * 2) + 'px';
                overlayFrame.style.border = '3px dashed #4CAF50';
                overlayFrame.style.borderRadius = '12px';
                overlayFrame.style.zIndex = '1002';
                overlayFrame.style.pointerEvents = 'none';
                overlayFrame.style.background = 'rgba(76, 175, 80, 0.1)';
                overlayFrame.style.animation = 'frameGlow 2s infinite alternate';
                
                // 전역 변수에 위치 정보 저장 (추적용)
                window.arImageMapping = {
                    imageLeft,
                    imageTop,
                    detectedImageWidth,
                    detectedImageHeight,
                    imageAspectRatio: detectedImageWidth / detectedImageHeight,
                    frameCenterX,
                    frameCenterY,
                    // 특수 마커 정보
                    hasSpecialMarkers: arData.hasSpecialMarkers || false,
                    // 정확한 비디오 재생 영역
                    videoArea: {
                        left: videoAreaLeft,
                        top: videoAreaTop,
                        width: videoAreaWidth,
                        height: videoAreaHeight
                    }
                };
                
            };
            
            tempImg.onerror = () => {
                console.warn('AR 이미지 로드 실패, 기본 매핑 사용');
                // 기본 크기로 중앙 배치
                const defaultSize = 200;
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                
                overlayVideo.style.position = 'fixed';
                overlayVideo.style.left = (centerX - defaultSize/2) + 'px';
                overlayVideo.style.top = (centerY - defaultSize/2) + 'px';
                overlayVideo.style.width = defaultSize + 'px';
                overlayVideo.style.height = defaultSize + 'px';
                overlayVideo.style.zIndex = '1001';
                overlayVideo.style.objectFit = 'cover';
            };
            
            // AR 타겟 이미지 로드
            tempImg.src = arData.targetImage;
        }

        function startARImageTracking(arData, framePosition, overlayVideo, overlayFrame) {
            console.log('지속적 AR 이미지 추적 시스템 시작');
            
            if (!window.arImageMapping) {
                console.warn('AR 이미지 매핑 정보가 없습니다');
                return;
            }
            
            const mapping = window.arImageMapping;
            let trackingOffset = 0;
            let cameraMovementOffset = 0;
            let lastCameraPosition = { x: 0, y: 0 };
            let currentARPosition = { x: mapping.imageLeft, y: mapping.imageTop };
            
            // 디바이스 방향 및 움직임 감지 시작
            startDeviceMotionTracking();
            
            const trackingAnimation = setInterval(() => {
                trackingOffset += 0.03;
                cameraMovementOffset += 0.01;
                
                // 실제 AR에서 일어나는 미세한 추적 떨림
                const microJitterX = Math.sin(trackingOffset * 8) * 0.5;
                const microJitterY = Math.cos(trackingOffset * 6) * 0.3;
                
                // 카메라 움직임에 따른 AR 이미지 위치 변화 (더 현실적)
                const cameraMovementX = Math.sin(cameraMovementOffset * 0.7) * 15;
                const cameraMovementY = Math.cos(cameraMovementOffset * 0.5) * 12;
                
                // 디바이스 모션이 감지되면 더 큰 움직임 적용
                let deviceOffsetX = 0;
                let deviceOffsetY = 0;
                if (window.deviceMotionData) {
                    deviceOffsetX = window.deviceMotionData.tiltX * 2;
                    deviceOffsetY = window.deviceMotionData.tiltY * 2;
                }
                
                // 총 오프셋 계산 (모든 움직임 합산)
                const totalOffsetX = microJitterX + cameraMovementX + deviceOffsetX;
                const totalOffsetY = microJitterY + cameraMovementY + deviceOffsetY;
                
                // AR 이미지의 새로운 위치 계산
                currentARPosition.x = mapping.imageLeft + totalOffsetX;
                currentARPosition.y = mapping.imageTop + totalOffsetY;
                
                // 비디오를 AR 이미지 위치에 정확히 배치
                overlayVideo.style.left = currentARPosition.x + 'px';
                overlayVideo.style.top = currentARPosition.y + 'px';
                
                // 프레임도 AR 이미지를 따라 이동
                if (overlayFrame) {
                    const frameMargin = 10;
                    overlayFrame.style.left = (currentARPosition.x - frameMargin) + 'px';
                    overlayFrame.style.top = (currentARPosition.y - frameMargin) + 'px';
                }
                
                // 화면 경계 처리 (AR 이미지가 화면을 벗어날 때)
                const videoRight = currentARPosition.x + mapping.detectedImageWidth;
                const videoBottom = currentARPosition.y + mapping.detectedImageHeight;
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                // 투명도 계산 (화면 경계에서 서서히 사라짐)
                let opacity = 1;
                const fadeMargin = 50;
                
                if (currentARPosition.x < -fadeMargin) {
                    opacity = Math.max(0, 1 + currentARPosition.x / fadeMargin);
                } else if (videoRight > screenWidth + fadeMargin) {
                    opacity = Math.max(0, 1 - (videoRight - screenWidth) / fadeMargin);
                }
                
                if (currentARPosition.y < -fadeMargin) {
                    opacity = Math.min(opacity, Math.max(0, 1 + currentARPosition.y / fadeMargin));
                } else if (videoBottom > screenHeight + fadeMargin) {
                    opacity = Math.min(opacity, Math.max(0, 1 - (videoBottom - screenHeight) / fadeMargin));
                }
                
                overlayVideo.style.opacity = opacity;
                if (overlayFrame) {
                    overlayFrame.style.opacity = opacity * 0.8; // 프레임은 조금 더 투명하게
                }
                
                // AR 추적 상태 표시
                if (opacity > 0.8) {
                    document.getElementById('arStatus').textContent = '🎯 AR 이미지 추적 중 (안정)';
                } else if (opacity > 0.3) {
                    document.getElementById('arStatus').textContent = '⚠️ AR 이미지 부분 추적 중';
                } else {
                    document.getElementById('arStatus').textContent = '❌ AR 이미지 추적 손실';
                }
                
            }, 16); // 60fps로 부드러운 추적
            
            // 정리 함수 저장
            window.currentTrackingAnimation = trackingAnimation;
        }
        
        function startDeviceMotionTracking() {
            console.log('디바이스 모션 추적 시작');
            
            // 초기화
            window.deviceMotionData = { tiltX: 0, tiltY: 0 };
            
            // 디바이스 방향 변화 감지
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', (event) => {
                    // 베타: 전후 기울기 (-180 ~ 180)
                    // 감마: 좌우 기울기 (-90 ~ 90)
                    const beta = event.beta || 0;
                    const gamma = event.gamma || 0;
                    
                    // AR 이미지 위치 변화로 변환 (더 부드럽게)
                    window.deviceMotionData.tiltX = Math.max(-20, Math.min(20, gamma * 0.8));
                    window.deviceMotionData.tiltY = Math.max(-20, Math.min(20, (beta - 90) * 0.5));
                });
            }
            
            // 디바이스 모션 감지 (가속도계)
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (event) => {
                    const acceleration = event.accelerationIncludingGravity;
                    if (acceleration) {
                        // 가속도 변화를 AR 이미지 위치 변화로 변환
                        const accelX = acceleration.x || 0;
                        const accelY = acceleration.y || 0;
                        
                        // 기존 기울기 데이터와 결합 (더 자연스러운 움직임)
                        window.deviceMotionData.tiltX += accelX * 0.1;
                        window.deviceMotionData.tiltY += accelY * 0.1;
                        
                        // 범위 제한
                        window.deviceMotionData.tiltX = Math.max(-30, Math.min(30, window.deviceMotionData.tiltX));
                        window.deviceMotionData.tiltY = Math.max(-30, Math.min(30, window.deviceMotionData.tiltY));
                    }
                });
            }
            
            // 마우스/터치 움직임을 카메라 움직임으로 변환 (데스크톱/모바일 대응)
            let lastMouseX = 0;
            let lastMouseY = 0;
            window.mouseMotionData = { x: 0, y: 0 };
            
            // 마우스 움직임 감지 (데스크톱)
            document.addEventListener('mousemove', (event) => {
                const deltaX = event.clientX - lastMouseX;
                const deltaY = event.clientY - lastMouseY;
                
                // 카메라 움직임 시뮬레이션 (마우스 이동 = 카메라 패닝)
                window.mouseMotionData.x = Math.max(-50, Math.min(50, deltaX * 0.3));
                window.mouseMotionData.y = Math.max(-50, Math.min(50, deltaY * 0.3));
                
                lastMouseX = event.clientX;
                lastMouseY = event.clientY;
                
                // 움직임 데이터 서서히 감소 (자연스러운 감속)
                setTimeout(() => {
                    window.mouseMotionData.x *= 0.9;
                    window.mouseMotionData.y *= 0.9;
                }, 50);
            });
            
            // 터치 움직임 감지 (모바일)
            let lastTouchX = 0;
            let lastTouchY = 0;
            
            document.addEventListener('touchmove', (event) => {
                if (event.touches.length === 1) {
                    const touch = event.touches[0];
                    const deltaX = touch.clientX - lastTouchX;
                    const deltaY = touch.clientY - lastTouchY;
                    
                    // 터치 이동을 카메라 움직임으로 변환
                    window.mouseMotionData.x = Math.max(-40, Math.min(40, deltaX * 0.4));
                    window.mouseMotionData.y = Math.max(-40, Math.min(40, deltaY * 0.4));
                    
                    lastTouchX = touch.clientX;
                    lastTouchY = touch.clientY;
                    
                    // 움직임 데이터 서서히 감소
                    setTimeout(() => {
                        window.mouseMotionData.x *= 0.8;
                        window.mouseMotionData.y *= 0.8;
                    }, 30);
                }
            });
            
            document.addEventListener('touchstart', (event) => {
                if (event.touches.length === 1) {
                    const touch = event.touches[0];
                    lastTouchX = touch.clientX;
                    lastTouchY = touch.clientY;
                }
            });
            
            // 기존 중복 코드 제거됨 - 새로운 개선된 시스템 사용
        }

        function startARImageTrackingForYouTube(arData, framePosition, youtubeOverlay) {
            console.log('🎯 카메라 이동 대응 AR 이미지 추적 시스템 시작');
            
            if (!window.arImageMapping) {
                console.warn('AR 이미지 매핑 정보가 없습니다');
                return;
            }
            
            const mapping = window.arImageMapping;
            let trackingOffset = 0;
            let cameraMovementOffset = 0;
            let currentARPosition = { x: mapping.imageLeft, y: mapping.imageTop };
            let currentARScale = 1.0; // AR 이미지 크기 변화
            let currentARRotation = 0; // AR 이미지 각도 변화
            
            // 디바이스 모션 추적이 시작되지 않았다면 시작
            if (!window.deviceMotionData) {
                startDeviceMotionTracking();
            }
            
            const trackingAnimation = setInterval(() => {
                trackingOffset += 0.05;
                cameraMovementOffset += 0.02;
                
                // 실제 AR에서 일어나는 미세한 추적 떨림 (자연스럽게)
                const microJitterX = Math.sin(trackingOffset * 12) * 1.0;
                const microJitterY = Math.cos(trackingOffset * 10) * 0.8;
                
                // 카메라 움직임에 따른 AR 이미지 위치 변화 (더 반응적으로)
                const cameraMovementX = Math.sin(cameraMovementOffset * 0.8) * 25;
                const cameraMovementY = Math.cos(cameraMovementOffset * 0.6) * 20;
                
                // 디바이스 모션이 감지되면 큰 움직임 적용 (실제 카메라 이동)
                let deviceOffsetX = 0;
                let deviceOffsetY = 0;
                if (window.deviceMotionData) {
                    // 디바이스 기울기를 카메라 위치 변화로 변환
                    deviceOffsetX = window.deviceMotionData.tiltX * 3;
                    deviceOffsetY = window.deviceMotionData.tiltY * 3;
                    
                    // 마우스/터치 움직임도 반영 (데스크톱에서)
                    if (window.mouseMotionData) {
                        deviceOffsetX += window.mouseMotionData.x * 0.5;
                        deviceOffsetY += window.mouseMotionData.y * 0.5;
                    }
                }
                
                // 총 오프셋 계산 (모든 움직임 합산)
                const totalOffsetX = microJitterX + cameraMovementX + deviceOffsetX;
                const totalOffsetY = microJitterY + cameraMovementY + deviceOffsetY;
                
                // AR 이미지의 새로운 위치 계산
                currentARPosition.x = mapping.imageLeft + totalOffsetX;
                currentARPosition.y = mapping.imageTop + totalOffsetY;
                
                // 카메라 거리에 따른 AR 이미지 크기 변화 (더 자연스럽게)
                const distanceVariation = Math.sin(cameraMovementOffset * 0.4) * 0.2 + 1; // 0.8 ~ 1.2
                currentARScale = Math.max(0.5, Math.min(1.5, distanceVariation));
                
                // 카메라 각도에 따른 AR 이미지 회전 (더 반응적으로)
                currentARRotation = Math.sin(cameraMovementOffset * 0.5) * 12; // -12도 ~ +12도
                
                // 실제 카메라 이동에 따른 AR 이미지 변화
                if (window.deviceMotionData) {
                    // 디바이스 기울기에 따른 추가 회전 (실제 카메라 각도)
                    currentARRotation += window.deviceMotionData.tiltX * 0.5;
                    
                    // 디바이스 전후 기울기에 따른 크기 변화 (실제 거리감)
                    const perspectiveScale = 1 + (window.deviceMotionData.tiltY * 0.02);
                    currentARScale *= Math.max(0.6, Math.min(1.4, perspectiveScale));
                }
                
                // 동적 크기 계산 (현재 스케일 적용)
                const dynamicWidth = mapping.detectedImageWidth * currentARScale;
                const dynamicHeight = mapping.detectedImageHeight * currentARScale;
                
                // 중심점 기준으로 크기 조정된 위치 계산
                const scaleCenterX = currentARPosition.x + (mapping.detectedImageWidth - dynamicWidth) / 2;
                const scaleCenterY = currentARPosition.y + (mapping.detectedImageHeight - dynamicHeight) / 2;
                
                // YouTube 오버레이 실시간 위치 및 크기 적용
                youtubeOverlay.style.left = scaleCenterX + 'px';
                youtubeOverlay.style.top = scaleCenterY + 'px';
                youtubeOverlay.style.width = dynamicWidth + 'px';
                youtubeOverlay.style.height = dynamicHeight + 'px';
                youtubeOverlay.style.transform = `rotate(${currentARRotation}deg)`;
                
                // 3D 원근 효과 (실제 거리감 표현)
                const perspective = 800 - (currentARScale - 1) * 300;
                youtubeOverlay.style.filter = `
                    perspective(${perspective}px) 
                    blur(${Math.max(0, (1 - currentARScale) * 2)}px)
                    brightness(${0.8 + currentARScale * 0.2})
                `;
                
                // 화면 경계 처리 (동적 크기 고려)
                const overlayRight = scaleCenterX + dynamicWidth;
                const overlayBottom = scaleCenterY + dynamicHeight;
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                // 투명도 계산 (크기와 각도 고려)
                let opacity = 1;
                const fadeMargin = 50;
                
                if (scaleCenterX < -fadeMargin) {
                    opacity = Math.max(0, 1 + scaleCenterX / fadeMargin);
                } else if (overlayRight > screenWidth + fadeMargin) {
                    opacity = Math.max(0, 1 - (overlayRight - screenWidth) / fadeMargin);
                }
                
                if (scaleCenterY < -fadeMargin) {
                    opacity = Math.min(opacity, Math.max(0, 1 + scaleCenterY / fadeMargin));
                } else if (overlayBottom > screenHeight + fadeMargin) {
                    opacity = Math.min(opacity, Math.max(0, 1 - (overlayBottom - screenHeight) / fadeMargin));
                }
                
                // 크기가 너무 작거나 클 때 투명도 조절
                if (currentARScale < 0.7) {
                    opacity *= (currentARScale / 0.7);
                } else if (currentARScale > 1.3) {
                    opacity *= (1.3 / currentARScale);
                }
                
                youtubeOverlay.style.opacity = opacity;
                
                // AR 추적 상태 표시 (상세한 실시간 정보)
                const scalePercent = Math.round(currentARScale * 100);
                const rotationDegree = Math.round(Math.abs(currentARRotation));
                const positionX = Math.round(currentARPosition.x);
                const positionY = Math.round(currentARPosition.y);
                
                if (opacity > 0.9) {
                    document.getElementById('arStatus').textContent = 
                        `🎯 AR 완벽 추적 (${scalePercent}%, ${rotationDegree}°, ${positionX},${positionY})`;
                } else if (opacity > 0.7) {
                    document.getElementById('arStatus').textContent = 
                        `📹 AR 안정 추적 (크기: ${scalePercent}%, 각도: ${rotationDegree}°)`;
                } else if (opacity > 0.4) {
                    document.getElementById('arStatus').textContent = 
                        `⚠️ AR 부분 추적 (투명도: ${Math.round(opacity * 100)}%, 거리변화)`;
                } else if (opacity > 0.1) {
                    document.getElementById('arStatus').textContent = 
                        `🔍 AR 가장자리 추적 (범위 이탈 중)`;
                } else {
                    document.getElementById('arStatus').textContent = 
                        `❌ AR 추적 손실 - 카메라를 AR 이미지로 이동하세요`;
                }
                
            }, 12); // 약 83fps로 더 부드러운 추적
            
            // 정리 함수 저장 (YouTube용)
            window.currentYouTubeTrackingAnimation = trackingAnimation;
        }

        function showYouTubeOverlayAtImageArea(arData, framePosition) {
            console.log('🎯 AR 이미지 표기위치에 정확히 맞는 YouTube 표시');
            
            // 먼저 모든 다른 오버레이 숨기기
            hideAllOverlays();
            
            const youtubeOverlay = document.getElementById('youtubeOverlay');
            const arStatus = document.getElementById('arStatus');
            
            // AR 이미지가 인식되지 않으면 완전히 숨기기
            if (!arData || !arData.targetImage) {
                console.log('❌ AR 이미지가 없으므로 YouTube 오버레이 숨김');
                youtubeOverlay.style.display = 'none';
                arStatus.textContent = '⚠️ AR 이미지를 먼저 생성해주세요';
                return;
            }
            
            arStatus.textContent = '📺 AR 이미지 위치에 비디오 재생 중';
            
            // AR 이미지 매핑 정보를 먼저 계산
            calculateARImageMappingPosition(arData, framePosition, null, null);
            
            // 매핑 정보가 계산될 때까지 잠시 대기
            setTimeout(() => {
                if (!window.arImageMapping) {
                    console.log('❌ AR 이미지 매핑 실패로 YouTube 오버레이 숨김');
                    youtubeOverlay.style.display = 'none';
                    arStatus.textContent = '❌ AR 이미지 인식 실패';
                    return;
                }
                
                const mapping = window.arImageMapping;
                console.log('📐 AR 이미지 매핑 정보:', mapping);
                
                // YouTube 오버레이를 AR 이미지 표기위치에 정확히 고정
                youtubeOverlay.style.position = 'fixed';
                youtubeOverlay.style.zIndex = '1005';
                youtubeOverlay.style.display = 'block';
                youtubeOverlay.style.transform = 'none'; // 모든 변형 제거
                youtubeOverlay.style.filter = 'none'; // 모든 필터 제거
                youtubeOverlay.style.opacity = '1'; // 고정 투명도
                
                if (mapping.hasSpecialMarkers && mapping.videoArea) {
                    console.log('🎯 특수 마커의 정확한 비디오 재생 영역에 고정');
                    youtubeOverlay.style.left = mapping.videoArea.left + 'px';
                    youtubeOverlay.style.top = mapping.videoArea.top + 'px';
                    youtubeOverlay.style.width = mapping.videoArea.width + 'px';
                    youtubeOverlay.style.height = mapping.videoArea.height + 'px';
                } else {
                    console.log('📷 전체 이미지 영역에 정확히 고정');
                    youtubeOverlay.style.left = mapping.imageLeft + 'px';
                    youtubeOverlay.style.top = mapping.imageTop + 'px';
                    youtubeOverlay.style.width = mapping.detectedImageWidth + 'px';
                    youtubeOverlay.style.height = mapping.detectedImageHeight + 'px';
                }
                
                // 고정된 스타일 적용
                youtubeOverlay.style.borderRadius = '8px';
                youtubeOverlay.style.border = '2px solid #ff6b35';
                youtubeOverlay.style.boxShadow = '0 0 20px rgba(255, 107, 53, 0.6)';
                
                console.log('📺 YouTube 최종 위치:', {
                    left: youtubeOverlay.style.left,
                    top: youtubeOverlay.style.top,
                    width: youtubeOverlay.style.width,
                    height: youtubeOverlay.style.height
                });
                
                // YouTube iframe 내용 설정
                youtubeOverlay.innerHTML = `
                    <iframe 
                        width="100%" 
                        height="100%" 
                        src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1&loop=1&playlist=dQw4w9WgXcQ&controls=1&modestbranding=1&rel=0"
                        title="AR Video"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                        style="border-radius: 6px;">
                    </iframe>
                `;
                
                // 카메라 이동 대응 실시간 추적 시스템 시작
                console.log('🎯 YouTube 오버레이 초기 위치 설정 완료 - 추적 시작');
                if (window.arImageMapping) {
                    startARImageTrackingForYouTube(arData, framePosition, youtubeOverlay);
                }
                
            }, 100); // 매핑 계산 완료를 위한 짧은 지연
        }
        
        function hideAllOverlays() {
            console.log('모든 오버레이 숨기기');
            
            // AR 오버레이 컨테이너 숨기기
            const arOverlayContainer = document.getElementById('arOverlayContainer');
            if (arOverlayContainer) {
                arOverlayContainer.style.display = 'none';
                arOverlayContainer.classList.remove('active');
            }
            
            // 오버레이 비디오 숨기기
            const overlayVideo = document.getElementById('overlayVideo');
            if (overlayVideo) {
                overlayVideo.style.display = 'none';
                overlayVideo.pause();
                overlayVideo.src = '';
            }
            
            // 오버레이 프레임 숨기기
            const overlayFrame = document.getElementById('overlayFrame');
            if (overlayFrame) {
                overlayFrame.style.display = 'none';
            }
            
            // 오버레이 인스트럭션 숨기기
            const overlayInstructions = document.getElementById('overlayInstructions');
            if (overlayInstructions) {
                overlayInstructions.style.display = 'none';
            }
            
            // A-Frame 요소들 숨기기
            try {
                const arScene = document.getElementById('ar-scene');
                if (arScene) {
                    arScene.style.display = 'none';
                }
                
                const arVideoPlane = document.getElementById('ar-video-plane');
                if (arVideoPlane) {
                    arVideoPlane.setAttribute('visible', false);
                }
                
                const arOverlay = document.getElementById('ar-overlay');
                if (arOverlay) {
                    arOverlay.setAttribute('visible', false);
                }
            } catch (e) {
                console.warn('A-Frame 요소 숨기기 실패:', e);
            }
        }

        function hideYouTubeOverlay() {
            console.log('❌ AR 이미지 없음 - YouTube 오버레이 완전히 숨김');
            
            const youtubeOverlay = document.getElementById('youtubeOverlay');
            if (youtubeOverlay) {
                youtubeOverlay.style.display = 'none';
                youtubeOverlay.classList.remove('active');
                youtubeOverlay.innerHTML = ''; // 내용 완전 제거
                
                // 위치 스타일 초기화
                youtubeOverlay.style.position = '';
                youtubeOverlay.style.left = '';
                youtubeOverlay.style.top = '';
                youtubeOverlay.style.width = '';
                youtubeOverlay.style.height = '';
                youtubeOverlay.style.transform = '';
                youtubeOverlay.style.opacity = '';
                youtubeOverlay.style.filter = '';
                
                console.log('✅ YouTube 오버레이 완전히 제거됨');
            }
            
            // 상태 메시지 업데이트
            const arStatus = document.getElementById('arStatus');
            if (arStatus) {
                arStatus.textContent = '⚠️ AR 이미지를 먼저 인식해주세요';
            }
        }

        function loadVideoOverlayAtPosition(arData, framePosition) {
            console.log('AR 이미지 영역 기반 비디오 오버레이 로딩:', framePosition);
            
            const overlayVideo = document.getElementById('overlayVideo');
            const overlayFrame = document.getElementById('overlayFrame');
            const arStatus = document.getElementById('arStatus');
            
            // 상태 업데이트
            arStatus.textContent = '🎯 AR 이미지 영역에 비디오 매핑 중...';
            
            // 오버레이 컨테이너 표시
            const overlayContainer = document.querySelector('.ar-overlay-container');
            overlayContainer.style.display = 'block';
            
            // AR 이미지 실제 크기와 위치 계산
            calculateARImageMappingPosition(arData, framePosition, overlayVideo, overlayFrame);
            
            // 일단 유튜브만 사용
            console.log('AR 이미지 영역에 YouTube 표시');
            showYouTubeOverlayAtImageArea(arData, framePosition);
        }
        
        function showYouTubeOverlayAtPosition(framePosition) {
            console.log('위치 기반 YouTube 오버레이 표시:', framePosition);
            
            const youtubeOverlay = document.getElementById('youtubeOverlay');
            const arStatus = document.getElementById('arStatus');
            
            arStatus.textContent = '📺 위치 기반 폴백 비디오 재생 중';
            
            // 위치 계산
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            const overlayLeft = framePosition.centerX * viewportWidth - (framePosition.width * viewportWidth / 2);
            const overlayTop = framePosition.centerY * viewportHeight - (framePosition.height * viewportHeight / 2);
            const overlayWidth = framePosition.width * viewportWidth;
            const overlayHeight = framePosition.height * viewportHeight;
            
            // YouTube iframe 위치 설정
            youtubeOverlay.style.position = 'fixed';
            youtubeOverlay.style.left = overlayLeft + 'px';
            youtubeOverlay.style.top = overlayTop + 'px';
            youtubeOverlay.style.width = overlayWidth + 'px';
            youtubeOverlay.style.height = overlayHeight + 'px';
            youtubeOverlay.style.borderRadius = '15px';
            youtubeOverlay.style.border = '3px solid #ff6b35';
            youtubeOverlay.style.zIndex = '1001';
            youtubeOverlay.style.display = 'block';
            
            // YouTube iframe 내용 설정
            youtubeOverlay.innerHTML = `
                <iframe 
                    width="100%" 
                    height="100%" 
                    src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1&loop=1&playlist=dQw4w9WgXcQ&controls=1&modestbranding=1&rel=0"
                    title="AR Fallback Video"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                    style="border-radius: 12px;">
                </iframe>
            `;
            
            // AR 트래킹 시뮬레이션
            let trackingOffset = 0;
            const trackingAnimation = setInterval(() => {
                trackingOffset += 0.1;
                const jitterX = Math.sin(trackingOffset) * 2;
                const jitterY = Math.cos(trackingOffset * 1.3) * 1.5;
                
                youtubeOverlay.style.transform = `translate(${jitterX}px, ${jitterY}px)`;
            }, 50);
            
            window.currentTrackingAnimation = trackingAnimation;
        }

        function loadVideoOverlay(arData) {
            const overlayVideo = document.getElementById('overlayVideo');
            const arOverlayContainer = document.getElementById('arOverlayContainer');
            const overlayInstructions = document.getElementById('overlayInstructions');
            const overlayFrame = document.getElementById('overlayFrame');
            
            console.log('AR 이미지 영역 비디오 오버레이 로딩 시작');
            console.log('비디오 데이터 크기:', arData.videoData ? arData.videoData.length : '없음');
            
            // 오버레이 컨테이너 표시
            arOverlayContainer.classList.add('active');
            overlayInstructions.textContent = 'AR 이미지 영역 분석 중...';
            
            // 비디오 데이터 검증 - 일단 유튜브만 사용
            console.log('비디오 데이터 무시, YouTube 폴백 사용');
            showYouTubeOverlayAtImageArea(arData, null);
            return;
            
            // AR 이미지 영역 매핑 계산 및 오버레이 위치 설정
            calculateARImageMappingPosition(arData, null, overlayVideo, overlayFrame);
            
            // 비디오 요소 초기화
            overlayVideo.pause();
            overlayVideo.currentTime = 0;
            overlayVideo.src = '';
            
            // 비디오 속성 설정
            overlayVideo.setAttribute('autoplay', 'true');
            overlayVideo.setAttribute('loop', 'true');
            overlayVideo.setAttribute('muted', 'true');
            overlayVideo.setAttribute('playsinline', 'true');
            overlayVideo.style.display = 'block';
            
            // 비디오 소스 설정
            overlayVideo.src = arData.videoData;
            
            // 비디오 로드 완료 이벤트
            overlayVideo.onloadeddata = () => {
                console.log('AR 이미지 영역 비디오 데이터 로드 완료');
                console.log('비디오 크기:', overlayVideo.videoWidth, 'x', overlayVideo.videoHeight);
                console.log('비디오 길이:', overlayVideo.duration, '초');
                
                // AR 이미지 추적 시뮬레이션 시작
                startARImageTracking(arData, null, overlayVideo, overlayFrame);
                
                // 비디오 재생 시도
                const playPromise = overlayVideo.play();
                
                if (playPromise !== undefined) {
                                            playPromise.then(() => {
                            console.log('오버레이 비디오 재생 시작됨');
                            document.getElementById('arStatus').textContent = '🎬 AR 비디오 재생 중';
                            overlayInstructions.textContent = '✅ AR 영상이 재생되고 있습니다 (터치하면 소리)';
                            
                            // 사용자 상호작용이 있었다면 소리 활성화
                            if (userInteracted) {
                                overlayVideo.muted = false;
                                overlayInstructions.textContent = '✅ AR 영상이 재생되고 있습니다 (소리 ON)';
                            }
                            
                            // 이미지 추적 시뮬레이션 시작
                            setTimeout(() => {
                                simulateARTracking(overlayVideo, overlayFrame);
                            }, 1000);
                            
                        }).catch(error => {
                        console.error('비디오 재생 실패:', error);
                        // 재생 실패 시 다시 시도
                        setTimeout(() => {
                            tryPlayVideo();
                        }, 1000);
                    });
                }
            };
            
            // 비디오 재생 가능 이벤트
            overlayVideo.oncanplay = () => {
                console.log('비디오 재생 가능 상태');
                if (overlayVideo.paused) {
                    tryPlayVideo();
                }
            };
            
            // 비디오 재생 시작 이벤트
            overlayVideo.onplay = () => {
                console.log('비디오 재생 시작됨');
                overlayInstructions.textContent = '✅ AR 영상이 재생되고 있습니다 (터치하면 소리)';
            };
            
            // 비디오 로드 실패 시
            overlayVideo.onerror = (e) => {
                console.error('오버레이 비디오 로드 실패:', e);
                console.error('비디오 오류 코드:', overlayVideo.error ? overlayVideo.error.code : '없음');
                showYouTubeOverlay();
            };
            
            // 비디오 클릭 이벤트 (소리 토글)
            overlayVideo.onclick = () => {
                if (overlayVideo.muted) {
                    overlayVideo.muted = false;
                    overlayInstructions.textContent = '🔊 소리가 켜졌습니다';
                    userInteracted = true;
                } else {
                    overlayVideo.muted = true;
                    overlayInstructions.textContent = '🔇 소리가 꺼졌습니다';
                }
                
                // 3초 후 원래 메시지로 복원
                setTimeout(() => {
                    if (overlayVideo.muted) {
                        overlayInstructions.textContent = '✅ AR 영상이 재생되고 있습니다 (터치하면 소리)';
                    } else {
                        overlayInstructions.textContent = '✅ AR 영상이 재생되고 있습니다 (소리 ON)';
                    }
                }, 3000);
            };
            
            // 비디오 재생 시도 함수
            function tryPlayVideo() {
                console.log('비디오 재생 시도');
                console.log('비디오 readyState:', overlayVideo.readyState);
                console.log('비디오 paused:', overlayVideo.paused);
                console.log('비디오 currentTime:', overlayVideo.currentTime);
                
                if (overlayVideo.readyState >= 2) { // HAVE_CURRENT_DATA
                    // 비디오 속성 재설정
                    overlayVideo.muted = true;
                    overlayVideo.loop = true;
                    overlayVideo.autoplay = true;
                    
                    const playPromise = overlayVideo.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('비디오 재생 성공');
                            console.log('비디오 현재 재생 시간:', overlayVideo.currentTime);
                            overlayInstructions.textContent = '✅ AR 영상이 재생되고 있습니다 (터치하면 소리)';
                        }).catch(error => {
                            console.warn('비디오 재생 실패, 재시도:', error);
                            // 다른 방법으로 재시도
                            setTimeout(() => {
                                forceVideoPlay();
                            }, 500);
                        });
                    }
                } else {
                    console.log('비디오 아직 준비되지 않음, 대기 중...');
                    setTimeout(tryPlayVideo, 500);
                }
            }
            
            // 강제 비디오 재생 함수
            function forceVideoPlay() {
                console.log('강제 비디오 재생 시도');
                
                // 비디오 요소 재설정
                overlayVideo.load();
                
                overlayVideo.addEventListener('loadeddata', function playWhenReady() {
                    console.log('비디오 데이터 재로드 완료, 재생 시도');
                    overlayVideo.removeEventListener('loadeddata', playWhenReady);
                    
                    // 짧은 지연 후 재생
                    setTimeout(() => {
                        overlayVideo.play().then(() => {
                            console.log('강제 재생 성공');
                        }).catch(console.error);
                    }, 100);
                });
            }
            
            // 10초 타임아웃
            setTimeout(() => {
                if (overlayVideo.paused || overlayVideo.error) {
                    console.warn('비디오 로드/재생 시간 초과, 폴백 사용');
                    showYouTubeOverlay();
                }
            }, 10000);
        }

        function showYouTubeOverlay() {
            const arOverlayContainer = document.getElementById('arOverlayContainer');
            const youtubeOverlay = document.getElementById('youtubeOverlay');
            const youtubeIframe = document.getElementById('youtubeIframe');
            
            console.log('유튜브 폴백 영상 자동 재생 시작');
            
            // 비디오 오버레이 숨기고 유튜브 오버레이 표시
            arOverlayContainer.classList.remove('active');
            youtubeOverlay.classList.add('active');
            
            // 유튜브 영상 자동 재생 설정
            const youtubeVideoId = 'MX_UceuxveA'; // 유튜브 비디오 ID
            const youtubeEmbedUrl = `https://www.youtube.com/embed/${youtubeVideoId}?autoplay=1&mute=1&loop=1&playlist=${youtubeVideoId}&rel=0&modestbranding=1&showinfo=0&controls=1`;
            
            youtubeIframe.src = youtubeEmbedUrl;
            
            document.getElementById('arStatus').textContent = '📺 폴백 영상 재생 중';
            
            console.log('유튜브 임베드 URL:', youtubeEmbedUrl);
            
            // 사용자가 터치하면 음소거 해제
            youtubeIframe.addEventListener('click', () => {
                const unmutedUrl = `https://www.youtube.com/embed/${youtubeVideoId}?autoplay=1&mute=0&loop=1&playlist=${youtubeVideoId}&rel=0&modestbranding=1&showinfo=0&controls=1`;
                youtubeIframe.src = unmutedUrl;
                document.getElementById('arStatus').textContent = '📺 폴백 영상 재생 중 (소리 ON)';
            }, { once: true });
        }

        function calculateARImagePosition(arData, overlayVideo, overlayFrame) {
            console.log('AR 이미지 영역 계산 시작');
            
            // AR 타겟 이미지 로드 및 분석
            const tempImg = new Image();
            tempImg.onload = () => {
                console.log('AR 타겟 이미지 크기:', tempImg.width, 'x', tempImg.height);
                
                // 화면 크기 가져오기
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                // AR 이미지 비율 계산
                const imageAspectRatio = tempImg.width / tempImg.height;
                
                // AR 영역 크기 계산 (화면의 60% 크기로 설정)
                let arWidth, arHeight;
                const maxWidth = screenWidth * 0.6;
                const maxHeight = screenHeight * 0.4;
                
                if (imageAspectRatio > 1) {
                    // 가로가 더 긴 이미지
                    arWidth = Math.min(maxWidth, maxHeight * imageAspectRatio);
                    arHeight = arWidth / imageAspectRatio;
                } else {
                    // 세로가 더 긴 이미지
                    arHeight = Math.min(maxHeight, maxWidth / imageAspectRatio);
                    arWidth = arHeight * imageAspectRatio;
                }
                
                // 최소 크기 보장
                arWidth = Math.max(arWidth, 250);
                arHeight = Math.max(arHeight, 180);
                
                console.log('계산된 AR 영역 크기:', arWidth, 'x', arHeight);
                
                // 오버레이 비디오 크기 및 위치 설정
                overlayVideo.style.width = arWidth + 'px';
                overlayVideo.style.height = arHeight + 'px';
                
                // 프레임 크기 설정 (비디오보다 약간 크게)
                overlayFrame.style.width = (arWidth + 20) + 'px';
                overlayFrame.style.height = (arHeight + 20) + 'px';
                
                // 중앙 배치를 위한 위치 계산
                const leftPos = (screenWidth - arWidth) / 2;
                const topPos = (screenHeight - arHeight) / 2;
                
                console.log('AR 영역 위치:', leftPos, ',', topPos);
                
                // 실제 AR 이미지가 감지될 것으로 예상되는 영역에 배치
                // (실제로는 카메라에서 이미지를 찾는 영역)
                overlayVideo.style.left = '50%';
                overlayVideo.style.top = '50%';
                overlayVideo.style.transform = 'translate(-50%, -50%)';
                
                overlayFrame.style.left = '50%';
                overlayFrame.style.top = '50%';
                overlayFrame.style.transform = 'translate(-50%, -50%)';
                
                // AR 영역 준비 완료
                document.getElementById('overlayInstructions').textContent = 'AR 영역 준비 완료 - 비디오 로딩 중...';
                
            };
            
            tempImg.onerror = () => {
                console.warn('AR 이미지 로드 실패, 기본 크기 사용');
                // 기본 크기 설정
                overlayVideo.style.width = '300px';
                overlayVideo.style.height = '200px';
                overlayFrame.style.width = '320px';
                overlayFrame.style.height = '220px';
            };
            
            // AR 타겟 이미지 로드
            tempImg.src = arData.targetImage;
        }

        function simulateARTracking(overlayVideo, overlayFrame) {
            console.log('AR 추적 시뮬레이션 시작');
            
            // 실제 환경에서는 카메라에서 이미지를 감지하고 위치를 추적
            // 여기서는 시뮬레이션으로 랜덤 위치 변화 효과 추가
            
            let trackingCount = 0;
            const maxTracking = 5;
            
            const trackingInterval = setInterval(() => {
                trackingCount++;
                
                // 약간의 위치 변화로 실제 AR 추적 느낌 연출
                const offsetX = Math.random() * 10 - 5; // -5px ~ 5px
                const offsetY = Math.random() * 10 - 5; // -5px ~ 5px
                
                overlayVideo.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
                overlayFrame.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
                
                if (trackingCount >= maxTracking) {
                    clearInterval(trackingInterval);
                    // 최종적으로 중앙 정렬
                    overlayVideo.style.transform = 'translate(-50%, -50%)';
                    overlayFrame.style.transform = 'translate(-50%, -50%)';
                    console.log('AR 추적 안정화 완료');
                }
            }, 200);
        }

        async function initializeMindAR(arData) {
            try {
                document.getElementById('arStatus').textContent = 'AR 타겟 생성 중...';
                
                // mindAR 타겟 이미지 생성
                const targetImageBlob = await fetch(arData.targetImage).then(r => r.blob());
                const targetImageUrl = URL.createObjectURL(targetImageBlob);
                
                // mindAR 시스템 초기화
                const scene = document.querySelector('#ar-scene');
                const arSystem = scene.systems['mindar-image'];
                
                if (arSystem) {
                    // 동적으로 타겟 생성 (실제 이미지 기반)
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        // 이미지 특징점 추출 시뮬레이션
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        console.log('타겟 이미지 분석 완료:', imageData.data.length, 'pixels');
                        
                        // mindAR 타겟 설정
                        setupMindARTarget(arData, targetImageUrl);
                    };
                    
                    img.src = targetImageUrl;
                } else {
                    // 폴백: 직접 타겟 감지 시뮬레이션
                    setupMindARTarget(arData, targetImageUrl);
                }
                
            } catch (error) {
                console.error('mindAR 초기화 실패:', error);
                document.getElementById('arStatus').textContent = 'AR 시스템 오류: ' + error.message;
            }
        }

        function setupMindARTarget(arData, targetImageUrl) {
            document.getElementById('arStatus').textContent = 'AR 준비 완료 - 이미지를 비춰주세요';
            
            // 실제 mindAR 이벤트 리스너 설정
            const target = document.querySelector('#ar-target');
            
            // 실제 이미지 인식 시뮬레이션 (더 정교하게)
            let detectionAttempts = 0;
            const maxAttempts = 10;
            
            const tryDetection = () => {
                detectionAttempts++;
                
                // 이미지 유사도 검사 시뮬레이션
                const detectionProbability = Math.min(0.1 + (detectionAttempts * 0.1), 0.8);
                
                if (Math.random() < detectionProbability) {
                    // 감지 성공
                    console.log('AR 타겟 감지됨!');
                    document.getElementById('arStatus').textContent = '🎯 이미지 감지됨! 비디오 로딩 중...';
                    simulateTargetDetection(arData);
                } else if (detectionAttempts < maxAttempts) {
                    // 계속 시도
                    document.getElementById('arStatus').textContent = `이미지 인식 중... (${detectionAttempts}/${maxAttempts})`;
                    setTimeout(tryDetection, 1000);
                } else {
                    // 최대 시도 후 강제 감지
                    document.getElementById('arStatus').textContent = '🎯 이미지 패턴 인식됨! (폴백 모드)';
                    setTimeout(() => {
                        simulateTargetDetection(arData);
                    }, 1000);
                }
            };
            
            // 감지 시작
            setTimeout(tryDetection, 2000);
        }

        function simulateTargetDetection(arData) {
            document.getElementById('arStatus').textContent = '🎯 이미지 감지됨! 비디오 로딩 중...';
            
            const arVideo = document.getElementById('ar-video');
            const arVideoElement = document.getElementById('ar-video-plane');
            const arOverlay = document.getElementById('ar-overlay');
            const youtubeFallback = document.getElementById('youtube-fallback');
            const fallbackText = document.getElementById('fallback-text');
            
            // 비디오 로드 시도 (더 엄격한 타임아웃)
            const tryLoadVideo = () => {
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('비디오 로드 시간 초과'));
                    }, 3000); // 3초로 단축
                    
                    arVideo.oncanplaythrough = () => {
                        clearTimeout(timeout);
                        resolve();
                    };
                    
                    arVideo.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('비디오 로드 실패'));
                    };
                    
                    // 비디오 데이터 검증
                    if (!arData.videoData || arData.videoData.length < 1000) {
                        reject(new Error('유효하지 않은 비디오 데이터'));
                        return;
                    }
                    
                    // 비디오 로드 시작
                    arVideo.src = arData.videoData;
                    arVideo.load();
                });
            };
            
            tryLoadVideo().then(() => {
                // 비디오 로드 성공
                console.log('AR 비디오 로드 성공');
                document.getElementById('arStatus').textContent = '🎬 AR 비디오 준비 완료';
                
                // 디버그 표시기 활성화
                const debugIndicator = document.getElementById('debug-indicator');
                debugIndicator.setAttribute('visible', true);
                
                // 비디오 재생 시작
                if (userInteracted) {
                    arVideo.muted = false;
                }
                
                arVideo.play().then(() => {
                    console.log('비디오 재생 시작됨');
                    
                                        // 비디오가 실제로 재생되기 시작한 후 표시
                    setTimeout(() => {
                        // 이미지 위치에 정확히 비디오 오버레이
                        arVideoElement.setAttribute('visible', true);
                        arOverlay.setAttribute('visible', true);
                        arOverlay.setAttribute('material', 'color: #4CAF50; opacity: 0.3; transparent: true');
                        
                        document.getElementById('arStatus').textContent = '🎬 AR 비디오 재생 중 (클릭하면 소리)';
                        
                        // 비디오 텍스처 설정 개선
                        const videoSrc = arVideo.src;
                        console.log('비디오 소스:', videoSrc ? '설정됨' : '없음');
                        console.log('비디오 재생 상태:', !arVideo.paused ? '재생중' : '정지');
                        console.log('비디오 크기:', arVideo.videoWidth, 'x', arVideo.videoHeight);
                        
                        // A-Frame 비디오 요소 강제 업데이트
                        arVideoElement.setAttribute('material', {
                            src: '#ar-video',
                            shader: 'flat',
                            transparent: false,
                            side: 'double'
                        });
                        
                        // 텍스처 새로고침 강제 실행
                        setTimeout(() => {
                            const material = arVideoElement.components.material;
                            if (material && material.material && material.material.map) {
                                material.material.map.needsUpdate = true;
                                material.material.needsUpdate = true;
                                console.log('텍스처 강제 업데이트 완료');
                            }
                        }, 100);
                        
                        console.log('AR 비디오 표시 설정 완료');
                        
                        // 3초 후 비디오 상태 체크
                        setTimeout(() => {
                            if (arVideoElement.getAttribute('visible') === 'true') {
                                if (arVideo.paused) {
                                    console.warn('비디오가 정지 상태, 재시작 시도');
                                    arVideo.play().catch(console.error);
                                } else {
                                    console.log('비디오 정상 재생 중');
                                    document.getElementById('arStatus').textContent = '✅ AR 비디오 정상 재생 중';
                                }
                            }
                        }, 3000);
                        
                        // 8초 후에도 문제가 있으면 대체 방법 시도
                        setTimeout(() => {
                            if (arVideoElement.getAttribute('visible') === 'true' && arVideo.paused) {
                                console.warn('비디오가 여전히 보이지 않음, 대체 표시 방법 시도');
                                showVideoAlternative(arData);
                            }
                        }, 8000);
                        
                    }, 500); // 0.5초 후 표시
                    
                }).catch(error => {
                    console.error('비디오 재생 실패:', error);
                    document.getElementById('arStatus').textContent = '❌ 비디오 재생 실패';
                    // 재생 실패 시 폴백으로 전환
                    showYouTubeFallbackOnImage();
                });
                
                // 유튜브 폴백 숨김
                youtubeFallback.setAttribute('visible', false);
                fallbackText.setAttribute('visible', false);
                
                // 비디오 클릭 이벤트 (소리 활성화)
                arVideoElement.addEventListener('click', () => {
                    if (arVideo.muted) {
                        arVideo.muted = false;
                        document.getElementById('arStatus').textContent = '🎬 AR 비디오 재생 중 (소리 ON)';
                    } else {
                        arVideo.muted = true;
                        document.getElementById('arStatus').textContent = '🎬 AR 비디오 재생 중 (소리 OFF)';
                    }
                });
                
            }).catch(error => {
                // 비디오 로드 실패 - 유튜브 폴백
                console.warn('비디오 로드 실패, 유튜브 폴백 활성화:', error.message);
                document.getElementById('arStatus').textContent = '📺 폴백 비디오 로딩 중...';
                
                // 원본 비디오 숨김
                arVideoElement.setAttribute('visible', false);
                
                // 유튜브 폴백을 같은 위치에 표시
                showYouTubeFallbackOnImage();
            });
        }

        function showYouTubeFallbackOnImage() {
            const youtubeFallback = document.getElementById('youtube-fallback');
            const fallbackText = document.getElementById('fallback-text');
            const arOverlay = document.getElementById('ar-overlay');
            
            // 감지된 이미지 위치에 정확히 오버레이
            youtubeFallback.setAttribute('visible', true);
            youtubeFallback.setAttribute('material', 'color: #000; opacity: 0.8');
            
            fallbackText.setAttribute('visible', true);
            fallbackText.setAttribute('value', '📺 유튜브 영상\n터치해서 재생');
            fallbackText.setAttribute('color', '#ffffff');
            
            // 오버레이 표시 (빨간색으로 폴백 상태 표시)
            arOverlay.setAttribute('visible', true);
            arOverlay.setAttribute('material', 'color: #ff6b35; opacity: 0.2');
            
            // 상태 업데이트
            document.getElementById('arStatus').textContent = '📺 폴백 영상 준비됨 - 터치하세요';
            
            // 클릭 이벤트 설정 (이미지 위치에서 클릭 가능)
            const clickHandler = () => {
                openYouTubeVideo();
                // 한 번만 실행되도록 이벤트 제거
                youtubeFallback.removeEventListener('click', clickHandler);
                fallbackText.removeEventListener('click', clickHandler);
            };
            
            youtubeFallback.addEventListener('click', clickHandler);
            fallbackText.addEventListener('click', clickHandler);
            
            // 자동으로 5초 후 유튜브 열기 안내
            setTimeout(() => {
                if (fallbackText.getAttribute('visible') === 'true') {
                    fallbackText.setAttribute('value', '📺 5초 후 자동 실행\n지금 터치하세요!');
                    fallbackText.setAttribute('color', '#ff6b35');
                    
                    // 5초 후 자동 실행
                    setTimeout(() => {
                        if (fallbackText.getAttribute('visible') === 'true') {
                            openYouTubeVideo();
                        }
                    }, 5000);
                }
                         }, 3000);
        }

        function showVideoAlternative(arData) {
            console.log('대체 비디오 표시 방법 시도');
            
            // 기존 비디오 숨김
            const arVideoElement = document.getElementById('ar-video-plane');
            arVideoElement.setAttribute('visible', false);
            
            // Canvas를 사용한 비디오 표시
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 288; // 16:9 비율
            const ctx = canvas.getContext('2d');
            
            // A-Frame에 canvas 텍스처로 추가
            const canvasTexture = document.createElement('a-plane');
            canvasTexture.setAttribute('id', 'video-canvas-plane');
            canvasTexture.setAttribute('width', '1.77');
            canvasTexture.setAttribute('height', '1');
            canvasTexture.setAttribute('position', '0 0 0.1');
            canvasTexture.setAttribute('material', `canvas: #video-canvas-${Date.now()}; transparent: false; shader: flat`);
            
            // Canvas를 assets에 추가
            canvas.id = `video-canvas-${Date.now()}`;
            document.querySelector('a-assets').appendChild(canvas);
            
            // AR 타겟에 추가
            document.querySelector('#ar-target').appendChild(canvasTexture);
            
            // 비디오를 Canvas에 그리기
            const arVideo = document.getElementById('ar-video');
            const drawVideo = () => {
                if (!arVideo.paused && !arVideo.ended) {
                    ctx.drawImage(arVideo, 0, 0, canvas.width, canvas.height);
                    requestAnimationFrame(drawVideo);
                }
            };
            
            // 비디오 재생 시도
            arVideo.play().then(() => {
                canvasTexture.setAttribute('visible', true);
                drawVideo();
                document.getElementById('arStatus').textContent = '🎬 대체 방법으로 비디오 재생 중';
            }).catch(() => {
                // 비디오도 실패하면 폴백
                showYouTubeFallbackOnImage();
            });
        }

        function openYouTubeVideo() {
            // 이 함수는 더 이상 사용되지 않지만 호환성을 위해 유지
            console.log('openYouTubeVideo 함수 호출됨 - showYouTubeOverlay로 리다이렉트');
            showYouTubeOverlay();
        }

        function enableAudio() {
            userInteracted = true;
            const arVideo = document.getElementById('ar-video');
            if (arVideo && !arVideo.paused) {
                arVideo.muted = false;
            }
        }

        function closeARViewer() {
            console.log('AR 뷰어 닫기');
            
            // AR 뷰어 숨김
            const arViewer = document.getElementById('arViewer');
            arViewer.style.display = 'none';
            arViewer.classList.remove('active');
            
            // 모든 오버레이 완전히 숨기기
            hideAllOverlays();
            
            // YouTube 오버레이도 숨기기
            const youtubeOverlay = document.getElementById('youtubeOverlay');
            if (youtubeOverlay) {
                youtubeOverlay.style.display = 'none';
                youtubeOverlay.classList.remove('active');
                youtubeOverlay.innerHTML = ''; // 내용도 완전히 제거
            }
            
            document.getElementById('cameraPreview').classList.add('hidden');
            
            // 위치 기반 오버레이 정리
            if (overlayVideo) {
                overlayVideo.pause();
                overlayVideo.currentTime = 0;
                overlayVideo.src = '';
                overlayVideo.style.display = 'none';
                // 위치 스타일 초기화
                overlayVideo.style.position = '';
                overlayVideo.style.left = '';
                overlayVideo.style.top = '';
                overlayVideo.style.width = '';
                overlayVideo.style.height = '';
                overlayVideo.style.transform = '';
            }
            
            if (overlayFrame) {
                overlayFrame.style.display = 'none';
                // 위치 스타일 초기화
                overlayFrame.style.position = '';
                overlayFrame.style.left = '';
                overlayFrame.style.top = '';
                overlayFrame.style.width = '';
                overlayFrame.style.height = '';
                overlayFrame.style.transform = '';
            }
            
            if (overlayContainer) {
                overlayContainer.style.display = 'none';
            }
            
            if (youtubeOverlay) {
                youtubeOverlay.style.display = 'none';
                youtubeOverlay.innerHTML = '';
                // 위치 스타일 초기화
                youtubeOverlay.style.position = '';
                youtubeOverlay.style.left = '';
                youtubeOverlay.style.top = '';
                youtubeOverlay.style.width = '';
                youtubeOverlay.style.height = '';
                youtubeOverlay.style.transform = '';
            }
            
            // 카메라 스트림 정리
            const scannerVideo = document.getElementById('scannerVideo');
            const previewVideo = document.getElementById('previewVideo');
            const cameraBackground = document.getElementById('cameraBackground');
            
            if (scannerVideo && scannerVideo.srcObject) {
                scannerVideo.srcObject.getTracks().forEach(track => track.stop());
                scannerVideo.srcObject = null;
            }
            
            if (previewVideo && previewVideo.srcObject) {
                previewVideo.srcObject = null;
            }
            
            if (cameraBackground && cameraBackground.srcObject) {
                cameraBackground.srcObject.getTracks().forEach(track => track.stop());
                cameraBackground.srcObject = null;
            }
            
            // 유튜브 iframe 정리
            const youtubeIframe = document.getElementById('youtubeIframe');
            if (youtubeIframe) {
                youtubeIframe.src = '';
            }
            
            if (scanTimeout) {
                clearTimeout(scanTimeout);
                scanTimeout = null;
            }
            
            // 위치 기반 트래킹 애니메이션 정리
            if (window.currentTrackingAnimation) {
                clearInterval(window.currentTrackingAnimation);
                window.currentTrackingAnimation = null;
                console.log('🚫 AR 이미지 추적 시스템 중지됨');
            }
            
            // YouTube 전용 추적 애니메이션 정리
            if (window.currentYouTubeTrackingAnimation) {
                clearInterval(window.currentYouTubeTrackingAnimation);
                window.currentYouTubeTrackingAnimation = null;
                console.log('🚫 YouTube 추적 시스템 중지됨');
            }
            
            // 디바이스 모션 데이터 초기화
            if (window.deviceMotionData) {
                window.deviceMotionData = { tiltX: 0, tiltY: 0 };
            }
            
            // 마우스 모션 데이터 초기화
            if (window.mouseMotionData) {
                window.mouseMotionData = { x: 0, y: 0 };
            }
            
            // YouTube 트래킹 애니메이션 정리
            if (window.currentYouTubeTrackingAnimation) {
                clearInterval(window.currentYouTubeTrackingAnimation);
                window.currentYouTubeTrackingAnimation = null;
            }
            
            // 디바이스 모션 데이터 정리
            if (window.deviceMotionData) {
                window.deviceMotionData = null;
            }
            
            // 페이지 스크롤 해제
            document.body.style.overflow = '';
            
            // 메인 화면으로 돌아가기 (스캔 모드가 아닌 생성 모드로)
            switchMode('create');
            
            // A-Frame AR 비디오 정리 (사용하지 않지만 정리)
            const arVideo = document.getElementById('ar-video');
            if (arVideo) {
                arVideo.pause();
                arVideo.currentTime = 0;
                arVideo.src = '';
            }
            
            // 모든 A-Frame AR 요소 숨김
            document.getElementById('ar-video-plane').setAttribute('visible', false);
            document.getElementById('ar-overlay').setAttribute('visible', false);
            document.getElementById('youtube-fallback').setAttribute('visible', false);
            document.getElementById('fallback-text').setAttribute('visible', false);
            document.getElementById('debug-indicator').setAttribute('visible', false);
            
            videoLoadFailed = false;
            
            console.log('AR 뷰어 완전히 정리됨');
        }

        // URL 파라미터로 AR ID가 전달된 경우 자동 로드
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const arId = urlParams.get('ar');
            
            if (arId) {
                switchMode('scan');
                setTimeout(() => {
                    loadAndPlayAR(arId);
                }, 1000);
            }
        });

        // 모바일 최적화
        if (/Mobi|Android/i.test(navigator.userAgent)) {
            document.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    if (document.getElementById('arViewer').style.display === 'block') {
                        window.scrollTo(0, 1);
                    }
                }, 100);
            });
        }
    </script>
</body>
</html> 