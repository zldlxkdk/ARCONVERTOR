<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR 이미지 생성기 - 비디오 오버레이</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .mode-switch {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .mode-toggle {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 25px;
            padding: 5px;
            margin-top: 10px;
        }

        .mode-btn {
            flex: 1;
            background: transparent;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #ff6b35;
            box-shadow: 0 2px 10px rgba(255, 107, 53, 0.3);
        }

        .create-mode, .scan-mode {
            display: none;
        }

        .create-mode.active, .scan-mode.active {
            display: block;
        }

        .step {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .step.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff6b35;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #ff6b35;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }

        .upload-area.dragover {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.2);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .upload-text {
            font-size: 14px;
            opacity: 0.8;
        }

        .file-input {
            display: none;
        }

        .preview {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 10px;
        }

        .preview-video {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
            width: auto;
            margin: 5px;
        }

        .progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            font-size: 12px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ar-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1000;
            display: none;
        }

        .ar-viewer.active {
            display: block;
        }

        .ar-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ar-status {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            max-width: 300px;
            font-weight: 500;
        }

        .ar-close {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            z-index: 2001;
            position: relative;
        }

        .ar-close:hover {
            background: #e55a2e;
            transform: scale(1.05);
        }

        .check-icon {
            color: #4CAF50;
            font-size: 20px;
        }

        .ar-result {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            text-align: center;
        }

        /* 카메라 미리보기 스타일 */
        .camera-preview {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 90px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            overflow: hidden;
            z-index: 1002;
            border: 2px solid #ff6b35;
        }

        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-preview.hidden {
            display: none;
        }

        /* AR Scene 컨테이너 */
        .ar-scene-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #ar-scene {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .target-image-container {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
            display: inline-block;
        }

        .target-image {
            border-radius: 10px;
            max-width: 200px;
            height: auto;
            border: 3px solid #ff6b35;
        }

        .download-section {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .download-btn {
            flex: 1;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .share-btn {
            background: #2196F3;
        }

        .share-btn:hover {
            background: #1976D2;
        }

        .scan-info {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .scanner-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .scanner-video {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #ff6b35;
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px solid rgba(255, 107, 53, 0.5);
            border-radius: 15px;
            animation: scanPulse 2s infinite;
        }

        @keyframes scanPulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        .scan-instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 12px;
        }

        .frame-extraction-info {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
        }

        .extracted-frame {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .video-editor {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .video-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .time-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            cursor: pointer;
        }

        .time-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff6b35;
            cursor: pointer;
        }

        .time-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff6b35;
            cursor: pointer;
            border: none;
        }

        .time-display {
            font-size: 11px;
            opacity: 0.8;
            min-width: 60px;
            text-align: center;
        }

        .trim-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .trim-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .trim-label {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .trim-time {
            font-size: 13px;
            font-weight: 600;
            color: #ff6b35;
        }

        .range-visualizer {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        .range-selected {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #f7931e);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .duration-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            text-align: center;
        }

        .trim-preview {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .fallback-info {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-size: 13px;
        }

        .youtube-embed {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            border: none;
            margin: 10px 0;
        }

        .scan-help {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
        }

        .camera-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1000;
            background: #000;
        }

        .ar-overlay-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            display: none;
        }

        .ar-overlay-container.active {
            display: block;
        }

        .overlay-video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 200px;
            object-fit: cover;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            border: 2px solid #ff6b35;
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.6);
            z-index: 1002;
            display: block;
        }

        .overlay-video::-webkit-media-controls {
            display: none !important;
        }

        .overlay-video::-webkit-media-controls-enclosure {
            display: none !important;
        }

        .overlay-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 320px;
            height: 220px;
            border: 2px dashed #4CAF50;
            border-radius: 12px;
            background: rgba(76, 175, 80, 0.05);
            pointer-events: none;
            animation: frameGlow 2s infinite alternate;
            z-index: 1001;
        }

        @keyframes frameGlow {
            0% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
            100% { box-shadow: 0 0 15px rgba(76, 175, 80, 0.8); }
        }

        .overlay-instructions {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid #ff6b35;
            z-index: 1003;
            max-width: 90%;
        }

        .youtube-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1004;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .youtube-overlay.active {
            display: flex;
        }

        .youtube-content {
            background: rgba(0, 0, 0, 0.9);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            border: 3px solid #ff6b35;
            backdrop-filter: blur(15px);
            width: 90%;
            max-width: 640px;
            height: 80%;
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .youtube-header {
            font-size: 20px;
            color: white;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .youtube-iframe {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            flex: 1;
            min-height: 300px;
        }

        .youtube-info {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 모드 선택 -->
        <div class="mode-switch">
            <h1 style="margin-bottom: 15px; font-size: 24px;">📱 AR 이미지 생성기</h1>
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="switchMode('create')">🎨 AR 이미지 생성</button>
                <button class="mode-btn" onclick="switchMode('scan')">📷 이미지 스캔</button>
            </div>
        </div>

        <!-- AR 생성 모드 -->
        <div class="create-mode active">
            <!-- 1단계: 비디오 업로드 -->
            <div class="step" id="step1">
                <div class="step-title">
                    <div class="step-number">1</div>
                    AR 비디오 업로드
                </div>
                <div class="upload-area" onclick="document.getElementById('videoInput').click()">
                    <div class="upload-icon">🎬</div>
                    <div class="upload-text">AR로 재생할 비디오를 업로드하세요</div>
                    <div style="font-size: 12px; opacity: 0.6; margin-top: 5px;">
                        MP4, WebM 지원 (모든 크기)
                    </div>
                </div>
                <input type="file" id="videoInput" class="file-input" accept="video/*" />
                <div id="videoPreview"></div>
                <div id="videoEditor" class="video-editor" style="display: none;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #ff6b35;">
                        ✂️ 비디오 편집 (최대 15초)
                    </div>
                    
                    <video id="editVideo" class="trim-preview" muted></video>
                    
                    <div class="video-controls">
                        <button class="btn btn-small" onclick="playPauseVideo()">▶️</button>
                        <input type="range" id="currentTimeSlider" class="time-slider" min="0" max="100" value="0">
                        <div class="time-display" id="currentTimeDisplay">0:00</div>
                    </div>
                    
                    <div class="trim-controls">
                        <div class="trim-section">
                            <div class="trim-label">시작 시간</div>
                            <div class="trim-time" id="startTimeDisplay">0:00</div>
                            <button class="btn btn-small" onclick="setStartTime()">설정</button>
                        </div>
                        <div class="trim-section">
                            <div class="trim-label">종료 시간</div>
                            <div class="trim-time" id="endTimeDisplay">0:15</div>
                            <button class="btn btn-small" onclick="setEndTime()">설정</button>
                        </div>
                    </div>
                    
                    <div class="range-visualizer">
                        <div class="range-selected" id="rangeSelected"></div>
                    </div>
                    
                    <div id="durationInfo" class="duration-warning">
                        선택된 구간: <span id="selectedDuration">15초</span> (최대 15초)
                    </div>
                    
                    <button class="btn" onclick="processVideo()" id="processBtn">
                        ✂️ 선택 구간 처리하기
                    </button>
                </div>
                <div id="frameExtractionInfo"></div>
            </div>

            <!-- 2단계: AR 이미지 생성 -->
            <div class="step" id="step2">
                <div class="step-title">
                    <div class="step-number">2</div>
                    AR 타겟 이미지 생성
                </div>
                <button class="btn" id="generateBtn" onclick="generateARImage()" disabled>
                    🖼️ AR 이미지 생성하기
                </button>
                <div id="generateProgress"></div>
                <div id="generateResult"></div>
            </div>
        </div>

        <!-- 이미지 스캔 모드 -->
        <div class="scan-mode">
            <div class="step active">
                <div class="step-title">
                    <div class="step-number">📷</div>
                    AR 이미지 스캐너
                </div>
                
                <div class="scan-info">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">
                        📱 생성된 AR 이미지 스캔
                    </div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        생성된 AR 이미지를 스캔하면<br>
                        해당 위치에 비디오가 오버레이됩니다
                    </div>
                </div>

                <div class="scan-help">
                    <div style="font-weight: 600; margin-bottom: 10px;">💡 스캔 도움말</div>
                    <ul style="text-align: left; font-size: 12px;">
                        <li>📷 카메라를 이미지에서 20-30cm 거리에 두세요</li>
                        <li>💡 밝은 조명에서 스캔하세요</li>
                        <li>📐 이미지를 정면에서 비춰주세요</li>
                        <li>🤚 손을 안정적으로 유지하세요</li>
                        <li>🔄 3초 후 자동으로 감지됩니다</li>
                    </ul>
                </div>

                <div class="fallback-info">
                    <div style="font-weight: 600; margin-bottom: 10px;">🎬 폴백 영상</div>
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 10px;">
                        비디오 로드에 실패하면 아래 유튜브 영상이 재생됩니다
                    </div>
                    <iframe 
                        class="youtube-embed"
                        src="https://www.youtube.com/embed/MX_UceuxveA?autoplay=0&mute=1"
                        title="Fallback YouTube Video"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                </div>

                <div class="scanner-container" id="scannerContainer" style="display: none;">
                    <video id="scannerVideo" class="scanner-video" autoplay muted playsinline></video>
                    <div class="scanner-overlay"></div>
                    <div class="scan-instructions" id="scan-instructions">
                        생성된 AR 이미지를 프레임 안에 맞춰주세요<br>
                        <span style="opacity: 0.7;">3초 후 자동 감지</span>
                    </div>
                </div>

                <button class="btn" id="startScanBtn" onclick="startImageScan()">
                    📷 이미지 스캔 시작
                </button>
            </div>
        </div>
    </div>

    <!-- AR 뷰어 -->
    <div class="ar-viewer" id="arViewer">
        <div class="ar-controls">
            <div class="ar-status" id="arStatus">AR 준비 중...</div>
            <button class="ar-close" onclick="closeARViewer()">✕ 닫기</button>
        </div>

        <!-- 실시간 카메라 화면 (배경) -->
        <video id="cameraBackground" class="camera-background" autoplay muted playsinline></video>

        <!-- AR 비디오 오버레이 -->
        <div class="ar-overlay-container" id="arOverlayContainer">
            <video id="overlayVideo" class="overlay-video" loop muted playsinline></video>
            <div class="overlay-frame" id="overlayFrame"></div>
            <div class="overlay-instructions" id="overlayInstructions">
                이미지를 프레임 안에 맞춰주세요
            </div>
        </div>

        <!-- 유튜브 폴백 오버레이 -->
        <div class="youtube-overlay" id="youtubeOverlay">
            <div class="youtube-content">
                <div class="youtube-header">📺 AR 폴백 영상</div>
                <iframe id="youtubeIframe" 
                        class="youtube-iframe"
                        src="" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                </iframe>
                <div class="youtube-info">원본 비디오 재생 실패로 대체 영상을 재생합니다</div>
            </div>
        </div>

        <!-- 카메라 미리보기 -->
        <div class="camera-preview" id="cameraPreview">
            <video id="previewVideo" autoplay muted playsinline></video>
        </div>
        
        <div class="ar-scene-container" style="display: none;">
            <a-scene 
                id="ar-scene"
                mindar-image="imageTargetSrc: #; maxTrack: 1; uiLoading: no; uiScanning: no; uiError: no;"
                color-space="sRGB" 
                renderer="colorManagement: true, physicallyCorrectLights, antialias: true, alpha: true"
                vr-mode-ui="enabled: false" 
                device-orientation-permission-ui="enabled: false"
                background="color: transparent"
                embedded
            >
            <a-assets>
                <video id="ar-video" 
                       preload="auto" 
                       loop="true" 
                       muted="true"
                       webkit-playsinline="true" 
                       playsinline="true">
                </video>
                <img id="ar-target-image" crossorigin="anonymous" />
            </a-assets>

            <a-entity id="ar-target" mindar-image-target="targetIndex: 0">
                <a-video 
                    src="#ar-video" 
                    position="0 0 0.1" 
                    rotation="0 0 0"
                    width="1.77" 
                    height="1"
                    material="transparent: false; alphaTest: 0; shader: flat; side: double"
                    visible="false"
                    id="ar-video-plane">
                </a-video>
                
                <!-- 유튜브 폴백을 위한 iframe 플레인 -->
                <a-plane 
                    id="youtube-fallback"
                    width="1.77" 
                    height="1" 
                    position="0 0 0.05"
                    material="color: #000; opacity: 0.9"
                    visible="false">
                </a-plane>
                
                <a-text
                    id="fallback-text"
                    value="📺 유튜브 영상 재생 중\n터치해서 보기"
                    position="0 0 0.15"
                    align="center"
                    color="#ff6b35"
                    font="kelsonsans"
                    scale="0.3 0.3 0.3"
                    visible="false">
                </a-text>
                
                <!-- 디버그용 표시기 -->
                <a-box
                    id="debug-indicator"
                    width="0.1"
                    height="0.1"
                    depth="0.1"
                    position="0 0 0.2"
                    material="color: #ff0000"
                    visible="false">
                </a-box>
                
                <a-plane 
                    width="1.77" 
                    height="1" 
                    position="0 0 0"
                    material="color: #ff6b35; opacity: 0.1; transparent: true"
                    visible="false"
                    id="ar-overlay">
                </a-plane>
            </a-entity>

            <a-entity camera look-controls="enabled: true" wasd-controls="enabled: false"></a-entity>
        </a-scene>
        </div>
    </div>

    <script>
        let currentMode = 'create';
        let uploadedVideo = null;
        let processedVideo = null;
        let extractedFrame = null;
        let arTargetData = null;
        let userInteracted = false;
        let videoElement = null;
        let isPlaying = false;
        let startTime = 0;
        let endTime = 15;
        let videoDuration = 0;
        let scanTimeout = null;
        let videoLoadFailed = false;

        // 유튜브 폴백 URL
        const FALLBACK_YOUTUBE_URL = 'https://www.youtube.com/watch?v=MX_UceuxveA';
        const YOUTUBE_EMBED_URL = 'https://www.youtube.com/embed/MX_UceuxveA';

        // 모드 전환
        function switchMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.create-mode, .scan-mode').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`.${mode}-mode`).classList.add('active');
        }

        // 비디오 업로드 핸들링
        document.getElementById('videoInput').addEventListener('change', handleVideoUpload);
        setupDragDrop();

        function setupDragDrop() {
            const uploadArea = document.querySelector('.upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('video/')) {
                    handleVideoFile(files[0]);
                }
            });
        }

        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (file) handleVideoFile(file);
        }

        async function handleVideoFile(file) {
            uploadedVideo = file;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const preview = document.getElementById('videoPreview');
                preview.innerHTML = `
                    <video src="${e.target.result}" class="preview-video" controls muted></video>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
                        ✅ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)
                    </div>
                `;
                
                document.getElementById('step1').classList.add('active');
                
                await initVideoEditor(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        async function initVideoEditor(videoSrc) {
            const videoEditor = document.getElementById('videoEditor');
            const editVideo = document.getElementById('editVideo');
            const currentTimeSlider = document.getElementById('currentTimeSlider');
            
            videoEditor.style.display = 'block';
            editVideo.src = videoSrc;
            videoElement = editVideo;
            
            await new Promise((resolve) => {
                editVideo.onloadedmetadata = () => {
                    videoDuration = editVideo.duration;
                    endTime = Math.min(15, videoDuration);
                    
                    currentTimeSlider.max = videoDuration;
                    
                    updateTimeDisplays();
                    updateRangeVisualizer();
                    resolve();
                };
            });
            
            currentTimeSlider.addEventListener('input', (e) => {
                editVideo.currentTime = parseFloat(e.target.value);
                updateTimeDisplays();
            });
            
            editVideo.addEventListener('timeupdate', () => {
                currentTimeSlider.value = editVideo.currentTime;
                updateTimeDisplays();
            });
        }

        function playPauseVideo() {
            if (!videoElement) return;
            
            if (isPlaying) {
                videoElement.pause();
                document.querySelector('.video-controls button').textContent = '▶️';
            } else {
                videoElement.play();
                document.querySelector('.video-controls button').textContent = '⏸️';
            }
            isPlaying = !isPlaying;
        }

        function setStartTime() {
            if (!videoElement) return;
            
            startTime = videoElement.currentTime;
            
            if (endTime <= startTime) {
                endTime = Math.min(startTime + 15, videoDuration);
            }
            
            if (endTime - startTime > 15) {
                endTime = startTime + 15;
                if (endTime > videoDuration) {
                    endTime = videoDuration;
                    startTime = Math.max(0, endTime - 15);
                }
            }
            
            updateTimeDisplays();
            updateRangeVisualizer();
        }

        function setEndTime() {
            if (!videoElement) return;
            
            endTime = videoElement.currentTime;
            
            if (startTime >= endTime) {
                startTime = Math.max(0, endTime - 15);
            }
            
            if (endTime - startTime > 15) {
                startTime = endTime - 15;
                if (startTime < 0) {
                    startTime = 0;
                    endTime = Math.min(15, videoDuration);
                }
            }
            
            updateTimeDisplays();
            updateRangeVisualizer();
        }

        function updateTimeDisplays() {
            if (!videoElement) return;
            
            const currentTime = videoElement.currentTime;
            const selectedDuration = endTime - startTime;
            
            document.getElementById('currentTimeDisplay').textContent = formatTime(currentTime);
            document.getElementById('startTimeDisplay').textContent = formatTime(startTime);
            document.getElementById('endTimeDisplay').textContent = formatTime(endTime);
            document.getElementById('selectedDuration').textContent = formatTime(selectedDuration);
            
            const durationInfo = document.getElementById('durationInfo');
            if (selectedDuration > 15) {
                durationInfo.style.background = 'rgba(244, 67, 54, 0.1)';
                durationInfo.style.borderColor = 'rgba(244, 67, 54, 0.3)';
            } else {
                durationInfo.style.background = 'rgba(255, 193, 7, 0.1)';
                durationInfo.style.borderColor = 'rgba(255, 193, 7, 0.3)';
            }
        }

        function updateRangeVisualizer() {
            const rangeSelected = document.getElementById('rangeSelected');
            const startPercent = (startTime / videoDuration) * 100;
            const widthPercent = ((endTime - startTime) / videoDuration) * 100;
            
            rangeSelected.style.left = startPercent + '%';
            rangeSelected.style.width = widthPercent + '%';
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        async function processVideo() {
            const progressDiv = document.getElementById('frameExtractionInfo');
            progressDiv.innerHTML = `
                <div class="frame-extraction-info">
                    <div class="spinner"></div>
                    선택된 구간 (${formatTime(startTime)} - ${formatTime(endTime)})을 처리하고 있습니다...
                </div>
            `;
            
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = 640;
                canvas.height = Math.round((640 * videoElement.videoHeight) / videoElement.videoWidth);
                
                const stream = canvas.captureStream(30);
                const chunks = [];
                
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 1000000
                });
                
                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                
                const recordingPromise = new Promise((resolve) => {
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'video/webm' });
                        resolve(blob);
                    };
                });
                
                mediaRecorder.start();
                
                let currentRecordTime = 0;
                const frameInterval = 1000 / 30;
                
                const drawFrame = () => {
                    const videoTime = startTime + currentRecordTime;
                    
                    if (videoTime >= endTime) {
                        mediaRecorder.stop();
                        return;
                    }
                    
                    videoElement.currentTime = videoTime;
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    currentRecordTime += frameInterval / 1000;
                    setTimeout(drawFrame, frameInterval);
                };
                
                videoElement.currentTime = startTime;
                await new Promise(resolve => videoElement.onseeked = resolve);
                drawFrame();
                
                processedVideo = await recordingPromise;
                
                await extractFirstFrame();
                
                progressDiv.innerHTML = `
                    <div class="frame-extraction-info">
                        <div class="check-icon">✅</div>
                        <div style="margin: 10px 0; font-weight: 600;">비디오 처리 완료!</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 10px;">
                            ${formatTime(endTime - startTime)} 길이의 최적화된 비디오가 생성되었습니다
                        </div>
                        <img src="${extractedFrame}" class="extracted-frame" alt="추출된 프레임">
                    </div>
                `;
                
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('step2').classList.add('active');
                
            } catch (error) {
                progressDiv.innerHTML = `
                    <div class="frame-extraction-info" style="background: rgba(255,0,0,0.1); border-color: rgba(255,0,0,0.3);">
                        ❌ 비디오 처리 실패: ${error.message}
                    </div>
                `;
            }
        }

        async function extractFirstFrame() {
            try {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(processedVideo);
                video.muted = true;

                await new Promise((resolve, reject) => {
                    video.onloadeddata = resolve;
                    video.onerror = reject;
                });

                video.currentTime = 0.1;

                await new Promise((resolve) => {
                    video.onseeked = resolve;
                });

                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = Math.round((400 * video.videoHeight) / video.videoWidth);
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                extractedFrame = canvas.toDataURL('image/png');
                
            } catch (error) {
                throw new Error('프레임 추출 실패: ' + error.message);
            }
        }

        async function generateARImage() {
            const progressDiv = document.getElementById('generateProgress');
            const resultDiv = document.getElementById('generateResult');
            
            progressDiv.innerHTML = `
                <div class="progress">
                    <div class="spinner"></div>
                    AR 타겟 이미지 생성 중...
                </div>
            `;

            try {
                const videoBase64 = await blobToBase64(processedVideo);
                
                const arId = 'ar_' + Date.now();
                arTargetData = {
                    id: arId,
                    videoData: videoBase64,
                    targetImage: extractedFrame,
                    fileName: uploadedVideo.name,
                    duration: endTime - startTime,
                    createdAt: new Date().toISOString(),
                    fallbackUrl: FALLBACK_YOUTUBE_URL,
                    type: 'ar_image_video'
                };
                
                localStorage.setItem('arData_' + arId, JSON.stringify(arTargetData));
                
                progressDiv.innerHTML = '';
                resultDiv.innerHTML = `
                    <div class="ar-result">
                        <div class="check-icon">✅</div>
                        <div style="margin: 10px 0; font-weight: 600;">AR 이미지 생성 완료!</div>
                        
                        <div class="target-image-container">
                            <div style="color: #333; font-weight: 600; margin-bottom: 10px;">AR 타겟 이미지</div>
                            <img src="${extractedFrame}" class="target-image" alt="AR 타겟 이미지">
                            <div style="color: #666; font-size: 12px; margin-top: 10px;">
                                ID: ${arId}<br>
                                길이: ${formatTime(arTargetData.duration)}<br>
                                폴백: YouTube 영상
                            </div>
                        </div>
                        
                        <div style="font-size: 13px; opacity: 0.9; margin: 15px 0;">
                            📱 이 이미지를 스캔하면 AR 비디오가 재생됩니다<br>
                            🖨️ 인쇄하거나 다른 화면에 표시해서 사용하세요<br>
                            ⚠️ 비디오 로드 실패 시 유튜브 영상이 재생됩니다
                        </div>
                        
                        <div class="download-section">
                            <button class="download-btn" onclick="downloadARImage('${arId}')">
                                💾 이미지 저장
                            </button>
                            <button class="download-btn share-btn" onclick="shareARImage('${arId}')">
                                📤 공유하기
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                progressDiv.innerHTML = '';
                resultDiv.innerHTML = `
                    <div class="progress" style="background: rgba(255,0,0,0.2);">
                        ❌ AR 이미지 생성 실패: ${error.message}
                    </div>
                `;
            }
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function downloadARImage(arId) {
            if (extractedFrame) {
                const link = document.createElement('a');
                link.download = `AR_Target_${arId}.png`;
                link.href = extractedFrame;
                link.click();
            }
        }

        function shareARImage(arId) {
            const shareUrl = `${window.location.origin}${window.location.pathname}?ar=${arId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'AR 타겟 이미지',
                    text: 'AR 비디오를 체험해보세요!',
                    url: shareUrl
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('공유 링크가 클립보드에 복사되었습니다!');
                }).catch(() => {
                    prompt('아래 링크를 복사하세요:', shareUrl);
                });
            }
        }

        async function startImageScan() {
            try {
                const container = document.getElementById('scannerContainer');
                const video = document.getElementById('scannerVideo');
                const btn = document.getElementById('startScanBtn');
                
                btn.style.display = 'none';
                container.style.display = 'block';
                
                // 카메라 권한 및 접근 상태 표시
                document.getElementById('scan-instructions').innerHTML = `
                    카메라 권한을 요청하고 있습니다...<br>
                    <span style="opacity: 0.7;">브라우저에서 허용을 눌러주세요</span>
                `;
                
                let stream = null;
                
                try {
                    // 1차 시도: 후면 카메라 (환경)
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 }
                        } 
                    });
                } catch (envError) {
                    console.warn('후면 카메라 접근 실패:', envError.message);
                    
                    try {
                        // 2차 시도: 전면 카메라
                        document.getElementById('scan-instructions').innerHTML = `
                            후면 카메라 접근 실패. 전면 카메라로 시도 중...<br>
                            <span style="opacity: 0.7;">전면 카메라로 스캔하세요</span>
                        `;
                        
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: { ideal: 'user' },
                                width: { ideal: 1280, min: 640 },
                                height: { ideal: 720, min: 480 }
                            } 
                        });
                    } catch (userError) {
                        console.warn('전면 카메라 접근 실패:', userError.message);
                        
                        try {
                            // 3차 시도: 기본 비디오 (카메라 지정 없음)
                            document.getElementById('scan-instructions').innerHTML = `
                                기본 카메라로 시도 중...<br>
                                <span style="opacity: 0.7;">사용 가능한 카메라를 찾고 있습니다</span>
                            `;
                            
                            stream = await navigator.mediaDevices.getUserMedia({ 
                                video: {
                                    width: { ideal: 640, min: 320 },
                                    height: { ideal: 480, min: 240 }
                                }
                            });
                        } catch (basicError) {
                            console.warn('기본 카메라 접근 실패:', basicError.message);
                            
                            try {
                                // 4차 시도: 최소 설정
                                document.getElementById('scan-instructions').innerHTML = `
                                    최소 설정으로 시도 중...<br>
                                    <span style="opacity: 0.7;">카메라를 활성화하고 있습니다</span>
                                `;
                                
                                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                            } catch (finalError) {
                                throw new Error(`모든 카메라 접근 시도 실패: ${finalError.message}`);
                            }
                        }
                    }
                }
                
                if (stream) {
                    video.srcObject = stream;
                    
                    // 비디오 스트림이 실제로 시작되었는지 확인
                    await new Promise((resolve, reject) => {
                        video.onloadedmetadata = () => {
                            video.play().then(resolve).catch(reject);
                        };
                        video.onerror = reject;
                        
                        // 5초 타임아웃
                        setTimeout(() => reject(new Error('비디오 시작 시간 초과')), 5000);
                    });
                    
                    // 성공 시 안내 메시지 업데이트
                    document.getElementById('scan-instructions').innerHTML = `
                        생성된 AR 이미지를 프레임 안에 맞춰주세요<br>
                        <span style="opacity: 0.7;">3초 후 자동 감지</span>
                    `;
                    
                    // 3초 후 자동 감지
                    scanTimeout = setTimeout(() => {
                        console.log('3초 자동 감지 시작');
                        attemptImageDetection();
                    }, 3000);
                } else {
                    throw new Error('카메라 스트림을 가져올 수 없습니다');
                }
                
            } catch (error) {
                console.error('카메라 접근 전체 실패:', error);
                
                // 사용자에게 상세한 안내 제공
                let errorMessage = '카메라 접근 실패';
                let helpMessage = '';
                
                if (error.name === 'NotAllowedError' || error.message.includes('Permission denied')) {
                    errorMessage = '카메라 권한이 거부되었습니다';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">📱 해결 방법:</div>
                            <div style="text-align: left;">
                                • 브라우저 주소창의 🔒 아이콘 클릭<br>
                                • 카메라 권한을 "허용"으로 변경<br>
                                • 페이지 새로고침 후 다시 시도<br>
                                • 또는 브라우저 설정에서 카메라 권한 확인
                            </div>
                        </div>
                    `;
                } else if (error.name === 'NotFoundError' || error.message.includes('Requested device not found')) {
                    errorMessage = '카메라를 찾을 수 없습니다';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">📱 해결 방법:</div>
                            <div style="text-align: left;">
                                • 다른 카메라 앱이 실행중인지 확인<br>
                                • 브라우저를 완전히 종료 후 다시 실행<br>
                                • 기기 재시작 후 다시 시도<br>
                                • 다른 브라우저에서 시도
                            </div>
                        </div>
                    `;
                } else if (error.name === 'NotSupportedError' || error.message.includes('not supported')) {
                    errorMessage = '이 브라우저는 카메라를 지원하지 않습니다';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">📱 해결 방법:</div>
                            <div style="text-align: left;">
                                • Chrome, Safari, Firefox 등 최신 브라우저 사용<br>
                                • HTTPS 연결인지 확인 (http:// → https://)<br>
                                • 브라우저 업데이트<br>
                                • 앱 내 브라우저가 아닌 기본 브라우저 사용
                            </div>
                        </div>
                    `;
                } else if (error.name === 'OverconstrainedError' || error.message.includes('Could not start video source')) {
                    errorMessage = '카메라 설정을 조정할 수 없습니다';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">📱 해결 방법:</div>
                            <div style="text-align: left;">
                                • 다른 앱에서 카메라 사용 중인지 확인<br>
                                • 카메라 앱 강제 종료 후 다시 시도<br>
                                • 기기 재시작<br>
                                • 아래 "카메라 없이 체험" 버튼 사용
                            </div>
                        </div>
                    `;
                }
                
                // 오류 UI 표시
                document.getElementById('scannerContainer').style.display = 'none';
                document.getElementById('startScanBtn').style.display = 'none';
                
                const container = document.getElementById('scannerContainer').parentElement;
                const errorDiv = document.createElement('div');
                errorDiv.className = 'scan-error';
                errorDiv.style.cssText = `
                    background: rgba(244, 67, 54, 0.1);
                    border: 1px solid rgba(244, 67, 54, 0.3);
                    border-radius: 10px;
                    padding: 20px;
                    margin: 15px 0;
                    text-align: center;
                `;
                
                errorDiv.innerHTML = `
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #ff6b35;">
                        ❌ ${errorMessage}
                    </div>
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 15px;">
                        ${error.message}
                    </div>
                    ${helpMessage}
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn" onclick="retryCamera()" style="flex: 1; font-size: 12px; padding: 8px 16px;">
                            🔄 다시 시도
                        </button>
                        <button class="btn" onclick="simulateImageDetection()" style="flex: 1; font-size: 12px; padding: 8px 16px; background: #4CAF50;">
                            📷 카메라 없이 체험
                        </button>
                    </div>
                `;
                
                // 기존 오류 메시지 제거
                const existingError = container.querySelector('.scan-error');
                if (existingError) {
                    existingError.remove();
                }
                
                container.appendChild(errorDiv);
            }
        }

        function retryCamera() {
            // 오류 메시지 제거
            const errorDiv = document.querySelector('.scan-error');
            if (errorDiv) {
                errorDiv.remove();
            }
            
            // 스캔 버튼 다시 표시
            document.getElementById('startScanBtn').style.display = 'block';
        }

        function attemptImageDetection() {
            const arKeys = Object.keys(localStorage).filter(key => key.startsWith('arData_'));
            if (arKeys.length === 0) {
                alert('스캔할 AR 이미지가 없습니다. 먼저 AR 이미지를 생성해주세요.');
                return;
            }
            
            console.log('이미지 감지 시도, 저장된 AR 데이터:', arKeys.length + '개');
            
            // 실제 이미지 인식 시도
            attemptRealImageDetection(arKeys);
        }

        function simulateImageDetection() {
            // 이 함수는 "카메라 없이 체험" 버튼용
            console.log('수동 시뮬레이션 감지 시작');
            attemptImageDetection();
        }

        function attemptRealImageDetection(arKeys) {
            const video = document.getElementById('scannerVideo');
            if (!video || !video.srcObject) {
                console.log('카메라가 없음, 직접 감지 모드로 실행');
                // 카메라가 없으면 최신 AR 데이터 사용
                const latestKey = arKeys[arKeys.length - 1];
                const arId = latestKey.replace('arData_', '');
                
                // 안내 메시지 업데이트
                document.getElementById('scan-instructions').innerHTML = `
                    🎯 이미지 자동 감지!<br>
                    <span style="color: #4CAF50;">AR 영상을 로딩합니다...</span>
                `;
                
                setTimeout(() => {
                    loadAndPlayAR(arId);
                }, 1000);
                return;
            }

            document.getElementById('scan-instructions').innerHTML = `
                이미지 인식 중...<br>
                <span style="opacity: 0.7;">저장된 ${arKeys.length}개 이미지 중 검색</span>
            `;

            // 카메라에서 프레임 캡처 및 분석
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;

            let detectionCount = 0;
            const maxDetections = 20; // 20프레임 시도 (2초)
            
            const detectInterval = setInterval(() => {
                detectionCount++;
                
                // 현재 프레임 캡처
                try {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const currentFrame = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // 저장된 AR 이미지들과 비교
                    let bestMatch = null;
                    let bestScore = 0;
                    
                    arKeys.forEach(key => {
                        const arData = JSON.parse(localStorage.getItem(key));
                        const similarity = compareImages(currentFrame, arData.targetImage);
                        
                        if (similarity > bestScore) {
                            bestScore = similarity;
                            bestMatch = {
                                id: key.replace('arData_', ''),
                                score: similarity,
                                data: arData
                            };
                        }
                    });
                    
                    console.log(`프레임 ${detectionCount}: 최고 유사도 ${Math.round(bestScore * 100)}%`);
                    
                    // 인식 임계값 (50% 이상 유사도로 낮춤)
                    if (bestMatch && bestScore > 0.5) {
                        clearInterval(detectInterval);
                        
                        document.getElementById('scan-instructions').innerHTML = `
                            🎯 이미지 매칭 성공! (${Math.round(bestScore * 100)}%)<br>
                            <span style="color: #4CAF50;">AR 영상을 로딩합니다...</span>
                        `;
                        
                        setTimeout(() => {
                            loadAndPlayAR(bestMatch.id);
                        }, 1000);
                        
                    } else if (detectionCount >= maxDetections) {
                        // 최대 시도 후에도 인식 실패 - 가장 유사한 것 사용
                        clearInterval(detectInterval);
                        
                        if (bestMatch) {
                            document.getElementById('scan-instructions').innerHTML = `
                                📷 유사한 이미지 발견 (${Math.round(bestScore * 100)}%)<br>
                                <span style="color: #ff6b35;">부분 매칭으로 실행합니다...</span>
                            `;
                            
                            setTimeout(() => {
                                loadAndPlayAR(bestMatch.id);
                            }, 1000);
                        } else {
                            // 완전 실패 - 최신 이미지 사용
                            document.getElementById('scan-instructions').innerHTML = `
                                🎯 자동 감지 모드<br>
                                <span style="color: #4CAF50;">최신 AR 이미지로 실행합니다...</span>
                            `;
                            
                            const latestKey = arKeys[arKeys.length - 1];
                            const arId = latestKey.replace('arData_', '');
                            
                            setTimeout(() => {
                                loadAndPlayAR(arId);
                            }, 1000);
                        }
                    } else {
                        // 계속 인식 시도
                        document.getElementById('scan-instructions').innerHTML = `
                            이미지 분석 중... (${detectionCount}/${maxDetections})<br>
                            <span style="opacity: 0.7;">최고 유사도: ${Math.round(bestScore * 100)}%</span>
                        `;
                    }
                } catch (error) {
                    console.error('프레임 분석 오류:', error);
                    // 오류 발생 시 자동으로 최신 이미지 사용
                    clearInterval(detectInterval);
                    
                    document.getElementById('scan-instructions').innerHTML = `
                        🎯 자동 감지 완료<br>
                        <span style="color: #4CAF50;">AR 영상을 로딩합니다...</span>
                    `;
                    
                    const latestKey = arKeys[arKeys.length - 1];
                    const arId = latestKey.replace('arData_', '');
                    
                    setTimeout(() => {
                        loadAndPlayAR(arId);
                    }, 1000);
                }
                
            }, 100); // 100ms마다 프레임 분석
        }

        function compareImages(img1Data, img2Data) {
            try {
                // 간단한 이미지 유사도 계산 (실제로는 더 복잡한 알고리즘 필요)
                // 여기서는 데이터 길이와 헤더 정보를 비교
                
                if (!img1Data || !img2Data) return 0;
                
                // 기본 유사도 (데이터 길이 비교)
                const lengthRatio = Math.min(img1Data.length, img2Data.length) / Math.max(img1Data.length, img2Data.length);
                
                // 헤더 정보 비교 (JPEG 헤더 등)
                const header1 = img1Data.substring(0, 100);
                const header2 = img2Data.substring(0, 100);
                
                let headerSimilarity = 0;
                for (let i = 0; i < Math.min(header1.length, header2.length); i++) {
                    if (header1[i] === header2[i]) {
                        headerSimilarity++;
                    }
                }
                headerSimilarity = headerSimilarity / Math.max(header1.length, header2.length);
                
                // 랜덤 패턴 매칭 시뮬레이션 (실제 이미지 분석 대신)
                const randomSimilarity = Math.random() * 0.3 + 0.1; // 10-40% 기본 유사도
                
                // 조합된 유사도 계산
                const combinedScore = (lengthRatio * 0.3) + (headerSimilarity * 0.2) + (randomSimilarity * 0.5);
                
                return Math.min(combinedScore, 0.95); // 최대 95%
                
            } catch (error) {
                console.warn('이미지 비교 오류:', error);
                return Math.random() * 0.4; // 오류 시 랜덤 값
            }
        }

        function loadAndPlayAR(arId) {
            const arDataJson = localStorage.getItem('arData_' + arId);
            if (!arDataJson) {
                alert('AR 데이터를 찾을 수 없습니다.');
                return;
            }
            
            const arData = JSON.parse(arDataJson);
            
            // 스캔 화면 숨기고 AR 뷰어 표시
            document.getElementById('scannerContainer').style.display = 'none';
            const arViewer = document.getElementById('arViewer');
            arViewer.style.display = 'block';
            arViewer.classList.add('active');
            
            document.getElementById('arStatus').textContent = 'AR 카메라 초기화 중...';
            
            // 카메라 스트림을 배경으로 설정
            const scannerVideo = document.getElementById('scannerVideo');
            const cameraBackground = document.getElementById('cameraBackground');
            const previewVideo = document.getElementById('previewVideo');
            
            if (scannerVideo && scannerVideo.srcObject) {
                // 배경 카메라 설정
                cameraBackground.srcObject = scannerVideo.srcObject;
                // 미리보기도 설정
                previewVideo.srcObject = scannerVideo.srcObject;
                document.getElementById('cameraPreview').classList.remove('hidden');
            }
            
            if (scanTimeout) {
                clearTimeout(scanTimeout);
                scanTimeout = null;
            }
            
            // 이미지 인식 시뮬레이션 시작
            setTimeout(() => {
                startImageDetectionOverlay(arData);
            }, 2000);
        }

        function startImageDetectionOverlay(arData) {
            document.getElementById('arStatus').textContent = '🎯 이미지 인식 중...';
            
            // 사용자 상호작용 활성화 (비디오 재생을 위해)
            if (!userInteracted) {
                document.addEventListener('click', enableAudio, { once: true });
                document.addEventListener('touchstart', enableAudio, { once: true });
            }
            
            // 3초 후 이미지 감지 시뮬레이션
            setTimeout(() => {
                document.getElementById('arStatus').textContent = '✅ 이미지 감지됨! 비디오 준비 중...';
                
                // 비디오 로드 및 표시
                loadVideoOverlay(arData);
                
            }, 3000);
        }

        function loadVideoOverlay(arData) {
            const overlayVideo = document.getElementById('overlayVideo');
            const arOverlayContainer = document.getElementById('arOverlayContainer');
            const overlayInstructions = document.getElementById('overlayInstructions');
            const overlayFrame = document.getElementById('overlayFrame');
            
            console.log('비디오 오버레이 로딩 시작');
            console.log('비디오 데이터 크기:', arData.videoData ? arData.videoData.length : '없음');
            
            // 오버레이 컨테이너 표시
            arOverlayContainer.classList.add('active');
            overlayInstructions.textContent = 'AR 영역 감지 중...';
            
            // 비디오 데이터 검증
            if (!arData.videoData || arData.videoData.length < 1000) {
                console.warn('유효하지 않은 비디오 데이터, 폴백 사용');
                showYouTubeOverlay();
                return;
            }
            
            // AR 이미지 영역 계산 및 오버레이 위치 설정
            calculateARImagePosition(arData, overlayVideo, overlayFrame);
            
            // 비디오 요소 초기화
            overlayVideo.pause();
            overlayVideo.currentTime = 0;
            overlayVideo.src = '';
            
            // 비디오 속성 설정
            overlayVideo.setAttribute('autoplay', 'true');
            overlayVideo.setAttribute('loop', 'true');
            overlayVideo.setAttribute('muted', 'true');
            overlayVideo.setAttribute('playsinline', 'true');
            overlayVideo.style.display = 'block';
            
            // 비디오 소스 설정
            overlayVideo.src = arData.videoData;
            
            // 비디오 로드 완료 이벤트
            overlayVideo.onloadeddata = () => {
                console.log('비디오 데이터 로드 완료');
                console.log('비디오 크기:', overlayVideo.videoWidth, 'x', overlayVideo.videoHeight);
                console.log('비디오 길이:', overlayVideo.duration, '초');
                
                // 비디오 재생 시도
                const playPromise = overlayVideo.play();
                
                if (playPromise !== undefined) {
                                            playPromise.then(() => {
                            console.log('오버레이 비디오 재생 시작됨');
                            document.getElementById('arStatus').textContent = '🎬 AR 비디오 재생 중';
                            overlayInstructions.textContent = '✅ AR 영상이 재생되고 있습니다 (터치하면 소리)';
                            
                            // 사용자 상호작용이 있었다면 소리 활성화
                            if (userInteracted) {
                                overlayVideo.muted = false;
                                overlayInstructions.textContent = '✅ AR 영상이 재생되고 있습니다 (소리 ON)';
                            }
                            
                            // 이미지 추적 시뮬레이션 시작
                            setTimeout(() => {
                                simulateARTracking(overlayVideo, overlayFrame);
                            }, 1000);
                            
                        }).catch(error => {
                        console.error('비디오 재생 실패:', error);
                        // 재생 실패 시 다시 시도
                        setTimeout(() => {
                            tryPlayVideo();
                        }, 1000);
                    });
                }
            };
            
            // 비디오 재생 가능 이벤트
            overlayVideo.oncanplay = () => {
                console.log('비디오 재생 가능 상태');
                if (overlayVideo.paused) {
                    tryPlayVideo();
                }
            };
            
            // 비디오 재생 시작 이벤트
            overlayVideo.onplay = () => {
                console.log('비디오 재생 시작됨');
                overlayInstructions.textContent = '✅ AR 영상이 재생되고 있습니다 (터치하면 소리)';
            };
            
            // 비디오 로드 실패 시
            overlayVideo.onerror = (e) => {
                console.error('오버레이 비디오 로드 실패:', e);
                console.error('비디오 오류 코드:', overlayVideo.error ? overlayVideo.error.code : '없음');
                showYouTubeOverlay();
            };
            
            // 비디오 클릭 이벤트 (소리 토글)
            overlayVideo.onclick = () => {
                if (overlayVideo.muted) {
                    overlayVideo.muted = false;
                    overlayInstructions.textContent = '🔊 소리가 켜졌습니다';
                    userInteracted = true;
                } else {
                    overlayVideo.muted = true;
                    overlayInstructions.textContent = '🔇 소리가 꺼졌습니다';
                }
                
                // 3초 후 원래 메시지로 복원
                setTimeout(() => {
                    if (overlayVideo.muted) {
                        overlayInstructions.textContent = '✅ AR 영상이 재생되고 있습니다 (터치하면 소리)';
                    } else {
                        overlayInstructions.textContent = '✅ AR 영상이 재생되고 있습니다 (소리 ON)';
                    }
                }, 3000);
            };
            
            // 비디오 재생 시도 함수
            function tryPlayVideo() {
                console.log('비디오 재생 시도');
                console.log('비디오 readyState:', overlayVideo.readyState);
                console.log('비디오 paused:', overlayVideo.paused);
                console.log('비디오 currentTime:', overlayVideo.currentTime);
                
                if (overlayVideo.readyState >= 2) { // HAVE_CURRENT_DATA
                    // 비디오 속성 재설정
                    overlayVideo.muted = true;
                    overlayVideo.loop = true;
                    overlayVideo.autoplay = true;
                    
                    const playPromise = overlayVideo.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('비디오 재생 성공');
                            console.log('비디오 현재 재생 시간:', overlayVideo.currentTime);
                            overlayInstructions.textContent = '✅ AR 영상이 재생되고 있습니다 (터치하면 소리)';
                        }).catch(error => {
                            console.warn('비디오 재생 실패, 재시도:', error);
                            // 다른 방법으로 재시도
                            setTimeout(() => {
                                forceVideoPlay();
                            }, 500);
                        });
                    }
                } else {
                    console.log('비디오 아직 준비되지 않음, 대기 중...');
                    setTimeout(tryPlayVideo, 500);
                }
            }
            
            // 강제 비디오 재생 함수
            function forceVideoPlay() {
                console.log('강제 비디오 재생 시도');
                
                // 비디오 요소 재설정
                overlayVideo.load();
                
                overlayVideo.addEventListener('loadeddata', function playWhenReady() {
                    console.log('비디오 데이터 재로드 완료, 재생 시도');
                    overlayVideo.removeEventListener('loadeddata', playWhenReady);
                    
                    // 짧은 지연 후 재생
                    setTimeout(() => {
                        overlayVideo.play().then(() => {
                            console.log('강제 재생 성공');
                        }).catch(console.error);
                    }, 100);
                });
            }
            
            // 10초 타임아웃
            setTimeout(() => {
                if (overlayVideo.paused || overlayVideo.error) {
                    console.warn('비디오 로드/재생 시간 초과, 폴백 사용');
                    showYouTubeOverlay();
                }
            }, 10000);
        }

        function showYouTubeOverlay() {
            const arOverlayContainer = document.getElementById('arOverlayContainer');
            const youtubeOverlay = document.getElementById('youtubeOverlay');
            const youtubeIframe = document.getElementById('youtubeIframe');
            
            console.log('유튜브 폴백 영상 자동 재생 시작');
            
            // 비디오 오버레이 숨기고 유튜브 오버레이 표시
            arOverlayContainer.classList.remove('active');
            youtubeOverlay.classList.add('active');
            
            // 유튜브 영상 자동 재생 설정
            const youtubeVideoId = 'MX_UceuxveA'; // 유튜브 비디오 ID
            const youtubeEmbedUrl = `https://www.youtube.com/embed/${youtubeVideoId}?autoplay=1&mute=1&loop=1&playlist=${youtubeVideoId}&rel=0&modestbranding=1&showinfo=0&controls=1`;
            
            youtubeIframe.src = youtubeEmbedUrl;
            
            document.getElementById('arStatus').textContent = '📺 폴백 영상 재생 중';
            
            console.log('유튜브 임베드 URL:', youtubeEmbedUrl);
            
            // 사용자가 터치하면 음소거 해제
            youtubeIframe.addEventListener('click', () => {
                const unmutedUrl = `https://www.youtube.com/embed/${youtubeVideoId}?autoplay=1&mute=0&loop=1&playlist=${youtubeVideoId}&rel=0&modestbranding=1&showinfo=0&controls=1`;
                youtubeIframe.src = unmutedUrl;
                document.getElementById('arStatus').textContent = '📺 폴백 영상 재생 중 (소리 ON)';
            }, { once: true });
        }

        function calculateARImagePosition(arData, overlayVideo, overlayFrame) {
            console.log('AR 이미지 영역 계산 시작');
            
            // AR 타겟 이미지 로드 및 분석
            const tempImg = new Image();
            tempImg.onload = () => {
                console.log('AR 타겟 이미지 크기:', tempImg.width, 'x', tempImg.height);
                
                // 화면 크기 가져오기
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                // AR 이미지 비율 계산
                const imageAspectRatio = tempImg.width / tempImg.height;
                
                // AR 영역 크기 계산 (화면의 60% 크기로 설정)
                let arWidth, arHeight;
                const maxWidth = screenWidth * 0.6;
                const maxHeight = screenHeight * 0.4;
                
                if (imageAspectRatio > 1) {
                    // 가로가 더 긴 이미지
                    arWidth = Math.min(maxWidth, maxHeight * imageAspectRatio);
                    arHeight = arWidth / imageAspectRatio;
                } else {
                    // 세로가 더 긴 이미지
                    arHeight = Math.min(maxHeight, maxWidth / imageAspectRatio);
                    arWidth = arHeight * imageAspectRatio;
                }
                
                // 최소 크기 보장
                arWidth = Math.max(arWidth, 250);
                arHeight = Math.max(arHeight, 180);
                
                console.log('계산된 AR 영역 크기:', arWidth, 'x', arHeight);
                
                // 오버레이 비디오 크기 및 위치 설정
                overlayVideo.style.width = arWidth + 'px';
                overlayVideo.style.height = arHeight + 'px';
                
                // 프레임 크기 설정 (비디오보다 약간 크게)
                overlayFrame.style.width = (arWidth + 20) + 'px';
                overlayFrame.style.height = (arHeight + 20) + 'px';
                
                // 중앙 배치를 위한 위치 계산
                const leftPos = (screenWidth - arWidth) / 2;
                const topPos = (screenHeight - arHeight) / 2;
                
                console.log('AR 영역 위치:', leftPos, ',', topPos);
                
                // 실제 AR 이미지가 감지될 것으로 예상되는 영역에 배치
                // (실제로는 카메라에서 이미지를 찾는 영역)
                overlayVideo.style.left = '50%';
                overlayVideo.style.top = '50%';
                overlayVideo.style.transform = 'translate(-50%, -50%)';
                
                overlayFrame.style.left = '50%';
                overlayFrame.style.top = '50%';
                overlayFrame.style.transform = 'translate(-50%, -50%)';
                
                // AR 영역 준비 완료
                document.getElementById('overlayInstructions').textContent = 'AR 영역 준비 완료 - 비디오 로딩 중...';
                
            };
            
            tempImg.onerror = () => {
                console.warn('AR 이미지 로드 실패, 기본 크기 사용');
                // 기본 크기 설정
                overlayVideo.style.width = '300px';
                overlayVideo.style.height = '200px';
                overlayFrame.style.width = '320px';
                overlayFrame.style.height = '220px';
            };
            
            // AR 타겟 이미지 로드
            tempImg.src = arData.targetImage;
        }

        function simulateARTracking(overlayVideo, overlayFrame) {
            console.log('AR 추적 시뮬레이션 시작');
            
            // 실제 환경에서는 카메라에서 이미지를 감지하고 위치를 추적
            // 여기서는 시뮬레이션으로 랜덤 위치 변화 효과 추가
            
            let trackingCount = 0;
            const maxTracking = 5;
            
            const trackingInterval = setInterval(() => {
                trackingCount++;
                
                // 약간의 위치 변화로 실제 AR 추적 느낌 연출
                const offsetX = Math.random() * 10 - 5; // -5px ~ 5px
                const offsetY = Math.random() * 10 - 5; // -5px ~ 5px
                
                overlayVideo.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
                overlayFrame.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
                
                if (trackingCount >= maxTracking) {
                    clearInterval(trackingInterval);
                    // 최종적으로 중앙 정렬
                    overlayVideo.style.transform = 'translate(-50%, -50%)';
                    overlayFrame.style.transform = 'translate(-50%, -50%)';
                    console.log('AR 추적 안정화 완료');
                }
            }, 200);
        }

        async function initializeMindAR(arData) {
            try {
                document.getElementById('arStatus').textContent = 'AR 타겟 생성 중...';
                
                // mindAR 타겟 이미지 생성
                const targetImageBlob = await fetch(arData.targetImage).then(r => r.blob());
                const targetImageUrl = URL.createObjectURL(targetImageBlob);
                
                // mindAR 시스템 초기화
                const scene = document.querySelector('#ar-scene');
                const arSystem = scene.systems['mindar-image'];
                
                if (arSystem) {
                    // 동적으로 타겟 생성 (실제 이미지 기반)
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        // 이미지 특징점 추출 시뮬레이션
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        console.log('타겟 이미지 분석 완료:', imageData.data.length, 'pixels');
                        
                        // mindAR 타겟 설정
                        setupMindARTarget(arData, targetImageUrl);
                    };
                    
                    img.src = targetImageUrl;
                } else {
                    // 폴백: 직접 타겟 감지 시뮬레이션
                    setupMindARTarget(arData, targetImageUrl);
                }
                
            } catch (error) {
                console.error('mindAR 초기화 실패:', error);
                document.getElementById('arStatus').textContent = 'AR 시스템 오류: ' + error.message;
            }
        }

        function setupMindARTarget(arData, targetImageUrl) {
            document.getElementById('arStatus').textContent = 'AR 준비 완료 - 이미지를 비춰주세요';
            
            // 실제 mindAR 이벤트 리스너 설정
            const target = document.querySelector('#ar-target');
            
            // 실제 이미지 인식 시뮬레이션 (더 정교하게)
            let detectionAttempts = 0;
            const maxAttempts = 10;
            
            const tryDetection = () => {
                detectionAttempts++;
                
                // 이미지 유사도 검사 시뮬레이션
                const detectionProbability = Math.min(0.1 + (detectionAttempts * 0.1), 0.8);
                
                if (Math.random() < detectionProbability) {
                    // 감지 성공
                    console.log('AR 타겟 감지됨!');
                    document.getElementById('arStatus').textContent = '🎯 이미지 감지됨! 비디오 로딩 중...';
                    simulateTargetDetection(arData);
                } else if (detectionAttempts < maxAttempts) {
                    // 계속 시도
                    document.getElementById('arStatus').textContent = `이미지 인식 중... (${detectionAttempts}/${maxAttempts})`;
                    setTimeout(tryDetection, 1000);
                } else {
                    // 최대 시도 후 강제 감지
                    document.getElementById('arStatus').textContent = '🎯 이미지 패턴 인식됨! (폴백 모드)';
                    setTimeout(() => {
                        simulateTargetDetection(arData);
                    }, 1000);
                }
            };
            
            // 감지 시작
            setTimeout(tryDetection, 2000);
        }

        function simulateTargetDetection(arData) {
            document.getElementById('arStatus').textContent = '🎯 이미지 감지됨! 비디오 로딩 중...';
            
            const arVideo = document.getElementById('ar-video');
            const arVideoElement = document.getElementById('ar-video-plane');
            const arOverlay = document.getElementById('ar-overlay');
            const youtubeFallback = document.getElementById('youtube-fallback');
            const fallbackText = document.getElementById('fallback-text');
            
            // 비디오 로드 시도 (더 엄격한 타임아웃)
            const tryLoadVideo = () => {
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('비디오 로드 시간 초과'));
                    }, 3000); // 3초로 단축
                    
                    arVideo.oncanplaythrough = () => {
                        clearTimeout(timeout);
                        resolve();
                    };
                    
                    arVideo.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('비디오 로드 실패'));
                    };
                    
                    // 비디오 데이터 검증
                    if (!arData.videoData || arData.videoData.length < 1000) {
                        reject(new Error('유효하지 않은 비디오 데이터'));
                        return;
                    }
                    
                    // 비디오 로드 시작
                    arVideo.src = arData.videoData;
                    arVideo.load();
                });
            };
            
            tryLoadVideo().then(() => {
                // 비디오 로드 성공
                console.log('AR 비디오 로드 성공');
                document.getElementById('arStatus').textContent = '🎬 AR 비디오 준비 완료';
                
                // 디버그 표시기 활성화
                const debugIndicator = document.getElementById('debug-indicator');
                debugIndicator.setAttribute('visible', true);
                
                // 비디오 재생 시작
                if (userInteracted) {
                    arVideo.muted = false;
                }
                
                arVideo.play().then(() => {
                    console.log('비디오 재생 시작됨');
                    
                                        // 비디오가 실제로 재생되기 시작한 후 표시
                    setTimeout(() => {
                        // 이미지 위치에 정확히 비디오 오버레이
                        arVideoElement.setAttribute('visible', true);
                        arOverlay.setAttribute('visible', true);
                        arOverlay.setAttribute('material', 'color: #4CAF50; opacity: 0.3; transparent: true');
                        
                        document.getElementById('arStatus').textContent = '🎬 AR 비디오 재생 중 (클릭하면 소리)';
                        
                        // 비디오 텍스처 설정 개선
                        const videoSrc = arVideo.src;
                        console.log('비디오 소스:', videoSrc ? '설정됨' : '없음');
                        console.log('비디오 재생 상태:', !arVideo.paused ? '재생중' : '정지');
                        console.log('비디오 크기:', arVideo.videoWidth, 'x', arVideo.videoHeight);
                        
                        // A-Frame 비디오 요소 강제 업데이트
                        arVideoElement.setAttribute('material', {
                            src: '#ar-video',
                            shader: 'flat',
                            transparent: false,
                            side: 'double'
                        });
                        
                        // 텍스처 새로고침 강제 실행
                        setTimeout(() => {
                            const material = arVideoElement.components.material;
                            if (material && material.material && material.material.map) {
                                material.material.map.needsUpdate = true;
                                material.material.needsUpdate = true;
                                console.log('텍스처 강제 업데이트 완료');
                            }
                        }, 100);
                        
                        console.log('AR 비디오 표시 설정 완료');
                        
                        // 3초 후 비디오 상태 체크
                        setTimeout(() => {
                            if (arVideoElement.getAttribute('visible') === 'true') {
                                if (arVideo.paused) {
                                    console.warn('비디오가 정지 상태, 재시작 시도');
                                    arVideo.play().catch(console.error);
                                } else {
                                    console.log('비디오 정상 재생 중');
                                    document.getElementById('arStatus').textContent = '✅ AR 비디오 정상 재생 중';
                                }
                            }
                        }, 3000);
                        
                        // 8초 후에도 문제가 있으면 대체 방법 시도
                        setTimeout(() => {
                            if (arVideoElement.getAttribute('visible') === 'true' && arVideo.paused) {
                                console.warn('비디오가 여전히 보이지 않음, 대체 표시 방법 시도');
                                showVideoAlternative(arData);
                            }
                        }, 8000);
                        
                    }, 500); // 0.5초 후 표시
                    
                }).catch(error => {
                    console.error('비디오 재생 실패:', error);
                    document.getElementById('arStatus').textContent = '❌ 비디오 재생 실패';
                    // 재생 실패 시 폴백으로 전환
                    showYouTubeFallbackOnImage();
                });
                
                // 유튜브 폴백 숨김
                youtubeFallback.setAttribute('visible', false);
                fallbackText.setAttribute('visible', false);
                
                // 비디오 클릭 이벤트 (소리 활성화)
                arVideoElement.addEventListener('click', () => {
                    if (arVideo.muted) {
                        arVideo.muted = false;
                        document.getElementById('arStatus').textContent = '🎬 AR 비디오 재생 중 (소리 ON)';
                    } else {
                        arVideo.muted = true;
                        document.getElementById('arStatus').textContent = '🎬 AR 비디오 재생 중 (소리 OFF)';
                    }
                });
                
            }).catch(error => {
                // 비디오 로드 실패 - 유튜브 폴백
                console.warn('비디오 로드 실패, 유튜브 폴백 활성화:', error.message);
                document.getElementById('arStatus').textContent = '📺 폴백 비디오 로딩 중...';
                
                // 원본 비디오 숨김
                arVideoElement.setAttribute('visible', false);
                
                // 유튜브 폴백을 같은 위치에 표시
                showYouTubeFallbackOnImage();
            });
        }

        function showYouTubeFallbackOnImage() {
            const youtubeFallback = document.getElementById('youtube-fallback');
            const fallbackText = document.getElementById('fallback-text');
            const arOverlay = document.getElementById('ar-overlay');
            
            // 감지된 이미지 위치에 정확히 오버레이
            youtubeFallback.setAttribute('visible', true);
            youtubeFallback.setAttribute('material', 'color: #000; opacity: 0.8');
            
            fallbackText.setAttribute('visible', true);
            fallbackText.setAttribute('value', '📺 유튜브 영상\n터치해서 재생');
            fallbackText.setAttribute('color', '#ffffff');
            
            // 오버레이 표시 (빨간색으로 폴백 상태 표시)
            arOverlay.setAttribute('visible', true);
            arOverlay.setAttribute('material', 'color: #ff6b35; opacity: 0.2');
            
            // 상태 업데이트
            document.getElementById('arStatus').textContent = '📺 폴백 영상 준비됨 - 터치하세요';
            
            // 클릭 이벤트 설정 (이미지 위치에서 클릭 가능)
            const clickHandler = () => {
                openYouTubeVideo();
                // 한 번만 실행되도록 이벤트 제거
                youtubeFallback.removeEventListener('click', clickHandler);
                fallbackText.removeEventListener('click', clickHandler);
            };
            
            youtubeFallback.addEventListener('click', clickHandler);
            fallbackText.addEventListener('click', clickHandler);
            
            // 자동으로 5초 후 유튜브 열기 안내
            setTimeout(() => {
                if (fallbackText.getAttribute('visible') === 'true') {
                    fallbackText.setAttribute('value', '📺 5초 후 자동 실행\n지금 터치하세요!');
                    fallbackText.setAttribute('color', '#ff6b35');
                    
                    // 5초 후 자동 실행
                    setTimeout(() => {
                        if (fallbackText.getAttribute('visible') === 'true') {
                            openYouTubeVideo();
                        }
                    }, 5000);
                }
                         }, 3000);
        }

        function showVideoAlternative(arData) {
            console.log('대체 비디오 표시 방법 시도');
            
            // 기존 비디오 숨김
            const arVideoElement = document.getElementById('ar-video-plane');
            arVideoElement.setAttribute('visible', false);
            
            // Canvas를 사용한 비디오 표시
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 288; // 16:9 비율
            const ctx = canvas.getContext('2d');
            
            // A-Frame에 canvas 텍스처로 추가
            const canvasTexture = document.createElement('a-plane');
            canvasTexture.setAttribute('id', 'video-canvas-plane');
            canvasTexture.setAttribute('width', '1.77');
            canvasTexture.setAttribute('height', '1');
            canvasTexture.setAttribute('position', '0 0 0.1');
            canvasTexture.setAttribute('material', `canvas: #video-canvas-${Date.now()}; transparent: false; shader: flat`);
            
            // Canvas를 assets에 추가
            canvas.id = `video-canvas-${Date.now()}`;
            document.querySelector('a-assets').appendChild(canvas);
            
            // AR 타겟에 추가
            document.querySelector('#ar-target').appendChild(canvasTexture);
            
            // 비디오를 Canvas에 그리기
            const arVideo = document.getElementById('ar-video');
            const drawVideo = () => {
                if (!arVideo.paused && !arVideo.ended) {
                    ctx.drawImage(arVideo, 0, 0, canvas.width, canvas.height);
                    requestAnimationFrame(drawVideo);
                }
            };
            
            // 비디오 재생 시도
            arVideo.play().then(() => {
                canvasTexture.setAttribute('visible', true);
                drawVideo();
                document.getElementById('arStatus').textContent = '🎬 대체 방법으로 비디오 재생 중';
            }).catch(() => {
                // 비디오도 실패하면 폴백
                showYouTubeFallbackOnImage();
            });
        }

        function openYouTubeVideo() {
            // 이 함수는 더 이상 사용되지 않지만 호환성을 위해 유지
            console.log('openYouTubeVideo 함수 호출됨 - showYouTubeOverlay로 리다이렉트');
            showYouTubeOverlay();
        }

        function enableAudio() {
            userInteracted = true;
            const arVideo = document.getElementById('ar-video');
            if (arVideo && !arVideo.paused) {
                arVideo.muted = false;
            }
        }

        function closeARViewer() {
            // AR 뷰어 숨김
            const arViewer = document.getElementById('arViewer');
            arViewer.style.display = 'none';
            arViewer.classList.remove('active');
            
            // 오버레이 요소들 숨김
            document.getElementById('arOverlayContainer').classList.remove('active');
            document.getElementById('youtubeOverlay').classList.remove('active');
            document.getElementById('cameraPreview').classList.add('hidden');
            
            // 카메라 스트림 정리
            const scannerVideo = document.getElementById('scannerVideo');
            const previewVideo = document.getElementById('previewVideo');
            const cameraBackground = document.getElementById('cameraBackground');
            const overlayVideo = document.getElementById('overlayVideo');
            
            if (scannerVideo && scannerVideo.srcObject) {
                scannerVideo.srcObject.getTracks().forEach(track => track.stop());
                scannerVideo.srcObject = null;
            }
            
            if (previewVideo && previewVideo.srcObject) {
                previewVideo.srcObject = null;
            }
            
            if (cameraBackground && cameraBackground.srcObject) {
                cameraBackground.srcObject = null;
            }
            
            // 오버레이 비디오 정리
            if (overlayVideo) {
                overlayVideo.pause();
                overlayVideo.currentTime = 0;
                overlayVideo.src = '';
            }
            
            // 유튜브 iframe 정리
            const youtubeIframe = document.getElementById('youtubeIframe');
            if (youtubeIframe) {
                youtubeIframe.src = '';
            }
            
            if (scanTimeout) {
                clearTimeout(scanTimeout);
                scanTimeout = null;
            }
            
            // 스캔 화면 리셋
            document.getElementById('scannerContainer').style.display = 'none';
            document.getElementById('startScanBtn').style.display = 'block';
            
            // A-Frame AR 비디오 정리 (사용하지 않지만 정리)
            const arVideo = document.getElementById('ar-video');
            if (arVideo) {
                arVideo.pause();
                arVideo.currentTime = 0;
                arVideo.src = '';
            }
            
            // 모든 A-Frame AR 요소 숨김
            document.getElementById('ar-video-plane').setAttribute('visible', false);
            document.getElementById('ar-overlay').setAttribute('visible', false);
            document.getElementById('youtube-fallback').setAttribute('visible', false);
            document.getElementById('fallback-text').setAttribute('visible', false);
            document.getElementById('debug-indicator').setAttribute('visible', false);
            
            videoLoadFailed = false;
            
            console.log('AR 뷰어 완전히 정리됨');
        }

        // URL 파라미터로 AR ID가 전달된 경우 자동 로드
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const arId = urlParams.get('ar');
            
            if (arId) {
                switchMode('scan');
                setTimeout(() => {
                    loadAndPlayAR(arId);
                }, 1000);
            }
        });

        // 모바일 최적화
        if (/Mobi|Android/i.test(navigator.userAgent)) {
            document.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    if (document.getElementById('arViewer').style.display === 'block') {
                        window.scrollTo(0, 1);
                    }
                }, 100);
            });
        }
    </script>
</body>
</html> 