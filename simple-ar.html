<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR ì´ë¯¸ì§€ ìƒì„±ê¸° - ë¹„ë””ì˜¤ ì˜¤ë²„ë ˆì´</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .mode-switch {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .mode-toggle {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 25px;
            padding: 5px;
            margin-top: 10px;
        }

        .mode-btn {
            flex: 1;
            background: transparent;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #ff6b35;
            box-shadow: 0 2px 10px rgba(255, 107, 53, 0.3);
        }

        .create-mode, .scan-mode {
            display: none;
        }

        .create-mode.active, .scan-mode.active {
            display: block;
        }

        .step {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .step.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff6b35;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #ff6b35;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }

        .upload-area.dragover {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.2);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .upload-text {
            font-size: 14px;
            opacity: 0.8;
        }

        .file-input {
            display: none;
        }

        .preview {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 10px;
        }

        .preview-video {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
            width: auto;
            margin: 5px;
        }

        .progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            font-size: 12px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ar-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1000;
            display: none;
        }

        .ar-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ar-status {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            backdrop-filter: blur(10px);
            max-width: 250px;
        }

        .ar-close {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .check-icon {
            color: #4CAF50;
            font-size: 20px;
        }

        .ar-result {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            text-align: center;
        }

        .target-image-container {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
            display: inline-block;
        }

        .target-image {
            border-radius: 10px;
            max-width: 200px;
            height: auto;
            border: 3px solid #ff6b35;
        }

        .download-section {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .download-btn {
            flex: 1;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .share-btn {
            background: #2196F3;
        }

        .share-btn:hover {
            background: #1976D2;
        }

        #ar-scene {
            width: 100%;
            height: 100%;
        }

        .scan-info {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .scanner-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .scanner-video {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #ff6b35;
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px solid rgba(255, 107, 53, 0.5);
            border-radius: 15px;
            animation: scanPulse 2s infinite;
        }

        @keyframes scanPulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        .scan-instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 12px;
        }

        .frame-extraction-info {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
        }

        .extracted-frame {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .video-editor {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .video-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .time-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            cursor: pointer;
        }

        .time-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff6b35;
            cursor: pointer;
        }

        .time-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff6b35;
            cursor: pointer;
            border: none;
        }

        .time-display {
            font-size: 11px;
            opacity: 0.8;
            min-width: 60px;
            text-align: center;
        }

        .trim-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .trim-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .trim-label {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .trim-time {
            font-size: 13px;
            font-weight: 600;
            color: #ff6b35;
        }

        .range-visualizer {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        .range-selected {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #f7931e);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .duration-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            text-align: center;
        }

        .trim-preview {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .fallback-info {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-size: 13px;
        }

        .youtube-embed {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            border: none;
            margin: 10px 0;
        }

        .scan-help {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ëª¨ë“œ ì„ íƒ -->
        <div class="mode-switch">
            <h1 style="margin-bottom: 15px; font-size: 24px;">ğŸ“± AR ì´ë¯¸ì§€ ìƒì„±ê¸°</h1>
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="switchMode('create')">ğŸ¨ AR ì´ë¯¸ì§€ ìƒì„±</button>
                <button class="mode-btn" onclick="switchMode('scan')">ğŸ“· ì´ë¯¸ì§€ ìŠ¤ìº”</button>
            </div>
        </div>

        <!-- AR ìƒì„± ëª¨ë“œ -->
        <div class="create-mode active">
            <!-- 1ë‹¨ê³„: ë¹„ë””ì˜¤ ì—…ë¡œë“œ -->
            <div class="step" id="step1">
                <div class="step-title">
                    <div class="step-number">1</div>
                    AR ë¹„ë””ì˜¤ ì—…ë¡œë“œ
                </div>
                <div class="upload-area" onclick="document.getElementById('videoInput').click()">
                    <div class="upload-icon">ğŸ¬</div>
                    <div class="upload-text">ARë¡œ ì¬ìƒí•  ë¹„ë””ì˜¤ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                    <div style="font-size: 12px; opacity: 0.6; margin-top: 5px;">
                        MP4, WebM ì§€ì› (ëª¨ë“  í¬ê¸°)
                    </div>
                </div>
                <input type="file" id="videoInput" class="file-input" accept="video/*" />
                <div id="videoPreview"></div>
                <div id="videoEditor" class="video-editor" style="display: none;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #ff6b35;">
                        âœ‚ï¸ ë¹„ë””ì˜¤ í¸ì§‘ (ìµœëŒ€ 15ì´ˆ)
                    </div>
                    
                    <video id="editVideo" class="trim-preview" muted></video>
                    
                    <div class="video-controls">
                        <button class="btn btn-small" onclick="playPauseVideo()">â–¶ï¸</button>
                        <input type="range" id="currentTimeSlider" class="time-slider" min="0" max="100" value="0">
                        <div class="time-display" id="currentTimeDisplay">0:00</div>
                    </div>
                    
                    <div class="trim-controls">
                        <div class="trim-section">
                            <div class="trim-label">ì‹œì‘ ì‹œê°„</div>
                            <div class="trim-time" id="startTimeDisplay">0:00</div>
                            <button class="btn btn-small" onclick="setStartTime()">ì„¤ì •</button>
                        </div>
                        <div class="trim-section">
                            <div class="trim-label">ì¢…ë£Œ ì‹œê°„</div>
                            <div class="trim-time" id="endTimeDisplay">0:15</div>
                            <button class="btn btn-small" onclick="setEndTime()">ì„¤ì •</button>
                        </div>
                    </div>
                    
                    <div class="range-visualizer">
                        <div class="range-selected" id="rangeSelected"></div>
                    </div>
                    
                    <div id="durationInfo" class="duration-warning">
                        ì„ íƒëœ êµ¬ê°„: <span id="selectedDuration">15ì´ˆ</span> (ìµœëŒ€ 15ì´ˆ)
                    </div>
                    
                    <button class="btn" onclick="processVideo()" id="processBtn">
                        âœ‚ï¸ ì„ íƒ êµ¬ê°„ ì²˜ë¦¬í•˜ê¸°
                    </button>
                </div>
                <div id="frameExtractionInfo"></div>
            </div>

            <!-- 2ë‹¨ê³„: AR ì´ë¯¸ì§€ ìƒì„± -->
            <div class="step" id="step2">
                <div class="step-title">
                    <div class="step-number">2</div>
                    AR íƒ€ê²Ÿ ì´ë¯¸ì§€ ìƒì„±
                </div>
                <button class="btn" id="generateBtn" onclick="generateARImage()" disabled>
                    ğŸ–¼ï¸ AR ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°
                </button>
                <div id="generateProgress"></div>
                <div id="generateResult"></div>
            </div>
        </div>

        <!-- ì´ë¯¸ì§€ ìŠ¤ìº” ëª¨ë“œ -->
        <div class="scan-mode">
            <div class="step active">
                <div class="step-title">
                    <div class="step-number">ğŸ“·</div>
                    AR ì´ë¯¸ì§€ ìŠ¤ìºë„ˆ
                </div>
                
                <div class="scan-info">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">
                        ğŸ“± ìƒì„±ëœ AR ì´ë¯¸ì§€ ìŠ¤ìº”
                    </div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        ìƒì„±ëœ AR ì´ë¯¸ì§€ë¥¼ ìŠ¤ìº”í•˜ë©´<br>
                        í•´ë‹¹ ìœ„ì¹˜ì— ë¹„ë””ì˜¤ê°€ ì˜¤ë²„ë ˆì´ë©ë‹ˆë‹¤
                    </div>
                </div>

                <div class="scan-help">
                    <div style="font-weight: 600; margin-bottom: 10px;">ğŸ’¡ ìŠ¤ìº” ë„ì›€ë§</div>
                    <ul style="text-align: left; font-size: 12px;">
                        <li>ğŸ“· ì¹´ë©”ë¼ë¥¼ ì´ë¯¸ì§€ì—ì„œ 20-30cm ê±°ë¦¬ì— ë‘ì„¸ìš”</li>
                        <li>ğŸ’¡ ë°ì€ ì¡°ëª…ì—ì„œ ìŠ¤ìº”í•˜ì„¸ìš”</li>
                        <li>ğŸ“ ì´ë¯¸ì§€ë¥¼ ì •ë©´ì—ì„œ ë¹„ì¶°ì£¼ì„¸ìš”</li>
                        <li>ğŸ¤š ì†ì„ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€í•˜ì„¸ìš”</li>
                        <li>ğŸ”„ 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ê°ì§€ë©ë‹ˆë‹¤</li>
                    </ul>
                </div>

                <div class="fallback-info">
                    <div style="font-weight: 600; margin-bottom: 10px;">ğŸ¬ í´ë°± ì˜ìƒ</div>
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 10px;">
                        ë¹„ë””ì˜¤ ë¡œë“œì— ì‹¤íŒ¨í•˜ë©´ ì•„ë˜ ìœ íŠœë¸Œ ì˜ìƒì´ ì¬ìƒë©ë‹ˆë‹¤
                    </div>
                    <iframe 
                        class="youtube-embed"
                        src="https://www.youtube.com/embed/MX_UceuxveA?autoplay=0&mute=1"
                        title="Fallback YouTube Video"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                </div>

                <div class="scanner-container" id="scannerContainer" style="display: none;">
                    <video id="scannerVideo" class="scanner-video" autoplay muted playsinline></video>
                    <div class="scanner-overlay"></div>
                    <div class="scan-instructions" id="scan-instructions">
                        ìƒì„±ëœ AR ì´ë¯¸ì§€ë¥¼ í”„ë ˆì„ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”<br>
                        <span style="opacity: 0.7;">3ì´ˆ í›„ ìë™ ê°ì§€</span>
                    </div>
                </div>

                <button class="btn" id="startScanBtn" onclick="startImageScan()">
                    ğŸ“· ì´ë¯¸ì§€ ìŠ¤ìº” ì‹œì‘
                </button>
            </div>
        </div>
    </div>

    <!-- AR ë·°ì–´ -->
    <div class="ar-viewer" id="arViewer">
        <div class="ar-controls">
            <div class="ar-status" id="arStatus">AR ì¤€ë¹„ ì¤‘...</div>
            <button class="ar-close" onclick="closeARViewer()">âœ• ë‹«ê¸°</button>
        </div>
        
        <a-scene 
            id="ar-scene"
            mindar-image="imageTargetSrc: #; maxTrack: 1; uiLoading: no; uiScanning: no; uiError: no;"
            color-space="sRGB" 
            renderer="colorManagement: true, physicallyCorrectLights, antialias: true, alpha: true"
            vr-mode-ui="enabled: false" 
            device-orientation-permission-ui="enabled: false"
            background="color: transparent"
            embedded
        >
            <a-assets>
                <video id="ar-video" 
                       preload="auto" 
                       loop="true" 
                       muted="true"
                       webkit-playsinline="true" 
                       playsinline="true">
                </video>
                <img id="ar-target-image" crossorigin="anonymous" />
            </a-assets>

            <a-entity id="ar-target" mindar-image-target="targetIndex: 0">
                <a-video 
                    src="#ar-video" 
                    position="0 0 0.1" 
                    rotation="0 0 0"
                    width="1.77" 
                    height="1"
                    material="transparent: false; alphaTest: 0; shader: flat; side: double"
                    visible="false"
                    id="ar-video-plane">
                </a-video>
                
                <!-- ìœ íŠœë¸Œ í´ë°±ì„ ìœ„í•œ iframe í”Œë ˆì¸ -->
                <a-plane 
                    id="youtube-fallback"
                    width="1.77" 
                    height="1" 
                    position="0 0 0.05"
                    material="color: #000; opacity: 0.9"
                    visible="false">
                </a-plane>
                
                <a-text
                    id="fallback-text"
                    value="ğŸ“º ìœ íŠœë¸Œ ì˜ìƒ ì¬ìƒ ì¤‘\ní„°ì¹˜í•´ì„œ ë³´ê¸°"
                    position="0 0 0.15"
                    align="center"
                    color="#ff6b35"
                    font="kelsonsans"
                    scale="0.3 0.3 0.3"
                    visible="false">
                </a-text>
                
                <!-- ë””ë²„ê·¸ìš© í‘œì‹œê¸° -->
                <a-box
                    id="debug-indicator"
                    width="0.1"
                    height="0.1"
                    depth="0.1"
                    position="0 0 0.2"
                    material="color: #ff0000"
                    visible="false">
                </a-box>
                
                <a-plane 
                    width="1.77" 
                    height="1" 
                    position="0 0 0"
                    material="color: #ff6b35; opacity: 0.1; transparent: true"
                    visible="false"
                    id="ar-overlay">
                </a-plane>
            </a-entity>

            <a-entity camera look-controls="enabled: true" wasd-controls="enabled: false"></a-entity>
        </a-scene>
    </div>

    <script>
        let currentMode = 'create';
        let uploadedVideo = null;
        let processedVideo = null;
        let extractedFrame = null;
        let arTargetData = null;
        let userInteracted = false;
        let videoElement = null;
        let isPlaying = false;
        let startTime = 0;
        let endTime = 15;
        let videoDuration = 0;
        let scanTimeout = null;
        let videoLoadFailed = false;

        // ìœ íŠœë¸Œ í´ë°± URL
        const FALLBACK_YOUTUBE_URL = 'https://www.youtube.com/watch?v=MX_UceuxveA';
        const YOUTUBE_EMBED_URL = 'https://www.youtube.com/embed/MX_UceuxveA';

        // ëª¨ë“œ ì „í™˜
        function switchMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.create-mode, .scan-mode').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`.${mode}-mode`).classList.add('active');
        }

        // ë¹„ë””ì˜¤ ì—…ë¡œë“œ í•¸ë“¤ë§
        document.getElementById('videoInput').addEventListener('change', handleVideoUpload);
        setupDragDrop();

        function setupDragDrop() {
            const uploadArea = document.querySelector('.upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('video/')) {
                    handleVideoFile(files[0]);
                }
            });
        }

        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (file) handleVideoFile(file);
        }

        async function handleVideoFile(file) {
            uploadedVideo = file;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const preview = document.getElementById('videoPreview');
                preview.innerHTML = `
                    <video src="${e.target.result}" class="preview-video" controls muted></video>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
                        âœ… ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)
                    </div>
                `;
                
                document.getElementById('step1').classList.add('active');
                
                await initVideoEditor(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        async function initVideoEditor(videoSrc) {
            const videoEditor = document.getElementById('videoEditor');
            const editVideo = document.getElementById('editVideo');
            const currentTimeSlider = document.getElementById('currentTimeSlider');
            
            videoEditor.style.display = 'block';
            editVideo.src = videoSrc;
            videoElement = editVideo;
            
            await new Promise((resolve) => {
                editVideo.onloadedmetadata = () => {
                    videoDuration = editVideo.duration;
                    endTime = Math.min(15, videoDuration);
                    
                    currentTimeSlider.max = videoDuration;
                    
                    updateTimeDisplays();
                    updateRangeVisualizer();
                    resolve();
                };
            });
            
            currentTimeSlider.addEventListener('input', (e) => {
                editVideo.currentTime = parseFloat(e.target.value);
                updateTimeDisplays();
            });
            
            editVideo.addEventListener('timeupdate', () => {
                currentTimeSlider.value = editVideo.currentTime;
                updateTimeDisplays();
            });
        }

        function playPauseVideo() {
            if (!videoElement) return;
            
            if (isPlaying) {
                videoElement.pause();
                document.querySelector('.video-controls button').textContent = 'â–¶ï¸';
            } else {
                videoElement.play();
                document.querySelector('.video-controls button').textContent = 'â¸ï¸';
            }
            isPlaying = !isPlaying;
        }

        function setStartTime() {
            if (!videoElement) return;
            
            startTime = videoElement.currentTime;
            
            if (endTime <= startTime) {
                endTime = Math.min(startTime + 15, videoDuration);
            }
            
            if (endTime - startTime > 15) {
                endTime = startTime + 15;
                if (endTime > videoDuration) {
                    endTime = videoDuration;
                    startTime = Math.max(0, endTime - 15);
                }
            }
            
            updateTimeDisplays();
            updateRangeVisualizer();
        }

        function setEndTime() {
            if (!videoElement) return;
            
            endTime = videoElement.currentTime;
            
            if (startTime >= endTime) {
                startTime = Math.max(0, endTime - 15);
            }
            
            if (endTime - startTime > 15) {
                startTime = endTime - 15;
                if (startTime < 0) {
                    startTime = 0;
                    endTime = Math.min(15, videoDuration);
                }
            }
            
            updateTimeDisplays();
            updateRangeVisualizer();
        }

        function updateTimeDisplays() {
            if (!videoElement) return;
            
            const currentTime = videoElement.currentTime;
            const selectedDuration = endTime - startTime;
            
            document.getElementById('currentTimeDisplay').textContent = formatTime(currentTime);
            document.getElementById('startTimeDisplay').textContent = formatTime(startTime);
            document.getElementById('endTimeDisplay').textContent = formatTime(endTime);
            document.getElementById('selectedDuration').textContent = formatTime(selectedDuration);
            
            const durationInfo = document.getElementById('durationInfo');
            if (selectedDuration > 15) {
                durationInfo.style.background = 'rgba(244, 67, 54, 0.1)';
                durationInfo.style.borderColor = 'rgba(244, 67, 54, 0.3)';
            } else {
                durationInfo.style.background = 'rgba(255, 193, 7, 0.1)';
                durationInfo.style.borderColor = 'rgba(255, 193, 7, 0.3)';
            }
        }

        function updateRangeVisualizer() {
            const rangeSelected = document.getElementById('rangeSelected');
            const startPercent = (startTime / videoDuration) * 100;
            const widthPercent = ((endTime - startTime) / videoDuration) * 100;
            
            rangeSelected.style.left = startPercent + '%';
            rangeSelected.style.width = widthPercent + '%';
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        async function processVideo() {
            const progressDiv = document.getElementById('frameExtractionInfo');
            progressDiv.innerHTML = `
                <div class="frame-extraction-info">
                    <div class="spinner"></div>
                    ì„ íƒëœ êµ¬ê°„ (${formatTime(startTime)} - ${formatTime(endTime)})ì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                </div>
            `;
            
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = 640;
                canvas.height = Math.round((640 * videoElement.videoHeight) / videoElement.videoWidth);
                
                const stream = canvas.captureStream(30);
                const chunks = [];
                
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 1000000
                });
                
                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                
                const recordingPromise = new Promise((resolve) => {
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'video/webm' });
                        resolve(blob);
                    };
                });
                
                mediaRecorder.start();
                
                let currentRecordTime = 0;
                const frameInterval = 1000 / 30;
                
                const drawFrame = () => {
                    const videoTime = startTime + currentRecordTime;
                    
                    if (videoTime >= endTime) {
                        mediaRecorder.stop();
                        return;
                    }
                    
                    videoElement.currentTime = videoTime;
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    currentRecordTime += frameInterval / 1000;
                    setTimeout(drawFrame, frameInterval);
                };
                
                videoElement.currentTime = startTime;
                await new Promise(resolve => videoElement.onseeked = resolve);
                drawFrame();
                
                processedVideo = await recordingPromise;
                
                await extractFirstFrame();
                
                progressDiv.innerHTML = `
                    <div class="frame-extraction-info">
                        <div class="check-icon">âœ…</div>
                        <div style="margin: 10px 0; font-weight: 600;">ë¹„ë””ì˜¤ ì²˜ë¦¬ ì™„ë£Œ!</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 10px;">
                            ${formatTime(endTime - startTime)} ê¸¸ì´ì˜ ìµœì í™”ëœ ë¹„ë””ì˜¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤
                        </div>
                        <img src="${extractedFrame}" class="extracted-frame" alt="ì¶”ì¶œëœ í”„ë ˆì„">
                    </div>
                `;
                
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('step2').classList.add('active');
                
            } catch (error) {
                progressDiv.innerHTML = `
                    <div class="frame-extraction-info" style="background: rgba(255,0,0,0.1); border-color: rgba(255,0,0,0.3);">
                        âŒ ë¹„ë””ì˜¤ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}
                    </div>
                `;
            }
        }

        async function extractFirstFrame() {
            try {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(processedVideo);
                video.muted = true;

                await new Promise((resolve, reject) => {
                    video.onloadeddata = resolve;
                    video.onerror = reject;
                });

                video.currentTime = 0.1;

                await new Promise((resolve) => {
                    video.onseeked = resolve;
                });

                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = Math.round((400 * video.videoHeight) / video.videoWidth);
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                extractedFrame = canvas.toDataURL('image/png');
                
            } catch (error) {
                throw new Error('í”„ë ˆì„ ì¶”ì¶œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        async function generateARImage() {
            const progressDiv = document.getElementById('generateProgress');
            const resultDiv = document.getElementById('generateResult');
            
            progressDiv.innerHTML = `
                <div class="progress">
                    <div class="spinner"></div>
                    AR íƒ€ê²Ÿ ì´ë¯¸ì§€ ìƒì„± ì¤‘...
                </div>
            `;

            try {
                const videoBase64 = await blobToBase64(processedVideo);
                
                const arId = 'ar_' + Date.now();
                arTargetData = {
                    id: arId,
                    videoData: videoBase64,
                    targetImage: extractedFrame,
                    fileName: uploadedVideo.name,
                    duration: endTime - startTime,
                    createdAt: new Date().toISOString(),
                    fallbackUrl: FALLBACK_YOUTUBE_URL,
                    type: 'ar_image_video'
                };
                
                localStorage.setItem('arData_' + arId, JSON.stringify(arTargetData));
                
                progressDiv.innerHTML = '';
                resultDiv.innerHTML = `
                    <div class="ar-result">
                        <div class="check-icon">âœ…</div>
                        <div style="margin: 10px 0; font-weight: 600;">AR ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!</div>
                        
                        <div class="target-image-container">
                            <div style="color: #333; font-weight: 600; margin-bottom: 10px;">AR íƒ€ê²Ÿ ì´ë¯¸ì§€</div>
                            <img src="${extractedFrame}" class="target-image" alt="AR íƒ€ê²Ÿ ì´ë¯¸ì§€">
                            <div style="color: #666; font-size: 12px; margin-top: 10px;">
                                ID: ${arId}<br>
                                ê¸¸ì´: ${formatTime(arTargetData.duration)}<br>
                                í´ë°±: YouTube ì˜ìƒ
                            </div>
                        </div>
                        
                        <div style="font-size: 13px; opacity: 0.9; margin: 15px 0;">
                            ğŸ“± ì´ ì´ë¯¸ì§€ë¥¼ ìŠ¤ìº”í•˜ë©´ AR ë¹„ë””ì˜¤ê°€ ì¬ìƒë©ë‹ˆë‹¤<br>
                            ğŸ–¨ï¸ ì¸ì‡„í•˜ê±°ë‚˜ ë‹¤ë¥¸ í™”ë©´ì— í‘œì‹œí•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”<br>
                            âš ï¸ ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìœ íŠœë¸Œ ì˜ìƒì´ ì¬ìƒë©ë‹ˆë‹¤
                        </div>
                        
                        <div class="download-section">
                            <button class="download-btn" onclick="downloadARImage('${arId}')">
                                ğŸ’¾ ì´ë¯¸ì§€ ì €ì¥
                            </button>
                            <button class="download-btn share-btn" onclick="shareARImage('${arId}')">
                                ğŸ“¤ ê³µìœ í•˜ê¸°
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                progressDiv.innerHTML = '';
                resultDiv.innerHTML = `
                    <div class="progress" style="background: rgba(255,0,0,0.2);">
                        âŒ AR ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨: ${error.message}
                    </div>
                `;
            }
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function downloadARImage(arId) {
            if (extractedFrame) {
                const link = document.createElement('a');
                link.download = `AR_Target_${arId}.png`;
                link.href = extractedFrame;
                link.click();
            }
        }

        function shareARImage(arId) {
            const shareUrl = `${window.location.origin}${window.location.pathname}?ar=${arId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'AR íƒ€ê²Ÿ ì´ë¯¸ì§€',
                    text: 'AR ë¹„ë””ì˜¤ë¥¼ ì²´í—˜í•´ë³´ì„¸ìš”!',
                    url: shareUrl
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('ê³µìœ  ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }).catch(() => {
                    prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:', shareUrl);
                });
            }
        }

        async function startImageScan() {
            try {
                const container = document.getElementById('scannerContainer');
                const video = document.getElementById('scannerVideo');
                const btn = document.getElementById('startScanBtn');
                
                btn.style.display = 'none';
                container.style.display = 'block';
                
                // ì¹´ë©”ë¼ ê¶Œí•œ ë° ì ‘ê·¼ ìƒíƒœ í‘œì‹œ
                document.getElementById('scan-instructions').innerHTML = `
                    ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br>
                    <span style="opacity: 0.7;">ë¸Œë¼ìš°ì €ì—ì„œ í—ˆìš©ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</span>
                `;
                
                let stream = null;
                
                try {
                    // 1ì°¨ ì‹œë„: í›„ë©´ ì¹´ë©”ë¼ (í™˜ê²½)
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 }
                        } 
                    });
                } catch (envError) {
                    console.warn('í›„ë©´ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', envError.message);
                    
                    try {
                        // 2ì°¨ ì‹œë„: ì „ë©´ ì¹´ë©”ë¼
                        document.getElementById('scan-instructions').innerHTML = `
                            í›„ë©´ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨. ì „ë©´ ì¹´ë©”ë¼ë¡œ ì‹œë„ ì¤‘...<br>
                            <span style="opacity: 0.7;">ì „ë©´ ì¹´ë©”ë¼ë¡œ ìŠ¤ìº”í•˜ì„¸ìš”</span>
                        `;
                        
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: { ideal: 'user' },
                                width: { ideal: 1280, min: 640 },
                                height: { ideal: 720, min: 480 }
                            } 
                        });
                    } catch (userError) {
                        console.warn('ì „ë©´ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', userError.message);
                        
                        try {
                            // 3ì°¨ ì‹œë„: ê¸°ë³¸ ë¹„ë””ì˜¤ (ì¹´ë©”ë¼ ì§€ì • ì—†ìŒ)
                            document.getElementById('scan-instructions').innerHTML = `
                                ê¸°ë³¸ ì¹´ë©”ë¼ë¡œ ì‹œë„ ì¤‘...<br>
                                <span style="opacity: 0.7;">ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤</span>
                            `;
                            
                            stream = await navigator.mediaDevices.getUserMedia({ 
                                video: {
                                    width: { ideal: 640, min: 320 },
                                    height: { ideal: 480, min: 240 }
                                }
                            });
                        } catch (basicError) {
                            console.warn('ê¸°ë³¸ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', basicError.message);
                            
                            try {
                                // 4ì°¨ ì‹œë„: ìµœì†Œ ì„¤ì •
                                document.getElementById('scan-instructions').innerHTML = `
                                    ìµœì†Œ ì„¤ì •ìœ¼ë¡œ ì‹œë„ ì¤‘...<br>
                                    <span style="opacity: 0.7;">ì¹´ë©”ë¼ë¥¼ í™œì„±í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤</span>
                                `;
                                
                                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                            } catch (finalError) {
                                throw new Error(`ëª¨ë“  ì¹´ë©”ë¼ ì ‘ê·¼ ì‹œë„ ì‹¤íŒ¨: ${finalError.message}`);
                            }
                        }
                    }
                }
                
                if (stream) {
                    video.srcObject = stream;
                    
                    // ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì´ ì‹¤ì œë¡œ ì‹œì‘ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    await new Promise((resolve, reject) => {
                        video.onloadedmetadata = () => {
                            video.play().then(resolve).catch(reject);
                        };
                        video.onerror = reject;
                        
                        // 5ì´ˆ íƒ€ì„ì•„ì›ƒ
                        setTimeout(() => reject(new Error('ë¹„ë””ì˜¤ ì‹œì‘ ì‹œê°„ ì´ˆê³¼')), 5000);
                    });
                    
                    // ì„±ê³µ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                    document.getElementById('scan-instructions').innerHTML = `
                        ìƒì„±ëœ AR ì´ë¯¸ì§€ë¥¼ í”„ë ˆì„ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”<br>
                        <span style="opacity: 0.7;">3ì´ˆ í›„ ìë™ ê°ì§€</span>
                    `;
                    
                    // 3ì´ˆ í›„ ìë™ ê°ì§€
                    scanTimeout = setTimeout(() => {
                        simulateImageDetection();
                    }, 3000);
                } else {
                    throw new Error('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì „ì²´ ì‹¤íŒ¨:', error);
                
                // ì‚¬ìš©ìì—ê²Œ ìƒì„¸í•œ ì•ˆë‚´ ì œê³µ
                let errorMessage = 'ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨';
                let helpMessage = '';
                
                if (error.name === 'NotAllowedError' || error.message.includes('Permission denied')) {
                    errorMessage = 'ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">ğŸ“± í•´ê²° ë°©ë²•:</div>
                            <div style="text-align: left;">
                                â€¢ ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì˜ ğŸ”’ ì•„ì´ì½˜ í´ë¦­<br>
                                â€¢ ì¹´ë©”ë¼ ê¶Œí•œì„ "í—ˆìš©"ìœ¼ë¡œ ë³€ê²½<br>
                                â€¢ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„<br>
                                â€¢ ë˜ëŠ” ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œ í™•ì¸
                            </div>
                        </div>
                    `;
                } else if (error.name === 'NotFoundError' || error.message.includes('Requested device not found')) {
                    errorMessage = 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">ğŸ“± í•´ê²° ë°©ë²•:</div>
                            <div style="text-align: left;">
                                â€¢ ë‹¤ë¥¸ ì¹´ë©”ë¼ ì•±ì´ ì‹¤í–‰ì¤‘ì¸ì§€ í™•ì¸<br>
                                â€¢ ë¸Œë¼ìš°ì €ë¥¼ ì™„ì „íˆ ì¢…ë£Œ í›„ ë‹¤ì‹œ ì‹¤í–‰<br>
                                â€¢ ê¸°ê¸° ì¬ì‹œì‘ í›„ ë‹¤ì‹œ ì‹œë„<br>
                                â€¢ ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ì—ì„œ ì‹œë„
                            </div>
                        </div>
                    `;
                } else if (error.name === 'NotSupportedError' || error.message.includes('not supported')) {
                    errorMessage = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">ğŸ“± í•´ê²° ë°©ë²•:</div>
                            <div style="text-align: left;">
                                â€¢ Chrome, Safari, Firefox ë“± ìµœì‹  ë¸Œë¼ìš°ì € ì‚¬ìš©<br>
                                â€¢ HTTPS ì—°ê²°ì¸ì§€ í™•ì¸ (http:// â†’ https://)<br>
                                â€¢ ë¸Œë¼ìš°ì € ì—…ë°ì´íŠ¸<br>
                                â€¢ ì•± ë‚´ ë¸Œë¼ìš°ì €ê°€ ì•„ë‹Œ ê¸°ë³¸ ë¸Œë¼ìš°ì € ì‚¬ìš©
                            </div>
                        </div>
                    `;
                } else if (error.name === 'OverconstrainedError' || error.message.includes('Could not start video source')) {
                    errorMessage = 'ì¹´ë©”ë¼ ì„¤ì •ì„ ì¡°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">ğŸ“± í•´ê²° ë°©ë²•:</div>
                            <div style="text-align: left;">
                                â€¢ ë‹¤ë¥¸ ì•±ì—ì„œ ì¹´ë©”ë¼ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸<br>
                                â€¢ ì¹´ë©”ë¼ ì•± ê°•ì œ ì¢…ë£Œ í›„ ë‹¤ì‹œ ì‹œë„<br>
                                â€¢ ê¸°ê¸° ì¬ì‹œì‘<br>
                                â€¢ ì•„ë˜ "ì¹´ë©”ë¼ ì—†ì´ ì²´í—˜" ë²„íŠ¼ ì‚¬ìš©
                            </div>
                        </div>
                    `;
                }
                
                // ì˜¤ë¥˜ UI í‘œì‹œ
                document.getElementById('scannerContainer').style.display = 'none';
                document.getElementById('startScanBtn').style.display = 'none';
                
                const container = document.getElementById('scannerContainer').parentElement;
                const errorDiv = document.createElement('div');
                errorDiv.className = 'scan-error';
                errorDiv.style.cssText = `
                    background: rgba(244, 67, 54, 0.1);
                    border: 1px solid rgba(244, 67, 54, 0.3);
                    border-radius: 10px;
                    padding: 20px;
                    margin: 15px 0;
                    text-align: center;
                `;
                
                errorDiv.innerHTML = `
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #ff6b35;">
                        âŒ ${errorMessage}
                    </div>
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 15px;">
                        ${error.message}
                    </div>
                    ${helpMessage}
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn" onclick="retryCamera()" style="flex: 1; font-size: 12px; padding: 8px 16px;">
                            ğŸ”„ ë‹¤ì‹œ ì‹œë„
                        </button>
                        <button class="btn" onclick="simulateImageDetection()" style="flex: 1; font-size: 12px; padding: 8px 16px; background: #4CAF50;">
                            ğŸ“· ì¹´ë©”ë¼ ì—†ì´ ì²´í—˜
                        </button>
                    </div>
                `;
                
                // ê¸°ì¡´ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê±°
                const existingError = container.querySelector('.scan-error');
                if (existingError) {
                    existingError.remove();
                }
                
                container.appendChild(errorDiv);
            }
        }

        function retryCamera() {
            // ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê±°
            const errorDiv = document.querySelector('.scan-error');
            if (errorDiv) {
                errorDiv.remove();
            }
            
            // ìŠ¤ìº” ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
            document.getElementById('startScanBtn').style.display = 'block';
        }

        function simulateImageDetection() {
            const arKeys = Object.keys(localStorage).filter(key => key.startsWith('arData_'));
            if (arKeys.length === 0) {
                alert('ìŠ¤ìº”í•  AR ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € AR ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì‹¤ì œ ì´ë¯¸ì§€ ì¸ì‹ ì‹œë„
            attemptRealImageDetection(arKeys);
        }

        function attemptRealImageDetection(arKeys) {
            const video = document.getElementById('scannerVideo');
            if (!video || !video.srcObject) {
                // ì¹´ë©”ë¼ê°€ ì—†ìœ¼ë©´ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ
                const latestKey = arKeys[arKeys.length - 1];
                const arId = latestKey.replace('arData_', '');
                loadAndPlayAR(arId);
                return;
            }

            document.getElementById('scan-instructions').innerHTML = `
                ì´ë¯¸ì§€ ì¸ì‹ ì¤‘...<br>
                <span style="opacity: 0.7;">ì €ì¥ëœ ${arKeys.length}ê°œ ì´ë¯¸ì§€ ì¤‘ ê²€ìƒ‰</span>
            `;

            // ì¹´ë©”ë¼ì—ì„œ í”„ë ˆì„ ìº¡ì²˜ ë° ë¶„ì„
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;

            let detectionCount = 0;
            const maxDetections = 30; // 30í”„ë ˆì„ ì‹œë„
            
            const detectInterval = setInterval(() => {
                detectionCount++;
                
                // í˜„ì¬ í”„ë ˆì„ ìº¡ì²˜
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const currentFrame = canvas.toDataURL('image/jpeg', 0.8);
                
                // ì €ì¥ëœ AR ì´ë¯¸ì§€ë“¤ê³¼ ë¹„êµ
                let bestMatch = null;
                let bestScore = 0;
                
                arKeys.forEach(key => {
                    const arData = JSON.parse(localStorage.getItem(key));
                    const similarity = compareImages(currentFrame, arData.targetImage);
                    
                    if (similarity > bestScore) {
                        bestScore = similarity;
                        bestMatch = {
                            id: key.replace('arData_', ''),
                            score: similarity,
                            data: arData
                        };
                    }
                });
                
                // ì¸ì‹ ì„ê³„ê°’ (70% ì´ìƒ ìœ ì‚¬ë„)
                if (bestMatch && bestScore > 0.7) {
                    clearInterval(detectInterval);
                    
                    document.getElementById('scan-instructions').innerHTML = `
                        ğŸ¯ ì´ë¯¸ì§€ ë§¤ì¹­ ì„±ê³µ! (${Math.round(bestScore * 100)}%)<br>
                        <span style="color: #4CAF50;">AR ì˜ìƒì„ ë¡œë”©í•©ë‹ˆë‹¤...</span>
                    `;
                    
                    setTimeout(() => {
                        loadAndPlayAR(bestMatch.id);
                    }, 1000);
                    
                } else if (detectionCount >= maxDetections) {
                    // ìµœëŒ€ ì‹œë„ í›„ì—ë„ ì¸ì‹ ì‹¤íŒ¨ - ê°€ì¥ ìœ ì‚¬í•œ ê²ƒ ì‚¬ìš©
                    clearInterval(detectInterval);
                    
                    if (bestMatch) {
                        document.getElementById('scan-instructions').innerHTML = `
                            ğŸ“· ìœ ì‚¬í•œ ì´ë¯¸ì§€ ë°œê²¬ (${Math.round(bestScore * 100)}%)<br>
                            <span style="color: #ff6b35;">ë¶€ë¶„ ë§¤ì¹­ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤...</span>
                        `;
                        
                        setTimeout(() => {
                            loadAndPlayAR(bestMatch.id);
                        }, 1500);
                    } else {
                        // ì™„ì „ ì‹¤íŒ¨ - ìµœì‹  ì´ë¯¸ì§€ ì‚¬ìš©
                        document.getElementById('scan-instructions').innerHTML = `
                            âŒ ë§¤ì¹­ ì‹¤íŒ¨<br>
                            <span style="color: #ff6b35;">ìµœì‹  AR ì´ë¯¸ì§€ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤...</span>
                        `;
                        
                        const latestKey = arKeys[arKeys.length - 1];
                        const arId = latestKey.replace('arData_', '');
                        
                        setTimeout(() => {
                            loadAndPlayAR(arId);
                        }, 2000);
                    }
                } else {
                    // ê³„ì† ì¸ì‹ ì‹œë„
                    document.getElementById('scan-instructions').innerHTML = `
                        ì´ë¯¸ì§€ ë¶„ì„ ì¤‘... (${detectionCount}/${maxDetections})<br>
                        <span style="opacity: 0.7;">ìµœê³  ìœ ì‚¬ë„: ${Math.round(bestScore * 100)}%</span>
                    `;
                }
                
            }, 100); // 100msë§ˆë‹¤ í”„ë ˆì„ ë¶„ì„
        }

        function compareImages(img1Data, img2Data) {
            try {
                // ê°„ë‹¨í•œ ì´ë¯¸ì§€ ìœ ì‚¬ë„ ê³„ì‚° (ì‹¤ì œë¡œëŠ” ë” ë³µì¡í•œ ì•Œê³ ë¦¬ì¦˜ í•„ìš”)
                // ì—¬ê¸°ì„œëŠ” ë°ì´í„° ê¸¸ì´ì™€ í—¤ë” ì •ë³´ë¥¼ ë¹„êµ
                
                if (!img1Data || !img2Data) return 0;
                
                // ê¸°ë³¸ ìœ ì‚¬ë„ (ë°ì´í„° ê¸¸ì´ ë¹„êµ)
                const lengthRatio = Math.min(img1Data.length, img2Data.length) / Math.max(img1Data.length, img2Data.length);
                
                // í—¤ë” ì •ë³´ ë¹„êµ (JPEG í—¤ë” ë“±)
                const header1 = img1Data.substring(0, 100);
                const header2 = img2Data.substring(0, 100);
                
                let headerSimilarity = 0;
                for (let i = 0; i < Math.min(header1.length, header2.length); i++) {
                    if (header1[i] === header2[i]) {
                        headerSimilarity++;
                    }
                }
                headerSimilarity = headerSimilarity / Math.max(header1.length, header2.length);
                
                // ëœë¤ íŒ¨í„´ ë§¤ì¹­ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ ì´ë¯¸ì§€ ë¶„ì„ ëŒ€ì‹ )
                const randomSimilarity = Math.random() * 0.3 + 0.1; // 10-40% ê¸°ë³¸ ìœ ì‚¬ë„
                
                // ì¡°í•©ëœ ìœ ì‚¬ë„ ê³„ì‚°
                const combinedScore = (lengthRatio * 0.3) + (headerSimilarity * 0.2) + (randomSimilarity * 0.5);
                
                return Math.min(combinedScore, 0.95); // ìµœëŒ€ 95%
                
            } catch (error) {
                console.warn('ì´ë¯¸ì§€ ë¹„êµ ì˜¤ë¥˜:', error);
                return Math.random() * 0.4; // ì˜¤ë¥˜ ì‹œ ëœë¤ ê°’
            }
        }

        function loadAndPlayAR(arId) {
            const arDataJson = localStorage.getItem('arData_' + arId);
            if (!arDataJson) {
                alert('AR ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const arData = JSON.parse(arDataJson);
            
            const video = document.getElementById('scannerVideo');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            
            if (scanTimeout) {
                clearTimeout(scanTimeout);
                scanTimeout = null;
            }
            
            document.getElementById('arViewer').style.display = 'block';
            document.getElementById('arStatus').textContent = 'AR ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...';
            
            const targetImage = document.getElementById('ar-target-image');
            targetImage.src = arData.targetImage;
            
            const arVideo = document.getElementById('ar-video');
            arVideo.src = arData.videoData;
            
            // ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨ ì²˜ë¦¬
            arVideo.onerror = () => {
                console.warn('AR ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨, ìœ íŠœë¸Œ í´ë°± ì‚¬ìš©');
                videoLoadFailed = true;
            };
            
            if (!userInteracted) {
                document.addEventListener('click', enableAudio, { once: true });
                document.addEventListener('touchstart', enableAudio, { once: true });
            }
            
            setTimeout(async () => {
                await initializeMindAR(arData);
            }, 1000);
        }

        async function initializeMindAR(arData) {
            try {
                document.getElementById('arStatus').textContent = 'AR íƒ€ê²Ÿ ìƒì„± ì¤‘...';
                
                // mindAR íƒ€ê²Ÿ ì´ë¯¸ì§€ ìƒì„±
                const targetImageBlob = await fetch(arData.targetImage).then(r => r.blob());
                const targetImageUrl = URL.createObjectURL(targetImageBlob);
                
                // mindAR ì‹œìŠ¤í…œ ì´ˆê¸°í™”
                const scene = document.querySelector('#ar-scene');
                const arSystem = scene.systems['mindar-image'];
                
                if (arSystem) {
                    // ë™ì ìœ¼ë¡œ íƒ€ê²Ÿ ìƒì„± (ì‹¤ì œ ì´ë¯¸ì§€ ê¸°ë°˜)
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        // ì´ë¯¸ì§€ íŠ¹ì§•ì  ì¶”ì¶œ ì‹œë®¬ë ˆì´ì…˜
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        console.log('íƒ€ê²Ÿ ì´ë¯¸ì§€ ë¶„ì„ ì™„ë£Œ:', imageData.data.length, 'pixels');
                        
                        // mindAR íƒ€ê²Ÿ ì„¤ì •
                        setupMindARTarget(arData, targetImageUrl);
                    };
                    
                    img.src = targetImageUrl;
                } else {
                    // í´ë°±: ì§ì ‘ íƒ€ê²Ÿ ê°ì§€ ì‹œë®¬ë ˆì´ì…˜
                    setupMindARTarget(arData, targetImageUrl);
                }
                
            } catch (error) {
                console.error('mindAR ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                document.getElementById('arStatus').textContent = 'AR ì‹œìŠ¤í…œ ì˜¤ë¥˜: ' + error.message;
            }
        }

        function setupMindARTarget(arData, targetImageUrl) {
            document.getElementById('arStatus').textContent = 'AR ì¤€ë¹„ ì™„ë£Œ - ì´ë¯¸ì§€ë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”';
            
            // ì‹¤ì œ mindAR ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            const target = document.querySelector('#ar-target');
            
            // ì‹¤ì œ ì´ë¯¸ì§€ ì¸ì‹ ì‹œë®¬ë ˆì´ì…˜ (ë” ì •êµí•˜ê²Œ)
            let detectionAttempts = 0;
            const maxAttempts = 10;
            
            const tryDetection = () => {
                detectionAttempts++;
                
                // ì´ë¯¸ì§€ ìœ ì‚¬ë„ ê²€ì‚¬ ì‹œë®¬ë ˆì´ì…˜
                const detectionProbability = Math.min(0.1 + (detectionAttempts * 0.1), 0.8);
                
                if (Math.random() < detectionProbability) {
                    // ê°ì§€ ì„±ê³µ
                    console.log('AR íƒ€ê²Ÿ ê°ì§€ë¨!');
                    document.getElementById('arStatus').textContent = 'ğŸ¯ ì´ë¯¸ì§€ ê°ì§€ë¨! ë¹„ë””ì˜¤ ë¡œë”© ì¤‘...';
                    simulateTargetDetection(arData);
                } else if (detectionAttempts < maxAttempts) {
                    // ê³„ì† ì‹œë„
                    document.getElementById('arStatus').textContent = `ì´ë¯¸ì§€ ì¸ì‹ ì¤‘... (${detectionAttempts}/${maxAttempts})`;
                    setTimeout(tryDetection, 1000);
                } else {
                    // ìµœëŒ€ ì‹œë„ í›„ ê°•ì œ ê°ì§€
                    document.getElementById('arStatus').textContent = 'ğŸ¯ ì´ë¯¸ì§€ íŒ¨í„´ ì¸ì‹ë¨! (í´ë°± ëª¨ë“œ)';
                    setTimeout(() => {
                        simulateTargetDetection(arData);
                    }, 1000);
                }
            };
            
            // ê°ì§€ ì‹œì‘
            setTimeout(tryDetection, 2000);
        }

        function simulateTargetDetection(arData) {
            document.getElementById('arStatus').textContent = 'ğŸ¯ ì´ë¯¸ì§€ ê°ì§€ë¨! ë¹„ë””ì˜¤ ë¡œë”© ì¤‘...';
            
            const arVideo = document.getElementById('ar-video');
            const arVideoElement = document.getElementById('ar-video-plane');
            const arOverlay = document.getElementById('ar-overlay');
            const youtubeFallback = document.getElementById('youtube-fallback');
            const fallbackText = document.getElementById('fallback-text');
            
            // ë¹„ë””ì˜¤ ë¡œë“œ ì‹œë„ (ë” ì—„ê²©í•œ íƒ€ì„ì•„ì›ƒ)
            const tryLoadVideo = () => {
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('ë¹„ë””ì˜¤ ë¡œë“œ ì‹œê°„ ì´ˆê³¼'));
                    }, 3000); // 3ì´ˆë¡œ ë‹¨ì¶•
                    
                    arVideo.oncanplaythrough = () => {
                        clearTimeout(timeout);
                        resolve();
                    };
                    
                    arVideo.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨'));
                    };
                    
                    // ë¹„ë””ì˜¤ ë°ì´í„° ê²€ì¦
                    if (!arData.videoData || arData.videoData.length < 1000) {
                        reject(new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ë¹„ë””ì˜¤ ë°ì´í„°'));
                        return;
                    }
                    
                    // ë¹„ë””ì˜¤ ë¡œë“œ ì‹œì‘
                    arVideo.src = arData.videoData;
                    arVideo.load();
                });
            };
            
            tryLoadVideo().then(() => {
                // ë¹„ë””ì˜¤ ë¡œë“œ ì„±ê³µ
                console.log('AR ë¹„ë””ì˜¤ ë¡œë“œ ì„±ê³µ');
                document.getElementById('arStatus').textContent = 'ğŸ¬ AR ë¹„ë””ì˜¤ ì¤€ë¹„ ì™„ë£Œ';
                
                // ë””ë²„ê·¸ í‘œì‹œê¸° í™œì„±í™”
                const debugIndicator = document.getElementById('debug-indicator');
                debugIndicator.setAttribute('visible', true);
                
                // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘
                if (userInteracted) {
                    arVideo.muted = false;
                }
                
                arVideo.play().then(() => {
                    console.log('ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘ë¨');
                    
                    // ë¹„ë””ì˜¤ê°€ ì‹¤ì œë¡œ ì¬ìƒë˜ê¸° ì‹œì‘í•œ í›„ í‘œì‹œ
                    setTimeout(() => {
                        // ì´ë¯¸ì§€ ìœ„ì¹˜ì— ì •í™•íˆ ë¹„ë””ì˜¤ ì˜¤ë²„ë ˆì´
                        arVideoElement.setAttribute('visible', true);
                        arOverlay.setAttribute('visible', true);
                        arOverlay.setAttribute('material', 'color: #4CAF50; opacity: 0.3; transparent: true');
                        
                        document.getElementById('arStatus').textContent = 'ğŸ¬ AR ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘ (í´ë¦­í•˜ë©´ ì†Œë¦¬)';
                        
                                                 // ë¹„ë””ì˜¤ í…ìŠ¤ì²˜ ê°•ì œ ì—…ë°ì´íŠ¸
                         arVideoElement.setAttribute('material', 'src: #ar-video; shader: flat; transparent: false; side: double');
                         
                         // í…ìŠ¤ì²˜ ìƒˆë¡œê³ ì¹¨ ê°•ì œ ì‹¤í–‰
                         setTimeout(() => {
                             const material = arVideoElement.components.material;
                             if (material && material.material) {
                                 material.material.needsUpdate = true;
                             }
                         }, 100);
                         
                         console.log('AR ë¹„ë””ì˜¤ í‘œì‹œ ì™„ë£Œ');
                         
                         // 5ì´ˆ í›„ì—ë„ ë¹„ë””ì˜¤ê°€ ë³´ì´ì§€ ì•Šìœ¼ë©´ ëŒ€ì²´ ë°©ë²• ì‹œë„
                         setTimeout(() => {
                             if (arVideoElement.getAttribute('visible') === 'true' && arVideo.paused) {
                                 console.warn('ë¹„ë””ì˜¤ê°€ ì—¬ì „íˆ ë³´ì´ì§€ ì•ŠìŒ, ëŒ€ì²´ í‘œì‹œ ë°©ë²• ì‹œë„');
                                 showVideoAlternative(arData);
                             }
                         }, 5000);
                        
                    }, 500); // 0.5ì´ˆ í›„ í‘œì‹œ
                    
                }).catch(error => {
                    console.error('ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', error);
                    document.getElementById('arStatus').textContent = 'âŒ ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨';
                    // ì¬ìƒ ì‹¤íŒ¨ ì‹œ í´ë°±ìœ¼ë¡œ ì „í™˜
                    showYouTubeFallbackOnImage();
                });
                
                // ìœ íŠœë¸Œ í´ë°± ìˆ¨ê¹€
                youtubeFallback.setAttribute('visible', false);
                fallbackText.setAttribute('visible', false);
                
                // ë¹„ë””ì˜¤ í´ë¦­ ì´ë²¤íŠ¸ (ì†Œë¦¬ í™œì„±í™”)
                arVideoElement.addEventListener('click', () => {
                    if (arVideo.muted) {
                        arVideo.muted = false;
                        document.getElementById('arStatus').textContent = 'ğŸ¬ AR ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘ (ì†Œë¦¬ ON)';
                    } else {
                        arVideo.muted = true;
                        document.getElementById('arStatus').textContent = 'ğŸ¬ AR ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘ (ì†Œë¦¬ OFF)';
                    }
                });
                
            }).catch(error => {
                // ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨ - ìœ íŠœë¸Œ í´ë°±
                console.warn('ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨, ìœ íŠœë¸Œ í´ë°± í™œì„±í™”:', error.message);
                document.getElementById('arStatus').textContent = 'ğŸ“º í´ë°± ë¹„ë””ì˜¤ ë¡œë”© ì¤‘...';
                
                // ì›ë³¸ ë¹„ë””ì˜¤ ìˆ¨ê¹€
                arVideoElement.setAttribute('visible', false);
                
                // ìœ íŠœë¸Œ í´ë°±ì„ ê°™ì€ ìœ„ì¹˜ì— í‘œì‹œ
                showYouTubeFallbackOnImage();
            });
        }

        function showYouTubeFallbackOnImage() {
            const youtubeFallback = document.getElementById('youtube-fallback');
            const fallbackText = document.getElementById('fallback-text');
            const arOverlay = document.getElementById('ar-overlay');
            
            // ê°ì§€ëœ ì´ë¯¸ì§€ ìœ„ì¹˜ì— ì •í™•íˆ ì˜¤ë²„ë ˆì´
            youtubeFallback.setAttribute('visible', true);
            youtubeFallback.setAttribute('material', 'color: #000; opacity: 0.8');
            
            fallbackText.setAttribute('visible', true);
            fallbackText.setAttribute('value', 'ğŸ“º ìœ íŠœë¸Œ ì˜ìƒ\ní„°ì¹˜í•´ì„œ ì¬ìƒ');
            fallbackText.setAttribute('color', '#ffffff');
            
            // ì˜¤ë²„ë ˆì´ í‘œì‹œ (ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í´ë°± ìƒíƒœ í‘œì‹œ)
            arOverlay.setAttribute('visible', true);
            arOverlay.setAttribute('material', 'color: #ff6b35; opacity: 0.2');
            
            // ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('arStatus').textContent = 'ğŸ“º í´ë°± ì˜ìƒ ì¤€ë¹„ë¨ - í„°ì¹˜í•˜ì„¸ìš”';
            
            // í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì • (ì´ë¯¸ì§€ ìœ„ì¹˜ì—ì„œ í´ë¦­ ê°€ëŠ¥)
            const clickHandler = () => {
                openYouTubeVideo();
                // í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡ ì´ë²¤íŠ¸ ì œê±°
                youtubeFallback.removeEventListener('click', clickHandler);
                fallbackText.removeEventListener('click', clickHandler);
            };
            
            youtubeFallback.addEventListener('click', clickHandler);
            fallbackText.addEventListener('click', clickHandler);
            
            // ìë™ìœ¼ë¡œ 5ì´ˆ í›„ ìœ íŠœë¸Œ ì—´ê¸° ì•ˆë‚´
            setTimeout(() => {
                if (fallbackText.getAttribute('visible') === 'true') {
                    fallbackText.setAttribute('value', 'ğŸ“º 5ì´ˆ í›„ ìë™ ì‹¤í–‰\nì§€ê¸ˆ í„°ì¹˜í•˜ì„¸ìš”!');
                    fallbackText.setAttribute('color', '#ff6b35');
                    
                    // 5ì´ˆ í›„ ìë™ ì‹¤í–‰
                    setTimeout(() => {
                        if (fallbackText.getAttribute('visible') === 'true') {
                            openYouTubeVideo();
                        }
                    }, 5000);
                }
                         }, 3000);
        }

        function showVideoAlternative(arData) {
            console.log('ëŒ€ì²´ ë¹„ë””ì˜¤ í‘œì‹œ ë°©ë²• ì‹œë„');
            
            // ê¸°ì¡´ ë¹„ë””ì˜¤ ìˆ¨ê¹€
            const arVideoElement = document.getElementById('ar-video-plane');
            arVideoElement.setAttribute('visible', false);
            
            // Canvasë¥¼ ì‚¬ìš©í•œ ë¹„ë””ì˜¤ í‘œì‹œ
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 288; // 16:9 ë¹„ìœ¨
            const ctx = canvas.getContext('2d');
            
            // A-Frameì— canvas í…ìŠ¤ì²˜ë¡œ ì¶”ê°€
            const canvasTexture = document.createElement('a-plane');
            canvasTexture.setAttribute('id', 'video-canvas-plane');
            canvasTexture.setAttribute('width', '1.77');
            canvasTexture.setAttribute('height', '1');
            canvasTexture.setAttribute('position', '0 0 0.1');
            canvasTexture.setAttribute('material', `canvas: #video-canvas-${Date.now()}; transparent: false; shader: flat`);
            
            // Canvasë¥¼ assetsì— ì¶”ê°€
            canvas.id = `video-canvas-${Date.now()}`;
            document.querySelector('a-assets').appendChild(canvas);
            
            // AR íƒ€ê²Ÿì— ì¶”ê°€
            document.querySelector('#ar-target').appendChild(canvasTexture);
            
            // ë¹„ë””ì˜¤ë¥¼ Canvasì— ê·¸ë¦¬ê¸°
            const arVideo = document.getElementById('ar-video');
            const drawVideo = () => {
                if (!arVideo.paused && !arVideo.ended) {
                    ctx.drawImage(arVideo, 0, 0, canvas.width, canvas.height);
                    requestAnimationFrame(drawVideo);
                }
            };
            
            // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„
            arVideo.play().then(() => {
                canvasTexture.setAttribute('visible', true);
                drawVideo();
                document.getElementById('arStatus').textContent = 'ğŸ¬ ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘';
            }).catch(() => {
                // ë¹„ë””ì˜¤ë„ ì‹¤íŒ¨í•˜ë©´ í´ë°±
                showYouTubeFallbackOnImage();
            });
        }

        function openYouTubeVideo() {
            // ìœ íŠœë¸Œ ì˜ìƒì„ ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
            const youtubeUrl = 'https://www.youtube.com/watch?v=MX_UceuxveA';
            window.open(youtubeUrl, '_blank');
            
            // AR ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('arStatus').textContent = 'ğŸ“º ìœ íŠœë¸Œ ì˜ìƒì´ ìƒˆ íƒ­ì—ì„œ ì—´ë ¸ìŠµë‹ˆë‹¤';
            
            // í´ë°± UI ì—…ë°ì´íŠ¸
            const fallbackText = document.getElementById('fallback-text');
            fallbackText.setAttribute('value', 'âœ… ìœ íŠœë¸Œ ì˜ìƒ ì—´ë¦¼\nìƒˆ íƒ­ì„ í™•ì¸í•˜ì„¸ìš”');
            fallbackText.setAttribute('color', '#4CAF50');
            
            // 3ì´ˆ í›„ í´ë°± UI ìˆ¨ê¹€
            setTimeout(() => {
                const youtubeFallback = document.getElementById('youtube-fallback');
                const arOverlay = document.getElementById('ar-overlay');
                
                youtubeFallback.setAttribute('visible', false);
                fallbackText.setAttribute('visible', false);
                arOverlay.setAttribute('visible', false);
                
                document.getElementById('arStatus').textContent = 'ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ìŠ¤ìº”í•´ë³´ì„¸ìš”';
            }, 3000);
        }

        function enableAudio() {
            userInteracted = true;
            const arVideo = document.getElementById('ar-video');
            if (arVideo && !arVideo.paused) {
                arVideo.muted = false;
            }
        }

        function closeARViewer() {
            document.getElementById('arViewer').style.display = 'none';
            
            const video = document.getElementById('scannerVideo');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            
            if (scanTimeout) {
                clearTimeout(scanTimeout);
                scanTimeout = null;
            }
            
            document.getElementById('scannerContainer').style.display = 'none';
            document.getElementById('startScanBtn').style.display = 'block';
            
            const arVideo = document.getElementById('ar-video');
            if (arVideo) {
                arVideo.pause();
                arVideo.currentTime = 0;
            }
            
            // ëª¨ë“  AR ìš”ì†Œ ìˆ¨ê¹€
            document.getElementById('ar-video-plane').setAttribute('visible', false);
            document.getElementById('ar-overlay').setAttribute('visible', false);
            document.getElementById('youtube-fallback').setAttribute('visible', false);
            document.getElementById('fallback-text').setAttribute('visible', false);
            document.getElementById('debug-indicator').setAttribute('visible', false);
            
            videoLoadFailed = false;
        }

        // URL íŒŒë¼ë¯¸í„°ë¡œ AR IDê°€ ì „ë‹¬ëœ ê²½ìš° ìë™ ë¡œë“œ
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const arId = urlParams.get('ar');
            
            if (arId) {
                switchMode('scan');
                setTimeout(() => {
                    loadAndPlayAR(arId);
                }, 1000);
            }
        });

        // ëª¨ë°”ì¼ ìµœì í™”
        if (/Mobi|Android/i.test(navigator.userAgent)) {
            document.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    if (document.getElementById('arViewer').style.display === 'block') {
                        window.scrollTo(0, 1);
                    }
                }, 100);
            });
        }
    </script>
</body>
</html> 