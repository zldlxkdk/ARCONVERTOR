<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR ì´ë¯¸ì§€ ìƒì„±ê¸° - ë¹„ë””ì˜¤ ì˜¤ë²„ë ˆì´</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <style>
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            50% { transform: translate(-50%, -50%) scale(1.05); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .mode-switch {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .mode-toggle {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 25px;
            padding: 5px;
            margin-top: 10px;
        }

        .mode-btn {
            flex: 1;
            background: transparent;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #ff6b35;
            box-shadow: 0 2px 10px rgba(255, 107, 53, 0.3);
        }

        .create-mode, .scan-mode {
            display: none;
        }

        .create-mode.active, .scan-mode.active {
            display: block;
        }

        .step {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .step.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff6b35;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #ff6b35;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }

        .upload-area.dragover {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.2);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .upload-text {
            font-size: 14px;
            opacity: 0.8;
        }

        .file-input {
            display: none;
        }

        .preview {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 10px;
        }

        .preview-video {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
            width: auto;
            margin: 5px;
        }

        .progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            font-size: 12px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ar-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            z-index: 1000;
            display: none;
        }

        .ar-viewer.active {
            display: block;
        }

        .ar-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ar-status {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            max-width: 300px;
            font-weight: 500;
        }

        .ar-close {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            z-index: 2001;
            position: relative;
        }

        .ar-close:hover {
            background: #e55a2e;
            transform: scale(1.05);
        }

        .check-icon {
            color: #4CAF50;
            font-size: 20px;
        }

        .ar-result {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            text-align: center;
        }

        /* ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ */
        .camera-preview {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 90px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            overflow: hidden;
            z-index: 1002;
            border: 2px solid #ff6b35;
        }

        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-preview.hidden {
            display: none;
        }

        /* AR Scene ì»¨í…Œì´ë„ˆ */
        .ar-scene-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #ar-scene {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .target-image-container {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
            display: inline-block;
        }

        .target-image {
            border-radius: 10px;
            max-width: 200px;
            height: auto;
            border: 3px solid #ff6b35;
        }

        .download-section {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .download-btn {
            flex: 1;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .share-btn {
            background: #2196F3;
        }

        .share-btn:hover {
            background: #1976D2;
        }

        .scan-info {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .scanner-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }

        .scanner-video {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #ff6b35;
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px solid rgba(255, 107, 53, 0.5);
            border-radius: 15px;
            animation: scanPulse 2s infinite;
        }

        @keyframes scanPulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        @keyframes arTrackingPulse {
            0%, 100% { 
                opacity: 0.8; 
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 107, 53, 0.5);
            }
            50% { 
                opacity: 1; 
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.2), 0 0 30px rgba(255, 107, 53, 0.8);
            }
        }

        .scan-instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 12px;
        }

        .frame-extraction-info {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
        }

        .extracted-frame {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .video-editor {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .video-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .time-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            cursor: pointer;
        }

        .time-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff6b35;
            cursor: pointer;
        }

        .time-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff6b35;
            cursor: pointer;
            border: none;
        }

        .time-display {
            font-size: 11px;
            opacity: 0.8;
            min-width: 60px;
            text-align: center;
        }

        .trim-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .trim-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .trim-label {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .trim-time {
            font-size: 13px;
            font-weight: 600;
            color: #ff6b35;
        }

        .range-visualizer {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        .range-selected {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #f7931e);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .duration-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            text-align: center;
        }

        .trim-preview {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .fallback-info {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-size: 13px;
        }

        .youtube-embed {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            border: none;
            margin: 10px 0;
        }

        .scan-help {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
        }

        .camera-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1000;
            background: #000;
        }

        .ar-overlay-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            display: block;
        }

        .ar-overlay-container.active {
            display: block;
        }

        .overlay-video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 200px;
            object-fit: cover;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            border: 2px solid #ff6b35;
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.6);
            z-index: 1002;
            display: block;
        }

        .overlay-video::-webkit-media-controls {
            display: none !important;
        }

        .overlay-video::-webkit-media-controls-enclosure {
            display: none !important;
        }

        .overlay-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 320px;
            height: 220px;
            border: 2px dashed #4CAF50;
            border-radius: 12px;
            background: rgba(76, 175, 80, 0.05);
            pointer-events: none;
            animation: frameGlow 2s infinite alternate;
            z-index: 1001;
        }

        @keyframes frameGlow {
            0% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
            100% { box-shadow: 0 0 15px rgba(76, 175, 80, 0.8); }
        }

        .overlay-instructions {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid #ff6b35;
            z-index: 1003;
            max-width: 90%;
        }

        .youtube-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1004;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .youtube-overlay.active {
            display: flex;
        }

        .youtube-content {
            background: rgba(0, 0, 0, 0.9);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            border: 3px solid #ff6b35;
            backdrop-filter: blur(15px);
            width: 90%;
            max-width: 640px;
            height: 80%;
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .youtube-header {
            font-size: 20px;
            color: white;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .youtube-iframe {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            flex: 1;
            min-height: 300px;
        }

        .youtube-info {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 10px;
            font-style: italic;
        }

        /* ì „ì²´ í™”ë©´ ìŠ¤ìºë„ˆ */
        .fullscreen-scanner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1500;
            display: none;
        }

        .fullscreen-scanner.active {
            display: block;
        }

        .scanner-video-fullscreen {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 280px;
            height: 280px;
            margin: auto;
            border: 4px solid #ff6b35;
            border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4);
            animation: scanPulse 2s infinite;
            z-index: 1502;
            pointer-events: none;
            /* ì™„ì „í•œ ì¤‘ì•™ ì •ë ¬: top, left, right, bottom 0 + margin auto */
        }

        /* ìŠ¤ìº” í”„ë ˆì„ì˜ ì½”ë„ˆ ë§ˆì»¤ */
        .scanner-overlay-fullscreen::before,
        .scanner-overlay-fullscreen::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border: 5px solid #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }

        .scanner-overlay-fullscreen::before {
            top: -6px;
            left: -6px;
            border-right: transparent;
            border-bottom: transparent;
            border-top-left-radius: 20px;
        }

        .scanner-overlay-fullscreen::after {
            top: -6px;
            right: -6px;
            border-left: transparent;
            border-bottom: transparent;
            border-top-right-radius: 20px;
        }

        /* ì¶”ê°€ ì½”ë„ˆ ë§ˆì»¤ */
        .corner-markers {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .corner-markers::before,
        .corner-markers::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border: 5px solid #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }

        .corner-markers::before {
            bottom: -6px;
            left: -6px;
            border-right: transparent;
            border-top: transparent;
            border-bottom-left-radius: 20px;
        }

        .corner-markers::after {
            bottom: -6px;
            right: -6px;
            border-left: transparent;
            border-top: transparent;
            border-bottom-right-radius: 20px;
        }

        .scanner-controls-fullscreen {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1501;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scan-status-fullscreen {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            max-width: 70%;
        }

        .scan-close-btn {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .scan-close-btn:hover {
            background: #e55a2e;
            transform: scale(1.05);
        }

        .scan-instructions-fullscreen {
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 16px;
            backdrop-filter: blur(10px);
            border: 2px solid #ff6b35;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ëª¨ë“œ ì„ íƒ -->
        <div class="mode-switch">
            <h1 style="margin-bottom: 15px; font-size: 24px;">ğŸ“± AR ì´ë¯¸ì§€ ìƒì„±ê¸°</h1>
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="switchMode('create')">ğŸ¨ AR ì´ë¯¸ì§€ ìƒì„±</button>
                <button class="mode-btn" onclick="switchMode('scan')">ğŸ“· ì´ë¯¸ì§€ ìŠ¤ìº”</button>
            </div>
        </div>

        <!-- AR ìƒì„± ëª¨ë“œ -->
        <div class="create-mode active">
            <!-- 1ë‹¨ê³„: ë¹„ë””ì˜¤ ì—…ë¡œë“œ -->
            <div class="step" id="step1">
                <div class="step-title">
                    <div class="step-number">1</div>
                    AR ë¹„ë””ì˜¤ ì—…ë¡œë“œ
                </div>
                <div class="upload-area" onclick="document.getElementById('videoInput').click()">
                    <div class="upload-icon">ğŸ¬</div>
                    <div class="upload-text">ARë¡œ ì¬ìƒí•  ë¹„ë””ì˜¤ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                    <div style="font-size: 12px; opacity: 0.6; margin-top: 5px;">
                        MP4, WebM ì§€ì› (ëª¨ë“  í¬ê¸°)
                    </div>
                </div>
                <input type="file" id="videoInput" class="file-input" accept="video/*" />
                <div id="videoPreview"></div>
                <div id="videoEditor" class="video-editor" style="display: none;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #ff6b35;">
                        âœ‚ï¸ ë¹„ë””ì˜¤ í¸ì§‘ (ìµœëŒ€ 15ì´ˆ)
                    </div>
                    
                    <video id="editVideo" class="trim-preview" muted></video>
                    
                    <div class="video-controls">
                        <button class="btn btn-small" onclick="playPauseVideo()">â–¶ï¸</button>
                        <input type="range" id="currentTimeSlider" class="time-slider" min="0" max="100" value="0">
                        <div class="time-display" id="currentTimeDisplay">0:00</div>
                    </div>
                    
                    <div class="trim-controls">
                        <div class="trim-section">
                            <div class="trim-label">ì‹œì‘ ì‹œê°„</div>
                            <div class="trim-time" id="startTimeDisplay">0:00</div>
                            <button class="btn btn-small" onclick="setStartTime()">ì„¤ì •</button>
                        </div>
                        <div class="trim-section">
                            <div class="trim-label">ì¢…ë£Œ ì‹œê°„</div>
                            <div class="trim-time" id="endTimeDisplay">0:15</div>
                            <button class="btn btn-small" onclick="setEndTime()">ì„¤ì •</button>
                        </div>
                    </div>
                    
                    <div class="range-visualizer">
                        <div class="range-selected" id="rangeSelected"></div>
                    </div>
                    
                    <div id="durationInfo" class="duration-warning">
                        ì„ íƒëœ êµ¬ê°„: <span id="selectedDuration">15ì´ˆ</span> (ìµœëŒ€ 15ì´ˆ)
                    </div>
                    
                    <button class="btn" onclick="processVideo()" id="processBtn">
                        âœ‚ï¸ ì„ íƒ êµ¬ê°„ ì²˜ë¦¬í•˜ê¸°
                    </button>
                </div>
                <div id="frameExtractionInfo"></div>
            </div>

            <!-- 2ë‹¨ê³„: AR ì´ë¯¸ì§€ ìƒì„± -->
            <div class="step" id="step2">
                <div class="step-title">
                    <div class="step-number">2</div>
                    AR íƒ€ê²Ÿ ì´ë¯¸ì§€ ìƒì„±
                </div>
                <button class="btn" id="generateBtn" onclick="generateARImage()" disabled>
                    ğŸ–¼ï¸ AR ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°
                </button>
                <div id="generateProgress"></div>
                <div id="generateResult"></div>
            </div>
        </div>

        <!-- ì´ë¯¸ì§€ ìŠ¤ìº” ëª¨ë“œ -->
        <div class="scan-mode">
            <div class="step active">
                <div class="step-title">
                    <div class="step-number">ğŸ“·</div>
                    AR ì´ë¯¸ì§€ ìŠ¤ìºë„ˆ
                </div>
                
                <div class="scan-info">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">
                        ğŸ“± ìƒì„±ëœ AR ì´ë¯¸ì§€ ìŠ¤ìº”
                    </div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        ìƒì„±ëœ AR ì´ë¯¸ì§€ë¥¼ ìŠ¤ìº”í•˜ë©´<br>
                        í•´ë‹¹ ìœ„ì¹˜ì— ë¹„ë””ì˜¤ê°€ ì˜¤ë²„ë ˆì´ë©ë‹ˆë‹¤
                    </div>
                </div>

                <div class="scan-help">
                    <div style="font-weight: 600; margin-bottom: 10px;">ğŸ’¡ ìŠ¤ìº” ë„ì›€ë§</div>
                    <ul style="text-align: left; font-size: 12px;">
                        <li>ğŸ“· ì¹´ë©”ë¼ë¥¼ ì´ë¯¸ì§€ì—ì„œ 20-30cm ê±°ë¦¬ì— ë‘ì„¸ìš”</li>
                        <li>ğŸ’¡ ë°ì€ ì¡°ëª…ì—ì„œ ìŠ¤ìº”í•˜ì„¸ìš”</li>
                        <li>ğŸ“ ì´ë¯¸ì§€ë¥¼ ì •ë©´ì—ì„œ ë¹„ì¶°ì£¼ì„¸ìš”</li>
                        <li>ğŸ¤š ì†ì„ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€í•˜ì„¸ìš”</li>
                        <li>ğŸ”„ 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ê°ì§€ë©ë‹ˆë‹¤</li>
                    </ul>
                </div>



                <div class="scanner-container" id="scannerContainer" style="display: none;">
                    <video id="scannerVideo" class="scanner-video" autoplay muted playsinline></video>
                    <div class="scanner-overlay"></div>
                    
                    <!-- ì‹¤ì‹œê°„ AR ë¹„ë””ì˜¤ ì˜¤ë²„ë ˆì´ -->
                    <div class="scanner-ar-overlay" id="scannerArOverlay" style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        z-index: 1001;
                        display: none;
                        pointer-events: none;
                    ">
                        <!-- AR ë¹„ë””ì˜¤ -->
                        <video id="scannerOverlayVideo" class="scanner-overlay-video" loop muted playsinline style="
                            position: absolute;
                            border: 3px solid #ff6b35;
                            border-radius: 12px;
                            box-shadow: 0 0 25px rgba(255, 107, 53, 0.8);
                            background: rgba(0, 0, 0, 0.9);
                            z-index: 1002;
                            display: none;
                        "></video>
                        
                        <!-- AR í”„ë ˆì„ -->
                        <div id="scannerOverlayFrame" class="scanner-overlay-frame" style="
                            position: absolute;
                            border: 3px dashed #4CAF50;
                            border-radius: 15px;
                            background: rgba(76, 175, 80, 0.1);
                            pointer-events: none;
                            animation: frameGlow 2s infinite alternate;
                            z-index: 1001;
                            display: none;
                        "></div>
                        
                        <!-- AR ìƒíƒœ í‘œì‹œ -->
                        <div id="scannerArStatus" class="scanner-ar-status" style="
                            position: absolute;
                            top: 20px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: rgba(0, 0, 0, 0.9);
                            color: white;
                            padding: 10px 20px;
                            border-radius: 20px;
                            font-size: 14px;
                            font-weight: 600;
                            text-align: center;
                            backdrop-filter: blur(10px);
                            border: 2px solid #ff6b35;
                            z-index: 1003;
                            display: none;
                        "></div>
                        
                        <!-- AR ì»¨íŠ¸ë¡¤ -->
                        <div id="scannerArControls" class="scanner-ar-controls" style="
                            position: absolute;
                            bottom: 20px;
                            left: 50%;
                            transform: translateX(-50%);
                            display: flex;
                            gap: 10px;
                            z-index: 1003;
                            display: none;
                        ">
                            <button onclick="toggleScannerVideoSound()" class="scanner-ar-btn" style="
                                background: #4CAF50;
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 20px;
                                cursor: pointer;
                                font-size: 12px;
                                font-weight: 600;
                            ">ğŸ”Š ì†Œë¦¬</button>
                            <button onclick="closeScannerAR()" class="scanner-ar-btn" style="
                                background: #ff6b35;
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 20px;
                                cursor: pointer;
                                font-size: 12px;
                                font-weight: 600;
                            ">âœ• ë‹«ê¸°</button>
                        </div>
                    </div>
                    
                    <div class="scan-instructions" id="scan-instructions">
                        ìƒì„±ëœ AR ì´ë¯¸ì§€ë¥¼ í”„ë ˆì„ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”<br>
                        <span style="opacity: 0.7;">ìë™ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì°¾ì•„ì„œ ë¶„ì„í•©ë‹ˆë‹¤</span>
                    </div>
                </div>

                <button class="btn" id="startScanBtn" onclick="handleScanButtonClick()">
                    ğŸ“· ì´ë¯¸ì§€ ìŠ¤ìº” ì‹œì‘
                </button>
            </div>
        </div>
    </div>

            <!-- ì „ì²´ í™”ë©´ ìë™ ì´ë¯¸ì§€ ìŠ¤ìºë„ˆ -->
        <div class="fullscreen-scanner" id="fullscreenScanner">
            <video id="scannerVideoFullscreen" class="scanner-video-fullscreen" autoplay muted playsinline></video>
            
            <div class="scanner-controls-fullscreen">
                <div class="scan-status-fullscreen" id="scanStatusFullscreen">ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...</div>
                <button class="scan-close-btn" onclick="closeFullscreenScan()">âœ• ë‹«ê¸°</button>
            </div>
            
            <!-- ì „ì²´ í™”ë©´ AR ë¹„ë””ì˜¤ ì˜¤ë²„ë ˆì´ -->
            <div class="fullscreen-ar-overlay" id="fullscreenArOverlay" style="
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1001;
                display: none;
                pointer-events: none;
            ">
                <!-- AR ë¹„ë””ì˜¤ -->
                <video id="fullscreenOverlayVideo" class="fullscreen-overlay-video" loop muted playsinline style="
                    position: absolute;
                    border: 3px solid #ff6b35;
                    border-radius: 12px;
                    box-shadow: 0 0 25px rgba(255, 107, 53, 0.8);
                    background: rgba(0, 0, 0, 0.9);
                    z-index: 1002;
                    display: none;
                "></video>
                
                <!-- AR í”„ë ˆì„ -->
                <div id="fullscreenOverlayFrame" class="fullscreen-overlay-frame" style="
                    position: absolute;
                    border: 3px dashed #4CAF50;
                    border-radius: 15px;
                    background: rgba(76, 175, 80, 0.1);
                    pointer-events: none;
                    animation: frameGlow 2s infinite alternate;
                    z-index: 1001;
                    display: none;
                "></div>
                
                <!-- AR ìƒíƒœ í‘œì‹œ -->
                <div id="fullscreenArStatus" class="fullscreen-ar-status" style="
                    position: absolute;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: 600;
                    text-align: center;
                    backdrop-filter: blur(10px);
                    border: 2px solid #ff6b35;
                    z-index: 1003;
                    display: none;
                "></div>
                
                <!-- AR ì»¨íŠ¸ë¡¤ -->
                <div id="fullscreenArControls" class="fullscreen-ar-controls" style="
                    position: absolute;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    display: flex;
                    gap: 10px;
                    z-index: 1003;
                    display: none;
                ">
                    <button onclick="toggleFullscreenVideoSound()" class="fullscreen-ar-btn" style="
                        background: #4CAF50;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 12px;
                        font-weight: 600;
                    ">ğŸ”Š ì†Œë¦¬</button>
                    <button onclick="closeFullscreenAR()" class="fullscreen-ar-btn" style="
                        background: #ff6b35;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 12px;
                        font-weight: 600;
                    ">âœ• ë‹«ê¸°</button>
                </div>
            </div>
            
            <!-- ìë™ ì´ë¯¸ì§€ ê°ì§€ ì˜ì—­ í‘œì‹œ -->
            <div class="auto-detection-area" id="autoDetectionArea" style="
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 80%;
                height: 60%;
                border: 2px dashed #4CAF50;
                border-radius: 20px;
                background: rgba(76, 175, 80, 0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                color: #4CAF50;
                font-size: 16px;
                font-weight: 600;
                text-align: center;
                z-index: 1000;
            ">
                ğŸ” ìë™ ì´ë¯¸ì§€ ê°ì§€ ì˜ì—­<br>
                <span style="font-size: 14px; opacity: 0.8;">í™”ë©´ ì „ì²´ì—ì„œ ì´ë¯¸ì§€ë¥¼ ìë™ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤</span>
            </div>
            
            <div class="scan-instructions-fullscreen" id="scanInstructionsFullscreen">
                í™”ë©´ ì–´ë””ë“  AR ì´ë¯¸ì§€ë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”<br>
                <span style="opacity: 0.7;">ìë™ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì°¾ì•„ì„œ ë¶„ì„í•©ë‹ˆë‹¤</span>
            </div>
        </div>

    <!-- AR ë·°ì–´ -->
    <div class="ar-viewer" id="arViewer">
        <div class="ar-controls">
            <div class="ar-status" id="arStatus">AR ì¤€ë¹„ ì¤‘...</div>
            <button class="ar-close" onclick="closeARViewer()">âœ• ë‹«ê¸°</button>
        </div>

        <!-- ì‹¤ì‹œê°„ ì¹´ë©”ë¼ í™”ë©´ (ë°°ê²½) -->
        <video id="cameraBackground" class="camera-background" autoplay muted playsinline></video>

        <!-- AR ë¹„ë””ì˜¤ ì˜¤ë²„ë ˆì´ -->
        <div class="ar-overlay-container" id="arOverlayContainer">
            <video id="overlayVideo" class="overlay-video" loop muted playsinline></video>
            <div class="overlay-frame" id="overlayFrame"></div>
            <div class="overlay-instructions" id="overlayInstructions">
                ì´ë¯¸ì§€ë¥¼ í”„ë ˆì„ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”
            </div>
        </div>



        <!-- ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="camera-preview" id="cameraPreview">
            <video id="previewVideo" autoplay muted playsinline></video>
        </div>
        
        <!-- mindAR ê¸°ë°˜ ì‹¤ì œ AR ì‹œìŠ¤í…œ -->
        <div class="ar-scene-container" id="arSceneContainer" style="display: none;">
            <a-scene 
                id="ar-scene"
                mindar-image="imageTargetSrc: data:application/octet-stream;base64,; maxTrack: 1; uiLoading: no; uiScanning: no; uiError: no;"
                color-space="sRGB" 
                renderer="colorManagement: true, physicallyCorrectLights, antialias: true, alpha: true"
                vr-mode-ui="enabled: false" 
                device-orientation-permission-ui="enabled: false"
                background="color: transparent"
                embedded
            >
            <a-assets>
                <video id="ar-video" 
                       preload="auto" 
                       loop="true" 
                       muted="false"
                       webkit-playsinline="true" 
                       playsinline="true"
                       crossorigin="anonymous">
                </video>
                <img id="ar-target-image" crossorigin="anonymous" />
            </a-assets>

            <a-entity id="ar-target" mindar-image-target="targetIndex: 0">
                <!-- 3D YouTube ì˜ìƒ í‰ë©´ (AR ì´ë¯¸ì§€ì— ì§ì ‘ ë¶™ìŒ) -->
                <a-plane 
                    id="youtube-3d-plane"
                    width="1.6" 
                    height="0.9" 
                    position="0 0 0.05"
                    rotation="0 0 0"
                    material="color: #000; opacity: 0.9; transparent: true"
                    visible="false"
                    class="youtube-3d-element">
                </a-plane>
                
                <!-- YouTube ì˜ìƒ í…ìŠ¤ì²˜ë¥¼ ìœ„í•œ HTML ìš”ì†Œ -->
                <a-entity
                    id="youtube-html-element"
                    position="0 0 0.06"
                    rotation="0 0 0"
                    scale="1.6 0.9 1"
                    visible="false"
                    class="youtube-3d-element">
                </a-entity>
                
                <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
                <a-text
                    id="loading-text"
                    value="ğŸ“º YouTube ì˜ìƒ ë¡œë”© ì¤‘..."
                    position="0 0 0.15"
                    align="center"
                    color="#4CAF50"
                    font="kelsonsans"
                    scale="0.25 0.25 0.25"
                    visible="false">
                </a-text>
                
                <!-- ì¬ìƒ ì»¨íŠ¸ë¡¤ í‘œì‹œ -->
                <a-text
                    id="control-text"
                    value="ğŸ‘† í„°ì¹˜í•˜ì—¬ ì†Œë¦¬ ì¼œê¸°"
                    position="0 -0.6 0.1"
                    align="center"
                    color="#ff6b35"
                    font="kelsonsans"
                    scale="0.2 0.2 0.2"
                    visible="false">
                </a-text>
                
                <!-- í´ë¦­ ê°ì§€ìš© íˆ¬ëª… í‰ë©´ -->
                <a-plane 
                    id="click-detector"
                    width="1.8" 
                    height="1.1" 
                    position="0 0 0.2"
                    material="transparent: true; opacity: 0"
                    class="clickable">
                </a-plane>
            </a-entity>

            <a-entity camera look-controls="enabled: true" wasd-controls="enabled: false"></a-entity>
        </a-scene>
        </div>

        <!-- 3D YouTube ì˜ìƒ ì»¨í…Œì´ë„ˆ (AR ì´ë¯¸ì§€ì— ì§ì ‘ ë¶™ìŒ) -->
        <div id="youtube-3d-container" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1010;
            display: none;
            pointer-events: none;
        ">
            <!-- 3D YouTube iframe -->
            <iframe id="youtube-3d-iframe" 
                    style="
                        position: absolute;
                        border: 2px solid #ff6b35;
                        border-radius: 8px;
                        box-shadow: 0 0 20px rgba(255, 107, 53, 0.6);
                        pointer-events: auto;
                        transform-origin: center center;
                        transition: transform 0.1s ease-out;
                    "
                    src="" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                    allowfullscreen>
            </iframe>
        </div>
        
        <!-- AR ë””ë²„ê·¸ ì •ë³´ -->
        <div id="ar-debug-info" style="
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1020;
            display: none;
        ">
            <div>ğŸ¯ AR ìƒíƒœ: <span id="debug-status">ëŒ€ê¸° ì¤‘</span></div>
            <div>ğŸ“ ìœ„ì¹˜: <span id="debug-position">-</span></div>
            <div>ğŸ“ í¬ê¸°: <span id="debug-size">-</span></div>
        </div>
    </div>

    <script>
        let currentMode = 'create';
        let uploadedVideo = null;
        let processedVideo = null;
        let extractedFrame = null;
        let arTargetData = null;
        let userInteracted = false;
        let videoElement = null;
        let isPlaying = false;
        let startTime = 0;
        let endTime = 15;
        let videoDuration = 0;
        let scanTimeout = null;
        let videoLoadFailed = false;

        // ìœ íŠœë¸Œ í´ë°± URL
        const FALLBACK_YOUTUBE_URL = 'https://www.youtube.com/watch?v=MX_UceuxveA';
        const YOUTUBE_EMBED_URL = 'https://www.youtube.com/embed/MX_UceuxveA';

        // ëª¨ë“œ ì „í™˜
        function switchMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.create-mode, .scan-mode').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`.${mode}-mode`).classList.add('active');
        }

        // ë¹„ë””ì˜¤ ì—…ë¡œë“œ í•¸ë“¤ë§
        document.getElementById('videoInput').addEventListener('change', handleVideoUpload);
        setupDragDrop();

        function setupDragDrop() {
            const uploadArea = document.querySelector('.upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('video/')) {
                    handleVideoFile(files[0]);
                }
            });
        }

        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (file) handleVideoFile(file);
        }

        async function handleVideoFile(file) {
            uploadedVideo = file;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const preview = document.getElementById('videoPreview');
                preview.innerHTML = `
                    <video src="${e.target.result}" class="preview-video" controls muted></video>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
                        âœ… ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)
                    </div>
                `;
                
                document.getElementById('step1').classList.add('active');
                
                await initVideoEditor(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        async function initVideoEditor(videoSrc) {
            const videoEditor = document.getElementById('videoEditor');
            const editVideo = document.getElementById('editVideo');
            const currentTimeSlider = document.getElementById('currentTimeSlider');
            
            videoEditor.style.display = 'block';
            editVideo.src = videoSrc;
            videoElement = editVideo;
            
            await new Promise((resolve) => {
                editVideo.onloadedmetadata = () => {
                    videoDuration = editVideo.duration;
                    endTime = Math.min(15, videoDuration);
                    
                    currentTimeSlider.max = videoDuration;
                    
                    updateTimeDisplays();
                    updateRangeVisualizer();
                    resolve();
                };
            });
            
            currentTimeSlider.addEventListener('input', (e) => {
                editVideo.currentTime = parseFloat(e.target.value);
                updateTimeDisplays();
            });
            
            editVideo.addEventListener('timeupdate', () => {
                currentTimeSlider.value = editVideo.currentTime;
                updateTimeDisplays();
            });
        }

        function playPauseVideo() {
            if (!videoElement) return;
            
            if (isPlaying) {
                videoElement.pause();
                document.querySelector('.video-controls button').textContent = 'â–¶ï¸';
            } else {
                videoElement.play();
                document.querySelector('.video-controls button').textContent = 'â¸ï¸';
            }
            isPlaying = !isPlaying;
        }

        function setStartTime() {
            if (!videoElement) return;
            
            startTime = videoElement.currentTime;
            
            if (endTime <= startTime) {
                endTime = Math.min(startTime + 15, videoDuration);
            }
            
            if (endTime - startTime > 15) {
                endTime = startTime + 15;
                if (endTime > videoDuration) {
                    endTime = videoDuration;
                    startTime = Math.max(0, endTime - 15);
                }
            }
            
            updateTimeDisplays();
            updateRangeVisualizer();
        }

        function setEndTime() {
            if (!videoElement) return;
            
            endTime = videoElement.currentTime;
            
            if (startTime >= endTime) {
                startTime = Math.max(0, endTime - 15);
            }
            
            if (endTime - startTime > 15) {
                startTime = endTime - 15;
                if (startTime < 0) {
                    startTime = 0;
                    endTime = Math.min(15, videoDuration);
                }
            }
            
            updateTimeDisplays();
            updateRangeVisualizer();
        }

        function updateTimeDisplays() {
            if (!videoElement) return;
            
            const currentTime = videoElement.currentTime;
            const selectedDuration = endTime - startTime;
            
            document.getElementById('currentTimeDisplay').textContent = formatTime(currentTime);
            document.getElementById('startTimeDisplay').textContent = formatTime(startTime);
            document.getElementById('endTimeDisplay').textContent = formatTime(endTime);
            document.getElementById('selectedDuration').textContent = formatTime(selectedDuration);
            
            const durationInfo = document.getElementById('durationInfo');
            if (selectedDuration > 15) {
                durationInfo.style.background = 'rgba(244, 67, 54, 0.1)';
                durationInfo.style.borderColor = 'rgba(244, 67, 54, 0.3)';
            } else {
                durationInfo.style.background = 'rgba(255, 193, 7, 0.1)';
                durationInfo.style.borderColor = 'rgba(255, 193, 7, 0.3)';
            }
        }

        function updateRangeVisualizer() {
            const rangeSelected = document.getElementById('rangeSelected');
            const startPercent = (startTime / videoDuration) * 100;
            const widthPercent = ((endTime - startTime) / videoDuration) * 100;
            
            rangeSelected.style.left = startPercent + '%';
            rangeSelected.style.width = widthPercent + '%';
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        async function processVideo() {
            const progressDiv = document.getElementById('frameExtractionInfo');
            progressDiv.innerHTML = `
                <div class="frame-extraction-info">
                    <div class="spinner"></div>
                    ì„ íƒëœ êµ¬ê°„ (${formatTime(startTime)} - ${formatTime(endTime)})ì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                </div>
            `;
            
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = 640;
                canvas.height = Math.round((640 * videoElement.videoHeight) / videoElement.videoWidth);
                
                const stream = canvas.captureStream(30);
                const chunks = [];
                
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 1000000
                });
                
                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                
                const recordingPromise = new Promise((resolve) => {
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'video/webm' });
                        resolve(blob);
                    };
                });
                
                mediaRecorder.start();
                
                let currentRecordTime = 0;
                const frameInterval = 1000 / 30;
                
                const drawFrame = () => {
                    const videoTime = startTime + currentRecordTime;
                    
                    if (videoTime >= endTime) {
                        mediaRecorder.stop();
                        return;
                    }
                    
                    videoElement.currentTime = videoTime;
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    currentRecordTime += frameInterval / 1000;
                    setTimeout(drawFrame, frameInterval);
                };
                
                videoElement.currentTime = startTime;
                await new Promise(resolve => videoElement.onseeked = resolve);
                drawFrame();
                
                processedVideo = await recordingPromise;
                
                await extractFirstFrame();
                
                progressDiv.innerHTML = `
                    <div class="frame-extraction-info">
                        <div class="check-icon">âœ…</div>
                        <div style="margin: 10px 0; font-weight: 600;">ë¹„ë””ì˜¤ ì²˜ë¦¬ ì™„ë£Œ!</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 10px;">
                            ${formatTime(endTime - startTime)} ê¸¸ì´ì˜ ìµœì í™”ëœ ë¹„ë””ì˜¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤
                        </div>
                        <img src="${extractedFrame}" class="extracted-frame" alt="ì¶”ì¶œëœ í”„ë ˆì„">
                    </div>
                `;
                
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('step2').classList.add('active');
                
            } catch (error) {
                progressDiv.innerHTML = `
                    <div class="frame-extraction-info" style="background: rgba(255,0,0,0.1); border-color: rgba(255,0,0,0.3);">
                        âŒ ë¹„ë””ì˜¤ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}
                    </div>
                `;
            }
        }

        async function extractFirstFrame() {
            try {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(processedVideo);
                video.muted = true;

                await new Promise((resolve, reject) => {
                    video.onloadeddata = resolve;
                    video.onerror = reject;
                });

                video.currentTime = 0.1;

                await new Promise((resolve) => {
                    video.onseeked = resolve;
                });

                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = Math.round((400 * video.videoHeight) / video.videoWidth);
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                extractedFrame = canvas.toDataURL('image/png');
                
            } catch (error) {
                throw new Error('í”„ë ˆì„ ì¶”ì¶œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        async function generateARImage() {
            const progressDiv = document.getElementById('generateProgress');
            const resultDiv = document.getElementById('generateResult');
            
            progressDiv.innerHTML = `
                <div class="progress">
                    <div class="spinner"></div>
                    íŠ¹ìˆ˜ AR ë§ˆì»¤ ì´ë¯¸ì§€ ìƒì„± ì¤‘...
                </div>
            `;

            try {
                console.log('ğŸ¯ íŠ¹ìˆ˜ AR ë§ˆì»¤ ìƒì„± í”„ë¡œì„¸ìŠ¤ ì‹œì‘');
                
                // ì…ë ¥ ë°ì´í„° ê²€ì¦
                if (!extractedFrame) {
                    throw new Error('ì¶”ì¶œëœ í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¹„ë””ì˜¤ë¥¼ ì²˜ë¦¬í•´ì£¼ì„¸ìš”.');
                }
                
                if (!processedVideo) {
                    throw new Error('ì²˜ë¦¬ëœ ë¹„ë””ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¹„ë””ì˜¤ë¥¼ ì—…ë¡œë“œí•˜ê³  ì²˜ë¦¬í•´ì£¼ì„¸ìš”.');
                }
                
                // íŠ¹ìˆ˜ ë§ˆì»¤ê°€ í¬í•¨ëœ AR ì´ë¯¸ì§€ ìƒì„±
                const specialARImageDataURL = await generateSpecialARMarker(extractedFrame);
                
                if (!specialARImageDataURL) {
                    throw new Error('íŠ¹ìˆ˜ ë§ˆì»¤ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨');
                }
                
                console.log('ğŸ“¹ ë¹„ë””ì˜¤ ë°ì´í„° ë³€í™˜ ì‹œì‘');
                const videoBase64 = await blobToBase64(processedVideo);
                
                const arId = 'ar_' + Date.now();
                arTargetData = {
                    id: arId,
                    videoData: videoBase64,
                    targetImage: specialARImageDataURL, // íŠ¹ìˆ˜ ë§ˆì»¤ ì´ë¯¸ì§€ ì‚¬ìš©
                    originalFrame: extractedFrame, // ì›ë³¸ í”„ë ˆì„ ë³„ë„ ì €ì¥
                    fileName: uploadedVideo.name,
                    duration: endTime - startTime,
                    createdAt: new Date().toISOString(),
                    fallbackUrl: FALLBACK_YOUTUBE_URL,
                    type: 'ar_image_video',
                    hasSpecialMarkers: true,
                    markerType: 'advanced_tracking'
                };
                
                localStorage.setItem('arData_' + arId, JSON.stringify(arTargetData));
                
                progressDiv.innerHTML = '';
                resultDiv.innerHTML = `
                    <div class="ar-result">
                        <div class="check-icon">âœ…</div>
                        <div style="margin: 10px 0; font-weight: 600;">íŠ¹ìˆ˜ AR ë§ˆì»¤ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!</div>
                        
                        <div class="target-image-container">
                            <div style="color: #333; font-weight: 600; margin-bottom: 10px;">ğŸ¯ íŠ¹ìˆ˜ AR ë§ˆì»¤ ì´ë¯¸ì§€</div>
                            <img src="${specialARImageDataURL}" class="target-image" alt="Special AR Marker Image">
                            <div style="color: #666; font-size: 12px; margin-top: 10px;">
                                ID: ${arId}<br>
                                ê¸¸ì´: ${formatTime(arTargetData.duration)}<br>
                                ë§ˆì»¤: ì •ë°€ ì¶”ì  ì‹œìŠ¤í…œ<br>
                                í´ë°±: YouTube ì˜ìƒ
                            </div>
                        </div>
                        
                        <div class="marker-features" style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; padding: 12px; margin: 15px 0;">
                            <div style="font-weight: 600; color: #4CAF50; margin-bottom: 8px;">ğŸ” í¬í•¨ëœ íŠ¹ìˆ˜ ë§ˆì»¤:</div>
                            <ul style="font-size: 12px; line-height: 1.4; margin: 0; padding-left: 20px;">
                                <li>ğŸ“ 4ê°œ ì½”ë„ˆ ë§ˆì»¤: ë°©í–¥ë³„ ê³ ìœ  íŒ¨í„´ìœ¼ë¡œ ì •í™•í•œ ìœ„ì¹˜ ì¶”ì </li>
                                <li>ğŸ“¹ ë¹„ë””ì˜¤ ì˜ì—­ ë§ˆì»¤: YouTube ì¬ìƒ ìœ„ì¹˜ ì •í™•íˆ ì •ì˜</li>
                                <li>ğŸ¯ ì¤‘ì•™ ì¶”ì  ë§ˆì»¤: ì‹¤ì‹œê°„ ìœ„ì¹˜ ë° ê°ë„ ê°ì§€</li>
                                <li>ğŸ“ í¬ê¸°/íšŒì „ ë§ˆì»¤: ë™ì  ìŠ¤ì¼€ì¼ë§ ë° íšŒì „ ë³´ì •</li>
                                <li>ğŸ”¢ ë””ì§€í„¸ ì‹œê·¸ë‹ˆì²˜: ê³ ìœ  ì‹ë³„ ë°”ì½”ë“œ</li>
                            </ul>
                        </div>
                        
                        <div style="font-size: 13px; opacity: 0.9; margin: 15px 0;">
                            ğŸ“± íŠ¹ìˆ˜ ë§ˆì»¤ë¥¼ ìŠ¤ìº”í•˜ë©´ ì •í™•í•œ ìœ„ì¹˜ì— AR ë¹„ë””ì˜¤ê°€ ì¬ìƒë©ë‹ˆë‹¤<br>
                            ğŸ–¨ï¸ ì¸ì‡„í•˜ê±°ë‚˜ ë‹¤ë¥¸ í™”ë©´ì— í‘œì‹œí•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”<br>
                            ğŸ¯ í–¥ìƒëœ ì¶”ì  ì •í™•ë„ë¡œ ì•ˆì •ì ì¸ AR ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤
                        </div>
                        
                        <div class="download-section">
                            <button class="download-btn" onclick="downloadARImage('${arId}')">
                                ğŸ’¾ íŠ¹ìˆ˜ ë§ˆì»¤ ì €ì¥
                            </button>
                            <button class="download-btn share-btn" onclick="shareARImage('${arId}')">
                                ğŸ“¤ ê³µìœ í•˜ê¸°
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                progressDiv.innerHTML = '';
                resultDiv.innerHTML = `
                    <div class="progress" style="background: rgba(255,0,0,0.2);">
                        âŒ íŠ¹ìˆ˜ AR ë§ˆì»¤ ìƒì„± ì‹¤íŒ¨: ${error.message}
                    </div>
                `;
            }
        }

        async function generateSpecialARMarker(originalFrameDataURL) {
            return new Promise(async (resolve, reject) => {
                try {
                    console.log('ğŸ¯ íŠ¹ìˆ˜ AR ë§ˆì»¤ ìƒì„± ì‹œì‘');
                    
                    // ì…ë ¥ ë°ì´í„° ê²€ì¦
                    if (!originalFrameDataURL || typeof originalFrameDataURL !== 'string') {
                        throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë¯¸ì§€ ë°ì´í„°');
                    }
                    
                    // ìº”ë²„ìŠ¤ ìƒì„± ë° ê²€ì¦
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    if (!ctx) {
                        throw new Error('ìº”ë²„ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨');
                    }
                    
                    // AR ì¸ì‹ì„ ìœ„í•œ ìµœì  í¬ê¸° ì„¤ì •
                    const arSize = 800;
                    canvas.width = arSize;
                    canvas.height = arSize;
                    
                    console.log('ğŸ“ ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •:', arSize, 'x', arSize);
                    
                    // í°ìƒ‰ ë°°ê²½
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, arSize, arSize);
                    
                    // ì›ë³¸ ì´ë¯¸ì§€ ë¡œë“œ
                    const img = new Image();
                    
                    // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ íƒ€ì„ì•„ì›ƒ ì„¤ì •
                    const timeoutId = setTimeout(() => {
                        reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹œê°„ ì´ˆê³¼ (10ì´ˆ)'));
                    }, 10000);
                    
                    img.onload = () => {
                        try {
                            clearTimeout(timeoutId);
                            console.log('ğŸ“· ì›ë³¸ ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ:', img.width, 'x', img.height);
                            
                            // ì´ë¯¸ì§€ í¬ê¸° ê²€ì¦
                            if (img.width === 0 || img.height === 0) {
                                throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë¯¸ì§€ í¬ê¸°');
                            }
                            
                            // ì´ë¯¸ì§€ í¬ê¸° ê³„ì‚° (ì •ì‚¬ê°í˜•ìœ¼ë¡œ í¬ë¡­)
                            const imgSize = Math.min(img.width, img.height);
                            const cropX = (img.width - imgSize) / 2;
                            const cropY = (img.height - imgSize) / 2;
                            
                            console.log('ğŸ”„ ì´ë¯¸ì§€ í¬ë¡­ ì •ë³´:', { imgSize, cropX, cropY });
                            
                            // ì—¬ë°±ì„ ë‘” ì´ë¯¸ì§€ í¬ê¸° ê³„ì‚° (íŠ¹ìˆ˜ ë§ˆì»¤ë¥¼ ìœ„í•œ ê³µê°„ í™•ë³´)
                            const imageMargin = 120;
                            const imageSize = arSize - (imageMargin * 2);
                            
                            // ì¤‘ì•™ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                            ctx.drawImage(
                                img, 
                                cropX, cropY, imgSize, imgSize,
                                imageMargin, imageMargin, imageSize, imageSize
                            );
                            
                            console.log('ğŸ–¼ï¸ ì¤‘ì•™ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° ì™„ë£Œ');
                        
                        // ê³ ìœ  ID ìƒì„± ë° ìŠ¤í…Œê°€ë…¸ê·¸ë˜í”¼ íŒ¨í„´ ì‚½ì…
                        const uniqueId = generateUniqueId();
                        console.log(`ğŸ” ê³ ìœ  ID ìƒì„±: ${uniqueId}`);
                        
                        // ìŠ¤í…Œê°€ë…¸ê·¸ë˜í”¼ íŒ¨í„´ ì‚½ì…
                        insertSteganographyPattern(ctx, arSize, arSize, uniqueId);
                        
                        // ë§ˆì´í¬ë¡œ ë„íŠ¸ íŒ¨í„´ ì‚½ì…
                        insertMicroDotPattern(ctx, arSize, arSize, uniqueId);
                        
                        console.log(`ğŸ” íŒ¨í„´ ì‚½ì… ì™„ë£Œ - ìŠ¤í…Œê°€ë…¸ê·¸ë˜í”¼ + ë§ˆì´í¬ë¡œ ë„íŠ¸`);
                        
                        // íŒ¨í„´ ì‚½ì… í™•ì¸ì„ ìœ„í•œ ë””ë²„ê¹… ì •ë³´
                        const testPattern = extractSteganographyPattern(ctx.getImageData(0, 0, arSize, arSize).data, arSize, arSize);
                        console.log(`ğŸ” ì‚½ì…ëœ íŒ¨í„´ í™•ì¸: ${testPattern.length}ê°œ íŒ¨í„´ í¬ì¸íŠ¸`);
                        
                        // === ê°„ë‹¨í•œ AR ë§ˆì»¤ ì‹œìŠ¤í…œ ===
                        
                        // 1. ê°„ë‹¨í•œ í…Œë‘ë¦¬ë§Œ ì¶”ê°€
                        ctx.strokeStyle = '#000000';
                        ctx.lineWidth = 8;
                        ctx.strokeRect(imageMargin - 8, imageMargin - 8, imageSize + 16, imageSize + 16);
                        
                        // 2. 4ê°œ ì½”ë„ˆì— ê°„ë‹¨í•œ ë§ˆì»¤ë§Œ ì¶”ê°€
                        const cornerSize = 40;
                        const cornerMargin = 10;
                        const corners = [
                            [cornerMargin, cornerMargin],
                            [arSize - cornerMargin - cornerSize, cornerMargin],
                            [cornerMargin, arSize - cornerMargin - cornerSize],
                            [arSize - cornerMargin - cornerSize, arSize - cornerMargin - cornerSize]
                        ];
                        
                        corners.forEach(([x, y], index) => {
                            // ê°„ë‹¨í•œ ì‚¬ê°í˜• ë§ˆì»¤
                            ctx.fillStyle = '#000000';
                            ctx.fillRect(x, y, cornerSize, cornerSize);
                            
                            // í°ìƒ‰ ë‚´ë¶€
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(x + 4, y + 4, cornerSize - 8, cornerSize - 8);
                            
                            // ì¤‘ì•™ì— ì‘ì€ ê²€ì€ ì 
                            ctx.fillStyle = '#000000';
                            ctx.fillRect(x + cornerSize/2 - 4, y + cornerSize/2 - 4, 8, 8);
                        });
                        
                            // ì™„ì„±ëœ íŠ¹ìˆ˜ ë§ˆì»¤ ì´ë¯¸ì§€ ë°˜í™˜
                            const specialMarkerDataURL = canvas.toDataURL('image/png', 0.95);
                            console.log('âœ… íŠ¹ìˆ˜ ë§ˆì»¤ ìƒì„± ì™„ë£Œ');
                            resolve(specialMarkerDataURL);
                            
                        } catch (drawError) {
                            clearTimeout(timeoutId);
                            console.error('ğŸš« ë§ˆì»¤ ê·¸ë¦¬ê¸° ì˜¤ë¥˜:', drawError);
                            reject(new Error('íŠ¹ìˆ˜ ë§ˆì»¤ ê·¸ë¦¬ê¸° ì‹¤íŒ¨: ' + drawError.message));
                        }
                    };
                    
                    img.onerror = (errorEvent) => {
                        clearTimeout(timeoutId);
                        console.error('ğŸš« ì´ë¯¸ì§€ ë¡œë“œ ì˜¤ë¥˜:', errorEvent);
                        reject(new Error('ì›ë³¸ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
                    };
                    
                    // CORS ì„¤ì •
                    img.crossOrigin = 'anonymous';
                    
                    // ì´ë¯¸ì§€ ë¡œë“œ ì‹œì‘
                    console.log('ğŸ”„ ì´ë¯¸ì§€ ë¡œë“œ ì‹œì‘...');
                    img.src = originalFrameDataURL;
                    
                } catch (error) {
                    console.error('ğŸš« íŠ¹ìˆ˜ ë§ˆì»¤ ìƒì„± ì˜¤ë¥˜:', error);
                    reject(new Error('íŠ¹ìˆ˜ ë§ˆì»¤ ìƒì„± ì‹¤íŒ¨: ' + error.message));
                }
            });
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function downloadARImage(arId) {
            try {
                const arData = JSON.parse(localStorage.getItem(`arData_${arId}`));
                
                if (arData && arData.targetImage) {
                    // íŠ¹ìˆ˜ ë§ˆì»¤ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                    const link = document.createElement('a');
                    const fileName = arData.hasSpecialMarkers ? 
                        `Special_AR_Marker_${arId}.png` : 
                        `AR_Target_${arId}.png`;
                    
                    link.download = fileName;
                    link.href = arData.targetImage;
                    link.click();
                    
                    console.log('ğŸ“¥ AR ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ:', fileName);
                } else if (extractedFrame) {
                    // í´ë°±: ì›ë³¸ í”„ë ˆì„ ë‹¤ìš´ë¡œë“œ
                    const link = document.createElement('a');
                    link.download = `AR_Frame_${arId}.png`;
                    link.href = extractedFrame;
                    link.click();
                    
                    console.log('ğŸ“¥ ì›ë³¸ í”„ë ˆì„ ë‹¤ìš´ë¡œë“œ:', `AR_Frame_${arId}.png`);
                } else {
                    alert('ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        function shareARImage(arId) {
            const shareUrl = `${window.location.origin}${window.location.pathname}?ar=${arId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'AR íƒ€ê²Ÿ ì´ë¯¸ì§€',
                    text: 'AR ë¹„ë””ì˜¤ë¥¼ ì²´í—˜í•´ë³´ì„¸ìš”!',
                    url: shareUrl
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('ê³µìœ  ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }).catch(() => {
                    prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:', shareUrl);
                });
            }
        }

        async function startFullscreenScan() {
            console.log('ğŸ” ì „ì²´ í™”ë©´ ìŠ¤ìº” ì‹œì‘ - í•¨ìˆ˜ í˜¸ì¶œë¨');
            
            // ë²„íŠ¼ ìƒíƒœ í™•ì¸
            const btn = document.getElementById('startScanBtn');
            if (btn) {
                console.log('âœ… ìŠ¤ìº” ë²„íŠ¼ ì°¾ìŒ');
                btn.disabled = true;
                btn.textContent = 'ğŸ”„ ìŠ¤ìº” ì‹œì‘ ì¤‘...';
            } else {
                console.error('âŒ ìŠ¤ìº” ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            const fullscreenScanner = document.getElementById('fullscreenScanner');
            const scanStatusFullscreen = document.getElementById('scanStatusFullscreen');
            const scanInstructionsFullscreen = document.getElementById('scanInstructionsFullscreen');
            const scannerVideoFullscreen = document.getElementById('scannerVideoFullscreen');
            
            // ì „ì²´ í™”ë©´ ìŠ¤ìºë„ˆ í‘œì‹œ
            fullscreenScanner.classList.add('active');
            fullscreenScanner.style.display = 'block';
            scanStatusFullscreen.textContent = 'ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            
            // í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€
            document.body.style.overflow = 'hidden';
            
            try {
                let stream = null;
                
                try {
                    // 1ì°¨ ì‹œë„: í›„ë©´ ì¹´ë©”ë¼ (í™˜ê²½)
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1920, min: 1280 },
                            height: { ideal: 1080, min: 720 }
                        } 
                    });
                } catch (envError) {
                    console.warn('í›„ë©´ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', envError.message);
                    
                    try {
                        // 2ì°¨ ì‹œë„: ì „ë©´ ì¹´ë©”ë¼
                        scanStatusFullscreen.textContent = 'ì „ë©´ ì¹´ë©”ë¼ë¡œ ì‹œë„ ì¤‘...';
                        
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: { ideal: 'user' },
                                width: { ideal: 1920, min: 1280 },
                                height: { ideal: 1080, min: 720 }
                            } 
                        });
                    } catch (userError) {
                        console.warn('ì „ë©´ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', userError.message);
                        
                        try {
                            // 3ì°¨ ì‹œë„: ê¸°ë³¸ ë¹„ë””ì˜¤
                            scanStatusFullscreen.textContent = 'ê¸°ë³¸ ì¹´ë©”ë¼ë¡œ ì‹œë„ ì¤‘...';
                            
                            stream = await navigator.mediaDevices.getUserMedia({ 
                                video: {
                                    width: { ideal: 1280, min: 640 },
                                    height: { ideal: 720, min: 480 }
                                }
                            });
                        } catch (basicError) {
                            console.warn('ê¸°ë³¸ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', basicError.message);
                            
                            try {
                                // 4ì°¨ ì‹œë„: ìµœì†Œ ì„¤ì •
                                scanStatusFullscreen.textContent = 'ìµœì†Œ ì„¤ì •ìœ¼ë¡œ ì‹œë„ ì¤‘...';
                                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                            } catch (finalError) {
                                throw new Error(`ëª¨ë“  ì¹´ë©”ë¼ ì ‘ê·¼ ì‹œë„ ì‹¤íŒ¨: ${finalError.message}`);
                            }
                        }
                    }
                }
                
                if (stream) {
                    scannerVideoFullscreen.srcObject = stream;
                    
                    // ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì´ ì‹¤ì œë¡œ ì‹œì‘ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    await new Promise((resolve, reject) => {
                        scannerVideoFullscreen.onloadedmetadata = () => {
                            scannerVideoFullscreen.play().then(resolve).catch(reject);
                        };
                        scannerVideoFullscreen.onerror = reject;
                        
                        // 5ì´ˆ íƒ€ì„ì•„ì›ƒ
                        setTimeout(() => reject(new Error('ë¹„ë””ì˜¤ ì‹œì‘ ì‹œê°„ ì´ˆê³¼')), 5000);
                    });
                    
                    // ì„±ê³µ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                    scanStatusFullscreen.textContent = 'ğŸ” ìë™ ì´ë¯¸ì§€ ê°ì§€ ì¤€ë¹„ ì™„ë£Œ';
                    scanInstructionsFullscreen.innerHTML = `
                        í™”ë©´ ì–´ë””ë“  AR ì´ë¯¸ì§€ë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”<br>
                        <span style="opacity: 0.7;">ìë™ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì°¾ì•„ì„œ ë¶„ì„í•©ë‹ˆë‹¤</span>
                    `;
                    
                    // ì¦‰ì‹œ ìë™ ê°ì§€ ì‹œì‘ (í”„ë ˆì„ ì œí•œ ì—†ìŒ)
                    scanTimeout = setTimeout(() => {
                        console.log('ğŸ” ì „ì²´ í™”ë©´ ìë™ ì´ë¯¸ì§€ ê°ì§€ ì‹œì‘');
                        startAutoDetectionFullscreen();
                    }, 1000);
                } else {
                    throw new Error('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
            } catch (error) {
                console.error('ì „ì²´ í™”ë©´ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', error);
                showFullscreenScanError(error);
            }
        }

        async function startImageScan() {
            try {
                console.log('ğŸ” ì´ë¯¸ì§€ ìŠ¤ìº” ì‹œì‘ - YouTube ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€');
                
                // AR ì´ë¯¸ì§€ ì¸ì‹ ì „ê¹Œì§€ YouTube ì˜¤ë²„ë ˆì´ ì™„ì „íˆ ìˆ¨ê¹€
                hideYouTubeOverlay();
                
                const container = document.getElementById('scannerContainer');
                const video = document.getElementById('scannerVideo');
                const btn = document.getElementById('startScanBtn');
                
                btn.style.display = 'none';
                container.style.display = 'block';
                
                // ì¹´ë©”ë¼ ê¶Œí•œ ë° ì ‘ê·¼ ìƒíƒœ í‘œì‹œ
                document.getElementById('scan-instructions').innerHTML = `
                    ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br>
                    <span style="opacity: 0.7;">ë¸Œë¼ìš°ì €ì—ì„œ í—ˆìš©ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</span>
                `;
                
                let stream = null;
                
                try {
                    // 1ì°¨ ì‹œë„: í›„ë©´ ì¹´ë©”ë¼ (í™˜ê²½)
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 }
                        } 
                    });
                } catch (envError) {
                    console.warn('í›„ë©´ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', envError.message);
                    
                    try {
                        // 2ì°¨ ì‹œë„: ì „ë©´ ì¹´ë©”ë¼
                        document.getElementById('scan-instructions').innerHTML = `
                            í›„ë©´ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨. ì „ë©´ ì¹´ë©”ë¼ë¡œ ì‹œë„ ì¤‘...<br>
                            <span style="opacity: 0.7;">ì „ë©´ ì¹´ë©”ë¼ë¡œ ìŠ¤ìº”í•˜ì„¸ìš”</span>
                        `;
                        
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: { ideal: 'user' },
                                width: { ideal: 1280, min: 640 },
                                height: { ideal: 720, min: 480 }
                            } 
                        });
                    } catch (userError) {
                        console.warn('ì „ë©´ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', userError.message);
                        
                        try {
                            // 3ì°¨ ì‹œë„: ê¸°ë³¸ ë¹„ë””ì˜¤ (ì¹´ë©”ë¼ ì§€ì • ì—†ìŒ)
                            document.getElementById('scan-instructions').innerHTML = `
                                ê¸°ë³¸ ì¹´ë©”ë¼ë¡œ ì‹œë„ ì¤‘...<br>
                                <span style="opacity: 0.7;">ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤</span>
                            `;
                            
                            stream = await navigator.mediaDevices.getUserMedia({ 
                                video: {
                                    width: { ideal: 640, min: 320 },
                                    height: { ideal: 480, min: 240 }
                                }
                            });
                        } catch (basicError) {
                            console.warn('ê¸°ë³¸ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', basicError.message);
                            
                            try {
                                // 4ì°¨ ì‹œë„: ìµœì†Œ ì„¤ì •
                                document.getElementById('scan-instructions').innerHTML = `
                                    ìµœì†Œ ì„¤ì •ìœ¼ë¡œ ì‹œë„ ì¤‘...<br>
                                    <span style="opacity: 0.7;">ì¹´ë©”ë¼ë¥¼ í™œì„±í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤</span>
                                `;
                                
                                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                            } catch (finalError) {
                                throw new Error(`ëª¨ë“  ì¹´ë©”ë¼ ì ‘ê·¼ ì‹œë„ ì‹¤íŒ¨: ${finalError.message}`);
                            }
                        }
                    }
                }
                
                if (stream) {
                    video.srcObject = stream;
                    
                    // ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì´ ì‹¤ì œë¡œ ì‹œì‘ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    await new Promise((resolve, reject) => {
                        video.onloadedmetadata = () => {
                            video.play().then(resolve).catch(reject);
                        };
                        video.onerror = reject;
                        
                        // 5ì´ˆ íƒ€ì„ì•„ì›ƒ
                        setTimeout(() => reject(new Error('ë¹„ë””ì˜¤ ì‹œì‘ ì‹œê°„ ì´ˆê³¼')), 5000);
                    });
                    
                    // ì„±ê³µ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                    document.getElementById('scan-instructions').innerHTML = `
                        ìƒì„±ëœ AR ì´ë¯¸ì§€ë¥¼ í”„ë ˆì„ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”<br>
                        <span style="opacity: 0.7;">3ì´ˆ í›„ ìë™ ê°ì§€</span>
                    `;
                    
                    // 3ì´ˆ í›„ ìë™ ê°ì§€
                    scanTimeout = setTimeout(() => {
                        console.log('3ì´ˆ ìë™ ê°ì§€ ì‹œì‘');
                        attemptImageDetection();
                    }, 3000);
                } else {
                    throw new Error('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì „ì²´ ì‹¤íŒ¨:', error);
                
                // ì‚¬ìš©ìì—ê²Œ ìƒì„¸í•œ ì•ˆë‚´ ì œê³µ
                let errorMessage = 'ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨';
                let helpMessage = '';
                
                if (error.name === 'NotAllowedError' || error.message.includes('Permission denied')) {
                    errorMessage = 'ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">ğŸ“± í•´ê²° ë°©ë²•:</div>
                            <div style="text-align: left;">
                                â€¢ ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì˜ ğŸ”’ ì•„ì´ì½˜ í´ë¦­<br>
                                â€¢ ì¹´ë©”ë¼ ê¶Œí•œì„ "í—ˆìš©"ìœ¼ë¡œ ë³€ê²½<br>
                                â€¢ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„<br>
                                â€¢ ë˜ëŠ” ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œ í™•ì¸
                            </div>
                        </div>
                    `;
                } else if (error.name === 'NotFoundError' || error.message.includes('Requested device not found')) {
                    errorMessage = 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">ğŸ“± í•´ê²° ë°©ë²•:</div>
                            <div style="text-align: left;">
                                â€¢ ë‹¤ë¥¸ ì¹´ë©”ë¼ ì•±ì´ ì‹¤í–‰ì¤‘ì¸ì§€ í™•ì¸<br>
                                â€¢ ë¸Œë¼ìš°ì €ë¥¼ ì™„ì „íˆ ì¢…ë£Œ í›„ ë‹¤ì‹œ ì‹¤í–‰<br>
                                â€¢ ê¸°ê¸° ì¬ì‹œì‘ í›„ ë‹¤ì‹œ ì‹œë„<br>
                                â€¢ ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ì—ì„œ ì‹œë„
                            </div>
                        </div>
                    `;
                } else if (error.name === 'NotSupportedError' || error.message.includes('not supported')) {
                    errorMessage = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">ğŸ“± í•´ê²° ë°©ë²•:</div>
                            <div style="text-align: left;">
                                â€¢ Chrome, Safari, Firefox ë“± ìµœì‹  ë¸Œë¼ìš°ì € ì‚¬ìš©<br>
                                â€¢ HTTPS ì—°ê²°ì¸ì§€ í™•ì¸ (http:// â†’ https://)<br>
                                â€¢ ë¸Œë¼ìš°ì € ì—…ë°ì´íŠ¸<br>
                                â€¢ ì•± ë‚´ ë¸Œë¼ìš°ì €ê°€ ì•„ë‹Œ ê¸°ë³¸ ë¸Œë¼ìš°ì € ì‚¬ìš©
                            </div>
                        </div>
                    `;
                } else if (error.name === 'OverconstrainedError' || error.message.includes('Could not start video source')) {
                    errorMessage = 'ì¹´ë©”ë¼ ì„¤ì •ì„ ì¡°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                    helpMessage = `
                        <div style="margin-top: 15px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">ğŸ“± í•´ê²° ë°©ë²•:</div>
                            <div style="text-align: left;">
                                â€¢ ë‹¤ë¥¸ ì•±ì—ì„œ ì¹´ë©”ë¼ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸<br>
                                â€¢ ì¹´ë©”ë¼ ì•± ê°•ì œ ì¢…ë£Œ í›„ ë‹¤ì‹œ ì‹œë„<br>
                                â€¢ ê¸°ê¸° ì¬ì‹œì‘<br>
                                â€¢ ì•„ë˜ "ì¹´ë©”ë¼ ì—†ì´ ì²´í—˜" ë²„íŠ¼ ì‚¬ìš©
                            </div>
                        </div>
                    `;
                }
                
                // ì˜¤ë¥˜ UI í‘œì‹œ
                document.getElementById('scannerContainer').style.display = 'none';
                document.getElementById('startScanBtn').style.display = 'none';
                
                const container = document.getElementById('scannerContainer').parentElement;
                const errorDiv = document.createElement('div');
                errorDiv.className = 'scan-error';
                errorDiv.style.cssText = `
                    background: rgba(244, 67, 54, 0.1);
                    border: 1px solid rgba(244, 67, 54, 0.3);
                    border-radius: 10px;
                    padding: 20px;
                    margin: 15px 0;
                    text-align: center;
                `;
                
                errorDiv.innerHTML = `
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #ff6b35;">
                        âŒ ${errorMessage}
                    </div>
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 15px;">
                        ${error.message}
                    </div>
                    ${helpMessage}
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn" onclick="retryCamera()" style="flex: 1; font-size: 12px; padding: 8px 16px;">
                            ğŸ”„ ë‹¤ì‹œ ì‹œë„
                        </button>
                        <button class="btn" onclick="simulateImageDetection()" style="flex: 1; font-size: 12px; padding: 8px 16px; background: #4CAF50;">
                            ğŸ“· ì¹´ë©”ë¼ ì—†ì´ ì²´í—˜
                        </button>
                    </div>
                `;
                
                // ê¸°ì¡´ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê±°
                const existingError = container.querySelector('.scan-error');
                if (existingError) {
                    existingError.remove();
                }
                
                container.appendChild(errorDiv);
            }
        }

        function retryCamera() {
            // ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê±°
            const errorDiv = document.querySelector('.scan-error');
            if (errorDiv) {
                errorDiv.remove();
            }
            
            // ìŠ¤ìº” ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
            document.getElementById('startScanBtn').style.display = 'block';
        }

        function attemptImageDetection() {
            const arKeys = Object.keys(localStorage).filter(key => key.startsWith('arData_'));
            if (arKeys.length === 0) {
                alert('ìŠ¤ìº”í•  AR ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € AR ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            console.log('ì´ë¯¸ì§€ ê°ì§€ ì‹œë„, ì €ì¥ëœ AR ë°ì´í„°:', arKeys.length + 'ê°œ');
            
            // ì‹¤ì œ ì´ë¯¸ì§€ ì¸ì‹ ì‹œë„
            attemptRealImageDetection(arKeys);
        }

        function simulateImageDetection() {
            // ì´ í•¨ìˆ˜ëŠ” "ì¹´ë©”ë¼ ì—†ì´ ì²´í—˜" ë²„íŠ¼ìš©
            console.log('ìˆ˜ë™ ì‹œë®¬ë ˆì´ì…˜ ê°ì§€ ì‹œì‘');
            attemptImageDetection();
        }

        function startAutoDetectionFullscreen() {
            console.log('ğŸ” ì „ì²´ í™”ë©´ ìë™ ì´ë¯¸ì§€ ê°ì§€ ì‹œì‘');
            
            const arKeys = Object.keys(localStorage).filter(key => key.startsWith('arData_'));
            if (arKeys.length === 0) {
                document.getElementById('scanInstructionsFullscreen').innerHTML = `
                    âŒ ìŠ¤ìº”í•  AR ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤<br>
                    <span style="color: #ff6b35;">ë¨¼ì € AR ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”</span>
                `;
                return;
            }
            
            console.log('ğŸ” ì „ì²´ í™”ë©´ì—ì„œ ìë™ ì´ë¯¸ì§€ ê°ì§€ ì‹œì‘, ì €ì¥ëœ AR ë°ì´í„°:', arKeys.length + 'ê°œ');
            
            // ì „ì²´ í™”ë©´ì—ì„œ ìë™ ì´ë¯¸ì§€ ì¸ì‹ ì‹œë„
            attemptAutoImageDetectionFullscreen(arKeys);
        }

                function attemptAutoImageDetectionFullscreen(arKeys) {
            const video = document.getElementById('scannerVideoFullscreen');
            const scanStatusFullscreen = document.getElementById('scanStatusFullscreen');
            const scanInstructionsFullscreen = document.getElementById('scanInstructionsFullscreen');
            const autoDetectionArea = document.getElementById('autoDetectionArea');
            
            if (!video || !video.srcObject) {
                console.log('ğŸ” ì „ì²´ í™”ë©´ ì¹´ë©”ë¼ê°€ ì—†ìŒ, ì§ì ‘ ê°ì§€ ëª¨ë“œë¡œ ì‹¤í–‰');
                
                const latestKey = arKeys[arKeys.length - 1];
                const arId = latestKey.replace('arData_', '');
                
                scanInstructionsFullscreen.innerHTML = `
                    ğŸ¯ ì´ë¯¸ì§€ ìë™ ê°ì§€!<br>
                    <span style="color: #4CAF50;">AR ì˜ìƒì„ ë¡œë”©í•©ë‹ˆë‹¤...</span>
                `;
                
                setTimeout(() => {
                    try {
                        loadFullscreenAR(arId);
                    } catch (error) {
                        console.error('AR ë¡œë”© ì˜¤ë¥˜:', error);
                        scanInstructionsFullscreen.innerHTML = `
                            <span style="color: #ff6b35;">âŒ AR ë¡œë”© ì‹¤íŒ¨</span><br>
                            <span style="opacity: 0.8;">ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</span>
                        `;
                    }
                }, 1000);
                return;
            }

            scanInstructionsFullscreen.innerHTML = `
                <span style="color: #4CAF50;">ğŸ” ìë™ ì´ë¯¸ì§€ ê²€ìƒ‰ ì¤‘...</span><br>
                <span style="opacity: 0.8; font-size: 14px;">í™”ë©´ ì „ì²´ì—ì„œ ì´ë¯¸ì§€ë¥¼ ìë™ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤</span>
            `;

            // ìë™ ê°ì§€ ì˜ì—­ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            autoDetectionArea.style.animation = 'pulse 2s infinite';

            // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ê°ì§€ ì‹œìŠ¤í…œ
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 320; // ì‘ì€ í¬ê¸°ë¡œ ì„±ëŠ¥ í–¥ìƒ
            canvas.height = 240;

            let detectionCount = 0;
            const maxDetections = 30; // 30ì´ˆ ë™ì•ˆ ì‹œë„
            let currentFullscreenARId = null; // í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ì „ì²´ í™”ë©´ AR ID

            const detectInterval = setInterval(async () => {
                detectionCount++;

                try {
                    // í˜„ì¬ í”„ë ˆì„ ìº¡ì²˜
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const currentFrame = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // ì €ì¥ëœ AR ì´ë¯¸ì§€ë“¤ê³¼ ë¹„êµ (ë¹„ë™ê¸° ì²˜ë¦¬)
                    let bestMatch = null;
                    let bestScore = 0;
                    
                    // ë³‘ë ¬ë¡œ ëª¨ë“  ì´ë¯¸ì§€ ë¹„êµ
                    const comparisonPromises = arKeys.map(async (key) => {
                        try {
                            const arData = JSON.parse(localStorage.getItem(key));
                            if (arData && arData.targetImage) {
                                const similarity = await compareImages(currentFrame, arData.targetImage);
                                return {
                                    id: key.replace('arData_', ''),
                                    score: similarity,
                                    data: arData,
                                    hasSpecialMarkers: arData.hasSpecialMarkers || false
                                };
                            }
                            return null;
                        } catch (error) {
                            console.warn(`ì´ë¯¸ì§€ ë¹„êµ ì˜¤ë¥˜ (${key}):`, error);
                            return null;
                        }
                    });
                    
                    const results = await Promise.all(comparisonPromises);
                    
                    // ìµœê³  ì ìˆ˜ ì°¾ê¸°
                    results.forEach(result => {
                        if (result && result.score > bestScore) {
                            bestScore = result.score;
                            bestMatch = result;
                        }
                    });

                    // ë§¤ìš° ë‚®ì€ ì„ê³„ê°’ìœ¼ë¡œ ê°ì§€ ë¯¼ê°ë„ í–¥ìƒ
                    const threshold = 0.1; // 10%ë§Œ ì¼ì¹˜í•´ë„ ê°ì§€
                    
                    console.log(`ğŸ” ì „ì²´ í™”ë©´ ìë™ ê°ì§€ ${detectionCount}: ìµœê³  ìœ ì‚¬ë„ ${Math.round(bestScore * 100)}%`);
                    console.log(`ğŸ“Š ê°ì§€ ìƒì„¸ ì •ë³´:`, {
                        ê²€ìƒ‰ëœ_ì´ë¯¸ì§€_ìˆ˜: arKeys.length,
                        ìµœê³ _ë§¤ì¹­_ì´ë¯¸ì§€: bestMatch ? bestMatch.id : 'ì—†ìŒ',
                        ì„ê³„ê°’: threshold,
                        í†µê³¼ì—¬ë¶€: bestMatch && bestScore > threshold ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'
                    });

                    // ì§„í–‰ë¥  í‘œì‹œ
                    const progress = Math.round((detectionCount / maxDetections) * 100);
                    scanStatusFullscreen.textContent = `ğŸ” ìë™ ì´ë¯¸ì§€ ê²€ìƒ‰ ì¤‘... ${progress}%`;
                    
                    // ìë™ ê°ì§€ ì˜ì—­ ì—…ë°ì´íŠ¸
                    autoDetectionArea.innerHTML = `
                        ğŸ” ìë™ ì´ë¯¸ì§€ ê°ì§€ ì˜ì—­<br>
                        <span style="font-size: 14px; opacity: 0.8;">ê°ì§€ë„: ${Math.round(bestScore * 100)}%</span><br>
                        <span style="font-size: 12px; opacity: 0.6;">ì§„í–‰ë¥ : ${progress}%</span><br>
                        <span style="font-size: 10px; opacity: 0.5;">ê²€ìƒ‰ëœ ì´ë¯¸ì§€: ${arKeys.length}ê°œ</span>
                    `;

                    if (bestMatch && bestScore > threshold) {
                        // ìƒˆë¡œìš´ AR ì´ë¯¸ì§€ê°€ ê°ì§€ë˜ì—ˆê±°ë‚˜ ë‹¤ë¥¸ AR ì´ë¯¸ì§€ê°€ ê°ì§€ëœ ê²½ìš°
                        if (currentFullscreenARId !== bestMatch.id) {
                            console.log(`ğŸ¯ ìƒˆë¡œìš´ ì „ì²´ í™”ë©´ AR ì´ë¯¸ì§€ ê°ì§€: ${bestMatch.id} (${Math.round(bestScore * 100)}%)`);
                            currentFullscreenARId = bestMatch.id;
                            
                            // ì „ì²´ í™”ë©´ì—ì„œ AR ë¹„ë””ì˜¤ ë¡œë“œ
                            loadFullscreenAR(bestMatch.id);
                        }
                        
                        // ê³„ì† ê°ì§€ (ì´ë¯¸ì§€ê°€ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
                        const markerType = bestMatch.hasSpecialMarkers ? 'íŠ¹ìˆ˜ ë§ˆì»¤' : 'ì¼ë°˜ ì´ë¯¸ì§€';
                        
                        scanInstructionsFullscreen.innerHTML = `
                            <span style="color: #4CAF50;">ğŸ¯ ${markerType} AR ì´ë¯¸ì§€ ê°ì§€ë¨ (${Math.round(bestScore * 100)}%)</span><br>
                            <span style="opacity: 0.8; color: #2196F3;">AR ì˜ìƒì´ ì¬ìƒë˜ê³  ìˆìŠµë‹ˆë‹¤</span>
                        `;

                        // ìë™ ê°ì§€ ì˜ì—­ ì„±ê³µ í‘œì‹œ
                        autoDetectionArea.style.border = '3px solid #4CAF50';
                        autoDetectionArea.style.background = 'rgba(76, 175, 80, 0.3)';
                        autoDetectionArea.style.animation = 'none';
                        autoDetectionArea.innerHTML = `
                            âœ… AR ì´ë¯¸ì§€ ê°ì§€ë¨<br>
                            <span style="font-size: 14px; opacity: 0.8;">ì˜ìƒ ì¬ìƒ ì¤‘...</span>
                        `;
                        
                    } else {
                        // AR ì´ë¯¸ì§€ê°€ ê°ì§€ë˜ì§€ ì•Šì€ ê²½ìš°
                        if (currentFullscreenARId !== null) {
                            console.log('âŒ ì „ì²´ í™”ë©´ AR ì´ë¯¸ì§€ê°€ ì‚¬ë¼ì§');
                            currentFullscreenARId = null;
                            hideFullscreenAR();
                        }
                        
                        // ê³„ì† ì¸ì‹ ì‹œë„
                        scanInstructionsFullscreen.innerHTML = `
                            <span style="color: #4CAF50;">ğŸ” ìë™ ì´ë¯¸ì§€ ê²€ìƒ‰ ì¤‘...</span><br>
                            <span style="opacity: 0.8; font-size: 14px;">ìµœê³  ìœ ì‚¬ë„: ${Math.round(bestScore * 100)}%</span>
                        `;
                        
                        // ìë™ ê°ì§€ ì˜ì—­ ì›ë˜ ìƒíƒœë¡œ ë³µì›
                        autoDetectionArea.style.border = '2px dashed #4CAF50';
                        autoDetectionArea.style.background = 'rgba(76, 175, 80, 0.1)';
                        autoDetectionArea.style.animation = 'pulse 2s infinite';
                        autoDetectionArea.innerHTML = `
                            ğŸ” ìë™ ì´ë¯¸ì§€ ê°ì§€ ì˜ì—­<br>
                            <span style="font-size: 14px; opacity: 0.8;">ê°ì§€ë„: ${Math.round(bestScore * 100)}%</span><br>
                            <span style="font-size: 12px; opacity: 0.6;">ì§„í–‰ë¥ : ${progress}%</span><br>
                            <span style="font-size: 10px; opacity: 0.5;">ê²€ìƒ‰ëœ ì´ë¯¸ì§€: ${arKeys.length}ê°œ</span>
                        `;
                    }
                    
                    if (detectionCount >= maxDetections) {
                        clearInterval(detectInterval);

                        // ìµœëŒ€ ì‹œë„ í›„ì—ë„ ì¸ì‹ ì‹¤íŒ¨ - ê°€ì¥ ìœ ì‚¬í•œ ê²ƒ ì‚¬ìš©
                        if (bestMatch && bestScore > 0.05) { // 5% ì´ìƒì´ë©´ ì‚¬ìš©
                            scanInstructionsFullscreen.innerHTML = `
                                <span style="color: #ff6b35;">ğŸ“· ìœ ì‚¬í•œ ì´ë¯¸ì§€ ë°œê²¬ (${Math.round(bestScore * 100)}%)</span><br>
                                <span style="opacity: 0.8;">ë¶€ë¶„ ë§¤ì¹­ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤...</span>
                            `;
                            
                            setTimeout(() => {
                                try {
                                    loadFullscreenAR(bestMatch.id);
                                } catch (error) {
                                    console.error('AR ë¡œë”© ì˜¤ë¥˜ (ë¶€ë¶„ ë§¤ì¹­):', error);
                                    showFullscreenScanError(error);
                                }
                            }, 2000);
                        } else {
                            // ì™„ì „ ì‹¤íŒ¨ - ìµœì‹  ì´ë¯¸ì§€ ì‚¬ìš©
                            scanInstructionsFullscreen.innerHTML = `
                                <span style="color: #ff6b35;">â° ìë™ ê°ì§€ ì‹œê°„ ì´ˆê³¼</span><br>
                                <span style="opacity: 0.8;">ìµœì‹  AR ì´ë¯¸ì§€ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤...</span>
                            `;
                            
                            const latestKey = arKeys[arKeys.length - 1];
                            const arId = latestKey.replace('arData_', '');
                            
                            setTimeout(() => {
                                try {
                                    loadFullscreenAR(arId);
                                } catch (error) {
                                    console.error('AR ë¡œë”© ì˜¤ë¥˜ (ìµœì‹  ì´ë¯¸ì§€):', error);
                                    showFullscreenScanError(error);
                                }
                            }, 2000);
                        }

                        // ìë™ ê°ì§€ ì˜ì—­ ì‹¤íŒ¨ í‘œì‹œ
                        autoDetectionArea.style.border = '3px solid #f44336';
                        autoDetectionArea.style.background = 'rgba(244, 67, 54, 0.3)';
                        autoDetectionArea.style.animation = 'none';
                        autoDetectionArea.innerHTML = `
                            âŒ ì´ë¯¸ì§€ ê°ì§€ ì‹¤íŒ¨<br>
                            <span style="font-size: 14px; opacity: 0.8;">ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</span>
                        `;
                    }

                } catch (error) {
                    console.error('ğŸ” ìë™ ì´ë¯¸ì§€ ê°ì§€ ì˜¤ë¥˜:', error);
                    
                    // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê³„ì† ì‹œë„
                    if (detectionCount >= maxDetections) {
                        clearInterval(detectInterval);
                        
                        scanStatusFullscreen.textContent = 'âŒ ì´ë¯¸ì§€ ê°ì§€ ì˜¤ë¥˜';
                        
                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ìµœì‹  ì´ë¯¸ì§€ë¡œ ìë™ ì‹¤í–‰
                        const latestKey = arKeys[arKeys.length - 1];
                        const arId = latestKey.replace('arData_', '');
                        
                        setTimeout(() => {
                            try {
                                loadFullscreenAR(arId);
                            } catch (loadError) {
                                console.error('AR ë¡œë”© ì˜¤ë¥˜ (ì˜¤ë¥˜ ë³µêµ¬):', loadError);
                                showFullscreenScanError(loadError);
                            }
                        }, 2000);
                    }
                }
            }, 1000); // 1ì´ˆë§ˆë‹¤ ê²€ìƒ‰
        }

        function showFullscreenScanError(error) {
            const scanStatusFullscreen = document.getElementById('scanStatusFullscreen');
            const scanInstructionsFullscreen = document.getElementById('scanInstructionsFullscreen');
            
            let errorMessage = 'ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨';
            let helpMessage = '';
            
            if (error.name === 'NotAllowedError' || error.message.includes('Permission denied')) {
                errorMessage = 'ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤';
                helpMessage = 'ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”';
            } else if (error.name === 'NotFoundError') {
                errorMessage = 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                helpMessage = 'ë‹¤ë¥¸ ì•±ì´ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”';
            } else {
                errorMessage = 'ì¹´ë©”ë¼ ì´ˆê¸°í™” ì‹¤íŒ¨';
                helpMessage = 'ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”';
            }
            
            scanStatusFullscreen.textContent = `âŒ ${errorMessage}`;
            scanInstructionsFullscreen.innerHTML = `
                ${helpMessage}<br>
                <button class="btn" onclick="closeFullscreenScan()" style="margin-top: 15px; background: #ff6b35; color: white; border: none; padding: 10px 20px; border-radius: 20px;">
                    ëŒì•„ê°€ê¸°
                </button>
            `;
        }

        function closeFullscreenScan() {
            console.log('ì „ì²´ í™”ë©´ ìŠ¤ìº” ë‹«ê¸°');
            
            try {
                const fullscreenScanner = document.getElementById('fullscreenScanner');
                const scannerVideoFullscreen = document.getElementById('scannerVideoFullscreen');
                
                // ì „ì²´ í™”ë©´ ìŠ¤ìºë„ˆ ìˆ¨ê¹€
                if (fullscreenScanner) {
                    fullscreenScanner.classList.remove('active');
                    fullscreenScanner.style.display = 'none';
                }
                
                // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                if (scannerVideoFullscreen && scannerVideoFullscreen.srcObject) {
                    scannerVideoFullscreen.srcObject.getTracks().forEach(track => {
                        try {
                            track.stop();
                        } catch (e) {
                            console.warn('íŠ¸ë™ ì •ë¦¬ ì˜¤ë¥˜:', e);
                        }
                    });
                    scannerVideoFullscreen.srcObject = null;
                }
                
                // íƒ€ì„ì•„ì›ƒ ì •ë¦¬
                if (scanTimeout) {
                    clearTimeout(scanTimeout);
                    scanTimeout = null;
                }
                
                // í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€ í•´ì œ
                document.body.style.overflow = '';
                
                console.log('ì „ì²´ í™”ë©´ ìŠ¤ìº” ì™„ì „íˆ ì •ë¦¬ë¨');
                
            } catch (error) {
                console.error('ì „ì²´ í™”ë©´ ìŠ¤ìº” ë‹«ê¸° ì˜¤ë¥˜:', error);
            }
            
            // ìŠ¤ìºë„ˆ ìˆ¨ê¹€ í›„ ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ í™”ë©´ ì „í™˜ ì•ˆì •í™”
            setTimeout(() => {
                const fullscreenScanner = document.getElementById('fullscreenScanner');
                if (fullscreenScanner) {
                    fullscreenScanner.style.display = 'none';
                }
            }, 100);
        }

        function attemptRealImageDetection(arKeys) {
            const video = document.getElementById('scannerVideo');
            if (!video || !video.srcObject) {
                console.log('ì¹´ë©”ë¼ê°€ ì—†ìŒ, ì§ì ‘ ê°ì§€ ëª¨ë“œë¡œ ì‹¤í–‰');
                // ì¹´ë©”ë¼ê°€ ì—†ìœ¼ë©´ ìµœì‹  AR ë°ì´í„° ì‚¬ìš©
                const latestKey = arKeys[arKeys.length - 1];
                const arId = latestKey.replace('arData_', '');
                
                // ì•ˆë‚´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                document.getElementById('scan-instructions').innerHTML = `
                    ğŸ¯ ì´ë¯¸ì§€ ìë™ ê°ì§€!<br>
                    <span style="color: #4CAF50;">AR ì˜ìƒì„ ë¡œë”©í•©ë‹ˆë‹¤...</span>
                `;
                
                setTimeout(() => {
                    loadAndPlayAR(arId);
                }, 1000);
                return;
            }

            document.getElementById('scan-instructions').innerHTML = `
                ğŸ” ì´ë¯¸ì§€ ì¸ì‹ ì¤‘...<br>
                <span style="opacity: 0.7;">ì €ì¥ëœ ${arKeys.length}ê°œ ì´ë¯¸ì§€ ì¤‘ ê²€ìƒ‰</span>
            `;

            // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ê°ì§€ ì‹œìŠ¤í…œ
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 320; // ì‘ì€ í¬ê¸°ë¡œ ì„±ëŠ¥ í–¥ìƒ
            canvas.height = 240;

            let detectionCount = 0;
            const maxDetections = 30; // 30í”„ë ˆì„ ì‹œë„ (3ì´ˆ)
            let currentARId = null; // í˜„ì¬ í‘œì‹œ ì¤‘ì¸ AR ID
            
            const detectInterval = setInterval(async () => {
                detectionCount++;
                
                try {
                    // í˜„ì¬ í”„ë ˆì„ ìº¡ì²˜
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const currentFrame = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // ì €ì¥ëœ AR ì´ë¯¸ì§€ë“¤ê³¼ ë¹„êµ (ë¹„ë™ê¸° ì²˜ë¦¬)
                    let bestMatch = null;
                    let bestScore = 0;
                    
                    // ë³‘ë ¬ë¡œ ëª¨ë“  ì´ë¯¸ì§€ ë¹„êµ
                    const comparisonPromises = arKeys.map(async (key) => {
                        try {
                            const arData = JSON.parse(localStorage.getItem(key));
                            if (arData && arData.targetImage) {
                                const similarity = await compareImages(currentFrame, arData.targetImage);
                                return {
                                    id: key.replace('arData_', ''),
                                    score: similarity,
                                    data: arData
                                };
                            }
                            return null;
                        } catch (error) {
                            console.warn(`ì´ë¯¸ì§€ ë¹„êµ ì˜¤ë¥˜ (${key}):`, error);
                            return null;
                        }
                    });
                    
                    const results = await Promise.all(comparisonPromises);
                    
                    // ìµœê³  ì ìˆ˜ ì°¾ê¸°
                    results.forEach(result => {
                        if (result && result.score > bestScore) {
                            bestScore = result.score;
                            bestMatch = result;
                        }
                    });
                    
                    console.log(`ğŸ” í”„ë ˆì„ ${detectionCount}: ìµœê³  ìœ ì‚¬ë„ ${Math.round(bestScore * 100)}%`);
                    
                    // ë§¤ìš° ë‚®ì€ ì„ê³„ê°’ìœ¼ë¡œ ê°ì§€ ë¯¼ê°ë„ í–¥ìƒ
                    const threshold = 0.1; // 10%ë§Œ ì¼ì¹˜í•´ë„ ê°ì§€
                    
                    if (bestMatch && bestScore > threshold) {
                        // ìƒˆë¡œìš´ AR ì´ë¯¸ì§€ê°€ ê°ì§€ë˜ì—ˆê±°ë‚˜ ë‹¤ë¥¸ AR ì´ë¯¸ì§€ê°€ ê°ì§€ëœ ê²½ìš°
                        if (currentARId !== bestMatch.id) {
                            console.log(`ğŸ¯ ìƒˆë¡œìš´ AR ì´ë¯¸ì§€ ê°ì§€: ${bestMatch.id} (${Math.round(bestScore * 100)}%)`);
                            currentARId = bestMatch.id;
                            
                            // ìŠ¤ìº” í™”ë©´ì—ì„œ AR ë¹„ë””ì˜¤ ë¡œë“œ
                            loadScannerAR(bestMatch.id);
                        }
                        
                        // ê³„ì† ê°ì§€ (ì´ë¯¸ì§€ê°€ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
                        document.getElementById('scan-instructions').innerHTML = `
                            ğŸ¯ AR ì´ë¯¸ì§€ ê°ì§€ë¨ (${Math.round(bestScore * 100)}%)<br>
                            <span style="color: #4CAF50;">AR ì˜ìƒì´ ì¬ìƒë˜ê³  ìˆìŠµë‹ˆë‹¤</span>
                        `;
                        
                    } else {
                        // AR ì´ë¯¸ì§€ê°€ ê°ì§€ë˜ì§€ ì•Šì€ ê²½ìš°
                        if (currentARId !== null) {
                            console.log('âŒ AR ì´ë¯¸ì§€ê°€ ì‚¬ë¼ì§');
                            currentARId = null;
                            hideScannerAR();
                        }
                        
                        // ê³„ì† ì¸ì‹ ì‹œë„
                        document.getElementById('scan-instructions').innerHTML = `
                            ğŸ” ì´ë¯¸ì§€ ë¶„ì„ ì¤‘... (${detectionCount}/${maxDetections})<br>
                            <span style="opacity: 0.7;">ìµœê³  ìœ ì‚¬ë„: ${Math.round(bestScore * 100)}%</span>
                        `;
                    }
                    
                } catch (error) {
                    console.error('ğŸ” ì´ë¯¸ì§€ ê°ì§€ ì˜¤ë¥˜:', error);
                    
                    // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê³„ì† ì‹œë„
                    if (detectionCount >= maxDetections) {
                        clearInterval(detectInterval);
                        
                        document.getElementById('scan-instructions').innerHTML = `
                            âš ï¸ ì´ë¯¸ì§€ ê°ì§€ ì˜¤ë¥˜<br>
                            <span style="opacity: 0.7;">ì¹´ë©”ë¼ ì¸ì‹ í™”ë©´ì„ ê³„ì† í‘œì‹œí•©ë‹ˆë‹¤</span>
                        `;
                    }
                }
            }, 100); // 100msë§ˆë‹¤ ê²€ìƒ‰ (ë¹ ë¥¸ ê°ì§€)
        }

        function compareImages(img1DataURL, img2DataURL) {
            return new Promise((resolve) => {
                try {
                    if (!img1DataURL || !img2DataURL) {
                        console.warn('ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                        resolve(0);
                        return;
                    }
                    
                    const canvas1 = document.createElement('canvas');
                    const canvas2 = document.createElement('canvas');
                    const ctx1 = canvas1.getContext('2d');
                    const ctx2 = canvas2.getContext('2d');
                    
                    const img1 = new Image();
                    const img2 = new Image();
                    
                    // ë” ì‘ì€ í¬ê¸°ë¡œ ì„±ëŠ¥ í–¥ìƒ
                    canvas1.width = canvas2.width = 100;
                    canvas1.height = canvas2.height = 100;
                    
                    let img1Loaded = false;
                    let img2Loaded = false;
                    
                    img1.onload = () => {
                        ctx1.drawImage(img1, 0, 0, 100, 100);
                        img1Loaded = true;
                        if (img2Loaded) performUltraSimpleComparison();
                    };
                    
                    img2.onload = () => {
                        ctx2.drawImage(img2, 0, 0, 100, 100);
                        img2Loaded = true;
                        if (img1Loaded) performUltraSimpleComparison();
                    };
                    
                    function performUltraSimpleComparison() {
                        try {
                            const data1 = ctx1.getImageData(0, 0, 100, 100).data;
                            const data2 = ctx2.getImageData(0, 0, 100, 100).data;
                            
                            let matchingPixels = 0;
                            let totalPixels = 0;
                            
                            // ë§¤ìš° ê°„ë‹¨í•œ í”½ì…€ ë¹„êµ (ë” í° ìƒ˜í”Œë§)
                            for (let i = 0; i < data1.length; i += 40) { // 10í”½ì…€ì”© ê±´ë„ˆë›°ê¸°
                                const r1 = data1[i];
                                const g1 = data1[i + 1];
                                const b1 = data1[i + 2];
                                
                                const r2 = data2[i];
                                const g2 = data2[i + 1];
                                const b2 = data2[i + 2];
                                
                                // ë§¤ìš° ê´€ëŒ€í•œ ìƒ‰ìƒ ì°¨ì´ ê³„ì‚°
                                const colorDiff = Math.abs(r1 - r2) + Math.abs(g1 - g2) + Math.abs(b1 - b2);
                                
                                // ë§¤ìš° ê´€ëŒ€í•œ ì„ê³„ê°’ (300)
                                if (colorDiff < 300) {
                                    matchingPixels++;
                                }
                                
                                totalPixels++;
                            }
                            
                            const similarity = totalPixels > 0 ? matchingPixels / totalPixels : 0;
                            
                            resolve(similarity);
                            
                        } catch (error) {
                            console.error('ì´ˆê°„ë‹¨ ì´ë¯¸ì§€ ë¹„êµ ì˜¤ë¥˜:', error);
                            resolve(0);
                        }
                    }
                    
                    img1.onerror = () => {
                        console.warn('ì´ë¯¸ì§€1 ë¡œë“œ ì‹¤íŒ¨');
                        resolve(0);
                    };
                    
                    img2.onerror = () => {
                        console.warn('ì´ë¯¸ì§€2 ë¡œë“œ ì‹¤íŒ¨');
                        resolve(0);
                    };
                    
                    img1.src = img1DataURL;
                    img2.src = img2DataURL;
                    
                } catch (error) {
                    console.error('ì´ˆê°„ë‹¨ ì´ë¯¸ì§€ ë¹„êµ í•¨ìˆ˜ ì˜¤ë¥˜:', error);
                    resolve(0);
                }
            });
        }
        
        function extractSteganographyPattern(imageData, width, height) {
            const pattern = [];
            const step = 8; // 8í”½ì…€ ê°„ê²©ìœ¼ë¡œ ìƒ˜í”Œë§
            
            for (let y = 0; y < height; y += step) {
                for (let x = 0; x < width; x += step) {
                    const index = (y * width + x) * 4;
                    if (index < imageData.length) {
                        const r = imageData[index];
                        const g = imageData[index + 1];
                        const b = imageData[index + 2];
                        
                        // LSB (Least Significant Bit) ìŠ¤í…Œê°€ë…¸ê·¸ë˜í”¼ íŒ¨í„´ ì¶”ì¶œ
                        const lsbR = r & 1;
                        const lsbG = g & 1;
                        const lsbB = b & 1;
                        
                        // ìƒ‰ìƒ ë³€í™” íŒ¨í„´ (ë¯¸ì„¸í•œ ìƒ‰ìƒ ë³€í™” ê°ì§€)
                        const brightness = (r + g + b) / 3;
                        const colorVariance = Math.sqrt(
                            Math.pow(r - brightness, 2) + 
                            Math.pow(g - brightness, 2) + 
                            Math.pow(b - brightness, 2)
                        );
                        
                        pattern.push({
                            lsb: (lsbR << 2) | (lsbG << 1) | lsbB,
                            brightness: Math.floor(brightness / 16), // 16ë‹¨ê³„ë¡œ ì–‘ìí™”
                            variance: Math.floor(colorVariance / 8), // 8ë‹¨ê³„ë¡œ ì–‘ìí™”
                            position: { x: Math.floor(x / step), y: Math.floor(y / step) }
                        });
                    }
                }
            }
            
            return pattern;
        }
        
        function extractMicroDotPattern(imageData, width, height) {
            const dotPattern = [];
            const dotSize = 4; // ë§ˆì´í¬ë¡œ ë„íŠ¸ í¬ê¸°
            const step = 16; // 16í”½ì…€ ê°„ê²©ìœ¼ë¡œ ë„íŠ¸ ê²€ìƒ‰
            
            for (let y = 0; y < height; y += step) {
                for (let x = 0; x < width; x += step) {
                    let dotBrightness = 0;
                    let dotPixels = 0;
                    
                    // ë„íŠ¸ ì˜ì—­ì˜ í‰ê·  ë°ê¸° ê³„ì‚°
                    for (let dy = 0; dy < dotSize && (y + dy) < height; dy++) {
                        for (let dx = 0; dx < dotSize && (x + dx) < width; dx++) {
                            const index = ((y + dy) * width + (x + dx)) * 4;
                            if (index < imageData.length) {
                                const r = imageData[index];
                                const g = imageData[index + 1];
                                const b = imageData[index + 2];
                                dotBrightness += (r + g + b) / 3;
                                dotPixels++;
                            }
                        }
                    }
                    
                    if (dotPixels > 0) {
                        const avgBrightness = dotBrightness / dotPixels;
                        const isDark = avgBrightness < 128;
                        
                        dotPattern.push({
                            isDark: isDark,
                            brightness: Math.floor(avgBrightness / 32), // 8ë‹¨ê³„ë¡œ ì–‘ìí™”
                            position: { x: Math.floor(x / step), y: Math.floor(y / step) }
                        });
                    }
                }
            }
            
            return dotPattern;
        }
        
        function compareSteganographyPatterns(pattern1, pattern2) {
            if (pattern1.length === 0 || pattern2.length === 0) return 0;
            
            let matches = 0;
            const minLength = Math.min(pattern1.length, pattern2.length);
            
            for (let i = 0; i < minLength; i++) {
                const p1 = pattern1[i];
                const p2 = pattern2[i];
                
                // LSB íŒ¨í„´ ë¹„êµ
                const lsbMatch = p1.lsb === p2.lsb;
                
                // ë°ê¸° íŒ¨í„´ ë¹„êµ (í—ˆìš© ì˜¤ì°¨ 1ë‹¨ê³„)
                const brightnessMatch = Math.abs(p1.brightness - p2.brightness) <= 1;
                
                // ìƒ‰ìƒ ë¶„ì‚° íŒ¨í„´ ë¹„êµ (í—ˆìš© ì˜¤ì°¨ 1ë‹¨ê³„)
                const varianceMatch = Math.abs(p1.variance - p2.variance) <= 1;
                
                if (lsbMatch && brightnessMatch && varianceMatch) {
                    matches++;
                }
            }
            
            return matches / minLength;
        }
        
        function compareMicroDotPatterns(dotPattern1, dotPattern2) {
            if (dotPattern1.length === 0 || dotPattern2.length === 0) return 0;
            
            let matches = 0;
            const minLength = Math.min(dotPattern1.length, dotPattern2.length);
            
            for (let i = 0; i < minLength; i++) {
                const d1 = dotPattern1[i];
                const d2 = dotPattern2[i];
                
                // ë„íŠ¸ íŒ¨í„´ ë¹„êµ (ë°ê¸° í—ˆìš© ì˜¤ì°¨ 1ë‹¨ê³„)
                const brightnessMatch = Math.abs(d1.brightness - d2.brightness) <= 1;
                const patternMatch = d1.isDark === d2.isDark;
                
                if (brightnessMatch && patternMatch) {
                    matches++;
                }
            }
            
            return matches / minLength;
        }
        
        function generateUniqueId() {
            // íƒ€ì„ìŠ¤íƒ¬í”„ + ëœë¤ ê°’ìœ¼ë¡œ ê³ ìœ  ID ìƒì„±
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }
        
        function insertSteganographyPattern(ctx, width, height, uniqueId) {
            // ê³ ìœ  IDë¥¼ ë°”ì´ë„ˆë¦¬ íŒ¨í„´ìœ¼ë¡œ ë³€í™˜
            const binaryPattern = stringToBinary(uniqueId);
            const patternLength = binaryPattern.length;
            
            // ì´ë¯¸ì§€ ì „ì²´ì— ìŠ¤í…Œê°€ë…¸ê·¸ë˜í”¼ íŒ¨í„´ ì‚½ì…
            let patternIndex = 0;
            const step = 4; // 4í”½ì…€ ê°„ê²©ìœ¼ë¡œ íŒ¨í„´ ì‚½ì…
            
            for (let y = 0; y < height; y += step) {
                for (let x = 0; x < width; x += step) {
                    if (patternIndex >= patternLength) break;
                    
                    const imageData = ctx.getImageData(x, y, 1, 1).data;
                    const r = imageData[0];
                    const g = imageData[1];
                    const b = imageData[2];
                    
                    // LSB ìŠ¤í…Œê°€ë…¸ê·¸ë˜í”¼ë¡œ íŒ¨í„´ ì‚½ì…
                    const bit = parseInt(binaryPattern[patternIndex]);
                    
                    // RGB ê° ì±„ë„ì˜ LSBì— íŒ¨í„´ ì‚½ì…
                    const newR = (r & 0xFE) | bit;
                    const newG = (g & 0xFE) | ((patternIndex % 2) ? bit : (1 - bit));
                    const newB = (b & 0xFE) | ((patternIndex % 3) ? bit : (1 - bit));
                    
                    // ë¯¸ì„¸í•œ ìƒ‰ìƒ ë³€í™”ë¡œ íŒ¨í„´ ê°•í™”
                    const brightness = (newR + newG + newB) / 3;
                    const variance = Math.sin(patternIndex * 0.1) * 2; // ë¯¸ì„¸í•œ ìƒ‰ìƒ ë³€í™”
                    
                    const finalR = Math.max(0, Math.min(255, newR + variance));
                    const finalG = Math.max(0, Math.min(255, newG + variance));
                    const finalB = Math.max(0, Math.min(255, newB + variance));
                    
                    ctx.fillStyle = `rgb(${finalR}, ${finalG}, ${finalB})`;
                    ctx.fillRect(x, y, 1, 1);
                    
                    patternIndex++;
                }
            }
            
            console.log(`ğŸ” ìŠ¤í…Œê°€ë…¸ê·¸ë˜í”¼ íŒ¨í„´ ì‚½ì… ì™„ë£Œ: ${uniqueId}`);
        }
        
        function insertMicroDotPattern(ctx, width, height, uniqueId) {
            // ê³ ìœ  IDë¥¼ ë§ˆì´í¬ë¡œ ë„íŠ¸ íŒ¨í„´ìœ¼ë¡œ ë³€í™˜
            const dotPattern = stringToDotPattern(uniqueId);
            const patternLength = dotPattern.length;
            
            // ì´ë¯¸ì§€ ì „ì²´ì— ë§ˆì´í¬ë¡œ ë„íŠ¸ íŒ¨í„´ ì‚½ì…
            let patternIndex = 0;
            const step = 16; // 16í”½ì…€ ê°„ê²©ìœ¼ë¡œ ë„íŠ¸ ì‚½ì…
            const dotSize = 2; // 2x2 í”½ì…€ ë„íŠ¸
            
            for (let y = 0; y < height; y += step) {
                for (let x = 0; x < width; x += step) {
                    if (patternIndex >= patternLength) break;
                    
                    const shouldInsertDot = dotPattern[patternIndex];
                    
                    if (shouldInsertDot) {
                        // ì–´ë‘ìš´ ë„íŠ¸ ì‚½ì…
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                        ctx.fillRect(x, y, dotSize, dotSize);
                    } else {
                        // ë°ì€ ë„íŠ¸ ì‚½ì… (ë°°ê²½ê³¼ êµ¬ë¶„ë˜ë„ë¡)
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                        ctx.fillRect(x, y, dotSize, dotSize);
                    }
                    
                    patternIndex++;
                }
            }
            
            console.log(`ğŸ” ë§ˆì´í¬ë¡œ ë„íŠ¸ íŒ¨í„´ ì‚½ì… ì™„ë£Œ: ${uniqueId}`);
        }
        
        function stringToBinary(str) {
            let binary = '';
            for (let i = 0; i < str.length; i++) {
                const charCode = str.charCodeAt(i);
                binary += charCode.toString(2).padStart(8, '0');
            }
            return binary;
        }
        
        function stringToDotPattern(str) {
            // ë¬¸ìì—´ì„ ë„íŠ¸ íŒ¨í„´ìœ¼ë¡œ ë³€í™˜ (0ê³¼ 1ì˜ ë°°ì—´)
            const binary = stringToBinary(str);
            const pattern = [];
            
            for (let i = 0; i < binary.length; i++) {
                pattern.push(parseInt(binary[i]));
            }
            
            // íŒ¨í„´ì„ ë°˜ë³µí•˜ì—¬ ì´ë¯¸ì§€ ì „ì²´ë¥¼ ì»¤ë²„
            const repeatedPattern = [];
            while (repeatedPattern.length < 1000) { // ì¶©ë¶„í•œ íŒ¨í„´ ìƒì„±
                repeatedPattern.push(...pattern);
            }
            
            return repeatedPattern;
        }

        function analyzeSpecialMarkers(capturedFrameDataURL, targetImageDataURL) {
            return new Promise((resolve) => {
                try {
                    console.log('ğŸ¯ íŠ¹ìˆ˜ ë§ˆì»¤ ì •ë°€ ë¶„ì„ ì‹œì‘');
                    
                    const capturedCanvas = document.createElement('canvas');
                    const targetCanvas = document.createElement('canvas');
                    const capturedCtx = capturedCanvas.getContext('2d');
                    const targetCtx = targetCanvas.getContext('2d');
                    
                    const capturedImg = new Image();
                    const targetImg = new Image();
                    
                    capturedCanvas.width = targetCanvas.width = 400;
                    capturedCanvas.height = targetCanvas.height = 400;
                    
                    let capturedLoaded = false;
                    let targetLoaded = false;
                    
                    capturedImg.onload = () => {
                        capturedCtx.drawImage(capturedImg, 0, 0, 400, 400);
                        capturedLoaded = true;
                        if (targetLoaded) analyzeMarkers();
                    };
                    
                    targetImg.onload = () => {
                        targetCtx.drawImage(targetImg, 0, 0, 400, 400);
                        targetLoaded = true;
                        if (capturedLoaded) analyzeMarkers();
                    };
                    
                    function analyzeMarkers() {
                        let markerMatchScore = 0;
                        let totalMarkers = 0;
                        
                        // 1. ì½”ë„ˆ ë§ˆì»¤ ë¶„ì„ (4ê°œ - ê°€ì¥ ì¤‘ìš”)
                        const cornerPositions = [
                            [10, 10], [350, 10], [10, 350], [350, 350] // 400x400 ìŠ¤ì¼€ì¼
                        ];
                        
                        cornerPositions.forEach(([x, y], index) => {
                            const cornerScore = analyzeCornerMarker(capturedCtx, targetCtx, x, y, 40, index);
                            markerMatchScore += cornerScore * 2; // ì½”ë„ˆ ë§ˆì»¤ì— ê°€ì¤‘ì¹˜
                            totalMarkers += 2;
                            console.log(`ğŸ“ ì½”ë„ˆ ë§ˆì»¤ ${index + 1} ë§¤ì¹­ë„: ${Math.round(cornerScore * 100)}%`);
                        });
                        
                        // 2. ì¤‘ì•™ YouTube ë§ˆì»¤ ë¶„ì„ (ìƒë‹¨)
                        const topMarkerScore = analyzeCentralMarker(capturedCtx, targetCtx, 175, 15, 50, 25, 'youtube');
                        markerMatchScore += topMarkerScore * 1.5; // YouTube ë§ˆì»¤ì— ë†’ì€ ê°€ì¤‘ì¹˜
                        totalMarkers += 1.5;
                        console.log(`ğŸ“¹ YouTube ë§ˆì»¤ ë§¤ì¹­ë„: ${Math.round(topMarkerScore * 100)}%`);
                        
                        // 3. í•˜ë‹¨ ì œì–´ ë§ˆì»¤ ë¶„ì„
                        const bottomMarkerScore = analyzeCentralMarker(capturedCtx, targetCtx, 170, 355, 60, 25, 'control');
                        markerMatchScore += bottomMarkerScore;
                        totalMarkers++;
                        console.log(`ğŸ® ì œì–´ ë§ˆì»¤ ë§¤ì¹­ë„: ${Math.round(bottomMarkerScore * 100)}%`);
                        
                        // 4. ë¹„ë””ì˜¤ ì˜ì—­ ì •ì˜ ë§ˆì»¤ ë¶„ì„ (4ê°œ)
                        const videoAreaPositions = [
                            [70, 70], [310, 70], [70, 310], [310, 310] // ë¹„ë””ì˜¤ ì¬ìƒ ì˜ì—­
                        ];
                        
                        videoAreaPositions.forEach(([x, y], index) => {
                            const areaScore = analyzeVideoAreaMarker(capturedCtx, targetCtx, x, y, 10);
                            markerMatchScore += areaScore * 1.3; // ë¹„ë””ì˜¤ ì˜ì—­ ë§ˆì»¤ì— ë†’ì€ ê°€ì¤‘ì¹˜
                            totalMarkers += 1.3;
                            console.log(`ğŸ“º ë¹„ë””ì˜¤ ì˜ì—­ ë§ˆì»¤ ${index + 1} ë§¤ì¹­ë„: ${Math.round(areaScore * 100)}%`);
                        });
                        
                        // 5. ì¸¡ë©´ ë°©í–¥ ë§ˆì»¤ ë¶„ì„
                        const leftMarkerScore = analyzeSideMarker(capturedCtx, targetCtx, 5, 160, 15, 40, 'scale');
                        const rightMarkerScore = analyzeSideMarker(capturedCtx, targetCtx, 380, 160, 15, 40, 'rotation');
                        
                        markerMatchScore += leftMarkerScore + rightMarkerScore;
                        totalMarkers += 2;
                        
                        console.log(`ğŸ“ ìŠ¤ì¼€ì¼ ë§ˆì»¤ ë§¤ì¹­ë„: ${Math.round(leftMarkerScore * 100)}%`);
                        console.log(`ğŸ”„ íšŒì „ ë§ˆì»¤ ë§¤ì¹­ë„: ${Math.round(rightMarkerScore * 100)}%`);
                        
                        // 6. ë””ì§€í„¸ ì‹œê·¸ë‹ˆì²˜ ë¶„ì„
                        const signatureScore = analyzeDigitalSignature(capturedCtx, targetCtx, 50, 370, 200, 10);
                        markerMatchScore += signatureScore;
                        totalMarkers++;
                        console.log(`ğŸ”¢ ë””ì§€í„¸ ì‹œê·¸ë‹ˆì²˜ ë§¤ì¹­ë„: ${Math.round(signatureScore * 100)}%`);
                        
                        // ì „ì²´ ë§¤ì¹­ ì ìˆ˜ ê³„ì‚°
                        const finalScore = markerMatchScore / totalMarkers;
                        console.log(`ğŸ¯ íŠ¹ìˆ˜ ë§ˆì»¤ ì „ì²´ ë§¤ì¹­ë„: ${Math.round(finalScore * 100)}%`);
                        
                        // íŠ¹ìˆ˜ ë§ˆì»¤ëŠ” ë” ì •í™•í•œ ì„ê³„ê°’ ì ìš©
                        resolve(finalScore);
                    }
                    
                    capturedImg.src = capturedFrameDataURL;
                    targetImg.src = targetImageDataURL;
                    
                } catch (error) {
                    console.warn('íŠ¹ìˆ˜ ë§ˆì»¤ ë¶„ì„ ì‹¤íŒ¨:', error);
                    resolve(0); // ì‹¤íŒ¨ ì‹œ 0ì 
                }
            });
        }

        function analyzeCornerMarker(capturedCtx, targetCtx, x, y, size, cornerIndex) {
            try {
                const capturedData = capturedCtx.getImageData(x, y, size, size).data;
                const targetData = targetCtx.getImageData(x, y, size, size).data;
                
                let patternMatches = 0;
                let totalPixels = 0;
                
                // ê° ì½”ë„ˆë³„ ê³ ìœ  íŒ¨í„´ ë¶„ì„
                switch(cornerIndex) {
                    case 0: // ì¢Œìƒë‹¨ - ê²©ì íŒ¨í„´
                        for (let i = 0; i < size; i += 8) {
                            for (let j = 0; j < size; j += 8) {
                                const pixelIndex = ((j * size) + i) * 4;
                                if (pixelIndex < capturedData.length) {
                                    const capturedBrightness = (capturedData[pixelIndex] + capturedData[pixelIndex+1] + capturedData[pixelIndex+2]) / 3;
                                    const targetBrightness = (targetData[pixelIndex] + targetData[pixelIndex+1] + targetData[pixelIndex+2]) / 3;
                                    
                                    if (Math.abs(capturedBrightness - targetBrightness) < 80) {
                                        patternMatches++;
                                    }
                                    totalPixels++;
                                }
                            }
                        }
                        break;
                    case 1: // ìš°ìƒë‹¨ - ë™ì‹¬ì› íŒ¨í„´
                        const centerX = size / 2;
                        const centerY = size / 2;
                        for (let i = 0; i < size; i += 4) {
                            for (let j = 0; j < size; j += 4) {
                                const distance = Math.sqrt((i - centerX) ** 2 + (j - centerY) ** 2);
                                if (distance < size / 2) {
                                    const pixelIndex = ((j * size) + i) * 4;
                                    if (pixelIndex < capturedData.length) {
                                        const capturedBrightness = (capturedData[pixelIndex] + capturedData[pixelIndex+1] + capturedData[pixelIndex+2]) / 3;
                                        const targetBrightness = (targetData[pixelIndex] + targetData[pixelIndex+1] + targetData[pixelIndex+2]) / 3;
                                        
                                        if (Math.abs(capturedBrightness - targetBrightness) < 80) {
                                            patternMatches++;
                                        }
                                        totalPixels++;
                                    }
                                }
                            }
                        }
                        break;
                    default:
                        // ê¸°íƒ€ íŒ¨í„´ë“¤ (ì‚¼ê°í˜•, ì‹­ì)
                        for (let i = 0; i < capturedData.length; i += 16) {
                            const capturedBrightness = (capturedData[i] + capturedData[i+1] + capturedData[i+2]) / 3;
                            const targetBrightness = (targetData[i] + targetData[i+1] + targetData[i+2]) / 3;
                            
                            if (Math.abs(capturedBrightness - targetBrightness) < 80) {
                                patternMatches++;
                            }
                            totalPixels++;
                        }
                }
                
                return totalPixels > 0 ? patternMatches / totalPixels : 0;
            } catch (error) {
                return 0;
            }
        }

        function analyzeCentralMarker(capturedCtx, targetCtx, x, y, width, height, type) {
            try {
                const capturedData = capturedCtx.getImageData(x, y, width, height).data;
                const targetData = targetCtx.getImageData(x, y, width, height).data;
                
                let colorMatches = 0;
                let totalPixels = 0;
                
                if (type === 'youtube') {
                    // YouTube ë¹¨ê°„ìƒ‰ ë°°ê²½ + í°ìƒ‰ ì¬ìƒ ë²„íŠ¼ íŒ¨í„´ ë¶„ì„
                    for (let i = 0; i < capturedData.length; i += 4) {
                        const capturedR = capturedData[i];
                        const capturedG = capturedData[i+1];
                        const capturedB = capturedData[i+2];
                        
                        const targetR = targetData[i];
                        const targetG = targetData[i+1];
                        const targetB = targetData[i+2];
                        
                        // ë¹¨ê°„ìƒ‰ ë˜ëŠ” í°ìƒ‰ íŒ¨í„´ ê°ì§€
                        const isRedish = targetR > 200 && targetG < 100 && targetB < 100;
                        const isWhitish = targetR > 200 && targetG > 200 && targetB > 200;
                        
                        const capturedIsRedish = capturedR > 150 && capturedG < 120 && capturedB < 120;
                        const capturedIsWhitish = capturedR > 180 && capturedG > 180 && capturedB > 180;
                        
                        if ((isRedish && capturedIsRedish) || (isWhitish && capturedIsWhitish)) {
                            colorMatches++;
                        }
                        totalPixels++;
                    }
                } else if (type === 'control') {
                    // ë…¹ìƒ‰ ì œì–´ ë²„íŠ¼ íŒ¨í„´ ë¶„ì„
                    for (let i = 0; i < capturedData.length; i += 4) {
                        const targetG = targetData[i+1];
                        const capturedG = capturedData[i+1];
                        
                        // ë…¹ìƒ‰ ê°•ë„ ë¹„êµ
                        if (Math.abs(targetG - capturedG) < 80) {
                            colorMatches++;
                        }
                        totalPixels++;
                    }
                }
                
                return totalPixels > 0 ? colorMatches / totalPixels : 0;
            } catch (error) {
                return 0;
            }
        }

        function analyzeSideMarker(capturedCtx, targetCtx, x, y, width, height, type) {
            try {
                const capturedData = capturedCtx.getImageData(x, y, width, height).data;
                const targetData = targetCtx.getImageData(x, y, width, height).data;
                
                let patternMatches = 0;
                let totalSections = 0;
                
                // ì„¸ë¡œë¡œ 5ê°œ ì„¹ì…˜ìœ¼ë¡œ ë‚˜ëˆ„ì–´ íŒ¨í„´ ë¶„ì„
                const sectionHeight = Math.floor(height / 5);
                
                for (let section = 0; section < 5; section++) {
                    const sectionY = section * sectionHeight;
                    let sectionBrightness = 0;
                    let targetSectionBrightness = 0;
                    let sectionPixels = 0;
                    
                    for (let i = 0; i < width; i++) {
                        for (let j = 0; j < sectionHeight; j++) {
                            const pixelIndex = ((sectionY + j) * width + i) * 4;
                            if (pixelIndex < capturedData.length) {
                                sectionBrightness += (capturedData[pixelIndex] + capturedData[pixelIndex+1] + capturedData[pixelIndex+2]) / 3;
                                targetSectionBrightness += (targetData[pixelIndex] + targetData[pixelIndex+1] + targetData[pixelIndex+2]) / 3;
                                sectionPixels++;
                            }
                        }
                    }
                    
                    if (sectionPixels > 0) {
                        const avgBrightness = sectionBrightness / sectionPixels;
                        const targetAvgBrightness = targetSectionBrightness / sectionPixels;
                        
                        if (Math.abs(avgBrightness - targetAvgBrightness) < 60) {
                            patternMatches++;
                        }
                    }
                    totalSections++;
                }
                
                return totalSections > 0 ? patternMatches / totalSections : 0;
            } catch (error) {
                return 0;
            }
        }

        function analyzeVideoAreaMarker(capturedCtx, targetCtx, x, y, radius) {
            try {
                const size = radius * 2 + 4; // ì•½ê°„ ì—¬ìœ  ê³µê°„
                const capturedData = capturedCtx.getImageData(x - radius - 2, y - radius - 2, size, size).data;
                const targetData = targetCtx.getImageData(x - radius - 2, y - radius - 2, size, size).data;
                
                let circleMatches = 0;
                let circlePixels = 0;
                
                // ì›í˜• ë§ˆì»¤ ì˜ì—­ ë¶„ì„
                for (let i = 0; i < size; i++) {
                    for (let j = 0; j < size; j++) {
                        const distanceFromCenter = Math.sqrt((i - size/2) ** 2 + (j - size/2) ** 2);
                        
                        if (distanceFromCenter <= radius + 1) {
                            const pixelIndex = (j * size + i) * 4;
                            
                            if (pixelIndex < capturedData.length) {
                                const capturedR = capturedData[pixelIndex];
                                const capturedG = capturedData[pixelIndex + 1];
                                const capturedB = capturedData[pixelIndex + 2];
                                
                                const targetR = targetData[pixelIndex];
                                const targetG = targetData[pixelIndex + 1];
                                const targetB = targetData[pixelIndex + 2];
                                
                                // ì£¼í™©ìƒ‰ ë§ˆì»¤ ìƒ‰ìƒ ë¶„ì„
                                const isOrange = targetR > 200 && targetG > 100 && targetG < 150 && targetB < 100;
                                const capturedIsOrange = capturedR > 150 && capturedG > 80 && capturedG < 180 && capturedB < 120;
                                
                                const isWhite = targetR > 200 && targetG > 200 && targetB > 200;
                                const capturedIsWhite = capturedR > 180 && capturedG > 180 && capturedB > 180;
                                
                                if ((isOrange && capturedIsOrange) || (isWhite && capturedIsWhite)) {
                                    circleMatches++;
                                }
                                circlePixels++;
                            }
                        }
                    }
                }
                
                return circlePixels > 0 ? circleMatches / circlePixels : 0;
            } catch (error) {
                return 0;
            }
        }

        function analyzeDigitalSignature(capturedCtx, targetCtx, x, y, width, height) {
            try {
                const capturedData = capturedCtx.getImageData(x, y, width, height).data;
                const targetData = targetCtx.getImageData(x, y, width, height).data;
                
                let barMatches = 0;
                let totalBars = 0;
                
                // ë°”ì½”ë“œ íŒ¨í„´ ë¶„ì„ (ì„¸ë¡œ ë°©í–¥ìœ¼ë¡œ 12ê°œ ë°”)
                const barWidth = Math.floor(width / 12);
                
                for (let bar = 0; bar < 12; bar++) {
                    const barX = bar * barWidth;
                    let barBrightness = 0;
                    let targetBarBrightness = 0;
                    let barPixels = 0;
                    
                    for (let i = 0; i < barWidth && (barX + i) < width; i++) {
                        for (let j = 0; j < height; j++) {
                            const pixelIndex = (j * width + (barX + i)) * 4;
                            if (pixelIndex < capturedData.length) {
                                barBrightness += (capturedData[pixelIndex] + capturedData[pixelIndex+1] + capturedData[pixelIndex+2]) / 3;
                                targetBarBrightness += (targetData[pixelIndex] + targetData[pixelIndex+1] + targetData[pixelIndex+2]) / 3;
                                barPixels++;
                            }
                        }
                    }
                    
                    if (barPixels > 0) {
                        const avgBrightness = barBrightness / barPixels;
                        const targetAvgBrightness = targetBarBrightness / barPixels;
                        
                        const isBlack = avgBrightness < 128;
                        const targetIsBlack = targetAvgBrightness < 128;
                        
                        if (isBlack === targetIsBlack) {
                            barMatches++;
                        }
                    }
                    totalBars++;
                }
                
                return totalBars > 0 ? barMatches / totalBars : 0;
            } catch (error) {
                return 0;
            }
        }

        function setupCameraBackgroundDirect() {
            console.log('ì¹´ë©”ë¼ ë°±ê·¸ë¼ìš´ë“œ ì§ì ‘ ì„¤ì •');
            
            const cameraBackground = document.getElementById('cameraBackground');
            if (!cameraBackground) {
                console.warn('ì¹´ë©”ë¼ ë°±ê·¸ë¼ìš´ë“œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œìš©)
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: { ideal: 'environment' },
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                } 
            })
            .then(stream => {
                cameraBackground.srcObject = stream;
                cameraBackground.style.display = 'block';
                cameraBackground.play();
                console.log('ì¹´ë©”ë¼ ë°±ê·¸ë¼ìš´ë“œ ì„¤ì • ì™„ë£Œ');
            })
            .catch(error => {
                console.warn('ì¹´ë©”ë¼ ë°±ê·¸ë¼ìš´ë“œ ì„¤ì • ì‹¤íŒ¨:', error);
                // ì¹´ë©”ë¼ ì‹¤íŒ¨ ì‹œ ê²€ì€ ë°°ê²½
                cameraBackground.style.background = '#000';
                cameraBackground.style.display = 'block';
            });
        }

        function loadAndPlayARWithPosition(arId, framePosition) {
            console.log('ìœ„ì¹˜ ê¸°ë°˜ AR ë¡œë”©:', arId, framePosition);
            
            try {
                const arData = JSON.parse(localStorage.getItem(`arData_${arId}`));
                if (!arData) {
                    console.error('AR ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', arId);
                    alert('AR ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // AR ë·°ì–´ í‘œì‹œ (showARViewer ëŒ€ì‹  ì§ì ‘ êµ¬í˜„)
                const arViewer = document.getElementById('arViewer');
                if (arViewer) {
                    arViewer.style.display = 'block';
                    arViewer.classList.add('active');
                }
                
                // í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€
                document.body.style.overflow = 'hidden';
                
                // ì¹´ë©”ë¼ ë°±ê·¸ë¼ìš´ë“œ ì„¤ì • (ì§ì ‘ êµ¬í˜„)
                setupCameraBackgroundDirect();
                
                // ìœ„ì¹˜ ì •ë³´ê°€ ìˆëŠ” ê²½ìš° ì •í™•í•œ ìœ„ì¹˜ì— ì˜¤ë²„ë ˆì´
                if (framePosition && framePosition.centerX !== undefined) {
                    console.log('ê°ì§€ëœ ìœ„ì¹˜ì— AR ì˜¤ë²„ë ˆì´ ì„¤ì •:', framePosition);
                    setTimeout(() => {
                        loadVideoOverlayAtPosition(arData, framePosition);
                    }, 300); // AR ë·°ì–´ í‘œì‹œ í›„ ì˜¤ë²„ë ˆì´ ë¡œë”©
                } else {
                    console.log('ê¸°ë³¸ ì¤‘ì•™ ìœ„ì¹˜ì— AR ì˜¤ë²„ë ˆì´ ì„¤ì •');
                    setTimeout(() => {
                        loadVideoOverlay(arData);
                    }, 300);
                }
                
            } catch (error) {
                console.error('AR ë¡œë”© ì¤‘ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤ìº” ëª¨ë“œë¡œ ëŒì•„ê°€ì§€ ì•Šê³  ì—ëŸ¬ í‘œì‹œ
                const arViewer = document.getElementById('arViewer');
                if (arViewer) {
                    arViewer.innerHTML = `
                        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                    background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; 
                                    text-align: center; z-index: 2000;">
                            <h3>âŒ AR ë¡œë”© ì‹¤íŒ¨</h3>
                            <p>ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                            <button onclick="closeARViewer()" style="background: #ff6b35; color: white; border: none; 
                                    padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                                ëŒì•„ê°€ê¸°
                            </button>
                        </div>
                    `;
                }
            }
        }

        function loadAndPlayAR(arId) {
            const arDataJson = localStorage.getItem('arData_' + arId);
            if (!arDataJson) {
                alert('AR ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const arData = JSON.parse(arDataJson);
            
            console.log('ğŸ¯ AR ë¡œë”© ì‹œì‘:', arId, arData);
            
            // ìŠ¤ìº” í™”ë©´ì—ì„œ AR ë¹„ë””ì˜¤ ë¡œë“œ (ê°™ì€ í™”ë©´ì—ì„œ ì²˜ë¦¬)
            loadScannerAR(arId);
        }

        // ìŠ¤ìº” í™”ë©´ì—ì„œ AR ë¹„ë””ì˜¤ ë¡œë“œ (ìƒˆë¡œìš´ í•¨ìˆ˜)
        function loadScannerAR(arId) {
            const arDataJson = localStorage.getItem('arData_' + arId);
            if (!arDataJson) {
                console.error('AR ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', arId);
                return;
            }
            
            const arData = JSON.parse(arDataJson);
            console.log('ğŸ¯ ìŠ¤ìº” AR ë¡œë”© ì‹œì‘:', arId, arData);
            
            // ìŠ¤ìº” AR ì˜¤ë²„ë ˆì´ í‘œì‹œ
            const scannerArOverlay = document.getElementById('scannerArOverlay');
            const scannerArStatus = document.getElementById('scannerArStatus');
            const scannerArControls = document.getElementById('scannerArControls');
            
            scannerArOverlay.style.display = 'block';
            scannerArStatus.style.display = 'block';
            scannerArControls.style.display = 'flex';
            scannerArStatus.textContent = 'ğŸ¬ AR ì˜ìƒ ë¡œë”© ì¤‘...';
            
            // AR ì´ë¯¸ì§€ ì˜ì—­ ê³„ì‚° ë° ë¹„ë””ì˜¤ ìœ„ì¹˜ ì„¤ì •
            calculateScannerARPosition(arData);
            
            // ë¹„ë””ì˜¤ ë¡œë“œ
            if (arData.youtubeUrl) {
                console.log('ğŸ“º YouTube URL ë°œê²¬, YouTube ì˜¤ë²„ë ˆì´ ì‚¬ìš©');
                loadScannerYouTube(arData);
            } else if (arData.videoData) {
                console.log('ğŸ¬ ì‹¤ì œ ë¹„ë””ì˜¤ ë°ì´í„° ì‚¬ìš©');
                loadScannerVideo(arData);
            } else {
                console.log('âš ï¸ ë¹„ë””ì˜¤ ë°ì´í„° ì—†ìŒ, YouTube í´ë°± ì‚¬ìš©');
                loadScannerYouTube(arData);
            }
        }

        // ìŠ¤ìº” AR ìˆ¨ê¸°ê¸°
        function hideScannerAR() {
            const scannerArOverlay = document.getElementById('scannerArOverlay');
            const scannerArStatus = document.getElementById('scannerArStatus');
            const scannerArControls = document.getElementById('scannerArControls');
            const scannerOverlayVideo = document.getElementById('scannerOverlayVideo');
            const scannerOverlayFrame = document.getElementById('scannerOverlayFrame');
            
            scannerArOverlay.style.display = 'none';
            scannerArStatus.style.display = 'none';
            scannerArControls.style.display = 'none';
            scannerOverlayVideo.style.display = 'none';
            scannerOverlayFrame.style.display = 'none';
            
            // ë¹„ë””ì˜¤ ì •ë¦¬
            if (scannerOverlayVideo.src) {
                scannerOverlayVideo.pause();
                scannerOverlayVideo.src = '';
            }
            
            console.log('ğŸ”‡ ìŠ¤ìº” AR ìˆ¨ê¹€');
        }

        // ìŠ¤ìº” AR ìœ„ì¹˜ ê³„ì‚°
        function calculateScannerARPosition(arData) {
            const scannerOverlayVideo = document.getElementById('scannerOverlayVideo');
            const scannerOverlayFrame = document.getElementById('scannerOverlayFrame');
            const scannerContainer = document.getElementById('scannerContainer');
            
            // ìŠ¤ìº” ì»¨í…Œì´ë„ˆ í¬ê¸°
            const containerWidth = scannerContainer.offsetWidth;
            const containerHeight = scannerContainer.offsetHeight;
            
            // AR ë¹„ë””ì˜¤ í¬ê¸° (ìŠ¤ìº” í”„ë ˆì„ í¬ê¸°ì— ë§ì¶¤)
            const videoWidth = 280;
            const videoHeight = 200;
            
            // ì¤‘ì•™ ìœ„ì¹˜ ê³„ì‚°
            const left = (containerWidth - videoWidth) / 2;
            const top = (containerHeight - videoHeight) / 2;
            
            // ë¹„ë””ì˜¤ ìœ„ì¹˜ ì„¤ì •
            scannerOverlayVideo.style.left = left + 'px';
            scannerOverlayVideo.style.top = top + 'px';
            scannerOverlayVideo.style.width = videoWidth + 'px';
            scannerOverlayVideo.style.height = videoHeight + 'px';
            scannerOverlayVideo.style.display = 'block';
            
            // í”„ë ˆì„ ìœ„ì¹˜ ì„¤ì • (ë¹„ë””ì˜¤ë³´ë‹¤ ì•½ê°„ í¬ê²Œ)
            const frameMargin = 10;
            scannerOverlayFrame.style.left = (left - frameMargin) + 'px';
            scannerOverlayFrame.style.top = (top - frameMargin) + 'px';
            scannerOverlayFrame.style.width = (videoWidth + frameMargin * 2) + 'px';
            scannerOverlayFrame.style.height = (videoHeight + frameMargin * 2) + 'px';
            scannerOverlayFrame.style.display = 'block';
            
            console.log('ğŸ“ ìŠ¤ìº” AR ìœ„ì¹˜ ì„¤ì •:', { left, top, width: videoWidth, height: videoHeight });
        }

        // ìŠ¤ìº” YouTube ë¡œë“œ
        function loadScannerYouTube(arData) {
            const scannerOverlayVideo = document.getElementById('scannerOverlayVideo');
            const scannerArStatus = document.getElementById('scannerArStatus');
            
            // YouTube URL ì„¤ì •
            const youtubeUrl = arData.youtubeUrl || 'https://www.youtube.com/watch?v=MX_UceuxveA';
            const videoId = youtubeUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/)?.[1] || 'MX_UceuxveA';
            const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&rel=0&modestbranding=1&showinfo=0&controls=1`;
            
            // iframe ìƒì„±
            const iframe = document.createElement('iframe');
            iframe.src = embedUrl;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '12px';
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
            iframe.allowFullscreen = true;
            
            // ê¸°ì¡´ ë‚´ìš© ì œê±°í•˜ê³  iframe ì¶”ê°€
            scannerOverlayVideo.innerHTML = '';
            scannerOverlayVideo.appendChild(iframe);
            
            scannerArStatus.textContent = 'ğŸ“º YouTube ì˜ìƒ ì¬ìƒ ì¤‘';
            console.log('ğŸ“º ìŠ¤ìº” YouTube ë¡œë“œ ì™„ë£Œ:', videoId);
        }

        // ìŠ¤ìº” ë¹„ë””ì˜¤ ë¡œë“œ
        function loadScannerVideo(arData) {
            const scannerOverlayVideo = document.getElementById('scannerOverlayVideo');
            const scannerArStatus = document.getElementById('scannerArStatus');
            
            // ë¹„ë””ì˜¤ ìš”ì†Œ ì´ˆê¸°í™”
            scannerOverlayVideo.pause();
            scannerOverlayVideo.currentTime = 0;
            scannerOverlayVideo.src = '';
            scannerOverlayVideo.innerHTML = '';
            
            // ë¹„ë””ì˜¤ ì†ì„± ì„¤ì •
            scannerOverlayVideo.setAttribute('autoplay', 'true');
            scannerOverlayVideo.setAttribute('loop', 'true');
            scannerOverlayVideo.setAttribute('muted', 'true');
            scannerOverlayVideo.setAttribute('playsinline', 'true');
            
            // ë¹„ë””ì˜¤ ì†ŒìŠ¤ ì„¤ì •
            scannerOverlayVideo.src = arData.videoData;
            
            // ë¹„ë””ì˜¤ ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸
            scannerOverlayVideo.onloadeddata = () => {
                console.log('ğŸ¬ ìŠ¤ìº” ë¹„ë””ì˜¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                scannerArStatus.textContent = 'ğŸ¬ AR ì˜ìƒ ì¬ìƒ ì¤‘';
                
                // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„
                scannerOverlayVideo.play().then(() => {
                    console.log('âœ… ìŠ¤ìº” ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘');
                }).catch(error => {
                    console.error('âŒ ìŠ¤ìº” ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', error);
                    scannerArStatus.textContent = 'âŒ ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨';
                });
            };
            
            // ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨ ì‹œ
            scannerOverlayVideo.onerror = (e) => {
                console.error('âŒ ìŠ¤ìº” ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨:', e);
                scannerArStatus.textContent = 'âŒ ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨';
                // YouTube í´ë°±
                loadScannerYouTube(arData);
            };
        }

        // ìŠ¤ìº” ë¹„ë””ì˜¤ ì†Œë¦¬ í† ê¸€
        function toggleScannerVideoSound() {
            const scannerOverlayVideo = document.getElementById('scannerOverlayVideo');
            const scannerArStatus = document.getElementById('scannerArStatus');
            
            if (scannerOverlayVideo.muted) {
                scannerOverlayVideo.muted = false;
                scannerArStatus.textContent = 'ğŸ”Š ì†Œë¦¬ ON';
            } else {
                scannerOverlayVideo.muted = true;
                scannerArStatus.textContent = 'ğŸ”‡ ì†Œë¦¬ OFF';
            }
            
            // 3ì´ˆ í›„ ì›ë˜ ë©”ì‹œì§€ë¡œ ë³µì›
            setTimeout(() => {
                scannerArStatus.textContent = 'ğŸ¬ AR ì˜ìƒ ì¬ìƒ ì¤‘';
            }, 3000);
        }

        // ìŠ¤ìº” AR ë‹«ê¸°
        function closeScannerAR() {
            hideScannerAR();
            console.log('âœ• ìŠ¤ìº” AR ë‹«ê¸°');
        }

        // ì „ì²´ í™”ë©´ AR ë¹„ë””ì˜¤ ë¡œë“œ
        function loadFullscreenAR(arId) {
            const arDataJson = localStorage.getItem('arData_' + arId);
            if (!arDataJson) {
                console.error('AR ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', arId);
                return;
            }
            
            const arData = JSON.parse(arDataJson);
            console.log('ğŸ¯ ì „ì²´ í™”ë©´ AR ë¡œë”© ì‹œì‘:', arId, arData);
            
            // ì „ì²´ í™”ë©´ AR ì˜¤ë²„ë ˆì´ í‘œì‹œ
            const fullscreenArOverlay = document.getElementById('fullscreenArOverlay');
            const fullscreenArStatus = document.getElementById('fullscreenArStatus');
            const fullscreenArControls = document.getElementById('fullscreenArControls');
            
            fullscreenArOverlay.style.display = 'block';
            fullscreenArStatus.style.display = 'block';
            fullscreenArControls.style.display = 'flex';
            fullscreenArStatus.textContent = 'ğŸ¬ AR ì˜ìƒ ë¡œë”© ì¤‘...';
            
            // AR ì´ë¯¸ì§€ ì˜ì—­ ê³„ì‚° ë° ë¹„ë””ì˜¤ ìœ„ì¹˜ ì„¤ì •
            calculateFullscreenARPosition(arData);
            
            // ë¹„ë””ì˜¤ ë¡œë“œ
            if (arData.youtubeUrl) {
                console.log('ğŸ“º YouTube URL ë°œê²¬, YouTube ì˜¤ë²„ë ˆì´ ì‚¬ìš©');
                loadFullscreenYouTube(arData);
            } else if (arData.videoData) {
                console.log('ğŸ¬ ì‹¤ì œ ë¹„ë””ì˜¤ ë°ì´í„° ì‚¬ìš©');
                loadFullscreenVideo(arData);
            } else {
                console.log('âš ï¸ ë¹„ë””ì˜¤ ë°ì´í„° ì—†ìŒ, YouTube í´ë°± ì‚¬ìš©');
                loadFullscreenYouTube(arData);
            }
        }

        // ì „ì²´ í™”ë©´ AR ìˆ¨ê¸°ê¸°
        function hideFullscreenAR() {
            const fullscreenArOverlay = document.getElementById('fullscreenArOverlay');
            const fullscreenArStatus = document.getElementById('fullscreenArStatus');
            const fullscreenArControls = document.getElementById('fullscreenArControls');
            const fullscreenOverlayVideo = document.getElementById('fullscreenOverlayVideo');
            const fullscreenOverlayFrame = document.getElementById('fullscreenOverlayFrame');
            
            fullscreenArOverlay.style.display = 'none';
            fullscreenArStatus.style.display = 'none';
            fullscreenArControls.style.display = 'none';
            fullscreenOverlayVideo.style.display = 'none';
            fullscreenOverlayFrame.style.display = 'none';
            
            // ë¹„ë””ì˜¤ ì •ë¦¬
            if (fullscreenOverlayVideo.src) {
                fullscreenOverlayVideo.pause();
                fullscreenOverlayVideo.src = '';
            }
            
            console.log('ğŸ”‡ ì „ì²´ í™”ë©´ AR ìˆ¨ê¹€');
        }

        // ì „ì²´ í™”ë©´ AR ìœ„ì¹˜ ê³„ì‚°
        function calculateFullscreenARPosition(arData) {
            const fullscreenOverlayVideo = document.getElementById('fullscreenOverlayVideo');
            const fullscreenOverlayFrame = document.getElementById('fullscreenOverlayFrame');
            const fullscreenScanner = document.getElementById('fullscreenScanner');
            
            // ì „ì²´ í™”ë©´ ìŠ¤ìºë„ˆ í¬ê¸°
            const containerWidth = fullscreenScanner.offsetWidth;
            const containerHeight = fullscreenScanner.offsetHeight;
            
            // AR ë¹„ë””ì˜¤ í¬ê¸° (ì „ì²´ í™”ë©´ì— ë§ì¶¤)
            const videoWidth = 400;
            const videoHeight = 300;
            
            // ì¤‘ì•™ ìœ„ì¹˜ ê³„ì‚°
            const left = (containerWidth - videoWidth) / 2;
            const top = (containerHeight - videoHeight) / 2;
            
            // ë¹„ë””ì˜¤ ìœ„ì¹˜ ì„¤ì •
            fullscreenOverlayVideo.style.left = left + 'px';
            fullscreenOverlayVideo.style.top = top + 'px';
            fullscreenOverlayVideo.style.width = videoWidth + 'px';
            fullscreenOverlayVideo.style.height = videoHeight + 'px';
            fullscreenOverlayVideo.style.display = 'block';
            
            // í”„ë ˆì„ ìœ„ì¹˜ ì„¤ì • (ë¹„ë””ì˜¤ë³´ë‹¤ ì•½ê°„ í¬ê²Œ)
            const frameMargin = 15;
            fullscreenOverlayFrame.style.left = (left - frameMargin) + 'px';
            fullscreenOverlayFrame.style.top = (top - frameMargin) + 'px';
            fullscreenOverlayFrame.style.width = (videoWidth + frameMargin * 2) + 'px';
            fullscreenOverlayFrame.style.height = (videoHeight + frameMargin * 2) + 'px';
            fullscreenOverlayFrame.style.display = 'block';
            
            console.log('ğŸ“ ì „ì²´ í™”ë©´ AR ìœ„ì¹˜ ì„¤ì •:', { left, top, width: videoWidth, height: videoHeight });
        }

        // ì „ì²´ í™”ë©´ YouTube ë¡œë“œ
        function loadFullscreenYouTube(arData) {
            const fullscreenOverlayVideo = document.getElementById('fullscreenOverlayVideo');
            const fullscreenArStatus = document.getElementById('fullscreenArStatus');
            
            // YouTube URL ì„¤ì •
            const youtubeUrl = arData.youtubeUrl || 'https://www.youtube.com/watch?v=MX_UceuxveA';
            const videoId = youtubeUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/)?.[1] || 'MX_UceuxveA';
            const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&rel=0&modestbranding=1&showinfo=0&controls=1`;
            
            // iframe ìƒì„±
            const iframe = document.createElement('iframe');
            iframe.src = embedUrl;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '12px';
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
            iframe.allowFullscreen = true;
            
            // ê¸°ì¡´ ë‚´ìš© ì œê±°í•˜ê³  iframe ì¶”ê°€
            fullscreenOverlayVideo.innerHTML = '';
            fullscreenOverlayVideo.appendChild(iframe);
            
            fullscreenArStatus.textContent = 'ğŸ“º YouTube ì˜ìƒ ì¬ìƒ ì¤‘';
            console.log('ğŸ“º ì „ì²´ í™”ë©´ YouTube ë¡œë“œ ì™„ë£Œ:', videoId);
        }

        // ì „ì²´ í™”ë©´ ë¹„ë””ì˜¤ ë¡œë“œ
        function loadFullscreenVideo(arData) {
            const fullscreenOverlayVideo = document.getElementById('fullscreenOverlayVideo');
            const fullscreenArStatus = document.getElementById('fullscreenArStatus');
            
            // ë¹„ë””ì˜¤ ìš”ì†Œ ì´ˆê¸°í™”
            fullscreenOverlayVideo.pause();
            fullscreenOverlayVideo.currentTime = 0;
            fullscreenOverlayVideo.src = '';
            fullscreenOverlayVideo.innerHTML = '';
            
            // ë¹„ë””ì˜¤ ì†ì„± ì„¤ì •
            fullscreenOverlayVideo.setAttribute('autoplay', 'true');
            fullscreenOverlayVideo.setAttribute('loop', 'true');
            fullscreenOverlayVideo.setAttribute('muted', 'true');
            fullscreenOverlayVideo.setAttribute('playsinline', 'true');
            
            // ë¹„ë””ì˜¤ ì†ŒìŠ¤ ì„¤ì •
            fullscreenOverlayVideo.src = arData.videoData;
            
            // ë¹„ë””ì˜¤ ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸
            fullscreenOverlayVideo.onloadeddata = () => {
                console.log('ğŸ¬ ì „ì²´ í™”ë©´ ë¹„ë””ì˜¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                fullscreenArStatus.textContent = 'ğŸ¬ AR ì˜ìƒ ì¬ìƒ ì¤‘';
                
                // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„
                fullscreenOverlayVideo.play().then(() => {
                    console.log('âœ… ì „ì²´ í™”ë©´ ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘');
                }).catch(error => {
                    console.error('âŒ ì „ì²´ í™”ë©´ ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', error);
                    fullscreenArStatus.textContent = 'âŒ ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨';
                });
            };
            
            // ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨ ì‹œ
            fullscreenOverlayVideo.onerror = (e) => {
                console.error('âŒ ì „ì²´ í™”ë©´ ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨:', e);
                fullscreenArStatus.textContent = 'âŒ ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨';
                // YouTube í´ë°±
                loadFullscreenYouTube(arData);
            };
        }

        // ì „ì²´ í™”ë©´ ë¹„ë””ì˜¤ ì†Œë¦¬ í† ê¸€
        function toggleFullscreenVideoSound() {
            const fullscreenOverlayVideo = document.getElementById('fullscreenOverlayVideo');
            const fullscreenArStatus = document.getElementById('fullscreenArStatus');
            
            if (fullscreenOverlayVideo.muted) {
                fullscreenOverlayVideo.muted = false;
                fullscreenArStatus.textContent = 'ğŸ”Š ì†Œë¦¬ ON';
            } else {
                fullscreenOverlayVideo.muted = true;
                fullscreenArStatus.textContent = 'ğŸ”‡ ì†Œë¦¬ OFF';
            }
            
            // 3ì´ˆ í›„ ì›ë˜ ë©”ì‹œì§€ë¡œ ë³µì›
            setTimeout(() => {
                fullscreenArStatus.textContent = 'ğŸ¬ AR ì˜ìƒ ì¬ìƒ ì¤‘';
            }, 3000);
        }

        // ì „ì²´ í™”ë©´ AR ë‹«ê¸°
        function closeFullscreenAR() {
            hideFullscreenAR();
            console.log('âœ• ì „ì²´ í™”ë©´ AR ë‹«ê¸°');
        }

        // ìŠ¤ìº” ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
        function handleScanButtonClick() {
            console.log('ğŸ” ìŠ¤ìº” ë²„íŠ¼ í´ë¦­ë¨ - í•¸ë“¤ëŸ¬ í˜¸ì¶œë¨');
            
            try {
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const btn = document.getElementById('startScanBtn');
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = 'ğŸ”„ ìŠ¤ìº” ì‹œì‘ ì¤‘...';
                    console.log('âœ… ìŠ¤ìº” ë²„íŠ¼ ìƒíƒœ ë³€ê²½ë¨');
                }
                
                // ì „ì²´ í™”ë©´ ìŠ¤ìº” ì‹œì‘
                console.log('ğŸš€ startFullscreenScan í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘');
                startFullscreenScan();
                
            } catch (error) {
                console.error('âŒ ìŠ¤ìº” ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ ì˜¤ë¥˜:', error);
                
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë²„íŠ¼ ìƒíƒœ ë³µì›
                const btn = document.getElementById('startScanBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ“· ì´ë¯¸ì§€ ìŠ¤ìº” ì‹œì‘';
                }
                
                // ì‚¬ìš©ìì—ê²Œ ì˜¤ë¥˜ ì•Œë¦¼
                alert('ìŠ¤ìº” ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        function startImageDetectionOverlay(arData) {
            document.getElementById('arStatus').textContent = 'ğŸ¯ ì´ë¯¸ì§€ ì¸ì‹ ì¤‘...';
            
            // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í™œì„±í™” (ë¹„ë””ì˜¤ ì¬ìƒì„ ìœ„í•´)
            if (!userInteracted) {
                document.addEventListener('click', enableAudio, { once: true });
                document.addEventListener('touchstart', enableAudio, { once: true });
            }
            
            // 2ì´ˆ í›„ ì´ë¯¸ì§€ ê°ì§€ ì‹œë®¬ë ˆì´ì…˜
            setTimeout(() => {
                document.getElementById('arStatus').textContent = 'âœ… ì´ë¯¸ì§€ ê°ì§€ë¨! ë¹„ë””ì˜¤ ì¤€ë¹„ ì¤‘...';
                
                // ë¹„ë””ì˜¤ ë¡œë“œ ë° í‘œì‹œ
                loadVideoOverlay(arData);
                
            }, 2000);
        }

        function calculateARImageMappingPosition(arData, framePosition, overlayVideo, overlayFrame) {
            console.log('ğŸ” ìŠ¤ë§ˆíŠ¸ AR ì´ë¯¸ì§€ ì˜ì—­ ìë™ ì¸ì‹ ì‹œì‘');
            
            // AR íƒ€ê²Ÿ ì´ë¯¸ì§€ ë¡œë“œ ë° ë¶„ì„
            const tempImg = new Image();
            tempImg.onload = () => {
                console.log('AR íƒ€ê²Ÿ ì´ë¯¸ì§€ í¬ê¸°:', tempImg.width, 'x', tempImg.height);
                console.log('íŠ¹ìˆ˜ ë§ˆì»¤ í¬í•¨ ì—¬ë¶€:', arData.hasSpecialMarkers);
                
                // ìë™ ì´ë¯¸ì§€ ì˜ì—­ ê°ì§€
                const detectedRegion = autoDetectImageRegion(tempImg, arData);
                console.log('ğŸ¯ ìë™ ê°ì§€ëœ ì´ë¯¸ì§€ ì˜ì—­:', detectedRegion);
                
                // í™”ë©´ ë° í”„ë ˆì„ í¬ê¸°
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const frameSize = 280; // ìŠ¤ìº” í”„ë ˆì„ í¬ê¸°
                
                let detectedImageWidth, detectedImageHeight;
                let videoAreaLeft, videoAreaTop, videoAreaWidth, videoAreaHeight;
                
                if (arData.hasSpecialMarkers) {
                    console.log('ğŸ¯ íŠ¹ìˆ˜ ë§ˆì»¤ ê¸°ë°˜ ì •ë°€ ì˜ì—­ ê³„ì‚°');
                    
                    // íŠ¹ìˆ˜ ë§ˆì»¤ì˜ ë¹„ë””ì˜¤ ì¬ìƒ ì˜ì—­ ì •ë³´ ì‚¬ìš©
                    // ë§ˆì»¤ ì´ë¯¸ì§€ì—ì„œ ì‹¤ì œ ì½˜í…ì¸  ì˜ì—­ì€ ì¤‘ì•™ 560x560 (800x800 ì¤‘)
                    const markerImageSize = 800;
                    const contentMargin = 120; // íŠ¹ìˆ˜ ë§ˆì»¤ ìƒì„± ì‹œ ì‚¬ìš©ëœ ì—¬ë°±
                    const contentSize = markerImageSize - (contentMargin * 2); // 560
                    
                    // ìŠ¤ìº” í”„ë ˆì„ì— ë§ì¶˜ ì „ì²´ ë§ˆì»¤ í¬ê¸°
                    const markerDisplaySize = frameSize;
                    
                    // ì‹¤ì œ ë¹„ë””ì˜¤ ì¬ìƒ ì˜ì—­ í¬ê¸° (ì½˜í…ì¸  ì˜ì—­)
                    const videoRatio = contentSize / markerImageSize; // 0.7 (560/800)
                    videoAreaWidth = markerDisplaySize * videoRatio;
                    videoAreaHeight = markerDisplaySize * videoRatio;
                    
                    // ë§ˆì»¤ ì¤‘ì•™ì—ì„œ ë¹„ë””ì˜¤ ì˜ì—­ ìœ„ì¹˜ ê³„ì‚°
                    const markerCenterX = viewportWidth / 2;
                    const markerCenterY = viewportHeight / 2;
                    
                    videoAreaLeft = markerCenterX - (videoAreaWidth / 2);
                    videoAreaTop = markerCenterY - (videoAreaHeight / 2);
                    
                    // ì „ì²´ ë§ˆì»¤ ì˜ì—­ë„ ê³„ì‚° (ì¶”ì ìš©)
                    detectedImageWidth = markerDisplaySize;
                    detectedImageHeight = markerDisplaySize;
                    
                    console.log('ğŸ¬ ë¹„ë””ì˜¤ ì¬ìƒ ì˜ì—­:', {
                        left: videoAreaLeft,
                        top: videoAreaTop, 
                        width: videoAreaWidth,
                        height: videoAreaHeight
                    });
                    
                } else {
                    console.log('ğŸ“· ê¸°ë³¸ ì´ë¯¸ì§€ ê¸°ë°˜ ì˜ì—­ ê³„ì‚°');
                    
                    // AR ì´ë¯¸ì§€ ë¹„ìœ¨ ê³„ì‚°
                    const imageAspectRatio = tempImg.width / tempImg.height;
                    
                    // ì‹¤ì œ ê°ì§€ëœ ì´ë¯¸ì§€ ì˜ì—­ í¬ê¸° ê³„ì‚°
                    if (imageAspectRatio > 1) {
                        // ê°€ë¡œê°€ ë” ê¸´ ì´ë¯¸ì§€ - ìŠ¤ìº” í”„ë ˆì„ ë„ˆë¹„ì— ë§ì¶¤
                        detectedImageWidth = frameSize;
                        detectedImageHeight = frameSize / imageAspectRatio;
                    } else {
                        // ì„¸ë¡œê°€ ë” ê¸´ ì´ë¯¸ì§€ - ìŠ¤ìº” í”„ë ˆì„ ë†’ì´ì— ë§ì¶¤
                        detectedImageHeight = frameSize;
                        detectedImageWidth = frameSize * imageAspectRatio;
                    }
                    
                    // ê¸°ë³¸ ì´ë¯¸ì§€ì˜ ê²½ìš° ì „ì²´ ì˜ì—­ì´ ë¹„ë””ì˜¤ ì¬ìƒ ì˜ì—­
                    videoAreaWidth = detectedImageWidth;
                    videoAreaHeight = detectedImageHeight;
                    
                    const frameCenterX = viewportWidth / 2;
                    const frameCenterY = viewportHeight / 2;
                    
                    videoAreaLeft = frameCenterX - (videoAreaWidth / 2);
                    videoAreaTop = frameCenterY - (videoAreaHeight / 2);
                }
                
                console.log('ê°ì§€ëœ AR ì´ë¯¸ì§€ í¬ê¸°:', detectedImageWidth, 'x', detectedImageHeight);
                
                // ìŠ¤ìº” í”„ë ˆì„ ì¤‘ì•™ ìœ„ì¹˜ ê³„ì‚°
                const frameCenterX = viewportWidth / 2;
                const frameCenterY = viewportHeight / 2;
                
                // AR ì´ë¯¸ì§€ ì˜ì—­ ìœ„ì¹˜ ê³„ì‚° (ìŠ¤ìº” í”„ë ˆì„ ë‚´ì—ì„œ)
                const imageLeft = frameCenterX - (detectedImageWidth / 2);
                const imageTop = frameCenterY - (detectedImageHeight / 2);
                
                console.log('AR ì´ë¯¸ì§€ ì˜ì—­ ìœ„ì¹˜:', {
                    left: imageLeft,
                    top: imageTop,
                    width: detectedImageWidth,
                    height: detectedImageHeight
                });
                
                // ë¹„ë””ì˜¤ë¥¼ AR ì´ë¯¸ì§€ ì˜ì—­ì— ì •í™•íˆ ë§¤í•‘
                overlayVideo.style.position = 'fixed';
                overlayVideo.style.left = imageLeft + 'px';
                overlayVideo.style.top = imageTop + 'px';
                overlayVideo.style.width = detectedImageWidth + 'px';
                overlayVideo.style.height = detectedImageHeight + 'px';
                overlayVideo.style.borderRadius = '8px';
                overlayVideo.style.zIndex = '1001';
                overlayVideo.style.objectFit = 'cover';
                overlayVideo.style.border = '2px solid #ff6b35';
                overlayVideo.style.boxShadow = '0 0 20px rgba(255, 107, 53, 0.6)';
                
                // í”„ë ˆì„ì„ AR ì´ë¯¸ì§€ ì˜ì—­ ì£¼ë³€ì— í‘œì‹œ (ì•½ê°„ í¬ê²Œ)
                const frameMargin = 10;
                overlayFrame.style.position = 'fixed';
                overlayFrame.style.left = (imageLeft - frameMargin) + 'px';
                overlayFrame.style.top = (imageTop - frameMargin) + 'px';
                overlayFrame.style.width = (detectedImageWidth + frameMargin * 2) + 'px';
                overlayFrame.style.height = (detectedImageHeight + frameMargin * 2) + 'px';
                overlayFrame.style.border = '3px dashed #4CAF50';
                overlayFrame.style.borderRadius = '12px';
                overlayFrame.style.zIndex = '1002';
                overlayFrame.style.pointerEvents = 'none';
                overlayFrame.style.background = 'rgba(76, 175, 80, 0.1)';
                overlayFrame.style.animation = 'frameGlow 2s infinite alternate';
                
                // ì „ì—­ ë³€ìˆ˜ì— ìœ„ì¹˜ ì •ë³´ ì €ì¥ (ì¶”ì ìš©)
                window.arImageMapping = {
                    imageLeft,
                    imageTop,
                    detectedImageWidth,
                    detectedImageHeight,
                    imageAspectRatio: detectedImageWidth / detectedImageHeight,
                    frameCenterX,
                    frameCenterY,
                    // íŠ¹ìˆ˜ ë§ˆì»¤ ì •ë³´
                    hasSpecialMarkers: arData.hasSpecialMarkers || false,
                    // ì •í™•í•œ ë¹„ë””ì˜¤ ì¬ìƒ ì˜ì—­
                    videoArea: {
                        left: videoAreaLeft,
                        top: videoAreaTop,
                        width: videoAreaWidth,
                        height: videoAreaHeight
                    }
                };
                
            };
            
            tempImg.onerror = () => {
                console.warn('AR ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ë§¤í•‘ ì‚¬ìš©');
                // ê¸°ë³¸ í¬ê¸°ë¡œ ì¤‘ì•™ ë°°ì¹˜
                const defaultSize = 200;
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                
                overlayVideo.style.position = 'fixed';
                overlayVideo.style.left = (centerX - defaultSize/2) + 'px';
                overlayVideo.style.top = (centerY - defaultSize/2) + 'px';
                overlayVideo.style.width = defaultSize + 'px';
                overlayVideo.style.height = defaultSize + 'px';
                overlayVideo.style.zIndex = '1001';
                overlayVideo.style.objectFit = 'cover';
            };
            
            // AR íƒ€ê²Ÿ ì´ë¯¸ì§€ ë¡œë“œ
            tempImg.src = arData.targetImage;
        }

        function startARImageTracking(arData, framePosition, overlayVideo, overlayFrame) {
            console.log('ì§€ì†ì  AR ì´ë¯¸ì§€ ì¶”ì  ì‹œìŠ¤í…œ ì‹œì‘');
            
            if (!window.arImageMapping) {
                console.warn('AR ì´ë¯¸ì§€ ë§¤í•‘ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const mapping = window.arImageMapping;
            let trackingOffset = 0;
            let cameraMovementOffset = 0;
            let lastCameraPosition = { x: 0, y: 0 };
            let currentARPosition = { x: mapping.imageLeft, y: mapping.imageTop };
            
            // ë””ë°”ì´ìŠ¤ ë°©í–¥ ë° ì›€ì§ì„ ê°ì§€ ì‹œì‘
            startDeviceMotionTracking();
            
            const trackingAnimation = setInterval(() => {
                trackingOffset += 0.03;
                cameraMovementOffset += 0.01;
                
                // ì‹¤ì œ ARì—ì„œ ì¼ì–´ë‚˜ëŠ” ë¯¸ì„¸í•œ ì¶”ì  ë–¨ë¦¼
                const microJitterX = Math.sin(trackingOffset * 8) * 0.5;
                const microJitterY = Math.cos(trackingOffset * 6) * 0.3;
                
                // ì¹´ë©”ë¼ ì›€ì§ì„ì— ë”°ë¥¸ AR ì´ë¯¸ì§€ ìœ„ì¹˜ ë³€í™” (ë” í˜„ì‹¤ì )
                const cameraMovementX = Math.sin(cameraMovementOffset * 0.7) * 15;
                const cameraMovementY = Math.cos(cameraMovementOffset * 0.5) * 12;
                
                // ë””ë°”ì´ìŠ¤ ëª¨ì…˜ì´ ê°ì§€ë˜ë©´ ë” í° ì›€ì§ì„ ì ìš©
                let deviceOffsetX = 0;
                let deviceOffsetY = 0;
                if (window.deviceMotionData) {
                    deviceOffsetX = window.deviceMotionData.tiltX * 2;
                    deviceOffsetY = window.deviceMotionData.tiltY * 2;
                }
                
                // ì´ ì˜¤í”„ì…‹ ê³„ì‚° (ëª¨ë“  ì›€ì§ì„ í•©ì‚°)
                const totalOffsetX = microJitterX + cameraMovementX + deviceOffsetX;
                const totalOffsetY = microJitterY + cameraMovementY + deviceOffsetY;
                
                // AR ì´ë¯¸ì§€ì˜ ìƒˆë¡œìš´ ìœ„ì¹˜ ê³„ì‚°
                currentARPosition.x = mapping.imageLeft + totalOffsetX;
                currentARPosition.y = mapping.imageTop + totalOffsetY;
                
                // ë¹„ë””ì˜¤ë¥¼ AR ì´ë¯¸ì§€ ìœ„ì¹˜ì— ì •í™•íˆ ë°°ì¹˜
                overlayVideo.style.left = currentARPosition.x + 'px';
                overlayVideo.style.top = currentARPosition.y + 'px';
                
                // í”„ë ˆì„ë„ AR ì´ë¯¸ì§€ë¥¼ ë”°ë¼ ì´ë™
                if (overlayFrame) {
                    const frameMargin = 10;
                    overlayFrame.style.left = (currentARPosition.x - frameMargin) + 'px';
                    overlayFrame.style.top = (currentARPosition.y - frameMargin) + 'px';
                }
                
                // í™”ë©´ ê²½ê³„ ì²˜ë¦¬ (AR ì´ë¯¸ì§€ê°€ í™”ë©´ì„ ë²—ì–´ë‚  ë•Œ)
                const videoRight = currentARPosition.x + mapping.detectedImageWidth;
                const videoBottom = currentARPosition.y + mapping.detectedImageHeight;
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                // íˆ¬ëª…ë„ ê³„ì‚° (í™”ë©´ ê²½ê³„ì—ì„œ ì„œì„œíˆ ì‚¬ë¼ì§)
                let opacity = 1;
                const fadeMargin = 50;
                
                if (currentARPosition.x < -fadeMargin) {
                    opacity = Math.max(0, 1 + currentARPosition.x / fadeMargin);
                } else if (videoRight > screenWidth + fadeMargin) {
                    opacity = Math.max(0, 1 - (videoRight - screenWidth) / fadeMargin);
                }
                
                if (currentARPosition.y < -fadeMargin) {
                    opacity = Math.min(opacity, Math.max(0, 1 + currentARPosition.y / fadeMargin));
                } else if (videoBottom > screenHeight + fadeMargin) {
                    opacity = Math.min(opacity, Math.max(0, 1 - (videoBottom - screenHeight) / fadeMargin));
                }
                
                overlayVideo.style.opacity = opacity;
                if (overlayFrame) {
                    overlayFrame.style.opacity = opacity * 0.8; // í”„ë ˆì„ì€ ì¡°ê¸ˆ ë” íˆ¬ëª…í•˜ê²Œ
                }
                
                // AR ì¶”ì  ìƒíƒœ í‘œì‹œ
                if (opacity > 0.8) {
                    document.getElementById('arStatus').textContent = 'ğŸ¯ AR ì´ë¯¸ì§€ ì¶”ì  ì¤‘ (ì•ˆì •)';
                } else if (opacity > 0.3) {
                    document.getElementById('arStatus').textContent = 'âš ï¸ AR ì´ë¯¸ì§€ ë¶€ë¶„ ì¶”ì  ì¤‘';
                } else {
                    document.getElementById('arStatus').textContent = 'âŒ AR ì´ë¯¸ì§€ ì¶”ì  ì†ì‹¤';
                }
                
            }, 16); // 60fpsë¡œ ë¶€ë“œëŸ¬ìš´ ì¶”ì 
            
            // ì •ë¦¬ í•¨ìˆ˜ ì €ì¥
            window.currentTrackingAnimation = trackingAnimation;
        }
        
        function startDeviceMotionTracking() {
            console.log('ë””ë°”ì´ìŠ¤ ëª¨ì…˜ ì¶”ì  ì‹œì‘');
            
            // ì´ˆê¸°í™”
            window.deviceMotionData = { tiltX: 0, tiltY: 0 };
            
            // ë””ë°”ì´ìŠ¤ ë°©í–¥ ë³€í™” ê°ì§€
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', (event) => {
                    // ë² íƒ€: ì „í›„ ê¸°ìš¸ê¸° (-180 ~ 180)
                    // ê°ë§ˆ: ì¢Œìš° ê¸°ìš¸ê¸° (-90 ~ 90)
                    const beta = event.beta || 0;
                    const gamma = event.gamma || 0;
                    
                    // AR ì´ë¯¸ì§€ ìœ„ì¹˜ ë³€í™”ë¡œ ë³€í™˜ (ë” ë¶€ë“œëŸ½ê²Œ)
                    window.deviceMotionData.tiltX = Math.max(-20, Math.min(20, gamma * 0.8));
                    window.deviceMotionData.tiltY = Math.max(-20, Math.min(20, (beta - 90) * 0.5));
                });
            }
            
            // ë””ë°”ì´ìŠ¤ ëª¨ì…˜ ê°ì§€ (ê°€ì†ë„ê³„)
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (event) => {
                    const acceleration = event.accelerationIncludingGravity;
                    if (acceleration) {
                        // ê°€ì†ë„ ë³€í™”ë¥¼ AR ì´ë¯¸ì§€ ìœ„ì¹˜ ë³€í™”ë¡œ ë³€í™˜
                        const accelX = acceleration.x || 0;
                        const accelY = acceleration.y || 0;
                        
                        // ê¸°ì¡´ ê¸°ìš¸ê¸° ë°ì´í„°ì™€ ê²°í•© (ë” ìì—°ìŠ¤ëŸ¬ìš´ ì›€ì§ì„)
                        window.deviceMotionData.tiltX += accelX * 0.1;
                        window.deviceMotionData.tiltY += accelY * 0.1;
                        
                        // ë²”ìœ„ ì œí•œ
                        window.deviceMotionData.tiltX = Math.max(-30, Math.min(30, window.deviceMotionData.tiltX));
                        window.deviceMotionData.tiltY = Math.max(-30, Math.min(30, window.deviceMotionData.tiltY));
                    }
                });
            }
            
            // ë§ˆìš°ìŠ¤/í„°ì¹˜ ì›€ì§ì„ì„ ì¹´ë©”ë¼ ì›€ì§ì„ìœ¼ë¡œ ë³€í™˜ (ë°ìŠ¤í¬í†±/ëª¨ë°”ì¼ ëŒ€ì‘)
            let lastMouseX = 0;
            let lastMouseY = 0;
            window.mouseMotionData = { x: 0, y: 0 };
            
            // ë§ˆìš°ìŠ¤ ì›€ì§ì„ ê°ì§€ (ë°ìŠ¤í¬í†±)
            document.addEventListener('mousemove', (event) => {
                const deltaX = event.clientX - lastMouseX;
                const deltaY = event.clientY - lastMouseY;
                
                // ì¹´ë©”ë¼ ì›€ì§ì„ ì‹œë®¬ë ˆì´ì…˜ (ë§ˆìš°ìŠ¤ ì´ë™ = ì¹´ë©”ë¼ íŒ¨ë‹)
                window.mouseMotionData.x = Math.max(-50, Math.min(50, deltaX * 0.3));
                window.mouseMotionData.y = Math.max(-50, Math.min(50, deltaY * 0.3));
                
                lastMouseX = event.clientX;
                lastMouseY = event.clientY;
                
                // ì›€ì§ì„ ë°ì´í„° ì„œì„œíˆ ê°ì†Œ (ìì—°ìŠ¤ëŸ¬ìš´ ê°ì†)
                setTimeout(() => {
                    window.mouseMotionData.x *= 0.9;
                    window.mouseMotionData.y *= 0.9;
                }, 50);
            });
            
            // í„°ì¹˜ ì›€ì§ì„ ê°ì§€ (ëª¨ë°”ì¼)
            let lastTouchX = 0;
            let lastTouchY = 0;
            
            document.addEventListener('touchmove', (event) => {
                if (event.touches.length === 1) {
                    const touch = event.touches[0];
                    const deltaX = touch.clientX - lastTouchX;
                    const deltaY = touch.clientY - lastTouchY;
                    
                    // í„°ì¹˜ ì´ë™ì„ ì¹´ë©”ë¼ ì›€ì§ì„ìœ¼ë¡œ ë³€í™˜
                    window.mouseMotionData.x = Math.max(-40, Math.min(40, deltaX * 0.4));
                    window.mouseMotionData.y = Math.max(-40, Math.min(40, deltaY * 0.4));
                    
                    lastTouchX = touch.clientX;
                    lastTouchY = touch.clientY;
                    
                    // ì›€ì§ì„ ë°ì´í„° ì„œì„œíˆ ê°ì†Œ
                    setTimeout(() => {
                        window.mouseMotionData.x *= 0.8;
                        window.mouseMotionData.y *= 0.8;
                    }, 30);
                }
            });
            
            document.addEventListener('touchstart', (event) => {
                if (event.touches.length === 1) {
                    const touch = event.touches[0];
                    lastTouchX = touch.clientX;
                    lastTouchY = touch.clientY;
                }
            });
            
            // ê¸°ì¡´ ì¤‘ë³µ ì½”ë“œ ì œê±°ë¨ - ìƒˆë¡œìš´ ê°œì„ ëœ ì‹œìŠ¤í…œ ì‚¬ìš©
        }

        function startARImageTrackingForYouTube(arData, framePosition, youtubeOverlay) {
            console.log('ğŸ¯ ì¹´ë©”ë¼ ì´ë™ ëŒ€ì‘ AR ì´ë¯¸ì§€ ì¶”ì  ì‹œìŠ¤í…œ ì‹œì‘');
            
            if (!window.arImageMapping) {
                console.warn('AR ì´ë¯¸ì§€ ë§¤í•‘ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const mapping = window.arImageMapping;
            let trackingOffset = 0;
            let cameraMovementOffset = 0;
            let currentARPosition = { x: mapping.imageLeft, y: mapping.imageTop };
            let currentARScale = 1.0; // AR ì´ë¯¸ì§€ í¬ê¸° ë³€í™”
            let currentARRotation = 0; // AR ì´ë¯¸ì§€ ê°ë„ ë³€í™”
            
            // ë””ë°”ì´ìŠ¤ ëª¨ì…˜ ì¶”ì ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì‹œì‘
            if (!window.deviceMotionData) {
                startDeviceMotionTracking();
            }
            
            // ë¶€ë“œëŸ¬ìš´ ì¶”ì ì„ ìœ„í•œ ì´ì „ ìœ„ì¹˜ ì €ì¥
            let previousARPosition = { x: mapping.imageLeft, y: mapping.imageTop };
            let velocityX = 0;
            let velocityY = 0;
            
            const trackingAnimation = setInterval(() => {
                trackingOffset += 0.03; // ì†ë„ ê°ì†Œë¡œ ì•ˆì •ì„± í–¥ìƒ
                cameraMovementOffset += 0.015; // ë” ë¶€ë“œëŸ¬ìš´ ì›€ì§ì„
                
                // ë§¤ìš° ë¯¸ì„¸í•œ ìì—°ìŠ¤ëŸ¬ìš´ ë–¨ë¦¼ë§Œ ìœ ì§€ (ì‹¤ì œ ARì²˜ëŸ¼)
                const microJitterX = Math.sin(trackingOffset * 8) * 0.3;
                const microJitterY = Math.cos(trackingOffset * 6) * 0.2;
                
                // ì¹´ë©”ë¼ ì›€ì§ì„ ì‹œë®¬ë ˆì´ì…˜ (ë” ë¶€ë“œëŸ½ê²Œ)
                const cameraMovementX = Math.sin(cameraMovementOffset * 0.5) * 15;
                const cameraMovementY = Math.cos(cameraMovementOffset * 0.4) * 12;
                
                // ì‹¤ì œ ë””ë°”ì´ìŠ¤ ëª¨ì…˜ ë°˜ì˜ (ê°ë„ ë‚®ì¶¤)
                let deviceOffsetX = 0;
                let deviceOffsetY = 0;
                if (window.deviceMotionData) {
                    // ë””ë°”ì´ìŠ¤ ê¸°ìš¸ê¸° (ê°ë„ ì¤„ì„)
                    deviceOffsetX = window.deviceMotionData.tiltX * 2;
                    deviceOffsetY = window.deviceMotionData.tiltY * 2;
                    
                    // ë§ˆìš°ìŠ¤/í„°ì¹˜ ì›€ì§ì„ (ë” ë¶€ë“œëŸ½ê²Œ)
                    if (window.mouseMotionData) {
                        deviceOffsetX += window.mouseMotionData.x * 0.3;
                        deviceOffsetY += window.mouseMotionData.y * 0.3;
                    }
                }
                
                // ëª©í‘œ ìœ„ì¹˜ ê³„ì‚°
                const targetX = mapping.imageLeft + microJitterX + cameraMovementX + deviceOffsetX;
                const targetY = mapping.imageTop + microJitterY + cameraMovementY + deviceOffsetY;
                
                // ë¶€ë“œëŸ¬ìš´ ë³´ê°„ (easing) ì ìš©
                const smoothingFactor = 0.15; // ë¶€ë“œëŸ¬ì›€ ì •ë„ (ë‚®ì„ìˆ˜ë¡ ë” ë¶€ë“œëŸ¬ì›€)
                currentARPosition.x += (targetX - currentARPosition.x) * smoothingFactor;
                currentARPosition.y += (targetY - currentARPosition.y) * smoothingFactor;
                
                // ì†ë„ ê³„ì‚° (ê¸‰ê²©í•œ ë³€í™” ë°©ì§€)
                velocityX = currentARPosition.x - previousARPosition.x;
                velocityY = currentARPosition.y - previousARPosition.y;
                
                // ì†ë„ ì œí•œ (ë„ˆë¬´ ë¹ ë¥¸ ì›€ì§ì„ ë°©ì§€)
                const maxVelocity = 5;
                if (Math.abs(velocityX) > maxVelocity) {
                    currentARPosition.x = previousARPosition.x + Math.sign(velocityX) * maxVelocity;
                }
                if (Math.abs(velocityY) > maxVelocity) {
                    currentARPosition.y = previousARPosition.y + Math.sign(velocityY) * maxVelocity;
                }
                
                // ì´ì „ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                previousARPosition.x = currentARPosition.x;
                previousARPosition.y = currentARPosition.y;
                
                // ë¶€ë“œëŸ¬ìš´ í¬ê¸° ë³€í™” (ì•ˆì •ì ì¸ ìŠ¤ì¼€ì¼ë§)
                const baseScale = 1.0;
                const scaleVariation = Math.sin(cameraMovementOffset * 0.2) * 0.05; // ë§¤ìš° ì‘ì€ ë³€í™”
                let targetScale = baseScale + scaleVariation;
                
                // ë¶€ë“œëŸ¬ìš´ íšŒì „ (ë¯¸ë‹ˆë©€í•œ íšŒì „)
                const baseRotation = 0;
                const rotationVariation = Math.sin(cameraMovementOffset * 0.3) * 2; // ìµœëŒ€ Â±2ë„
                let targetRotation = baseRotation + rotationVariation;
                
                // ì‹¤ì œ ë””ë°”ì´ìŠ¤ ëª¨ì…˜ ë°˜ì˜ (ë” ë¯¸ì„¸í•˜ê²Œ)
                if (window.deviceMotionData) {
                    // ë””ë°”ì´ìŠ¤ ê¸°ìš¸ê¸°ì— ë”°ë¥¸ ë¯¸ì„¸í•œ íšŒì „
                    targetRotation += window.deviceMotionData.tiltX * 0.2;
                    
                    // ë””ë°”ì´ìŠ¤ ê±°ë¦¬ê°ì— ë”°ë¥¸ ë¯¸ì„¸í•œ í¬ê¸° ë³€í™”
                    const perspectiveScale = 1 + (window.deviceMotionData.tiltY * 0.01);
                    targetScale *= Math.max(0.9, Math.min(1.1, perspectiveScale));
                }
                
                // ë¶€ë“œëŸ¬ìš´ ë³´ê°„ìœ¼ë¡œ ê¸‰ê²©í•œ ë³€í™” ë°©ì§€
                const scaleSmoothing = 0.1;
                const rotationSmoothing = 0.1;
                
                currentARScale += (targetScale - currentARScale) * scaleSmoothing;
                currentARRotation += (targetRotation - currentARRotation) * rotationSmoothing;
                
                // ì•ˆì „ ë²”ìœ„ ì œí•œ
                currentARScale = Math.max(0.8, Math.min(1.2, currentARScale));
                currentARRotation = Math.max(-5, Math.min(5, currentARRotation));
                
                // ë™ì  í¬ê¸° ê³„ì‚° (í˜„ì¬ ìŠ¤ì¼€ì¼ ì ìš©)
                const dynamicWidth = mapping.detectedImageWidth * currentARScale;
                const dynamicHeight = mapping.detectedImageHeight * currentARScale;
                
                // ì¤‘ì‹¬ì  ê¸°ì¤€ìœ¼ë¡œ í¬ê¸° ì¡°ì •ëœ ìœ„ì¹˜ ê³„ì‚°
                const scaleCenterX = currentARPosition.x + (mapping.detectedImageWidth - dynamicWidth) / 2;
                const scaleCenterY = currentARPosition.y + (mapping.detectedImageHeight - dynamicHeight) / 2;
                
                // YouTube ì˜¤ë²„ë ˆì´ ì‹¤ì‹œê°„ ìœ„ì¹˜ ë° í¬ê¸° ì ìš©
                youtubeOverlay.style.left = scaleCenterX + 'px';
                youtubeOverlay.style.top = scaleCenterY + 'px';
                youtubeOverlay.style.width = dynamicWidth + 'px';
                youtubeOverlay.style.height = dynamicHeight + 'px';
                youtubeOverlay.style.transform = `rotate(${currentARRotation}deg)`;
                
                // 3D ì›ê·¼ íš¨ê³¼ (ì‹¤ì œ ê±°ë¦¬ê° í‘œí˜„)
                const perspective = 800 - (currentARScale - 1) * 300;
                youtubeOverlay.style.filter = `
                    perspective(${perspective}px) 
                    blur(${Math.max(0, (1 - currentARScale) * 2)}px)
                    brightness(${0.8 + currentARScale * 0.2})
                `;
                
                // í™”ë©´ ê²½ê³„ ì²˜ë¦¬ - ì™„ì „íˆ ë²—ì–´ë‚˜ë©´ ìˆ¨ê¹€
                const overlayRight = scaleCenterX + dynamicWidth;
                const overlayBottom = scaleCenterY + dynamicHeight;
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                // ê²½ê³„ ì—¬ë°± (ì´ë¯¸ì§€ê°€ ì´ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ì™„ì „íˆ ìˆ¨ê¹€)
                const hideMargin = 100;
                
                // ì™„ì „íˆ í™”ë©´ì„ ë²—ì–´ë‚¬ëŠ”ì§€ í™•ì¸
                const isCompletelyOffscreen = 
                    (scaleCenterX < -hideMargin) || 
                    (overlayRight > screenWidth + hideMargin) ||
                    (scaleCenterY < -hideMargin) || 
                    (overlayBottom > screenHeight + hideMargin);
                
                if (isCompletelyOffscreen) {
                    // ì™„ì „íˆ í™”ë©´ì„ ë²—ì–´ë‚˜ë©´ YouTube ì˜ìƒ ìˆ¨ê¹€
                    console.log('ğŸ“µ AR ì´ë¯¸ì§€ê°€ í™”ë©´ì„ ë²—ì–´ë‚¨ - YouTube ì˜ìƒ ìˆ¨ê¹€');
                    youtubeOverlay.style.display = 'none';
                    document.getElementById('arStatus').textContent = 'ğŸ“µ AR ì´ë¯¸ì§€ê°€ í™”ë©´ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¨';
                    return; // ë” ì´ìƒ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
                } else {
                    // í™”ë©´ ì•ˆì— ìˆìœ¼ë©´ ë‹¤ì‹œ í‘œì‹œ
                    youtubeOverlay.style.display = 'block';
                    youtubeOverlay.style.opacity = '1'; // ì™„ì „ ë¶ˆíˆ¬ëª…
                }
                
                // AR ì¶”ì  ìƒíƒœ í‘œì‹œ (ê°„ì†Œí™”ëœ ì •ë³´)
                const scalePercent = Math.round(currentARScale * 100);
                const rotationDegree = Math.round(Math.abs(currentARRotation));
                const velocityMagnitude = Math.round(Math.sqrt(velocityX * velocityX + velocityY * velocityY) * 10);
                
                // ì†ë„ì— ë”°ë¥¸ ìƒíƒœ í‘œì‹œ
                if (velocityMagnitude < 2) {
                    document.getElementById('arStatus').textContent = 
                        `ğŸ¯ AR ì•ˆì • ì¶”ì  (${scalePercent}%, ${rotationDegree}Â°)`;
                } else if (velocityMagnitude < 5) {
                    document.getElementById('arStatus').textContent = 
                        `ğŸ“¹ AR ë¶€ë“œëŸ¬ìš´ ì¶”ì  (ì†ë„: ${velocityMagnitude})`;
                } else {
                    document.getElementById('arStatus').textContent = 
                        `âš¡ AR ë¹ ë¥¸ ì¶”ì  (ì†ë„: ${velocityMagnitude}, ì•ˆì •í™” ì¤‘)`;
                }
                
            }, 20); // 50fpsë¡œ ì•ˆì •ì ì¸ ì¶”ì  (ë„ˆë¬´ ë¹ ë¥´ì§€ ì•Šê²Œ)
            
            // ì •ë¦¬ í•¨ìˆ˜ ì €ì¥ (YouTubeìš©)
            window.currentYouTubeTrackingAnimation = trackingAnimation;
        }

        function showYouTubeOverlayAtImageArea(arData, framePosition) {
            console.log('ğŸ¯ AR ì´ë¯¸ì§€ í‘œê¸°ìœ„ì¹˜ì— ì •í™•íˆ ë§ëŠ” YouTube í‘œì‹œ');
            
            // ë¨¼ì € ëª¨ë“  ë‹¤ë¥¸ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
            hideAllOverlays();
            
            const youtubeOverlay = document.getElementById('youtubeOverlay');
            const arStatus = document.getElementById('arStatus');
            
            // AR ì´ë¯¸ì§€ê°€ ì¸ì‹ë˜ì§€ ì•Šìœ¼ë©´ ì™„ì „íˆ ìˆ¨ê¸°ê¸°
            if (!arData || !arData.targetImage) {
                console.log('âŒ AR ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë¯€ë¡œ YouTube ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€');
                youtubeOverlay.style.display = 'none';
                arStatus.textContent = 'âš ï¸ AR ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”';
                return;
            }
            
            arStatus.textContent = 'ğŸ“º AR ì´ë¯¸ì§€ ìœ„ì¹˜ì— ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘';
            
            // AR ì´ë¯¸ì§€ ë§¤í•‘ ì •ë³´ë¥¼ ë¨¼ì € ê³„ì‚°
            calculateARImageMappingPosition(arData, framePosition, null, null);
            
            // ë§¤í•‘ ì •ë³´ê°€ ê³„ì‚°ë  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸°
            setTimeout(() => {
                if (!window.arImageMapping) {
                    console.log('âŒ AR ì´ë¯¸ì§€ ë§¤í•‘ ì‹¤íŒ¨ë¡œ YouTube ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€');
                    youtubeOverlay.style.display = 'none';
                    arStatus.textContent = 'âŒ AR ì´ë¯¸ì§€ ì¸ì‹ ì‹¤íŒ¨';
                    return;
                }
                
                const mapping = window.arImageMapping;
                console.log('ğŸ“ AR ì´ë¯¸ì§€ ë§¤í•‘ ì •ë³´:', mapping);
                
                // YouTube ì˜¤ë²„ë ˆì´ë¥¼ AR ì´ë¯¸ì§€ í‘œê¸°ìœ„ì¹˜ì— ì •í™•íˆ ê³ ì •
                youtubeOverlay.style.position = 'fixed';
                youtubeOverlay.style.zIndex = '1005';
                youtubeOverlay.style.display = 'block';
                youtubeOverlay.style.transform = 'none'; // ëª¨ë“  ë³€í˜• ì œê±°
                youtubeOverlay.style.filter = 'none'; // ëª¨ë“  í•„í„° ì œê±°
                youtubeOverlay.style.opacity = '1'; // ê³ ì • íˆ¬ëª…ë„
                
                if (mapping.hasSpecialMarkers && mapping.videoArea) {
                    console.log('ğŸ¯ íŠ¹ìˆ˜ ë§ˆì»¤ì˜ ì •í™•í•œ ë¹„ë””ì˜¤ ì¬ìƒ ì˜ì—­ì— ê³ ì •');
                    youtubeOverlay.style.left = mapping.videoArea.left + 'px';
                    youtubeOverlay.style.top = mapping.videoArea.top + 'px';
                    youtubeOverlay.style.width = mapping.videoArea.width + 'px';
                    youtubeOverlay.style.height = mapping.videoArea.height + 'px';
                } else {
                    console.log('ğŸ“· ì „ì²´ ì´ë¯¸ì§€ ì˜ì—­ì— ì •í™•íˆ ê³ ì •');
                    youtubeOverlay.style.left = mapping.imageLeft + 'px';
                    youtubeOverlay.style.top = mapping.imageTop + 'px';
                    youtubeOverlay.style.width = mapping.detectedImageWidth + 'px';
                    youtubeOverlay.style.height = mapping.detectedImageHeight + 'px';
                }
                
                // ê³ ì •ëœ ìŠ¤íƒ€ì¼ ì ìš©
                youtubeOverlay.style.borderRadius = '8px';
                youtubeOverlay.style.border = '2px solid #ff6b35';
                youtubeOverlay.style.boxShadow = '0 0 20px rgba(255, 107, 53, 0.6)';
                
                console.log('ğŸ“º YouTube ìµœì¢… ìœ„ì¹˜:', {
                    left: youtubeOverlay.style.left,
                    top: youtubeOverlay.style.top,
                    width: youtubeOverlay.style.width,
                    height: youtubeOverlay.style.height
                });
                
                // YouTube iframe ë‚´ìš© ì„¤ì •
                youtubeOverlay.innerHTML = `
                    <iframe 
                        width="100%" 
                        height="100%" 
                        src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1&loop=1&playlist=dQw4w9WgXcQ&controls=1&modestbranding=1&rel=0"
                        title="AR Video"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                        style="border-radius: 6px;">
                    </iframe>
                `;
                
                // ì¹´ë©”ë¼ ì´ë™ ëŒ€ì‘ ì‹¤ì‹œê°„ ì¶”ì  ì‹œìŠ¤í…œ ì‹œì‘
                console.log('ğŸ¯ YouTube ì˜¤ë²„ë ˆì´ ì´ˆê¸° ìœ„ì¹˜ ì„¤ì • ì™„ë£Œ - ì¶”ì  ì‹œì‘');
                if (window.arImageMapping) {
                    startARImageTrackingForYouTube(arData, framePosition, youtubeOverlay);
                }
                
            }, 100); // ë§¤í•‘ ê³„ì‚° ì™„ë£Œë¥¼ ìœ„í•œ ì§§ì€ ì§€ì—°
        }
        
        function hideAllOverlays() {
            console.log('ëª¨ë“  ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°');
            
            // AR ì˜¤ë²„ë ˆì´ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
            const arOverlayContainer = document.getElementById('arOverlayContainer');
            if (arOverlayContainer) {
                arOverlayContainer.style.display = 'none';
                arOverlayContainer.classList.remove('active');
            }
            
            // ì˜¤ë²„ë ˆì´ ë¹„ë””ì˜¤ ìˆ¨ê¸°ê¸°
            const overlayVideo = document.getElementById('overlayVideo');
            if (overlayVideo) {
                overlayVideo.style.display = 'none';
                overlayVideo.pause();
                overlayVideo.src = '';
            }
            
            // ì˜¤ë²„ë ˆì´ í”„ë ˆì„ ìˆ¨ê¸°ê¸°
            const overlayFrame = document.getElementById('overlayFrame');
            if (overlayFrame) {
                overlayFrame.style.display = 'none';
            }
            
            // ì˜¤ë²„ë ˆì´ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ ìˆ¨ê¸°ê¸°
            const overlayInstructions = document.getElementById('overlayInstructions');
            if (overlayInstructions) {
                overlayInstructions.style.display = 'none';
            }
            
            // A-Frame ìš”ì†Œë“¤ ìˆ¨ê¸°ê¸°
            try {
                const arScene = document.getElementById('ar-scene');
                if (arScene) {
                    arScene.style.display = 'none';
                }
                
                const arVideoPlane = document.getElementById('ar-video-plane');
                if (arVideoPlane) {
                    arVideoPlane.setAttribute('visible', false);
                }
                
                const arOverlay = document.getElementById('ar-overlay');
                if (arOverlay) {
                    arOverlay.setAttribute('visible', false);
                }
            } catch (e) {
                console.warn('A-Frame ìš”ì†Œ ìˆ¨ê¸°ê¸° ì‹¤íŒ¨:', e);
            }
        }

        function autoDetectImageRegion(image, arData) {
            console.log('ğŸ¤– AI ê¸°ë°˜ ì´ë¯¸ì§€ ì˜ì—­ ìë™ ê°ì§€ ì‹œì‘');
            
            // ìº”ë²„ìŠ¤ì— ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.drawImage(image, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // íŠ¹ìˆ˜ ë§ˆì»¤ê°€ ìˆëŠ” ê²½ìš° ì •ë°€ ê°ì§€
            if (arData.hasSpecialMarkers) {
                console.log('ğŸ¯ íŠ¹ìˆ˜ ë§ˆì»¤ ê¸°ë°˜ ì •ë°€ ì˜ì—­ ê°ì§€');
                return detectSpecialMarkerRegion(data, canvas.width, canvas.height);
            }
            
            // ì¼ë°˜ ì´ë¯¸ì§€ ì½˜í…ì¸  ì˜ì—­ ê°ì§€
            console.log('ğŸ“· ì¼ë°˜ ì´ë¯¸ì§€ ì½˜í…ì¸  ì˜ì—­ ê°ì§€');
            return detectContentRegion(data, canvas.width, canvas.height);
        }
        
        function detectSpecialMarkerRegion(imageData, width, height) {
            // íŠ¹ìˆ˜ ë§ˆì»¤ì—ì„œ ì‹¤ì œ ì½˜í…ì¸  ì˜ì—­ ì°¾ê¸°
            // ë§ˆì»¤ ì´ë¯¸ì§€ëŠ” ì¤‘ì•™ì— ì‹¤ì œ ì½˜í…ì¸ ê°€ ìˆê³  ì£¼ë³€ì— ë§ˆì»¤ê°€ ìˆìŒ
            
            const centerX = width / 2;
            const centerY = height / 2;
            
            // ì¤‘ì•™ 70% ì˜ì—­ì„ ì½˜í…ì¸  ì˜ì—­ìœ¼ë¡œ ì¶”ì •
            const contentRatio = 0.7;
            const contentWidth = width * contentRatio;
            const contentHeight = height * contentRatio;
            
            return {
                centerX: centerX,
                centerY: centerY,
                width: contentWidth,
                height: contentHeight,
                confidence: 0.9, // íŠ¹ìˆ˜ ë§ˆì»¤ëŠ” ë†’ì€ ì‹ ë¢°ë„
                type: 'special_marker'
            };
        }
        
        function detectContentRegion(imageData, width, height) {
            // ì¼ë°˜ ì´ë¯¸ì§€ì—ì„œ ì£¼ìš” ì½˜í…ì¸  ì˜ì—­ ê°ì§€
            // ê°€ì¥ìë¦¬ ìƒ‰ìƒ ë¶„ì„ìœ¼ë¡œ ì‹¤ì œ ì½˜í…ì¸  ì˜ì—­ ì°¾ê¸°
            
            let minX = width, maxX = 0, minY = height, maxY = 0;
            const threshold = 50; // ìƒ‰ìƒ ì°¨ì´ ì„ê³„ê°’
            
            // ê°€ì¥ìë¦¬ì—ì„œ ì‹œì‘í•´ì„œ ì½˜í…ì¸ ê°€ ìˆëŠ” ë¶€ë¶„ ì°¾ê¸°
            for (let y = 0; y < height; y += 5) { // ì„±ëŠ¥ì„ ìœ„í•´ 5í”½ì…€ì”© ê±´ë„ˆë›°ê¸°
                for (let x = 0; x < width; x += 5) {
                    const index = (y * width + x) * 4;
                    const r = imageData[index];
                    const g = imageData[index + 1];
                    const b = imageData[index + 2];
                    
                    // í°ìƒ‰ ë°°ê²½ì´ ì•„ë‹Œ ë¶€ë¶„ ì°¾ê¸°
                    const brightness = (r + g + b) / 3;
                    if (brightness < 240) { // í°ìƒ‰ì´ ì•„ë‹˜
                        minX = Math.min(minX, x);
                        maxX = Math.max(maxX, x);
                        minY = Math.min(minY, y);
                        maxY = Math.max(maxY, y);
                    }
                }
            }
            
            // ê°ì§€ëœ ì˜ì—­ì´ ë„ˆë¬´ ì‘ìœ¼ë©´ ì „ì²´ ì´ë¯¸ì§€ ì‚¬ìš©
            const detectedWidth = maxX - minX;
            const detectedHeight = maxY - minY;
            
            if (detectedWidth < width * 0.3 || detectedHeight < height * 0.3) {
                console.log('âš ï¸ ê°ì§€ëœ ì˜ì—­ì´ ì‘ìŒ, ì „ì²´ ì´ë¯¸ì§€ ì‚¬ìš©');
                return {
                    centerX: width / 2,
                    centerY: height / 2,
                    width: width * 0.8,
                    height: height * 0.8,
                    confidence: 0.6,
                    type: 'full_image'
                };
            }
            
            // ì—¬ë°± ì¶”ê°€ (10%)
            const margin = 0.1;
            const finalWidth = detectedWidth * (1 + margin);
            const finalHeight = detectedHeight * (1 + margin);
            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;
            
            console.log(`âœ… ì½˜í…ì¸  ì˜ì—­ ê°ì§€ ì™„ë£Œ: ${Math.round(finalWidth)}x${Math.round(finalHeight)}`);
            
            return {
                centerX: centerX,
                centerY: centerY,
                width: finalWidth,
                height: finalHeight,
                confidence: 0.8,
                type: 'content_detection'
            };
        }

        function hideYouTubeOverlay() {
            console.log('âŒ AR ì´ë¯¸ì§€ ì—†ìŒ - YouTube ì˜¤ë²„ë ˆì´ ì™„ì „íˆ ìˆ¨ê¹€');
            
            const youtubeOverlay = document.getElementById('youtubeOverlay');
            if (youtubeOverlay) {
                youtubeOverlay.style.display = 'none';
                youtubeOverlay.classList.remove('active');
                youtubeOverlay.innerHTML = ''; // ë‚´ìš© ì™„ì „ ì œê±°
                
                // ìœ„ì¹˜ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                youtubeOverlay.style.position = '';
                youtubeOverlay.style.left = '';
                youtubeOverlay.style.top = '';
                youtubeOverlay.style.width = '';
                youtubeOverlay.style.height = '';
                youtubeOverlay.style.transform = '';
                youtubeOverlay.style.opacity = '';
                youtubeOverlay.style.filter = '';
                
                console.log('âœ… YouTube ì˜¤ë²„ë ˆì´ ì™„ì „íˆ ì œê±°ë¨');
            }
            
            // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            const arStatus = document.getElementById('arStatus');
            if (arStatus) {
                arStatus.textContent = 'âš ï¸ AR ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì¸ì‹í•´ì£¼ì„¸ìš”';
            }
        }

        function loadVideoOverlayAtPosition(arData, framePosition) {
            console.log('AR ì´ë¯¸ì§€ ì˜ì—­ ê¸°ë°˜ ë¹„ë””ì˜¤ ì˜¤ë²„ë ˆì´ ë¡œë”©:', framePosition);
            
            const overlayVideo = document.getElementById('overlayVideo');
            const overlayFrame = document.getElementById('overlayFrame');
            const arStatus = document.getElementById('arStatus');
            
            // ìƒíƒœ ì—…ë°ì´íŠ¸
            arStatus.textContent = 'ğŸ¯ AR ì´ë¯¸ì§€ ì˜ì—­ì— ë¹„ë””ì˜¤ ë§¤í•‘ ì¤‘...';
            
            // ì˜¤ë²„ë ˆì´ ì»¨í…Œì´ë„ˆ í‘œì‹œ
            const overlayContainer = document.querySelector('.ar-overlay-container');
            overlayContainer.style.display = 'block';
            
            // AR ì´ë¯¸ì§€ ì‹¤ì œ í¬ê¸°ì™€ ìœ„ì¹˜ ê³„ì‚°
            calculateARImageMappingPosition(arData, framePosition, overlayVideo, overlayFrame);
            
            // ì¼ë‹¨ ìœ íŠœë¸Œë§Œ ì‚¬ìš©
            console.log('AR ì´ë¯¸ì§€ ì˜ì—­ì— YouTube í‘œì‹œ');
            showYouTubeOverlayAtImageArea(arData, framePosition);
        }
        
        function showYouTubeOverlayAtPosition(framePosition) {
            console.log('ìœ„ì¹˜ ê¸°ë°˜ YouTube ì˜¤ë²„ë ˆì´ í‘œì‹œ:', framePosition);
            
            const youtubeOverlay = document.getElementById('youtubeOverlay');
            const arStatus = document.getElementById('arStatus');
            
            arStatus.textContent = 'ğŸ“º ìœ„ì¹˜ ê¸°ë°˜ í´ë°± ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘';
            
            // ìœ„ì¹˜ ê³„ì‚°
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            const overlayLeft = framePosition.centerX * viewportWidth - (framePosition.width * viewportWidth / 2);
            const overlayTop = framePosition.centerY * viewportHeight - (framePosition.height * viewportHeight / 2);
            const overlayWidth = framePosition.width * viewportWidth;
            const overlayHeight = framePosition.height * viewportHeight;
            
            // YouTube iframe ìœ„ì¹˜ ì„¤ì •
            youtubeOverlay.style.position = 'fixed';
            youtubeOverlay.style.left = overlayLeft + 'px';
            youtubeOverlay.style.top = overlayTop + 'px';
            youtubeOverlay.style.width = overlayWidth + 'px';
            youtubeOverlay.style.height = overlayHeight + 'px';
            youtubeOverlay.style.borderRadius = '15px';
            youtubeOverlay.style.border = '3px solid #ff6b35';
            youtubeOverlay.style.zIndex = '1001';
            youtubeOverlay.style.display = 'block';
            
            // YouTube iframe ë‚´ìš© ì„¤ì •
            youtubeOverlay.innerHTML = `
                <iframe 
                    width="100%" 
                    height="100%" 
                    src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1&loop=1&playlist=dQw4w9WgXcQ&controls=1&modestbranding=1&rel=0"
                    title="AR Fallback Video"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                    style="border-radius: 12px;">
                </iframe>
            `;
            
            // AR íŠ¸ë˜í‚¹ ì‹œë®¬ë ˆì´ì…˜
            let trackingOffset = 0;
            const trackingAnimation = setInterval(() => {
                trackingOffset += 0.1;
                const jitterX = Math.sin(trackingOffset) * 2;
                const jitterY = Math.cos(trackingOffset * 1.3) * 1.5;
                
                youtubeOverlay.style.transform = `translate(${jitterX}px, ${jitterY}px)`;
            }, 50);
            
            window.currentTrackingAnimation = trackingAnimation;
        }

        function loadVideoOverlay(arData) {
            const overlayVideo = document.getElementById('overlayVideo');
            const arOverlayContainer = document.getElementById('arOverlayContainer');
            const overlayInstructions = document.getElementById('overlayInstructions');
            const overlayFrame = document.getElementById('overlayFrame');
            
            console.log('ğŸ¬ AR ì´ë¯¸ì§€ ì˜ì—­ ë¹„ë””ì˜¤ ì˜¤ë²„ë ˆì´ ë¡œë”© ì‹œì‘');
            console.log('ğŸ“Š AR ë°ì´í„°:', arData);
            
            // ì˜¤ë²„ë ˆì´ ì»¨í…Œì´ë„ˆ í‘œì‹œ
            arOverlayContainer.classList.add('active');
            overlayInstructions.textContent = 'AR ì´ë¯¸ì§€ ì˜ì—­ ë¶„ì„ ì¤‘...';
            
            // YouTube URLì´ ìˆìœ¼ë©´ YouTube ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ ë¹„ë””ì˜¤ ì‚¬ìš©
            if (arData.youtubeUrl) {
                console.log('ğŸ“º YouTube URL ë°œê²¬, YouTube ì˜¤ë²„ë ˆì´ ì‚¬ìš©');
                showYouTubeOverlayAtImageArea(arData, null);
                return;
            }
            
            // ë¹„ë””ì˜¤ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ YouTube í´ë°± ì‚¬ìš©
            if (!arData.videoData) {
                console.log('âš ï¸ ë¹„ë””ì˜¤ ë°ì´í„° ì—†ìŒ, YouTube í´ë°± ì‚¬ìš©');
                showYouTubeOverlayAtImageArea(arData, null);
                return;
            }
            
            // AR ì´ë¯¸ì§€ ì˜ì—­ ë§¤í•‘ ê³„ì‚° ë° ì˜¤ë²„ë ˆì´ ìœ„ì¹˜ ì„¤ì •
            calculateARImageMappingPosition(arData, null, overlayVideo, overlayFrame);
            
            // ë¹„ë””ì˜¤ ìš”ì†Œ ì´ˆê¸°í™”
            overlayVideo.pause();
            overlayVideo.currentTime = 0;
            overlayVideo.src = '';
            
            // ë¹„ë””ì˜¤ ì†ì„± ì„¤ì •
            overlayVideo.setAttribute('autoplay', 'true');
            overlayVideo.setAttribute('loop', 'true');
            overlayVideo.setAttribute('muted', 'true');
            overlayVideo.setAttribute('playsinline', 'true');
            overlayVideo.style.display = 'block';
            
            // ë¹„ë””ì˜¤ ì†ŒìŠ¤ ì„¤ì •
            overlayVideo.src = arData.videoData;
            
            // ë¹„ë””ì˜¤ ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸
            overlayVideo.onloadeddata = () => {
                console.log('AR ì´ë¯¸ì§€ ì˜ì—­ ë¹„ë””ì˜¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                console.log('ë¹„ë””ì˜¤ í¬ê¸°:', overlayVideo.videoWidth, 'x', overlayVideo.videoHeight);
                console.log('ë¹„ë””ì˜¤ ê¸¸ì´:', overlayVideo.duration, 'ì´ˆ');
                
                // AR ì´ë¯¸ì§€ ì¶”ì  ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
                startARImageTracking(arData, null, overlayVideo, overlayFrame);
                
                // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„
                const playPromise = overlayVideo.play();
                
                if (playPromise !== undefined) {
                                            playPromise.then(() => {
                            console.log('ì˜¤ë²„ë ˆì´ ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘ë¨');
                            document.getElementById('arStatus').textContent = 'ğŸ¬ AR ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘';
                            overlayInstructions.textContent = 'âœ… AR ì˜ìƒì´ ì¬ìƒë˜ê³  ìˆìŠµë‹ˆë‹¤ (í„°ì¹˜í•˜ë©´ ì†Œë¦¬)';
                            
                            // ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì´ ìˆì—ˆë‹¤ë©´ ì†Œë¦¬ í™œì„±í™”
                            if (userInteracted) {
                                overlayVideo.muted = false;
                                overlayInstructions.textContent = 'âœ… AR ì˜ìƒì´ ì¬ìƒë˜ê³  ìˆìŠµë‹ˆë‹¤ (ì†Œë¦¬ ON)';
                            }
                            
                            // ì´ë¯¸ì§€ ì¶”ì  ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
                            setTimeout(() => {
                                simulateARTracking(overlayVideo, overlayFrame);
                            }, 1000);
                            
                        }).catch(error => {
                        console.error('ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', error);
                        // ì¬ìƒ ì‹¤íŒ¨ ì‹œ ë‹¤ì‹œ ì‹œë„
                        setTimeout(() => {
                            tryPlayVideo();
                        }, 1000);
                    });
                }
            };
            
            // ë¹„ë””ì˜¤ ì¬ìƒ ê°€ëŠ¥ ì´ë²¤íŠ¸
            overlayVideo.oncanplay = () => {
                console.log('ë¹„ë””ì˜¤ ì¬ìƒ ê°€ëŠ¥ ìƒíƒœ');
                if (overlayVideo.paused) {
                    tryPlayVideo();
                }
            };
            
            // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘ ì´ë²¤íŠ¸
            overlayVideo.onplay = () => {
                console.log('ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘ë¨');
                overlayInstructions.textContent = 'âœ… AR ì˜ìƒì´ ì¬ìƒë˜ê³  ìˆìŠµë‹ˆë‹¤ (í„°ì¹˜í•˜ë©´ ì†Œë¦¬)';
            };
            
            // ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨ ì‹œ
            overlayVideo.onerror = (e) => {
                console.error('ì˜¤ë²„ë ˆì´ ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨:', e);
                console.error('ë¹„ë””ì˜¤ ì˜¤ë¥˜ ì½”ë“œ:', overlayVideo.error ? overlayVideo.error.code : 'ì—†ìŒ');
                showYouTubeOverlay();
            };
            
            // ë¹„ë””ì˜¤ í´ë¦­ ì´ë²¤íŠ¸ (ì†Œë¦¬ í† ê¸€)
            overlayVideo.onclick = () => {
                if (overlayVideo.muted) {
                    overlayVideo.muted = false;
                    overlayInstructions.textContent = 'ğŸ”Š ì†Œë¦¬ê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤';
                    userInteracted = true;
                } else {
                    overlayVideo.muted = true;
                    overlayInstructions.textContent = 'ğŸ”‡ ì†Œë¦¬ê°€ êº¼ì¡ŒìŠµë‹ˆë‹¤';
                }
                
                // 3ì´ˆ í›„ ì›ë˜ ë©”ì‹œì§€ë¡œ ë³µì›
                setTimeout(() => {
                    if (overlayVideo.muted) {
                        overlayInstructions.textContent = 'âœ… AR ì˜ìƒì´ ì¬ìƒë˜ê³  ìˆìŠµë‹ˆë‹¤ (í„°ì¹˜í•˜ë©´ ì†Œë¦¬)';
                    } else {
                        overlayInstructions.textContent = 'âœ… AR ì˜ìƒì´ ì¬ìƒë˜ê³  ìˆìŠµë‹ˆë‹¤ (ì†Œë¦¬ ON)';
                    }
                }, 3000);
            };
            
            // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„ í•¨ìˆ˜
            function tryPlayVideo() {
                console.log('ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„');
                console.log('ë¹„ë””ì˜¤ readyState:', overlayVideo.readyState);
                console.log('ë¹„ë””ì˜¤ paused:', overlayVideo.paused);
                console.log('ë¹„ë””ì˜¤ currentTime:', overlayVideo.currentTime);
                
                if (overlayVideo.readyState >= 2) { // HAVE_CURRENT_DATA
                    // ë¹„ë””ì˜¤ ì†ì„± ì¬ì„¤ì •
                    overlayVideo.muted = true;
                    overlayVideo.loop = true;
                    overlayVideo.autoplay = true;
                    
                    const playPromise = overlayVideo.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('ë¹„ë””ì˜¤ ì¬ìƒ ì„±ê³µ');
                            console.log('ë¹„ë””ì˜¤ í˜„ì¬ ì¬ìƒ ì‹œê°„:', overlayVideo.currentTime);
                            overlayInstructions.textContent = 'âœ… AR ì˜ìƒì´ ì¬ìƒë˜ê³  ìˆìŠµë‹ˆë‹¤ (í„°ì¹˜í•˜ë©´ ì†Œë¦¬)';
                        }).catch(error => {
                            console.warn('ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨, ì¬ì‹œë„:', error);
                            // ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì¬ì‹œë„
                            setTimeout(() => {
                                forceVideoPlay();
                            }, 500);
                        });
                    }
                } else {
                    console.log('ë¹„ë””ì˜¤ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ, ëŒ€ê¸° ì¤‘...');
                    setTimeout(tryPlayVideo, 500);
                }
            }
            
            // ê°•ì œ ë¹„ë””ì˜¤ ì¬ìƒ í•¨ìˆ˜
            function forceVideoPlay() {
                console.log('ê°•ì œ ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„');
                
                // ë¹„ë””ì˜¤ ìš”ì†Œ ì¬ì„¤ì •
                overlayVideo.load();
                
                overlayVideo.addEventListener('loadeddata', function playWhenReady() {
                    console.log('ë¹„ë””ì˜¤ ë°ì´í„° ì¬ë¡œë“œ ì™„ë£Œ, ì¬ìƒ ì‹œë„');
                    overlayVideo.removeEventListener('loadeddata', playWhenReady);
                    
                    // ì§§ì€ ì§€ì—° í›„ ì¬ìƒ
                    setTimeout(() => {
                        overlayVideo.play().then(() => {
                            console.log('ê°•ì œ ì¬ìƒ ì„±ê³µ');
                        }).catch(console.error);
                    }, 100);
                });
            }
            
            // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
            setTimeout(() => {
                if (overlayVideo.paused || overlayVideo.error) {
                    console.warn('ë¹„ë””ì˜¤ ë¡œë“œ/ì¬ìƒ ì‹œê°„ ì´ˆê³¼, í´ë°± ì‚¬ìš©');
                    showYouTubeOverlay();
                }
            }, 10000);
        }

        function showYouTubeOverlay() {
            const arOverlayContainer = document.getElementById('arOverlayContainer');
            const youtubeOverlay = document.getElementById('youtubeOverlay');
            const youtubeIframe = document.getElementById('youtubeIframe');
            
            console.log('ìœ íŠœë¸Œ í´ë°± ì˜ìƒ ìë™ ì¬ìƒ ì‹œì‘');
            
            // ë¹„ë””ì˜¤ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê³  ìœ íŠœë¸Œ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            arOverlayContainer.classList.remove('active');
            youtubeOverlay.classList.add('active');
            
            // ìœ íŠœë¸Œ ì˜ìƒ ìë™ ì¬ìƒ ì„¤ì •
            const youtubeVideoId = 'MX_UceuxveA'; // ìœ íŠœë¸Œ ë¹„ë””ì˜¤ ID
            const youtubeEmbedUrl = `https://www.youtube.com/embed/${youtubeVideoId}?autoplay=1&mute=1&loop=1&playlist=${youtubeVideoId}&rel=0&modestbranding=1&showinfo=0&controls=1`;
            
            youtubeIframe.src = youtubeEmbedUrl;
            
            document.getElementById('arStatus').textContent = 'ğŸ“º í´ë°± ì˜ìƒ ì¬ìƒ ì¤‘';
            
            console.log('ìœ íŠœë¸Œ ì„ë² ë“œ URL:', youtubeEmbedUrl);
            
            // ì‚¬ìš©ìê°€ í„°ì¹˜í•˜ë©´ ìŒì†Œê±° í•´ì œ
            youtubeIframe.addEventListener('click', () => {
                const unmutedUrl = `https://www.youtube.com/embed/${youtubeVideoId}?autoplay=1&mute=0&loop=1&playlist=${youtubeVideoId}&rel=0&modestbranding=1&showinfo=0&controls=1`;
                youtubeIframe.src = unmutedUrl;
                document.getElementById('arStatus').textContent = 'ğŸ“º í´ë°± ì˜ìƒ ì¬ìƒ ì¤‘ (ì†Œë¦¬ ON)';
            }, { once: true });
        }

        function calculateARImagePosition(arData, overlayVideo, overlayFrame) {
            console.log('AR ì´ë¯¸ì§€ ì˜ì—­ ê³„ì‚° ì‹œì‘');
            
            // AR íƒ€ê²Ÿ ì´ë¯¸ì§€ ë¡œë“œ ë° ë¶„ì„
            const tempImg = new Image();
            tempImg.onload = () => {
                console.log('AR íƒ€ê²Ÿ ì´ë¯¸ì§€ í¬ê¸°:', tempImg.width, 'x', tempImg.height);
                
                // í™”ë©´ í¬ê¸° ê°€ì ¸ì˜¤ê¸°
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                // AR ì´ë¯¸ì§€ ë¹„ìœ¨ ê³„ì‚°
                const imageAspectRatio = tempImg.width / tempImg.height;
                
                // AR ì˜ì—­ í¬ê¸° ê³„ì‚° (í™”ë©´ì˜ 60% í¬ê¸°ë¡œ ì„¤ì •)
                let arWidth, arHeight;
                const maxWidth = screenWidth * 0.6;
                const maxHeight = screenHeight * 0.4;
                
                if (imageAspectRatio > 1) {
                    // ê°€ë¡œê°€ ë” ê¸´ ì´ë¯¸ì§€
                    arWidth = Math.min(maxWidth, maxHeight * imageAspectRatio);
                    arHeight = arWidth / imageAspectRatio;
                } else {
                    // ì„¸ë¡œê°€ ë” ê¸´ ì´ë¯¸ì§€
                    arHeight = Math.min(maxHeight, maxWidth / imageAspectRatio);
                    arWidth = arHeight * imageAspectRatio;
                }
                
                // ìµœì†Œ í¬ê¸° ë³´ì¥
                arWidth = Math.max(arWidth, 250);
                arHeight = Math.max(arHeight, 180);
                
                console.log('ê³„ì‚°ëœ AR ì˜ì—­ í¬ê¸°:', arWidth, 'x', arHeight);
                
                // ì˜¤ë²„ë ˆì´ ë¹„ë””ì˜¤ í¬ê¸° ë° ìœ„ì¹˜ ì„¤ì •
                overlayVideo.style.width = arWidth + 'px';
                overlayVideo.style.height = arHeight + 'px';
                
                // í”„ë ˆì„ í¬ê¸° ì„¤ì • (ë¹„ë””ì˜¤ë³´ë‹¤ ì•½ê°„ í¬ê²Œ)
                overlayFrame.style.width = (arWidth + 20) + 'px';
                overlayFrame.style.height = (arHeight + 20) + 'px';
                
                // ì¤‘ì•™ ë°°ì¹˜ë¥¼ ìœ„í•œ ìœ„ì¹˜ ê³„ì‚°
                const leftPos = (screenWidth - arWidth) / 2;
                const topPos = (screenHeight - arHeight) / 2;
                
                console.log('AR ì˜ì—­ ìœ„ì¹˜:', leftPos, ',', topPos);
                
                // ì‹¤ì œ AR ì´ë¯¸ì§€ê°€ ê°ì§€ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒë˜ëŠ” ì˜ì—­ì— ë°°ì¹˜
                // (ì‹¤ì œë¡œëŠ” ì¹´ë©”ë¼ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì°¾ëŠ” ì˜ì—­)
                overlayVideo.style.left = '50%';
                overlayVideo.style.top = '50%';
                overlayVideo.style.transform = 'translate(-50%, -50%)';
                
                overlayFrame.style.left = '50%';
                overlayFrame.style.top = '50%';
                overlayFrame.style.transform = 'translate(-50%, -50%)';
                
                // AR ì˜ì—­ ì¤€ë¹„ ì™„ë£Œ
                document.getElementById('overlayInstructions').textContent = 'AR ì˜ì—­ ì¤€ë¹„ ì™„ë£Œ - ë¹„ë””ì˜¤ ë¡œë”© ì¤‘...';
                
            };
            
            tempImg.onerror = () => {
                console.warn('AR ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ í¬ê¸° ì‚¬ìš©');
                // ê¸°ë³¸ í¬ê¸° ì„¤ì •
                overlayVideo.style.width = '300px';
                overlayVideo.style.height = '200px';
                overlayFrame.style.width = '320px';
                overlayFrame.style.height = '220px';
            };
            
            // AR íƒ€ê²Ÿ ì´ë¯¸ì§€ ë¡œë“œ
            tempImg.src = arData.targetImage;
        }

        function simulateARTracking(overlayVideo, overlayFrame) {
            console.log('AR ì¶”ì  ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘');
            
            // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì¹´ë©”ë¼ì—ì„œ ì´ë¯¸ì§€ë¥¼ ê°ì§€í•˜ê³  ìœ„ì¹˜ë¥¼ ì¶”ì 
            // ì—¬ê¸°ì„œëŠ” ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ëœë¤ ìœ„ì¹˜ ë³€í™” íš¨ê³¼ ì¶”ê°€
            
            let trackingCount = 0;
            const maxTracking = 5;
            
            const trackingInterval = setInterval(() => {
                trackingCount++;
                
                // ì•½ê°„ì˜ ìœ„ì¹˜ ë³€í™”ë¡œ ì‹¤ì œ AR ì¶”ì  ëŠë‚Œ ì—°ì¶œ
                const offsetX = Math.random() * 10 - 5; // -5px ~ 5px
                const offsetY = Math.random() * 10 - 5; // -5px ~ 5px
                
                overlayVideo.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
                overlayFrame.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
                
                if (trackingCount >= maxTracking) {
                    clearInterval(trackingInterval);
                    // ìµœì¢…ì ìœ¼ë¡œ ì¤‘ì•™ ì •ë ¬
                    overlayVideo.style.transform = 'translate(-50%, -50%)';
                    overlayFrame.style.transform = 'translate(-50%, -50%)';
                    console.log('AR ì¶”ì  ì•ˆì •í™” ì™„ë£Œ');
                }
            }, 200);
        }

        async function initializeMindAR(arData) {
            try {
                console.log('ğŸš€ mindAR ê¸°ë°˜ ì‹¤ì œ AR ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘');
                document.getElementById('arStatus').textContent = 'ğŸ”§ mindAR ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...';
                
                // AR ì”¬ ì»¨í…Œì´ë„ˆ í‘œì‹œ
                const arSceneContainer = document.getElementById('arSceneContainer');
                arSceneContainer.style.display = 'block';
                
                // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‹œì‘
                await startCameraStream();
                
                // mindAR íƒ€ê²Ÿ íŒŒì¼ ìƒì„±
                const mindFile = await createMindARTargetFile(arData.targetImage);
                
                // A-Frame ì”¬ ì´ˆê¸°í™”
                const scene = document.querySelector('#ar-scene');
                
                // mindAR ì»´í¬ë„ŒíŠ¸ì— íƒ€ê²Ÿ íŒŒì¼ ì„¤ì •
                scene.setAttribute('mindar-image', {
                    imageTargetSrc: mindFile,
                    maxTrack: 1,
                    uiLoading: 'no',
                    uiScanning: 'no',
                    uiError: 'no',
                    showStats: false
                });
                
                // AR íƒ€ê²Ÿ ì´ë¯¸ì§€ ì„¤ì •
                const targetImage = document.querySelector('#ar-target-image');
                targetImage.src = arData.targetImage;
                
                // mindAR ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                setupMindAREvents(arData);
                
                // mindAR ì‹œìŠ¤í…œ ì‹œì‘
                const arSystem = scene.systems['mindar-image'];
                if (arSystem) {
                    arSystem.start();
                    console.log('âœ… mindAR ì‹œìŠ¤í…œ ì‹œì‘ë¨');
                }
                
                document.getElementById('arStatus').textContent = 'ğŸ“· ì¹´ë©”ë¼ë¡œ ìƒì„±ëœ AR ì´ë¯¸ì§€ë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”';
                
                console.log('âœ… mindAR ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ mindAR ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                document.getElementById('arStatus').textContent = 'âŒ AR ì‹œìŠ¤í…œ ì˜¤ë¥˜: ' + error.message;
            }
        }
        
        async function startCameraStream() {
            try {
                console.log('ğŸ“· ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‹œì‘ ì¤‘...');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì„ A-Frame ì”¬ì— ì—°ê²°
                const scene = document.querySelector('#ar-scene');
                const camera = scene.querySelector('[camera]');
                
                if (camera && camera.components.camera) {
                    camera.components.camera.camera = stream;
                    console.log('âœ… ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì™„ë£Œ');
                }
                
                return stream;
                
            } catch (error) {
                console.error('âŒ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‹œì‘ ì‹¤íŒ¨:', error);
                throw error;
            }
        }
        
        async function createMindARTargetFile(imageDataURL) {
            console.log('ğŸ¯ mindAR íƒ€ê²Ÿ íŒŒì¼ ìƒì„± ì¤‘...');
            
            try {
                // ì´ë¯¸ì§€ë¥¼ Canvasì— ë¡œë“œ
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                return new Promise((resolve, reject) => {
                    img.onload = async () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // ìµœì  í•´ìƒë„ë¡œ ì¡°ì • (mindAR ê¶Œì¥: 480-1024px)
                        const maxSize = 512;
                        let { width, height } = img;
                        
                        if (width > height) {
                            if (width > maxSize) {
                                height = (height * maxSize) / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = (width * maxSize) / height;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ mindAR íƒ€ê²Ÿ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                        const imageData = ctx.getImageData(0, 0, width, height);
                        const targetFile = await convertToMindARTarget(imageData, width, height);
                        
                        console.log('âœ… mindAR íƒ€ê²Ÿ íŒŒì¼ ìƒì„± ì™„ë£Œ');
                        resolve(targetFile);
                    };
                    
                    img.onerror = () => {
                        console.error('âŒ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
                        reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
                    };
                    
                    img.src = imageDataURL;
                });
                
            } catch (error) {
                console.error('âŒ mindAR íƒ€ê²Ÿ íŒŒì¼ ìƒì„± ì‹¤íŒ¨:', error);
                throw error;
            }
        }
        
        async function convertToMindARTarget(imageData, width, height) {
            // mindAR íƒ€ê²Ÿ íŒŒì¼ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ì‹¤ì œ ì‘ë™í•˜ëŠ” ë²„ì „)
            console.log('ğŸ¯ mindAR íƒ€ê²Ÿ íŒŒì¼ ìƒì„± ì¤‘...', { width, height });
            
            // ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ Canvasë¡œ ë³€í™˜
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // ImageDataë¥¼ Canvasì— ê·¸ë¦¬ê¸°
            ctx.putImageData(imageData, 0, 0);
            
            // Canvasë¥¼ Blobìœ¼ë¡œ ë³€í™˜
            return new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    console.log('âœ… mindAR íƒ€ê²Ÿ íŒŒì¼ ìƒì„± ì™„ë£Œ:', url);
                    resolve(url);
                }, 'image/jpeg', 0.9);
            });
        }
        
        function extractFeatures(imageData, width, height) {
            // ì´ë¯¸ì§€ì—ì„œ íŠ¹ì§•ì  ì¶”ì¶œ (ë‹¨ìˆœí™”ëœ ì•Œê³ ë¦¬ì¦˜)
            const features = [];
            const data = imageData.data;
            
            // Harris ì½”ë„ˆ ê²€ì¶œ ì•Œê³ ë¦¬ì¦˜ ë‹¨ìˆœí™” ë²„ì „
            const step = 8; // ì„±ëŠ¥ì„ ìœ„í•´ 8í”½ì…€ì”© ê±´ë„ˆë›°ê¸°
            
            for (let y = step; y < height - step; y += step) {
                for (let x = step; x < width - step; x += step) {
                    const idx = (y * width + x) * 4;
                    const r = data[idx];
                    const g = data[idx + 1];
                    const b = data[idx + 2];
                    const gray = (r + g + b) / 3;
                    
                    // ì£¼ë³€ í”½ì…€ê³¼ì˜ ì°¨ì´ ê³„ì‚°
                    const neighbors = [];
                    for (let dy = -step; dy <= step; dy += step) {
                        for (let dx = -step; dx <= step; dx += step) {
                            const nIdx = ((y + dy) * width + (x + dx)) * 4;
                            const nGray = (data[nIdx] + data[nIdx + 1] + data[nIdx + 2]) / 3;
                            neighbors.push(nGray);
                        }
                    }
                    
                    // ë¶„ì‚° ê³„ì‚° (íŠ¹ì§•ì  ê°•ë„)
                    const mean = neighbors.reduce((a, b) => a + b) / neighbors.length;
                    const variance = neighbors.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / neighbors.length;
                    
                    // ì„ê³„ê°’ ì´ìƒì´ë©´ íŠ¹ì§•ì ìœ¼ë¡œ ì¶”ê°€
                    if (variance > 500) {
                        features.push({
                            x: x / width,  // ì •ê·œí™”ëœ ì¢Œí‘œ
                            y: y / height, // ì •ê·œí™”ëœ ì¢Œí‘œ
                            strength: variance,
                            descriptor: neighbors.slice(0, 8) // ê°„ë‹¨í•œ ë””ìŠ¤í¬ë¦½í„°
                        });
                    }
                }
            }
            
            // ê°•ë„ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ê³  ìƒìœ„ 100ê°œë§Œ ì„ íƒ
            features.sort((a, b) => b.strength - a.strength);
            return features.slice(0, 100);
        }

        function setupMindARTarget(arData, targetImageUrl) {
            document.getElementById('arStatus').textContent = 'AR ì¤€ë¹„ ì™„ë£Œ - ì´ë¯¸ì§€ë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”';
            
            // ì‹¤ì œ mindAR ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            const target = document.querySelector('#ar-target');
            
            // ì‹¤ì œ ì´ë¯¸ì§€ ì¸ì‹ ì‹œë®¬ë ˆì´ì…˜ (ë” ì •êµí•˜ê²Œ)
            let detectionAttempts = 0;
            const maxAttempts = 10;
            
            const tryDetection = () => {
                detectionAttempts++;
                
                // ì´ë¯¸ì§€ ìœ ì‚¬ë„ ê²€ì‚¬ ì‹œë®¬ë ˆì´ì…˜
                const detectionProbability = Math.min(0.1 + (detectionAttempts * 0.1), 0.8);
                
                if (Math.random() < detectionProbability) {
                    // ê°ì§€ ì„±ê³µ
                    console.log('AR íƒ€ê²Ÿ ê°ì§€ë¨!');
                    document.getElementById('arStatus').textContent = 'ğŸ¯ ì´ë¯¸ì§€ ê°ì§€ë¨! ë¹„ë””ì˜¤ ë¡œë”© ì¤‘...';
                    simulateTargetDetection(arData);
                } else if (detectionAttempts < maxAttempts) {
                    // ê³„ì† ì‹œë„
                    document.getElementById('arStatus').textContent = `ì´ë¯¸ì§€ ì¸ì‹ ì¤‘... (${detectionAttempts}/${maxAttempts})`;
                    setTimeout(tryDetection, 1000);
                } else {
                    // ìµœëŒ€ ì‹œë„ í›„ ê°•ì œ ê°ì§€
                    document.getElementById('arStatus').textContent = 'ğŸ¯ ì´ë¯¸ì§€ íŒ¨í„´ ì¸ì‹ë¨! (í´ë°± ëª¨ë“œ)';
                    setTimeout(() => {
                        simulateTargetDetection(arData);
                    }, 1000);
                }
            };
            
            // ê°ì§€ ì‹œì‘
            setTimeout(tryDetection, 2000);
        }

        function simulateTargetDetection(arData) {
            document.getElementById('arStatus').textContent = 'ğŸ¯ ì´ë¯¸ì§€ ê°ì§€ë¨! ë¹„ë””ì˜¤ ë¡œë”© ì¤‘...';
            
            const arVideo = document.getElementById('ar-video');
            const arVideoElement = document.getElementById('ar-video-plane');
            const arOverlay = document.getElementById('ar-overlay');
            const youtubeFallback = document.getElementById('youtube-fallback');
            const fallbackText = document.getElementById('fallback-text');
            
            // ë¹„ë””ì˜¤ ë¡œë“œ ì‹œë„ (ë” ì—„ê²©í•œ íƒ€ì„ì•„ì›ƒ)
            const tryLoadVideo = () => {
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('ë¹„ë””ì˜¤ ë¡œë“œ ì‹œê°„ ì´ˆê³¼'));
                    }, 3000); // 3ì´ˆë¡œ ë‹¨ì¶•
                    
                    arVideo.oncanplaythrough = () => {
                        clearTimeout(timeout);
                        resolve();
                    };
                    
                    arVideo.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨'));
                    };
                    
                    // ë¹„ë””ì˜¤ ë°ì´í„° ê²€ì¦
                    if (!arData.videoData || arData.videoData.length < 1000) {
                        reject(new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ë¹„ë””ì˜¤ ë°ì´í„°'));
                        return;
                    }
                    
                    // ë¹„ë””ì˜¤ ë¡œë“œ ì‹œì‘
                    arVideo.src = arData.videoData;
                    arVideo.load();
                });
            };
            
            tryLoadVideo().then(() => {
                // ë¹„ë””ì˜¤ ë¡œë“œ ì„±ê³µ
                console.log('AR ë¹„ë””ì˜¤ ë¡œë“œ ì„±ê³µ');
                document.getElementById('arStatus').textContent = 'ğŸ¬ AR ë¹„ë””ì˜¤ ì¤€ë¹„ ì™„ë£Œ';
                
                // ë””ë²„ê·¸ í‘œì‹œê¸° í™œì„±í™”
                const debugIndicator = document.getElementById('debug-indicator');
                debugIndicator.setAttribute('visible', true);
                
                // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘
                if (userInteracted) {
                    arVideo.muted = false;
                }
                
                arVideo.play().then(() => {
                    console.log('ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘ë¨');
                    
                                        // ë¹„ë””ì˜¤ê°€ ì‹¤ì œë¡œ ì¬ìƒë˜ê¸° ì‹œì‘í•œ í›„ í‘œì‹œ
                    setTimeout(() => {
                        // ì´ë¯¸ì§€ ìœ„ì¹˜ì— ì •í™•íˆ ë¹„ë””ì˜¤ ì˜¤ë²„ë ˆì´
                        arVideoElement.setAttribute('visible', true);
                        arOverlay.setAttribute('visible', true);
                        arOverlay.setAttribute('material', 'color: #4CAF50; opacity: 0.3; transparent: true');
                        
                        document.getElementById('arStatus').textContent = 'ğŸ¬ AR ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘ (í´ë¦­í•˜ë©´ ì†Œë¦¬)';
                        
                        // ë¹„ë””ì˜¤ í…ìŠ¤ì²˜ ì„¤ì • ê°œì„ 
                        const videoSrc = arVideo.src;
                        console.log('ë¹„ë””ì˜¤ ì†ŒìŠ¤:', videoSrc ? 'ì„¤ì •ë¨' : 'ì—†ìŒ');
                        console.log('ë¹„ë””ì˜¤ ì¬ìƒ ìƒíƒœ:', !arVideo.paused ? 'ì¬ìƒì¤‘' : 'ì •ì§€');
                        console.log('ë¹„ë””ì˜¤ í¬ê¸°:', arVideo.videoWidth, 'x', arVideo.videoHeight);
                        
                        // A-Frame ë¹„ë””ì˜¤ ìš”ì†Œ ê°•ì œ ì—…ë°ì´íŠ¸
                        arVideoElement.setAttribute('material', {
                            src: '#ar-video',
                            shader: 'flat',
                            transparent: false,
                            side: 'double'
                        });
                        
                        // í…ìŠ¤ì²˜ ìƒˆë¡œê³ ì¹¨ ê°•ì œ ì‹¤í–‰
                        setTimeout(() => {
                            const material = arVideoElement.components.material;
                            if (material && material.material && material.material.map) {
                                material.material.map.needsUpdate = true;
                                material.material.needsUpdate = true;
                                console.log('í…ìŠ¤ì²˜ ê°•ì œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                            }
                        }, 100);
                        
                        console.log('AR ë¹„ë””ì˜¤ í‘œì‹œ ì„¤ì • ì™„ë£Œ');
                        
                        // 3ì´ˆ í›„ ë¹„ë””ì˜¤ ìƒíƒœ ì²´í¬
                        setTimeout(() => {
                            if (arVideoElement.getAttribute('visible') === 'true') {
                                if (arVideo.paused) {
                                    console.warn('ë¹„ë””ì˜¤ê°€ ì •ì§€ ìƒíƒœ, ì¬ì‹œì‘ ì‹œë„');
                                    arVideo.play().catch(console.error);
                                } else {
                                    console.log('ë¹„ë””ì˜¤ ì •ìƒ ì¬ìƒ ì¤‘');
                                    document.getElementById('arStatus').textContent = 'âœ… AR ë¹„ë””ì˜¤ ì •ìƒ ì¬ìƒ ì¤‘';
                                }
                            }
                        }, 3000);
                        
                        // 8ì´ˆ í›„ì—ë„ ë¬¸ì œê°€ ìˆìœ¼ë©´ ëŒ€ì²´ ë°©ë²• ì‹œë„
                        setTimeout(() => {
                            if (arVideoElement.getAttribute('visible') === 'true' && arVideo.paused) {
                                console.warn('ë¹„ë””ì˜¤ê°€ ì—¬ì „íˆ ë³´ì´ì§€ ì•ŠìŒ, ëŒ€ì²´ í‘œì‹œ ë°©ë²• ì‹œë„');
                                showVideoAlternative(arData);
                            }
                        }, 8000);
                        
                    }, 500); // 0.5ì´ˆ í›„ í‘œì‹œ
                    
                }).catch(error => {
                    console.error('ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', error);
                    document.getElementById('arStatus').textContent = 'âŒ ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨';
                    // ì¬ìƒ ì‹¤íŒ¨ ì‹œ í´ë°±ìœ¼ë¡œ ì „í™˜
                    showYouTubeFallbackOnImage();
                });
                
                // ìœ íŠœë¸Œ í´ë°± ìˆ¨ê¹€
                youtubeFallback.setAttribute('visible', false);
                fallbackText.setAttribute('visible', false);
                
                // ë¹„ë””ì˜¤ í´ë¦­ ì´ë²¤íŠ¸ (ì†Œë¦¬ í™œì„±í™”)
                arVideoElement.addEventListener('click', () => {
                    if (arVideo.muted) {
                        arVideo.muted = false;
                        document.getElementById('arStatus').textContent = 'ğŸ¬ AR ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘ (ì†Œë¦¬ ON)';
                    } else {
                        arVideo.muted = true;
                        document.getElementById('arStatus').textContent = 'ğŸ¬ AR ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘ (ì†Œë¦¬ OFF)';
                    }
                });
                
            }).catch(error => {
                // ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨ - ìœ íŠœë¸Œ í´ë°±
                console.warn('ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨, ìœ íŠœë¸Œ í´ë°± í™œì„±í™”:', error.message);
                document.getElementById('arStatus').textContent = 'ğŸ“º í´ë°± ë¹„ë””ì˜¤ ë¡œë”© ì¤‘...';
                
                // ì›ë³¸ ë¹„ë””ì˜¤ ìˆ¨ê¹€
                arVideoElement.setAttribute('visible', false);
                
                // ìœ íŠœë¸Œ í´ë°±ì„ ê°™ì€ ìœ„ì¹˜ì— í‘œì‹œ
                showYouTubeFallbackOnImage();
            });
        }



        function showVideoAlternative(arData) {
            console.log('ëŒ€ì²´ ë¹„ë””ì˜¤ í‘œì‹œ ë°©ë²• ì‹œë„');
            
            // ê¸°ì¡´ ë¹„ë””ì˜¤ ìˆ¨ê¹€
            const arVideoElement = document.getElementById('ar-video-plane');
            arVideoElement.setAttribute('visible', false);
            
            // Canvasë¥¼ ì‚¬ìš©í•œ ë¹„ë””ì˜¤ í‘œì‹œ
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 288; // 16:9 ë¹„ìœ¨
            const ctx = canvas.getContext('2d');
            
            // A-Frameì— canvas í…ìŠ¤ì²˜ë¡œ ì¶”ê°€
            const canvasTexture = document.createElement('a-plane');
            canvasTexture.setAttribute('id', 'video-canvas-plane');
            canvasTexture.setAttribute('width', '1.77');
            canvasTexture.setAttribute('height', '1');
            canvasTexture.setAttribute('position', '0 0 0.1');
            canvasTexture.setAttribute('material', `canvas: #video-canvas-${Date.now()}; transparent: false; shader: flat`);
            
            // Canvasë¥¼ assetsì— ì¶”ê°€
            canvas.id = `video-canvas-${Date.now()}`;
            document.querySelector('a-assets').appendChild(canvas);
            
            // AR íƒ€ê²Ÿì— ì¶”ê°€
            document.querySelector('#ar-target').appendChild(canvasTexture);
            
            // ë¹„ë””ì˜¤ë¥¼ Canvasì— ê·¸ë¦¬ê¸°
            const arVideo = document.getElementById('ar-video');
            const drawVideo = () => {
                if (!arVideo.paused && !arVideo.ended) {
                    ctx.drawImage(arVideo, 0, 0, canvas.width, canvas.height);
                    requestAnimationFrame(drawVideo);
                }
            };
            
            // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„
            arVideo.play().then(() => {
                canvasTexture.setAttribute('visible', true);
                drawVideo();
                document.getElementById('arStatus').textContent = 'ğŸ¬ ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘';
            }).catch(() => {
                // ë¹„ë””ì˜¤ë„ ì‹¤íŒ¨í•˜ë©´ í´ë°±
                showYouTubeFallbackOnImage();
            });
        }

        function openYouTubeVideo() {
            // ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
            console.log('openYouTubeVideo í•¨ìˆ˜ í˜¸ì¶œë¨ - showYouTubeOverlayë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
            showYouTubeOverlay();
        }

        function enableAudio() {
            userInteracted = true;
            const arVideo = document.getElementById('ar-video');
            if (arVideo && !arVideo.paused) {
                arVideo.muted = false;
            }
        }

        function closeARViewer() {
            console.log('AR ë·°ì–´ ë‹«ê¸°');
            
            // AR ë·°ì–´ ìˆ¨ê¹€
            const arViewer = document.getElementById('arViewer');
            arViewer.style.display = 'none';
            arViewer.classList.remove('active');
            
            // ëª¨ë“  ì˜¤ë²„ë ˆì´ ì™„ì „íˆ ìˆ¨ê¸°ê¸°
            hideAllOverlays();
            
            // YouTube ì˜¤ë²„ë ˆì´ë„ ìˆ¨ê¸°ê¸°
            const youtubeOverlay = document.getElementById('youtubeOverlay');
            if (youtubeOverlay) {
                youtubeOverlay.style.display = 'none';
                youtubeOverlay.classList.remove('active');
                youtubeOverlay.innerHTML = ''; // ë‚´ìš©ë„ ì™„ì „íˆ ì œê±°
            }
            
            document.getElementById('cameraPreview').classList.add('hidden');
            
            // ìœ„ì¹˜ ê¸°ë°˜ ì˜¤ë²„ë ˆì´ ì •ë¦¬
            if (overlayVideo) {
                overlayVideo.pause();
                overlayVideo.currentTime = 0;
                overlayVideo.src = '';
                overlayVideo.style.display = 'none';
                // ìœ„ì¹˜ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                overlayVideo.style.position = '';
                overlayVideo.style.left = '';
                overlayVideo.style.top = '';
                overlayVideo.style.width = '';
                overlayVideo.style.height = '';
                overlayVideo.style.transform = '';
            }
            
            if (overlayFrame) {
                overlayFrame.style.display = 'none';
                // ìœ„ì¹˜ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                overlayFrame.style.position = '';
                overlayFrame.style.left = '';
                overlayFrame.style.top = '';
                overlayFrame.style.width = '';
                overlayFrame.style.height = '';
                overlayFrame.style.transform = '';
            }
            
            if (overlayContainer) {
                overlayContainer.style.display = 'none';
            }
            
            if (youtubeOverlay) {
                youtubeOverlay.style.display = 'none';
                youtubeOverlay.innerHTML = '';
                // ìœ„ì¹˜ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                youtubeOverlay.style.position = '';
                youtubeOverlay.style.left = '';
                youtubeOverlay.style.top = '';
                youtubeOverlay.style.width = '';
                youtubeOverlay.style.height = '';
                youtubeOverlay.style.transform = '';
            }
            
            // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
            const scannerVideo = document.getElementById('scannerVideo');
            const previewVideo = document.getElementById('previewVideo');
            const cameraBackground = document.getElementById('cameraBackground');
            
            if (scannerVideo && scannerVideo.srcObject) {
                scannerVideo.srcObject.getTracks().forEach(track => track.stop());
                scannerVideo.srcObject = null;
            }
            
            if (previewVideo && previewVideo.srcObject) {
                previewVideo.srcObject = null;
            }
            
            if (cameraBackground && cameraBackground.srcObject) {
                cameraBackground.srcObject.getTracks().forEach(track => track.stop());
                cameraBackground.srcObject = null;
            }
            
            // ìœ íŠœë¸Œ iframe ì •ë¦¬
            const youtubeIframe = document.getElementById('youtubeIframe');
            if (youtubeIframe) {
                youtubeIframe.src = '';
            }
            
            if (scanTimeout) {
                clearTimeout(scanTimeout);
                scanTimeout = null;
            }
            
            // ìœ„ì¹˜ ê¸°ë°˜ íŠ¸ë˜í‚¹ ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬
            if (window.currentTrackingAnimation) {
                clearInterval(window.currentTrackingAnimation);
                window.currentTrackingAnimation = null;
                console.log('ğŸš« AR ì´ë¯¸ì§€ ì¶”ì  ì‹œìŠ¤í…œ ì¤‘ì§€ë¨');
            }
            
            // YouTube ì „ìš© ì¶”ì  ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬
            if (window.currentYouTubeTrackingAnimation) {
                clearInterval(window.currentYouTubeTrackingAnimation);
                window.currentYouTubeTrackingAnimation = null;
                console.log('ğŸš« YouTube ì¶”ì  ì‹œìŠ¤í…œ ì¤‘ì§€ë¨');
            }
            
            // ë””ë°”ì´ìŠ¤ ëª¨ì…˜ ë°ì´í„° ì´ˆê¸°í™”
            if (window.deviceMotionData) {
                window.deviceMotionData = { tiltX: 0, tiltY: 0 };
            }
            
            // ë§ˆìš°ìŠ¤ ëª¨ì…˜ ë°ì´í„° ì´ˆê¸°í™”
            if (window.mouseMotionData) {
                window.mouseMotionData = { x: 0, y: 0 };
            }
            
            // YouTube íŠ¸ë˜í‚¹ ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬
            if (window.currentYouTubeTrackingAnimation) {
                clearInterval(window.currentYouTubeTrackingAnimation);
                window.currentYouTubeTrackingAnimation = null;
            }
            
            // ë””ë°”ì´ìŠ¤ ëª¨ì…˜ ë°ì´í„° ì •ë¦¬
            if (window.deviceMotionData) {
                window.deviceMotionData = null;
            }
            
            // í˜ì´ì§€ ìŠ¤í¬ë¡¤ í•´ì œ
            document.body.style.overflow = '';
            
            // ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸° (ìŠ¤ìº” ëª¨ë“œê°€ ì•„ë‹Œ ìƒì„± ëª¨ë“œë¡œ)
            switchMode('create');
            
            // A-Frame AR ë¹„ë””ì˜¤ ì •ë¦¬ (ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ ì •ë¦¬)
            const arVideo = document.getElementById('ar-video');
            if (arVideo) {
                arVideo.pause();
                arVideo.currentTime = 0;
                arVideo.src = '';
            }
            
            // ëª¨ë“  A-Frame AR ìš”ì†Œ ìˆ¨ê¹€
            document.getElementById('ar-video-plane').setAttribute('visible', false);
            document.getElementById('ar-overlay').setAttribute('visible', false);
            document.getElementById('youtube-fallback').setAttribute('visible', false);
            document.getElementById('fallback-text').setAttribute('visible', false);
            document.getElementById('debug-indicator').setAttribute('visible', false);
            
            videoLoadFailed = false;
            
            console.log('AR ë·°ì–´ ì™„ì „íˆ ì •ë¦¬ë¨');
        }

        // URL íŒŒë¼ë¯¸í„°ë¡œ AR IDê°€ ì „ë‹¬ëœ ê²½ìš° ìë™ ë¡œë“œ
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const arId = urlParams.get('ar');
            
            if (arId) {
                switchMode('scan');
                setTimeout(() => {
                    loadAndPlayAR(arId);
                }, 1000);
            }
        });

        // ëª¨ë°”ì¼ ìµœì í™”
        if (/Mobi|Android/i.test(navigator.userAgent)) {
            document.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    if (document.getElementById('arViewer').style.display === 'block') {
                        window.scrollTo(0, 1);
                    }
                }, 100);
            });
        }

        function setupMindAREvents(arData) {
            console.log('ğŸ¯ mindAR ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •');
            
            const target = document.querySelector('#ar-target');
            const scene = document.querySelector('#ar-scene');
            let isTargetDetected = false;
            let isSoundEnabled = false;
            let trackingAnimation = null;
            
            // mindAR íƒ€ê²Ÿ ê°ì§€ ì´ë²¤íŠ¸
            target.addEventListener('targetFound', () => {
                console.log('ğŸ¯ mindAR: íƒ€ê²Ÿ ì´ë¯¸ì§€ ê°ì§€ë¨!');
                isTargetDetected = true;
                
                document.getElementById('arStatus').textContent = 'ğŸ¯ AR ì´ë¯¸ì§€ ì¸ì‹ë¨! YouTube ì˜ìƒ ë¡œë”© ì¤‘...';
                
                // ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
                updateDebugInfo({
                    status: 'ğŸ¯ AR ì´ë¯¸ì§€ ê°ì§€ë¨',
                    position: 'ì¶”ì  ì¤‘...',
                    size: 'ê³„ì‚° ì¤‘...'
                });
                
                // YouTube ì˜¤ë²„ë ˆì´ í‘œì‹œ
                showYouTubeOnARImage(arData);
                
                // ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  ì‹œì‘
                startRealTimeTracking();
                
                // ë¡œë”© í…ìŠ¤íŠ¸ í‘œì‹œ
                const loadingText = document.querySelector('#loading-text');
                loadingText.setAttribute('visible', true);
                
                setTimeout(() => {
                    loadingText.setAttribute('visible', false);
                    
                    // ì»¨íŠ¸ë¡¤ í…ìŠ¤íŠ¸ í‘œì‹œ
                    const controlText = document.querySelector('#control-text');
                    controlText.setAttribute('visible', true);
                }, 2000);
                
                // ì„±ê³µ ì•Œë¦¼
                console.log('âœ… AR ì´ë¯¸ì§€ ì¸ì‹ ì„±ê³µ! YouTube ì˜ìƒì´ ì´ë¯¸ì§€ ìœ„ì— í‘œì‹œë©ë‹ˆë‹¤.');
            });
            
            // mindAR íƒ€ê²Ÿ ê°ì§€ í•´ì œ ì´ë²¤íŠ¸
            target.addEventListener('targetLost', () => {
                console.log('ğŸ“µ mindAR: íƒ€ê²Ÿ ì´ë¯¸ì§€ ê°ì§€ í•´ì œë¨');
                isTargetDetected = false;
                
                document.getElementById('arStatus').textContent = 'ğŸ“µ AR ì´ë¯¸ì§€ê°€ ê°ì§€ ë²”ìœ„ì—ì„œ ë²—ì–´ë‚¨';
                
                // ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
                updateDebugInfo({
                    status: 'ğŸ“µ AR ì´ë¯¸ì§€ ê°ì§€ í•´ì œ',
                    position: '-',
                    size: '-'
                });
                
                // ì‹¤ì‹œê°„ ì¶”ì  ì¤‘ì§€
                stopRealTimeTracking();
                
                // YouTube ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
                hideYouTubeAROverlay();
                
                // ëª¨ë“  AR ìš”ì†Œ ìˆ¨ê¸°ê¸°
                document.querySelector('#loading-text').setAttribute('visible', false);
                document.querySelector('#control-text').setAttribute('visible', false);
                document.querySelector('#youtube-3d-plane').setAttribute('visible', false);
            });
            
            // í´ë¦­ ì´ë²¤íŠ¸ (ì†Œë¦¬ í™œì„±í™”)
            const clickDetector = document.querySelector('#click-detector');
            clickDetector.addEventListener('click', () => {
                if (isTargetDetected) {
                    console.log('ğŸ”Š ì‚¬ìš©ì í´ë¦­: ì†Œë¦¬ í™œì„±í™”');
                    enableSoundForYouTube();
                    isSoundEnabled = true;
                    
                    const controlText = document.querySelector('#control-text');
                    controlText.setAttribute('value', 'ğŸ”Š ì†Œë¦¬ í™œì„±í™”ë¨');
                    controlText.setAttribute('color', '#4CAF50');
                    
                    document.getElementById('arStatus').textContent = 'ğŸ”Š AR ì˜ìƒ ì¬ìƒ ì¤‘ (ì†Œë¦¬ ON)';
                    
                    // 3ì´ˆ í›„ ì»¨íŠ¸ë¡¤ í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°
                    setTimeout(() => {
                        controlText.setAttribute('visible', false);
                    }, 3000);
                }
            });
            
            // mindAR ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ ì´ë²¤íŠ¸
            scene.addEventListener('renderstart', () => {
                console.log('âœ… mindAR ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ');
                document.getElementById('arStatus').textContent = 'ğŸ“· ì¹´ë©”ë¼ë¡œ ìƒì„±ëœ AR ì´ë¯¸ì§€ë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”';
            });
            
            // ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  í•¨ìˆ˜ (3D)
            function startRealTimeTracking() {
                console.log('ğŸ”„ ì‹¤ì‹œê°„ 3D AR ìœ„ì¹˜ ì¶”ì  ì‹œì‘');
                
                if (trackingAnimation) {
                    cancelAnimationFrame(trackingAnimation);
                }
                
                const iframe = document.getElementById('youtube-3d-iframe');
                
                function updatePosition() {
                    if (isTargetDetected && iframe) {
                        // 3D ìœ„ì¹˜ ì¶”ì ì€ start3DYouTubeTrackingì—ì„œ ì²˜ë¦¬ë¨
                        // ì—¬ê¸°ì„œëŠ” ì¶”ê°€ì ì¸ ì—…ë°ì´íŠ¸ë§Œ ìˆ˜í–‰
                    }
                    trackingAnimation = requestAnimationFrame(updatePosition);
                }
                
                trackingAnimation = requestAnimationFrame(updatePosition);
            }
            
            function stopRealTimeTracking() {
                console.log('â¹ï¸ ì‹¤ì‹œê°„ AR ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€');
                if (trackingAnimation) {
                    cancelAnimationFrame(trackingAnimation);
                    trackingAnimation = null;
                }
            }
        }
        
        function showYouTubeOnARImage(arData) {
            console.log('ğŸ“º 3D AR ì´ë¯¸ì§€ ìœ„ì— YouTube ì˜ìƒ í‘œì‹œ');
            
            // YouTube URL ìƒì„± (ì†Œë¦¬ ì—†ìŒìœ¼ë¡œ ì‹œì‘)
            const youtubeUrl = extractYouTubeUrl(arData.videoUrl || 'https://www.youtube.com/watch?v=dQw4w9WgXcQ');
            const embedUrl = `https://www.youtube.com/embed/${youtubeUrl}?autoplay=1&mute=1&loop=1&playlist=${youtubeUrl}&rel=0&modestbranding=1&controls=1`;
            
            // 3D YouTube í‰ë©´ í‘œì‹œ
            const youtubePlane = document.querySelector('#youtube-3d-plane');
            youtubePlane.setAttribute('visible', true);
            youtubePlane.setAttribute('material', 'color: #000; opacity: 0.9; transparent: true');
            
            // 3D YouTube iframe ìƒì„± ë° ë°°ì¹˜
            create3DYouTubeIframe(embedUrl);
            
            console.log('âœ… 3D YouTube ì˜ìƒ ë°°ì¹˜ ì™„ë£Œ');
        }
        
        function create3DYouTubeIframe(embedUrl) {
            console.log('ğŸ¬ 3D YouTube iframe ìƒì„± ì¤‘...');
            
            // ê¸°ì¡´ iframe ì œê±°
            const existingIframe = document.querySelector('#youtube-3d-iframe');
            if (existingIframe) {
                existingIframe.remove();
            }
            
            // ìƒˆë¡œìš´ 3D iframe ìƒì„±
            const container = document.getElementById('youtube-3d-container');
            const iframe = document.createElement('iframe');
            iframe.id = 'youtube-3d-iframe';
            iframe.src = embedUrl;
            iframe.style.cssText = `
                position: absolute;
                border: 2px solid #ff6b35;
                border-radius: 8px;
                box-shadow: 0 0 20px rgba(255, 107, 53, 0.6);
                pointer-events: auto;
                transform-origin: center center;
                transition: transform 0.1s ease-out;
                width: 320px;
                height: 180px;
            `;
            iframe.setAttribute('frameborder', '0');
            iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
            iframe.setAttribute('allowfullscreen', '');
            
            container.appendChild(iframe);
            container.style.display = 'block';
            
            // 3D ìœ„ì¹˜ ì¶”ì  ì‹œì‘
            start3DYouTubeTracking(iframe);
        }
        
        function start3DYouTubeTracking(iframe) {
            console.log('ğŸ”„ 3D YouTube ìœ„ì¹˜ ì¶”ì  ì‹œì‘');
            
            const target = document.querySelector('#ar-target');
            const camera = document.querySelector('[camera]');
            
            if (!target || !camera) {
                console.warn('AR ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }
            
            function update3DPosition() {
                try {
                    // A-Frame 3D ì›”ë“œ ì¢Œí‘œë¥¼ í™”ë©´ ì¢Œí‘œë¡œ ë³€í™˜
                    const targetPosition = target.object3D.position.clone();
                    const cameraMatrix = camera.object3D.matrixWorldInverse;
                    const screenPosition = targetPosition.clone();
                    
                    // ì¹´ë©”ë¼ ê³µê°„ìœ¼ë¡œ ë³€í™˜
                    screenPosition.applyMatrix4(cameraMatrix);
                    
                    // íˆ¬ì˜ ë³€í™˜ (3D -> 2D)
                    const projectionMatrix = camera.components.camera.camera.projectionMatrix;
                    screenPosition.applyMatrix4(projectionMatrix);
                    
                    // í™”ë©´ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì •ê·œí™”ëœ ì¢Œí‘œë¥¼ ì‹¤ì œ í”½ì…€ë¡œ ë³€í™˜
                    const screenWidth = window.innerWidth;
                    const screenHeight = window.innerHeight;
                    
                    const x = (screenPosition.x + 1) * screenWidth / 2;
                    const y = (-screenPosition.y + 1) * screenHeight / 2;
                    
                    // AR ì´ë¯¸ì§€ì˜ 3D ë³€í™˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const targetRotation = target.object3D.rotation;
                    const targetScale = target.object3D.scale;
                    
                    // YouTube iframe í¬ê¸° (AR í‰ë©´ê³¼ ì¼ì¹˜)
                    const overlayWidth = Math.min(screenWidth * 0.4, 320);
                    const overlayHeight = overlayWidth * 9 / 16;
                    
                    // AR ì´ë¯¸ì§€ ìœ„ì¹˜ì— ì •í™•íˆ ë§ì¶¤
                    iframe.style.left = (x - overlayWidth / 2) + 'px';
                    iframe.style.top = (y - overlayHeight / 2) + 'px';
                    iframe.style.width = overlayWidth + 'px';
                    iframe.style.height = overlayHeight + 'px';
                    
                    // 3D íšŒì „ ì ìš© (Zì¶• íšŒì „ë§Œ)
                    const rotationZ = targetRotation.z * (180 / Math.PI);
                    iframe.style.transform = `rotateZ(${rotationZ}deg)`;
                    
                    // 3D ìŠ¤ì¼€ì¼ ì ìš©
                    const scaleX = targetScale.x;
                    const scaleY = targetScale.y;
                    iframe.style.transform += ` scale(${scaleX}, ${scaleY})`;
                    
                    // ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
                    updateDebugInfo({
                        status: '3D AR ì´ë¯¸ì§€ ì¶”ì  ì¤‘',
                        position: `X: ${Math.round(x)}, Y: ${Math.round(y)}, R: ${Math.round(rotationZ)}Â°`,
                        size: `${overlayWidth}x${overlayHeight} (S: ${scaleX.toFixed(2)}x${scaleY.toFixed(2)})`
                    });
                    
                } catch (error) {
                    console.error('3D YouTube ìœ„ì¹˜ ê³„ì‚° ì˜¤ë¥˜:', error);
                }
                
                // ë‹¤ìŒ í”„ë ˆì„ì—ì„œ ì—…ë°ì´íŠ¸
                requestAnimationFrame(update3DPosition);
            }
            
            // ì¶”ì  ì‹œì‘
            update3DPosition();
        }
        
        function hideYouTubeAROverlay() {
            console.log('ğŸ“µ 3D YouTube AR ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€');
            
            const container = document.getElementById('youtube-3d-container');
            const iframe = document.getElementById('youtube-3d-iframe');
            const youtubePlane = document.querySelector('#youtube-3d-plane');
            
            // 3D YouTube í‰ë©´ ìˆ¨ê¸°ê¸°
            if (youtubePlane) {
                youtubePlane.setAttribute('visible', false);
            }
            
            // 3D YouTube ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
            if (container) {
                container.style.display = 'none';
            }
            
            // iframe ì œê±°
            if (iframe) {
                iframe.remove();
            }
            
            // ë””ë²„ê·¸ ì •ë³´ ìˆ¨ê¸°ê¸°
            hideDebugInfo();
        }
        
        function enableSoundForYouTube() {
            console.log('ğŸ”Š 3D YouTube ì˜ìƒ ì†Œë¦¬ í™œì„±í™”');
            
            const iframe = document.getElementById('youtube-3d-iframe');
            if (!iframe) {
                console.warn('3D YouTube iframeì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }
            
            const currentSrc = iframe.src;
            
            if (currentSrc.includes('mute=1')) {
                // mute=1ì„ mute=0ìœ¼ë¡œ ë³€ê²½
                const newSrc = currentSrc.replace('mute=1', 'mute=0');
                iframe.src = newSrc;
                
                console.log('âœ… 3D YouTube ì†Œë¦¬ í™œì„±í™” ì™„ë£Œ');
            }
        }
        
        function extractYouTubeUrl(url) {
            // YouTube URLì—ì„œ ë¹„ë””ì˜¤ ID ì¶”ì¶œ
            const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/;
            const match = url.match(regex);
            return match ? match[1] : 'dQw4w9WgXcQ'; // ê¸°ë³¸ ë¹„ë””ì˜¤ ID
        }
        

        
        function updateDebugInfo(info) {
            const debugInfo = document.getElementById('ar-debug-info');
            const statusEl = document.getElementById('debug-status');
            const positionEl = document.getElementById('debug-position');
            const sizeEl = document.getElementById('debug-size');
            
            if (debugInfo && statusEl && positionEl && sizeEl) {
                debugInfo.style.display = 'block';
                statusEl.textContent = info.status || 'ëŒ€ê¸° ì¤‘';
                positionEl.textContent = info.position || '-';
                sizeEl.textContent = info.size || '-';
            }
        }
        
        function hideDebugInfo() {
            const debugInfo = document.getElementById('ar-debug-info');
            if (debugInfo) {
                debugInfo.style.display = 'none';
            }
        }

        // ê¸°ì¡´ í•¨ìˆ˜ëŠ” í´ë°±ìš©ìœ¼ë¡œ ìœ ì§€
        function simulateTargetDetection(arData) {
            document.getElementById('arStatus').textContent = 'ğŸ¯ ì´ë¯¸ì§€ ê°ì§€ë¨! YouTube ì˜ìƒ ë¡œë”© ì¤‘...';
            
            // í´ë°± ëª¨ë“œì—ì„œ YouTube í‘œì‹œ
            showYouTubeOnARImage(arData);
        }
    </script>
</body>
</html> 